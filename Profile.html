<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* جميع الأنماط كما هي دون تغيير */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --impartiality-color: #9b59b6;
            --confidentiality-color: #e74c3c;
            --quality-color: #f39c12;
            --light-bg: #f8f9fa;
            --border-color: #e0e0e0;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-primary: #333;
            --text-secondary: #666;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --section-width: 95%;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--accent-color);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            background-color: white;
            display: flex;
            overflow-x: auto;
            padding: 0 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 98px;
            z-index: 999;
        }
        
        .nav-tab {
            padding: 15px 20px;
            white-space: nowrap;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        
        .nav-tab:hover {
            color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .nav-tab.active {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
            font-weight: 600;
        }
        
        .nav-tab i {
            margin-left: 8px;
            font-size: 0.9rem;
        }
        
        /* Form Sections Container */
        .sections-container {
            display: flex;
            overflow-x: hidden;
            scroll-behavior: smooth;
            padding: 30px 0;
            min-height: calc(100vh - 200px);
            width: 100%;
        }
        
        .form-section {
            flex: 0 0 100%;
            padding: 0 30px;
            transition: transform 0.5s ease;
            width: 100%;
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--secondary-color);
            position: relative;
        }
        
        .section-number {
            background-color: var(--secondary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* Compact form styling */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
            font-size: 0.9rem;
        }
        
        textarea.form-input, select.form-input, input.form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background-color: white;
            resize: none;
            overflow-y: hidden;
            min-height: 44px;
            max-height: 300px;
            line-height: 1.5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        select.form-input {
            resize: none;
            height: 44px;
            overflow-y: visible;
        }
        
        input.form-input {
            height: 44px;
            resize: none;
        }
        
        input[type="number"] {
            font-family: monospace;
            text-align: left;
        }
        
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .date-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--impartiality-color);
            pointer-events: none;
            z-index: 2;
        }
        
        .date-input-wrapper input {
            padding-right: 40px;
            direction: ltr;
            text-align: right;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
            background-color: white;
        }
        
        .work-period-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .work-period-item {
            display: flex;
            flex-direction: column;
        }
        
        .work-period-item label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        textarea.auto-expand {
            transition: height 0.2s ease-out;
        }
        
        .stretchable {
            min-width: 100%;
            max-width: 100%;
        }
        
        textarea.form-input:focus, select.form-input:focus, input.form-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        
        .compact-input {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        /* Upload area styles */
        .upload-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .upload-container:hover {
            background: #e9ecef;
            border-color: var(--secondary-color);
        }
        
        .upload-container.dragover {
            background: #e3f2fd;
            border-color: var(--secondary-color);
            border-style: solid;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .upload-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1a5276);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .upload-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .upload-status {
            margin-top: 10px;
            font-size: 0.85rem;
            min-height: 20px;
            padding: 5px;
            border-radius: 4px;
        }
        
        .upload-status.success {
            color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
        }
        
        .upload-status.error {
            color: var(--confidentiality-color);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .upload-status.loading {
            color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 15px;
            margin-top: 10px;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        
        .file-preview:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }
        
        .file-preview i {
            color: var(--success-color);
            margin-left: 8px;
            font-size: 1.2rem;
        }
        
        .file-preview .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 8px;
        }
        
        .file-preview .badge {
            background: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 8px;
        }
        
        .file-link-btn {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s;
            margin-right: 8px;
        }
        
        .file-link-btn:hover {
            background: #219653;
            color: white;
            text-decoration: none;
        }
        
        .remove-file-btn {
            background: none;
            border: none;
            color: var(--confidentiality-color);
            cursor: pointer;
            font-size: 1rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .remove-file-btn:hover {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .experience-section {
            background-color: var(--light-bg);
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .experience-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .experience-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .add-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 18px auto;
            transition: background-color 0.3s;
        }
        
        .add-btn:hover {
            background-color: #16a085;
        }
        
        .add-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background-color: white;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            z-index: 999;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .section-counter {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 10px 25px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn-prev {
            background-color: #f8f9fa;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
        }
        
        .nav-btn-prev:hover {
            background-color: #e9ecef;
        }
        
        .nav-btn-next {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .nav-btn-next:hover {
            background-color: #2980b9;
        }
        
        .nav-btn-save {
            background-color: var(--success-color);
            color: white;
            margin-right: 10px;
        }
        
        .nav-btn-save:hover {
            background-color: #219653;
        }
        
        .nav-btn-save.saved {
            background-color: var(--accent-color);
        }
        
        .nav-btn-submit {
            background-color: var(--warning-color);
            color: white;
        }
        
        .nav-btn-submit:hover {
            background-color: #d68910;
        }
        
        .hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }
        
        .counter {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: left;
            margin-top: 5px;
        }
        
        .summary-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-right: 5px solid var(--accent-color);
        }
        
        .summary-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
            font-size: 1.3rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            margin-bottom: 12px;
        }
        
        .summary-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .summary-value {
            color: var(--text-secondary);
            background-color: var(--light-bg);
            padding: 8px 12px;
            border-radius: 6px;
            border-right: 3px solid var(--secondary-color);
            min-height: 40px;
            word-break: break-word;
        }
        
        .summary-value.empty {
            color: #999;
            font-style: italic;
        }
        
        .download-pdf-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 30px auto;
            transition: all 0.3s;
        }
        
        .download-pdf-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .download-pdf-btn i {
            font-size: 1.2rem;
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
        }
        
        .progress-bar {
            width: 150px;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 4px;
            width: 9.1%;
            transition: width 0.5s ease;
        }
        
        .other-input-container {
            display: none;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        .flatpickr-calendar {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            z-index: 10000 !important;
        }
        
        .flatpickr-month {
            height: 50px !important;
            padding-top: 5px !important;
        }
        
        .flatpickr-monthDropdown-months {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem !important;
            height: auto !important;
            padding: 5px !important;
            min-width: 100px !important;
        }
        
        .flatpickr-current-month {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
            padding: 0 !important;
            height: 100% !important;
        }
        
        .flatpickr-current-month .numInputWrapper {
            width: 70px !important;
        }
        
        .flatpickr-current-month .numInputWrapper input {
            font-size: 1rem !important;
            padding: 3px 5px !important;
        }
        
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--impartiality-color);
            border-color: var(--impartiality-color);
        }
        
        .flatpickr-weekdays {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .impartiality-policy-container,
        .confidentiality-policy-container,
        .quality-policy-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
            padding: 20px;
        }
        
        .policy-header {
            background: linear-gradient(135deg, var(--impartiality-color) 0%, #8e44ad 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: -20px -20px 20px -20px;
        }
        
        .confidentiality-policy-container .policy-header {
            background: linear-gradient(135deg, var(--confidentiality-color) 0%, #c0392b 100%);
        }
        
        .quality-policy-container .policy-header {
            background: linear-gradient(135deg, var(--quality-color) 0%, #d68910 100%);
        }
        
        .policy-header h3 {
            font-size: 1.4rem;
            margin-bottom: 8px;
        }
        
        .policy-subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .policy-display-area {
            width: 100%;
            max-width: 800px;
            height: 700px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin: 15px auto 0;
            background-color: #f8f9fa;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .pdf-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: white;
            overflow: auto;
            padding: 10px;
        }
        
        .policy-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
            transform-origin: 0 0;
        }
        
        .pdf-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .pdf-control-btn {
            background-color: var(--impartiality-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .confidentiality-policy-container .pdf-control-btn {
            background-color: var(--confidentiality-color);
        }
        
        .quality-policy-container .pdf-control-btn {
            background-color: var(--quality-color);
        }
        
        .pdf-control-btn:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        .confidentiality-policy-container .pdf-control-btn:hover {
            background-color: #c0392b;
        }
        
        .quality-policy-container .pdf-control-btn:hover {
            background-color: #d68910;
        }
        
        .pdf-control-btn.zoom-out {
            background-color: var(--secondary-color);
        }
        
        .pdf-control-btn.zoom-out:hover {
            background-color: #2980b9;
        }
        
        .pdf-control-btn.zoom-reset {
            background-color: var(--text-secondary);
        }
        
        .pdf-control-btn.zoom-reset:hover {
            background-color: #555;
        }
        
        .pdf-zoom-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        
        .policy-notice {
            background-color: rgba(155, 89, 182, 0.1);
            border-right: 4px solid var(--impartiality-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--primary-color);
        }
        
        .confidentiality-policy-container .policy-notice {
            background-color: rgba(231, 76, 60, 0.1);
            border-right: 4px solid var(--confidentiality-color);
        }
        
        .quality-policy-container .policy-notice {
            background-color: rgba(243, 156, 18, 0.1);
            border-right: 4px solid var(--quality-color);
        }
        
        .policy-notice i {
            color: var(--impartiality-color);
            margin-left: 8px;
        }
        
        .confidentiality-policy-container .policy-notice i {
            color: var(--confidentiality-color);
        }
        
        .quality-policy-container .policy-notice i {
            color: var(--quality-color);
        }
        
        .checkbox-group {
            background-color: var(--light-bg);
            padding: 18px;
            border-radius: 8px;
            margin-top: 20px;
            border-right: 4px solid var(--impartiality-color);
        }
        
        .confidentiality-policy-container .checkbox-group {
            border-right: 4px solid var(--confidentiality-color);
        }
        
        .quality-policy-container .checkbox-group {
            border-right: 4px solid var(--quality-color);
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-left: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-label {
            font-weight: 600;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .checkbox-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .impartiality-summary,
        .confidentiality-summary,
        .quality-summary {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            border-right: 4px solid var(--impartiality-color);
        }
        
        .confidentiality-summary {
            border-right: 4px solid var(--confidentiality-color);
        }
        
        .quality-summary {
            border-right: 4px solid var(--quality-color);
        }
        
        .impartiality-summary h4,
        .confidentiality-summary h4,
        .quality-summary h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .impartiality-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        
        .status-icon.complete {
            background-color: var(--success-color);
        }
        
        .status-icon.incomplete {
            background-color: var(--warning-color);
        }
        
        .status-text {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* File preview grid in summary */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .file-preview-summary {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .file-preview-summary:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }
        
        .file-preview-header {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-preview-header i {
            font-size: 1.2rem;
        }
        
        .file-preview-body {
            padding: 15px;
            background: #f8f9fa;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .file-preview-body iframe {
            width: 100%;
            height: 200px;
            border: none;
            border-radius: 6px;
        }

        .file-preview-body img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .file-preview-body .placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
        }
        
        .file-preview-footer {
            padding: 12px 15px;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-preview-footer .btn {
            background: var(--secondary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .file-preview-footer .btn:hover {
            background: #2980b9;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #27ae60;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10002;
            animation: slideIn 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 90%;
        }
        
        .toast-error {
            background-color: #e74c3c;
        }
        
        .toast-info {
            background-color: #3498db;
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }

        /* English date styling (LTR for numbers) */
        .english-date {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed !important;
            display: inline-block;
        }
        
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
            .nav-tabs { top: 94px; }
            .summary-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
            .dual-upload-container { flex-direction: column; }
            .work-period-container { grid-template-columns: 1fr; }
            .policy-display-area { height: 600px; max-width: 95%; }
        }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: flex-start; gap: 12px; }
            .logout-btn { align-self: flex-start; }
            .nav-tabs { top: 140px; }
            .nav-controls { flex-direction: column; gap: 15px; padding: 15px; }
            .nav-buttons { width: 100%; justify-content: space-between; }
            .nav-btn { padding: 10px 15px; font-size: 0.9rem; }
            .form-section { padding: 0 15px; }
            .section-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .section-number { margin-left: 0; }
            .form-grid { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
            .work-period-container { grid-template-columns: 1fr; }
            .policy-display-area { height: 500px; max-width: 100%; }
            .pdf-controls { flex-wrap: wrap; }
            .pdf-control-btn { flex: 1; min-width: 100px; }
        }
        
        @media (max-width: 480px) {
            .policy-display-area { height: 400px; }
            .pdf-controls { flex-direction: column; }
            .pdf-control-btn { width: 100%; }
            .nav-buttons { flex-wrap: wrap; }
            .nav-btn { flex: 1; min-width: 120px; justify-content: center; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-user-tie"></i>
                    <div>
                        <h1>الملف الشخصي</h1>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </header>
        
        <!-- Navigation Tabs -->
        <nav class="nav-tabs" id="navTabs">
            <div class="nav-tab active" data-section="1">
                <i class="fas fa-user"></i> البيانات الشخصية
            </div>
            <div class="nav-tab" data-section="2">
                <i class="fas fa-address-book"></i> بيانات الاتصال
            </div>
            <div class="nav-tab" data-section="3">
                <i class="fas fa-file-contract"></i> المستندات
            </div>
            <div class="nav-tab" data-section="4">
                <i class="fas fa-graduation-cap"></i> المؤهل العلمي
            </div>
            <div class="nav-tab" data-section="5">
                <i class="fas fa-briefcase"></i> الخبرات العملية
            </div>
            <div class="nav-tab" data-section="6">
                <i class="fas fa-id-badge"></i> البطاقة الوظيفية
            </div>
            <div class="nav-tab" data-section="7">
                <i class="fas fa-balance-scale"></i> الحيادية
            </div>
            <div class="nav-tab" data-section="8">
                <i class="fas fa-user-secret"></i> السرية
            </div>
            <div class="nav-tab" data-section="9">
                <i class="fas fa-award"></i> الجودة
            </div>
            <div class="nav-tab" data-section="10">
                <i class="fas fa-file-pdf"></i> الملخص وتحميل PDF
            </div>
        </nav>
        
        <!-- Form Sections Container -->
        <div class="sections-container" id="sectionsContainer">
            <!-- Section 1: Basic Personal Data -->
            <section class="form-section active" id="section-1">
                <div class="section-header">
                    <div class="section-number">1</div>
                    <h2 class="section-title">البيانات الشخصية الأساسية</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="full-name" class="required">الاسم بالكامل</label>
                        <textarea id="full-name" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="الاسم بالكامل مطابق لبطاقة الرقم القومي"></textarea>
                        <div class="hint">مطابق لبطاقة الرقم القومي</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="english-name">الاسم بالإنجليزي</label>
                        <textarea id="english-name" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="كما هو في جواز السفر إن وجد"></textarea>
                        <div class="hint">كما هو في جواز السفر إن وجد</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="national-id" class="required">الرقم القومي</label>
                        <textarea id="national-id" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="14 رقم" maxlength="14"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-date" class="required">تاريخ الميلاد</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="birth-date" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                            <i class="fas fa-calendar-alt date-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-place" class="required">محل الميلاد</label>
                        <textarea id="birth-place" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="المحافظة / الدولة"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="nationality" class="required">الجنسية</label>
                        <select id="nationality" class="form-input compact-input" onchange="toggleOtherInput('nationality', 'other-nationality-container')">
                            <option value="">اختر الجنسية</option>
                            <option value="مصري">مصري</option>
                            <option value="سعودي">سعودي</option>
                            <option value="أردني">أردني</option>
                            <option value="إماراتي">إماراتي</option>
                            <option value="آخر">آخر</option>
                        </select>
                        <div class="other-input-container" id="other-nationality-container">
                            <label for="other-nationality" class="required">الرجاء تحديد الجنسية</label>
                            <textarea id="other-nationality" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="الرجاء تحديد الجنسية"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="religion" class="required">الديانة</label>
                        <select id="religion" class="form-input compact-input" onchange="toggleOtherInput('religion', 'other-religion-container')">
                            <option value="">اختر الديانة</option>
                            <option value="مسلم">مسلم</option>
                            <option value="مسيحي">مسيحي</option>
                            <option value="آخر">آخر</option>
                        </select>
                        <div class="other-input-container" id="other-religion-container">
                            <label for="other-religion" class="required">الرجاء تحديد الديانة</label>
                            <textarea id="other-religion" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="الرجاء تحديد الديانة"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="marital-status" class="required">الحالة الاجتماعية</label>
                        <select id="marital-status" class="form-input compact-input">
                            <option value="">اختر الحالة الاجتماعية</option>
                            <option value="أعزب">أعزب</option>
                            <option value="متزوج">متزوج</option>
                            <option value="مطلق">مطلق</option>
                            <option value="أرمل">أرمل</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="children-count">عدد الأبناء</label>
                        <textarea id="children-count" rows="1" class="form-input compact-input auto-expand" placeholder="إن وجد" type="number"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="military-status" class="required">الموقف من التجنيد</label>
                        <select id="military-status" class="form-input compact-input">
                            <option value="">اختر الموقف من التجنيد</option>
                            <option value="أدى الخدمة">أدى الخدمة</option>
                            <option value="إعفاء">إعفاء</option>
                            <option value="مؤجل">مؤجل</option>
                            <option value="غير مطلوب">غير مطلوب</option>
                        </select>
                    </div>
                </div>
            </section>
            
            <!-- Section 2: Contact Information -->
            <section class="form-section" id="section-2">
                <div class="section-header">
                    <div class="section-number">2</div>
                    <h2 class="section-title">بيانات الاتصال والعنوان</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="address" class="required">العنوان الحالي</label>
                        <textarea id="address" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="العنوان بالتفصيل"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone" class="required">رقم الهاتف الأساسي</label>
                        <textarea id="phone" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="رقم الهاتف الأساسي" type="tel"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="alt-phone">رقم هاتف بديل</label>
                        <textarea id="alt-phone" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="رقم هاتف بديل" type="tel"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="required">البريد الإلكتروني الشخصي</label>
                        <textarea id="email" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="البريد الإلكتروني الشخصي" type="email"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="emergency-name" class="required">اسم شخص للطوارئ</label>
                        <textarea id="emergency-name" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="اسم شخص للطوارئ"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="emergency-phone" class="required">رقم هاتف شخص للطوارئ</label>
                        <textarea id="emergency-phone" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="رقم هاتف شخص للطوارئ" type="tel"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="emergency-relation" class="required">صلة القرابة</label>
                        <textarea id="emergency-relation" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="صلة القرابة بالشخص"></textarea>
                    </div>
                </div>
            </section>
            
            <!-- Section 3: Official Documents -->
            <section class="form-section" id="section-3">
                <div class="section-header">
                    <div class="section-number">3</div>
                    <h2 class="section-title">المستندات الرسمية</h2>
                </div>
                
                <div class="form-grid">
                    <!-- National ID Front -->
                    <div class="form-group">
                        <label>صورة بطاقة الرقم القومي - الوجه الأمامي</label>
                        <div class="upload-container">
                            <i class="fas fa-id-card" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="national-id-front-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('national-id-front-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('national-id-front-file')" id="upload-national-id-front-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="national-id-front-status"></div>
                            
                            <div id="national-id-front-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="national-id-front-name"></span>
                                    <span class="badge" id="national-id-front-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="national-id-front-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('national-id-front-file', 'national-id-front-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- National ID Back -->
                    <div class="form-group">
                        <label>صورة بطاقة الرقم القومي - الوجه الخلفي</label>
                        <div class="upload-container">
                            <i class="fas fa-id-card" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="national-id-back-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('national-id-back-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('national-id-back-file')" id="upload-national-id-back-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="national-id-back-status"></div>
                            
                            <div id="national-id-back-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="national-id-back-name"></span>
                                    <span class="badge" id="national-id-back-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="national-id-back-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('national-id-back-file', 'national-id-back-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Birth Certificate -->
                    <div class="form-group">
                        <label>صورة شهادة الميلاد</label>
                        <div class="upload-container">
                            <i class="fas fa-certificate" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="birth-certificate-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('birth-certificate-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('birth-certificate-file')" id="upload-birth-certificate-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="birth-certificate-status"></div>
                            
                            <div id="birth-certificate-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="birth-certificate-name"></span>
                                    <span class="badge" id="birth-certificate-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="birth-certificate-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('birth-certificate-file', 'birth-certificate-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Criminal Record -->
                    <div class="form-group">
                        <label>صحيفة الحالة الجنائية</label>
                        <div class="upload-container">
                            <i class="fas fa-file-contract" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="criminal-record-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('criminal-record-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('criminal-record-file')" id="upload-criminal-record-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="criminal-record-status"></div>
                            
                            <div id="criminal-record-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="criminal-record-name"></span>
                                    <span class="badge" id="criminal-record-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="criminal-record-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('criminal-record-file', 'criminal-record-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Military Certificate -->
                    <div class="form-group">
                        <label>شهادة التجنيد</label>
                        <div class="upload-container">
                            <i class="fas fa-shield-alt" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="military-certificate-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('military-certificate-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('military-certificate-file')" id="upload-military-certificate-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="military-certificate-status"></div>
                            
                            <div id="military-certificate-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="military-certificate-name"></span>
                                    <span class="badge" id="military-certificate-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="military-certificate-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('military-certificate-file', 'military-certificate-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personal Photos -->
                    <div class="form-group">
                        <label>صور شخصية</label>
                        <div class="upload-container">
                            <i class="fas fa-portrait" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="personal-photos-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('personal-photos-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('personal-photos-file')" id="upload-personal-photos-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="personal-photos-status"></div>
                            
                            <div id="personal-photos-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="personal-photos-name"></span>
                                    <span class="badge" id="personal-photos-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="personal-photos-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('personal-photos-file', 'personal-photos-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Section 4: Educational Qualification -->
            <section class="form-section" id="section-4">
                <div class="section-header">
                    <div class="section-number">4</div>
                    <h2 class="section-title">المؤهل العلمي</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="qualification" class="required">المؤهل</label>
                        <select id="qualification" class="form-input compact-input">
                            <option value="">اختر المؤهل العلمي</option>
                            <option value="بكالوريوس">بكالوريوس</option>
                            <option value="دبلوم">دبلوم</option>
                            <option value="ماجستير">ماجستير</option>
                            <option value="دكتوراه">دكتوراه</option>
                            <option value="دبلوم عالي">دبلوم عالي</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="university" class="required">اسم الجامعة / المعهد</label>
                        <textarea id="university" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="اسم الجامعة / المعهد"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialization" class="required">التخصص</label>
                        <textarea id="specialization" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="التخصص الدراسي"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="graduation-year" class="required">سنة التخرج</label>
                        <textarea id="graduation-year" rows="1" class="form-input compact-input auto-expand" placeholder="سنة التخرج" type="number"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="grade" class="required">التقدير العام</label>
                        <select id="grade" class="form-input compact-input">
                            <option value="">اختر التقدير</option>
                            <option value="ممتاز">ممتاز</option>
                            <option value="جيد جداً">جيد جداً</option>
                            <option value="جيد">جيد</option>
                            <option value="مقبول">مقبول</option>
                            <option value="ناجح">ناجح</option>
                        </select>
                    </div>
                    
                    <!-- Graduation Certificate Upload -->
                    <div class="form-group">
                        <label>شهادة التخرج (صورة معتمدة)</label>
                        <div class="upload-container">
                            <i class="fas fa-graduation-cap" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="graduation-certificate-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('graduation-certificate-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('graduation-certificate-file')" id="upload-graduation-certificate-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="graduation-certificate-status"></div>
                            
                            <div id="graduation-certificate-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="graduation-certificate-name"></span>
                                    <span class="badge" id="graduation-certificate-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="graduation-certificate-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('graduation-certificate-file', 'graduation-certificate-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equivalency Certificate Upload -->
                    <div class="form-group">
                        <label>معادلة الشهادة (إن وجدت)</label>
                        <div class="upload-container">
                            <i class="fas fa-balance-scale" style="font-size: 1.8rem; color: var(--secondary-color); margin-bottom: 8px;"></i>
                            <p>الأنواع المسموحة: PNG, JPG, JPEG, PDF (الحد الأقصى 10MB)</p>
                            
                            <input type="file" id="equivalency-file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" style="display: none">
                            <button type="button" class="upload-btn" onclick="document.getElementById('equivalency-file').click()">
                                <i class="fas fa-folder-open"></i> اختر ملف
                            </button>
                            <button type="button" class="upload-btn" onclick="uploadFile('equivalency-file')" id="upload-equivalency-btn">
                                <i class="fas fa-upload"></i> رفع الملف
                            </button>
                            
                            <div class="upload-status" id="equivalency-status"></div>
                            
                            <div id="equivalency-preview" style="display: none; margin-top: 10px; width: 100%;">
                                <div class="file-preview">
                                    <i class="fas fa-file"></i>
                                    <span class="file-name" id="equivalency-name"></span>
                                    <span class="badge" id="equivalency-size" style="display:none;"></span>
                                    <a href="#" target="_blank" class="file-link-btn" id="equivalency-link" style="display: none;">
                                        <i class="fas fa-external-link-alt"></i> فتح الملف
                                    </a>
                                    <button type="button" class="remove-file-btn" onclick="removeFile('equivalency-file', 'equivalency-preview')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Section 5: Work Experience -->
            <section class="form-section" id="section-5">
                <div class="section-header">
                    <div class="section-number">5</div>
                    <h2 class="section-title">الخبرات العملية (إن وجدت)</h2>
                </div>
                
                <div id="experience-container">
                    <div class="experience-section" id="experience-1">
                        <div class="experience-header">
                            <div class="experience-title">الخبرة العملية #1</div>
                            <button type="button" class="remove-btn" onclick="removeExperience(1)" style="display: none;">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="company-1">الشركة السابقة</label>
                                <textarea id="company-1" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="اسم الشركة السابقة"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="job-title-1">المسمى الوظيفي</label>
                                <textarea id="job-title-1" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="المسمى الوظيفي"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="job-tasks-1">المهام الأساسية</label>
                                <textarea id="job-tasks-1" rows="2" class="form-input stretchable compact-input auto-expand" placeholder="المهام الأساسية التي قمت بها"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>مدة العمل</label>
                                <div class="work-period-container">
                                    <div class="work-period-item">
                                        <label for="work-start-date-1">تاريخ البدء</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" id="work-start-date-1" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="work-period-item">
                                        <label for="work-end-date-1">تاريخ الانتهاء</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" id="work-end-date-1" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="leave-reason-1">سبب ترك العمل</label>
                                <textarea id="leave-reason-1" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="سبب ترك العمل"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="experience-certificate-1">شهادة خبرة</label>
                                <select id="experience-certificate-1" class="form-input compact-input">
                                    <option value="">اختر</option>
                                    <option value="نعم">نعم</option>
                                    <option value="لا">لا</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="social-security-1">تأمينات اجتماعية</label>
                                <select id="social-security-1" class="form-input compact-input">
                                    <option value="">اختر</option>
                                    <option value="نعم">نعم</option>
                                    <option value="لا">لا</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-btn" id="add-experience-btn">
                    <i class="fas fa-plus-circle"></i> إضافة خبرة عمل جديدة
                </button>
                <div class="counter" id="experience-counter">عدد الخبرات المضافة: 1 من أصل 5</div>
            </section>
            
            <!-- Section 6: Current Job Data -->
            <section class="form-section" id="section-6">
                <div class="section-header">
                    <div class="section-number">6</div>
                    <h2 class="section-title">البطاقة الوظيفية بالمعمل</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="job-title" class="required">المسمى الوظيفي</label>
                        <textarea id="job-title" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="المسمى الوظيفي في المعمل"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="job-role" class="required">الدور الوظيفي</label>
                        <textarea id="job-role" rows="2" class="form-input stretchable compact-input auto-expand" placeholder="الدور والمسؤوليات الوظيفية"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="department" class="required">القسم</label>
                        <textarea id="department" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="القسم التابع له"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="company-site" class="required">موقع الشركة</label>
                        <select id="company-site" class="form-input compact-input">
                            <option value="">اختر موقع الشركة</option>
                            <option value="المقر الرئيسي">المقر الرئيسي</option>
                            <option value="فرع الرياض">فرع الرياض</option>
                            <option value="فرع جدة">فرع جدة</option>
                            <option value="فرع الدمام">فرع الدمام</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="start-date" class="required">تاريخ بدء العمل</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="start-date" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                            <i class="fas fa-calendar-alt date-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="contract-type" class="required">نوع التعاقد</label>
                        <select id="contract-type" class="form-input compact-input">
                            <option value="">اختر نوع التعاقد</option>
                            <option value="دائم">دائم</option>
                            <option value="مؤقت">مؤقت</option>
                            <option value="تدريب">تدريب</option>
                            <option value="عمل حر">عمل حر</option>
                            <option value="عقد محدد المدة">عقد محدد المدة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contract-end-date">تاريخ انتهاء العقد</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="contract-end-date" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                            <i class="fas fa-calendar-alt date-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="manager" class="required">المدير المباشر</label>
                        <textarea id="manager" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="اسم المدير المباشر"></textarea>
                    </div>
                </div>
            </section>
            
            <!-- SECTION 7: Impartiality Section -->
            <section class="form-section" id="section-7">
                <div class="section-header">
                    <div class="section-number">7</div>
                    <h2 class="section-title">سياسة الحيادية والإقرار</h2>
                </div>
                
                <div class="impartiality-policy-container">
                    <div class="policy-header">
                        <h3><i class="fas fa-balance-scale"></i> سياسة الحيادية لشركة المعايرة</h3>
                        <p class="policy-subtitle">الرجاء قراءة السياسة بعناية والموافقة عليها قبل المتابعة</p>
                    </div>
                    
                    <div class="policy-display-area">
                        <div class="pdf-container" id="pdfContainer">
                            <iframe class="policy-iframe" id="policyIframe" 
                                src="https://drive.google.com/file/d/1V6xmzUAEtzsW2NaFU-WEv2pL9C1xmvQ7/preview?view=fitH&embedded=true" 
                                allow="autoplay" 
                                title="سياسة الحيادية"
                                frameborder="0">
                            </iframe>
                        </div>
                    </div>
                    
                    <div class="pdf-controls">
                        <button type="button" class="pdf-control-btn" onclick="adjustPdfZoom(0.1, 'impartiality')">
                            <i class="fas fa-search-plus"></i> تكبير
                        </button>
                        <button type="button" class="pdf-control-btn zoom-out" onclick="adjustPdfZoom(-0.1, 'impartiality')">
                            <i class="fas fa-search-minus"></i> تصغير
                        </button>
                        <button type="button" class="pdf-control-btn zoom-reset" onclick="resetPdfZoom('impartiality')">
                            <i class="fas fa-expand-arrows-alt"></i> إعادة الضبط
                        </button>
                        <div class="pdf-zoom-info">
                            مستوى التكبير: <span id="impartialityZoomLevel">100%</span>
                        </div>
                    </div>
                    
                    <div class="policy-notice">
                        <i class="fas fa-info-circle"></i>
                        <strong>ملاحظة هامة:</strong> سياسة الحيادية هي جزء أساسي من متطلبات العمل في شركة المعايرة. يجب على جميع الموظفين قراءة السياسة والموافقة عليها لضمان النزاهة والاستقلالية في عمليات المعايرة.
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="impartiality-agreement" class="required" onchange="updateImpartialityStatus()">
                        <label for="impartiality-agreement" class="checkbox-label required">
                            أوافق على أنني قرأت سياسة الحيادية بالكامل وأتفهم جميع بنودها وألتزم بالعمل وفقاً لمتطلباتها.
                        </label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="impartiality-understanding" class="required" onchange="updateImpartialityStatus()">
                        <label for="impartiality-understanding" class="checkbox-label required">
                            أقر بأن عدم الالتزام بسياسة الحيادية قد يؤدي إلى إجراءات تأديبية بما في ذلك إنهاء الخدمة.
                        </label>
                    </div>
                    <p class="checkbox-note">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>إلزامي:</strong> يجب الموافقة على جميع البنود أعلاه للمتابعة في عملية التوظيف.
                    </p>
                </div>
                
                <div class="impartiality-summary">
                    <h4>حالة متطلبات الحيادية</h4>
                    <div class="impartiality-status">
                        <div class="status-icon incomplete" id="impartiality-policy-status-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="status-text" id="impartiality-policy-status-text">لم تتم قراءة السياسة</div>
                    </div>
                    <div class="impartiality-status">
                        <div class="status-icon incomplete" id="impartiality-agreement-status-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="status-text" id="impartiality-agreement-status-text">لم تتم الموافقة على السياسة</div>
                    </div>
                </div>
            </section>
            
            <!-- SECTION 8: Confidentiality Section -->
            <section class="form-section" id="section-8">
                <div class="section-header">
                    <div class="section-number">8</div>
                    <h2 class="section-title">سياسة السرية والإقرار</h2>
                </div>
                
                <div class="confidentiality-policy-container">
                    <div class="policy-header">
                        <h3><i class="fas fa-user-secret"></i> سياسة السرية لشركة المعايرة</h3>
                        <p class="policy-subtitle">الرجاء قراءة سياسة السرية بعناية والموافقة عليها قبل المتابعة</p>
                    </div>
                    
                    <div class="policy-display-area">
                        <div class="pdf-container" id="confidentialityPdfContainer">
                            <iframe class="policy-iframe" id="confidentialityPolicyIframe" 
                                src="https://drive.google.com/file/d/1T9SIswJuboNpBt2TCsfI1jTuxzpEPMNw/preview?view=fitH&embedded=true" 
                                allow="autoplay" 
                                title="سياسة السرية"
                                frameborder="0">
                            </iframe>
                        </div>
                    </div>
                    
                    <div class="pdf-controls">
                        <button type="button" class="pdf-control-btn" onclick="adjustPdfZoom(0.1, 'confidentiality')">
                            <i class="fas fa-search-plus"></i> تكبير
                        </button>
                        <button type="button" class="pdf-control-btn zoom-out" onclick="adjustPdfZoom(-0.1, 'confidentiality')">
                            <i class="fas fa-search-minus"></i> تصغير
                        </button>
                        <button type="button" class="pdf-control-btn zoom-reset" onclick="resetPdfZoom('confidentiality')">
                            <i class="fas fa-expand-arrows-alt"></i> إعادة الضبط
                        </button>
                        <div class="pdf-zoom-info">
                            مستوى التكبير: <span id="confidentialityZoomLevel">100%</span>
                        </div>
                    </div>
                    
                    <div class="policy-notice">
                        <i class="fas fa-info-circle"></i>
                        <strong>ملاحظة هامة:</strong> سياسة السرية هي جزء أساسي من متطلبات العمل في شركة المعايرة. يجب على جميع الموظفين قراءة السياسة والموافقة عليها لضمان حماية المعلومات والبيانات السرية للشركة والعملاء.
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="confidentiality-agreement" class="required" onchange="updateConfidentialityStatus()">
                        <label for="confidentiality-agreement" class="checkbox-label required">
                            أوافق على أنني قرأت سياسة السرية بالكامل وأتفهم جميع بنودها وألتزم بالعمل وفقاً لمتطلباتها.
                        </label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="confidentiality-understanding" class="required" onchange="updateConfidentialityStatus()">
                        <label for="confidentiality-understanding" class="checkbox-label required">
                            أقر بأن عدم الالتزام بسياسة السرية قد يؤدي إلى إجراءات تأديبية بما في ذلك إنهاء الخدمة وملاحقة قانونية.
                        </label>
                    </div>
                    <p class="checkbox-note">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>إلزامي:</strong> يجب الموافقة على جميع البنود أعلاه للمتابعة في عملية التوظيف.
                    </p>
                </div>
                
                <div class="confidentiality-summary">
                    <h4>حالة متطلبات السرية</h4>
                    <div class="impartiality-status">
                        <div class="status-icon incomplete" id="confidentiality-policy-status-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="status-text" id="confidentiality-policy-status-text">لم تتم قراءة السياسة</div>
                    </div>
                    <div class="impartiality-status">
                        <div class="status-icon incomplete" id="confidentiality-agreement-status-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="status-text" id="confidentiality-agreement-status-text">لم تتم الموافقة على السياسة</div>
                    </div>
                </div>
            </section>
            
            <!-- SECTION 9: Quality Policy Section -->
            <section class="form-section" id="section-9">
                <div class="section-header">
                    <div class="section-number">9</div>
                    <h2 class="section-title">سياسة الجودة والإقرار</h2>
                </div>
                
                <div class="quality-policy-container">
                    <div class="policy-header">
                        <h3><i class="fas fa-award"></i> سياسة الجودة لشركة المعايرة</h3>
                        <p class="policy-subtitle">الرجاء قراءة سياسة الجودة بعناية والموافقة عليها قبل المتابعة</p>
                    </div>
                    
                    <div class="policy-display-area">
                        <div class="pdf-container" id="qualityPdfContainer">
                            <iframe class="policy-iframe" id="qualityPolicyIframe" 
                                src="https://drive.google.com/file/d/1VkvjxlpWGCOJRt8wM4zbzB3XGqL85wME/preview?view=fitH&embedded=true" 
                                allow="autoplay" 
                                title="سياسة الجودة"
                                frameborder="0">
                            </iframe>
                        </div>
                    </div>
                    
                    <div class="pdf-controls">
                        <button type="button" class="pdf-control-btn" onclick="adjustPdfZoom(0.1, 'quality')">
                            <i class="fas fa-search-plus"></i> تكبير
                        </button>
                        <button type="button" class="pdf-control-btn zoom-out" onclick="adjustPdfZoom(-0.1, 'quality')">
                            <i class="fas fa-search-minus"></i> تصغير
                        </button>
                        <button type="button" class="pdf-control-btn zoom-reset" onclick="resetPdfZoom('quality')">
                            <i class="fas fa-expand-arrows-alt"></i> إعادة الضبط
                        </button>
                        <div class="pdf-zoom-info">
                            مستوى التكبير: <span id="qualityZoomLevel">100%</span>
                        </div>
                    </div>
                    
                    <div class="policy-notice">
                        <i class="fas fa-info-circle"></i>
                        <strong>ملاحظة هامة:</strong> سياسة الجودة هي جزء أساسي من متطلبات العمل في شركة المعايرة. يجب على جميع الموظفين قراءة السياسة والموافقة عليها لضمان التزام الشركة بأعلى معايير الجودة في جميع عمليات المعايرة والخدمات المقدمة.
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="quality-agreement" class="required" onchange="updateQualityStatus()">
                        <label for="quality-agreement" class="checkbox-label required">
                            أوافق على أنني قرأت سياسة الجودة بالكامل وأتفهم جميع بنودها وألتزم بالعمل وفقاً لمتطلباتها.
                        </label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="quality-understanding" class="required" onchange="updateQualityStatus()">
                        <label for="quality-understanding" class="checkbox-label required">
                            أقر بأن عدم الالتزام بسياسة الجودة قد يؤدي إلى إجراءات تأديبية بما في ذلك إنهاء الخدمة.
                        </label>
                    </div>
                    <p class="checkbox-note">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>إلزامي:</strong> يجب الموافقة على جميع البنود أعلاه للمتابعة في عملية التوظيف.
                    </p>
                </div>
                
                <div class="quality-summary">
                    <h4>حالة متطلبات الجودة</h4>
                    <div class="impartiality-status">
                        <div class="status-icon incomplete" id="quality-policy-status-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="status-text" id="quality-policy-status-text">لم تتم قراءة السياسة</div>
                    </div>
                    <div class="impartiality-status">
                        <div class="status-icon incomplete" id="quality-agreement-status-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="status-text" id="quality-agreement-status-text">لم تتم الموافقة على السياسة</div>
                    </div>
                </div>
            </section>
            
            <!-- Section 10: Summary and PDF Download -->
            <section class="form-section" id="section-10">
                <div class="section-header">
                    <div class="section-number">10</div>
                    <h2 class="section-title">ملخص البيانات وتحميل PDF</h2>
                </div>
                
                <div id="summary-container">
                    <!-- Summary will be generated here dynamically -->
                </div>
                
                <button type="button" class="download-pdf-btn" id="downloadPdfBtn">
                    <i class="fas fa-download"></i> تحميل ملف PDF
                </button>
            </section>
        </div>
        
        <!-- Navigation Controls -->
        <div class="nav-controls">
            <div class="progress-indicator">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="section-counter" id="sectionCounter">القسم 1 من 10</div>
            </div>
            
            <div class="nav-buttons">
                <button type="button" class="nav-btn nav-btn-prev" id="prevBtn">
                    <i class="fas fa-arrow-right"></i> السابق
                </button>
                
                <button type="button" class="nav-btn nav-btn-save" id="saveBtn">
                    <i class="fas fa-save"></i> حفظ البيانات
                </button>
                
                <button type="button" class="nav-btn nav-btn-submit" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> حفظ وإرسال النموذج
                </button>
                
                <button type="button" class="nav-btn nav-btn-next" id="nextBtn">
                    التالي <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>

    <script>
        // ================ إعدادات الربط مع الويب آب (ثابتة) ================
        const UPLOAD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyeasGElv4TAkFoi8AqCtmMcVFzxwNylbUKKEjxYIDAUJGTFh2Ju9GqIn9ZY3HFNg/exec";  // رابط رفع الملفات
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzC1xYFqoSs9BQgKUbbIRac0it4xJRBArEjo6KgoNl57q6ZTeW6CNR_q0P63Zc2Aex4/exec"; // رابط إدارة السجلات

        // ================ CONFIGURATION ================
        const ALLOWED_TYPES = ['image/png', 'image/jpeg', 'application/pdf'];
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

        // ================ GLOBAL VARIABLES ================
        let currentSection = 1;
        const totalSections = 10;
        let experienceCount = 1;
        const maxExperiences = 5;
        let savedSections = new Set();
        let flatpickrInstances = {};
        
        // PDF Zoom control variables
        let impartialityPdfZoomLevel = 1.0;
        let confidentialityPdfZoomLevel = 1.0;
        let qualityPdfZoomLevel = 1.0;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 2.0;
        const ZOOM_STEP = 0.1;
        
        // File upload tracking - stores selected File objects and uploaded URLs
        let selectedFiles = {};
        let uploadedFileUrls = {};
        let uploadedFileTypes = {}; // تخزين نوع MIME للملفات المرفوعة
        
        // Agreement tracking for all policies
        let impartialityAgreed = false;
        let confidentialityAgreed = false;
        let qualityAgreed = false;
        
        // ================ متغيرات السجل الحالي ================
        let currentRowNumber = null;          // رقم الصف في الشيت
        let currentRecordId = '';            // المعرف الفريد إن وُجد
        let currentElectronicNumber = '';    // الرقم الإلكتروني للموظف الحالي
        let currentUserEmail = '';            // بريد المستخدم الحالي

        // ================ تعيين البادئات لكل ملف ================
        const FILE_PREFIX = {
            'national-id-front-file': 'IDF',
            'national-id-back-file': 'IDB',
            'birth-certificate-file': 'BC',
            'criminal-record-file': 'CR',
            'military-certificate-file': 'MC',
            'personal-photos-file': 'PP',
            'graduation-certificate-file': 'GC',
            'equivalency-file': 'EQ'
        };
        // أسماء الحقول في جدول البيانات (المستخدمة في updateRecord)
        const FILE_FIELD_MAP = {
            'national-id-front-file': 'nationalIdFrontFile',
            'national-id-back-file': 'nationalIdBackFile',
            'birth-certificate-file': 'birthCertificateFile',
            'criminal-record-file': 'criminalRecordFile',
            'military-certificate-file': 'militaryCertificateFile',
            'personal-photos-file': 'personalPhotosFile',
            'graduation-certificate-file': 'graduationCertificateFile',
            'equivalency-file': 'equivalencyFile'
        };

        // أسماء ودية للملفات للعرض
        const FRIENDLY_FILE_NAMES = {
            'national-id-front-file': 'البطاقة الشخصية (أمامي)',
            'national-id-back-file': 'البطاقة الشخصية (خلفي)',
            'birth-certificate-file': 'شهادة الميلاد',
            'criminal-record-file': 'صحيفة الحالة الجنائية',
            'military-certificate-file': 'شهادة التجنيد',
            'personal-photos-file': 'الصور الشخصية',
            'graduation-certificate-file': 'شهادة التخرج',
            'equivalency-file': 'معادلة الشهادة'
        };

        // ================ دوال التاريخ الجديدة (D, M, Y) من الكود الثاني ================
        function formatDateToDMY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `D${day} M${month} Y${year}`;
        }

        function parseDateFromDMY(dmyString) {
            if (!dmyString) return null;
            dmyString = dmyString.toString().trim();
            const match = dmyString.match(/^D(\d+)\s+M(\d+)\s+Y(\d+)$/);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10) - 1; // JavaScript months are 0-indexed
                const year = parseInt(match[3], 10);
                if (day < 1 || day > 31) return null;
                if (month < 0 || month > 11) return null;
                if (year < 1900 || year > 2100) return null;
                const dateObj = new Date(year, month, day);
                if (dateObj.getDate() !== day || dateObj.getMonth() !== month || dateObj.getFullYear() !== year) {
                    return null;
                }
                return dateObj;
            }
            return null;
        }

        function formatDMYForDisplay(dmyString) {
            if (!dmyString) return '';
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    if (!isNaN(regularDate.getTime())) {
                        return `<span class="english-date">${formatDateToDayMonthYear(regularDate)}</span>`;
                    }
                } catch (e) {}
                return `<span class="english-date">${dmyString}</span>`;
            }
            const formattedDate = formatDateToDayMonthYear(dateObj);
            return `<span class="english-date">${formattedDate}</span>`;
        }

        function formatDateToDayMonthYear(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate();
            const monthIndex = date.getMonth();
            const year = date.getFullYear();
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            return `${day} ${monthNames[monthIndex]} ${year}`;
        }

        function formatDMYForInput(dmyString) {
            if (!dmyString) return '';
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    if (!isNaN(regularDate.getTime())) {
                        return formatDateToDDMMYYYY(regularDate);
                    }
                } catch (e) {}
                return '';
            }
            return formatDateToDDMMYYYY(dateObj);
        }

        function validateDMYDate(dmyString) {
            if (!dmyString) return true;
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    return !isNaN(regularDate.getTime());
                } catch (e) {
                    return false;
                }
            }
            return true;
        }

        // ================ دوال التاريخ الموحدة (مأخوذة من النظام الثاني) ================
        function formatDateToDDMMYYYY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    if (day < 1 || day > 31) return null;
                    if (month < 0 || month > 11) return null;
                    if (year < 1900 || year > 2100) return null;
                    return new Date(year, month, day);
                }
            }
            return null;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const dateObj = parseDateDDMMYYYY(dateString);
            if (dateObj) return `<span class="english-date">${formatDateToDDMMYYYY(dateObj)}</span>`;
            return `<span class="english-date">${dateString}</span>`;
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const dateObj = parseDateDDMMYYYY(dateString);
            return dateObj ? formatDateToDDMMYYYY(dateObj) : dateString;
        }

        // دالة للحصول على الوقت الحالي بصيغة DMYHMS (مطابقة لتنسيق Apps Script)
        function getCurrentDateTimeDMYHMS() {
            const now = new Date();
            // نستخدم توقيت القاهرة (UTC+2)
            const options = { timeZone: 'Africa/Cairo', hour12: false };
            const cairoStr = now.toLocaleString('en-US', options);
            const cairoDate = new Date(cairoStr);
            const day = cairoDate.getDate();
            const month = cairoDate.getMonth() + 1;
            const year = cairoDate.getFullYear();
            const hour = cairoDate.getHours();
            const minute = cairoDate.getMinutes();
            const second = cairoDate.getSeconds();
            return `D${day} M${month} Y${year} H${hour} Min${minute} Sec${second}`;
        }

        // ================ استدعاء getOne وتحميل السجل باستخدام المعرف الفريد من sessionStorage ================
        function loadEmployeeRecord(uniqueId) {
            if (!uniqueId) {
                showToast('⚠️ لا يوجد معرف فريد للمستخدم. يرجى تسجيل الدخول أولاً.', 'error');
                return;
            }
            
            const url = `${SCRIPT_URL}?action=getOne&recordId=${encodeURIComponent(uniqueId)}&callback=handleGetOneCallback`;
            showToast('جاري تحميل بيانات الموظف...', 'info');
            jsonp(url);
        }

        window.handleGetOneCallback = function(response) {
            console.log('getOne response:', response);
            if (response.status === 'success' && response.record) {
                currentRowNumber = response.row;
                const record = response.record;
                currentRecordId = record[0] || '';
                currentElectronicNumber = record[16] || ''; // الرقم الإلكتروني (col 17)
                currentUserEmail = record[2] || ''; // البريد الإلكتروني (col 3)
                populateFormFromRecord(record);
                showToast(`✅ تم تحميل السجل`, 'success');
            } else {
                showToast('❌ لم يتم العثور على سجل بهذا المعرف', 'error');
            }
        };

        function populateFormFromRecord(record) {
            if (!record || record.length < 96) return;

            setValue('full-name', record[44]);
            setValue('english-name', record[47]);
            setValue('national-id', record[50]);
            
            setValue('birth-date', formatDMYForInput(record[51])); 
            
            setValue('birth-place', record[52]);
            setValue('nationality', record[53]);
            if (record[53] === 'آخر') document.getElementById('other-nationality-container').style.display = 'block';
            setValue('religion', record[54]);
            if (record[54] === 'آخر') document.getElementById('other-religion-container').style.display = 'block';
            setValue('marital-status', record[55]);
            setValue('children-count', record[56]);
            setValue('military-status', record[57]);

            setValue('address', record[58]);
            setValue('phone', record[59]);
            setValue('alt-phone', record[60]);
            setValue('email', record[61]);
            setValue('emergency-name', record[62]);
            setValue('emergency-phone', record[63]);
            setValue('emergency-relation', record[64]);

            loadFileUrlIntoPreview('national-id-front-file', record[65]);
            loadFileUrlIntoPreview('national-id-back-file', record[66]);
            loadFileUrlIntoPreview('birth-certificate-file', record[67]);
            loadFileUrlIntoPreview('criminal-record-file', record[68]);
            loadFileUrlIntoPreview('military-certificate-file', record[69]);
            loadFileUrlIntoPreview('personal-photos-file', record[70]);
            loadFileUrlIntoPreview('graduation-certificate-file', record[76]);
            loadFileUrlIntoPreview('equivalency-file', record[77]);

            setValue('qualification', record[71]);
            setValue('university', record[72]);
            setValue('specialization', record[73]);
            setValue('graduation-year', record[74]);
            setValue('grade', record[75]);

            try {
                const expJson = record[78] || '[]';
                const experiences = JSON.parse(expJson);
                while (experienceCount > 1) removeExperience(experienceCount);
                if (experiences.length > 0) {
                    setValue('company-1', experiences[0].company || '');
                    setValue('job-title-1', experiences[0].jobTitle || '');
                    setValue('job-tasks-1', experiences[0].jobTasks || '');
                    setValue('work-start-date-1', formatDMYForInput(experiences[0].startDate));
                    setValue('work-end-date-1', formatDMYForInput(experiences[0].endDate));
                    setValue('leave-reason-1', experiences[0].leaveReason || '');
                    setValue('experience-certificate-1', experiences[0].hasCertificate || '');
                    setValue('social-security-1', experiences[0].hasSocialSecurity || '');
                }
                for (let i = 1; i < experiences.length; i++) {
                    addExperience();
                    const idx = i + 1;
                    setValue(`company-${idx}`, experiences[i].company || '');
                    setValue(`job-title-${idx}`, experiences[i].jobTitle || '');
                    setValue(`job-tasks-${idx}`, experiences[i].jobTasks || '');
                    setValue(`work-start-date-${idx}`, formatDMYForInput(experiences[i].startDate));
                    setValue(`work-end-date-${idx}`, formatDMYForInput(experiences[i].endDate));
                    setValue(`leave-reason-${idx}`, experiences[i].leaveReason || '');
                    setValue(`experience-certificate-${idx}`, experiences[i].hasCertificate || '');
                    setValue(`social-security-${idx}`, experiences[i].hasSocialSecurity || '');
                }
            } catch(e) { console.warn('فشل تحليل الخبرات', e); }

            setValue('job-title', record[79]);
            setValue('job-role', record[80]);
            setValue('department', record[81]);
            setValue('company-site', record[82]);
            setValue('start-date', formatDMYForInput(record[83]));
            setValue('contract-type', record[84]);
            setValue('contract-end-date', formatDMYForInput(record[85]));
            setValue('manager', record[86]);

            document.getElementById('impartiality-agreement').checked = (record[87] === 'نعم');
            document.getElementById('impartiality-understanding').checked = (record[88] === 'نعم');
            document.getElementById('confidentiality-agreement').checked = (record[89] === 'نعم');
            document.getElementById('confidentiality-understanding').checked = (record[90] === 'نعم');
            document.getElementById('quality-agreement').checked = (record[91] === 'نعم');
            document.getElementById('quality-understanding').checked = (record[92] === 'نعم');
            updateImpartialityStatus(); updateConfidentialityStatus(); updateQualityStatus();

            setFlatpickrDateFromString('birthDate', document.getElementById('birth-date').value);
            setFlatpickrDateFromString('startDate', document.getElementById('start-date').value);
            setFlatpickrDateFromString('contractEndDate', document.getElementById('contract-end-date').value);
            for (let i = 1; i <= experienceCount; i++) {
                setFlatpickrDateFromString(`work-start-date-${i}`, document.getElementById(`work-start-date-${i}`).value);
                setFlatpickrDateFromString(`work-end-date-${i}`, document.getElementById(`work-end-date-${i}`).value);
            }

            document.querySelectorAll('.auto-expand').forEach(el => {
                const ev = new Event('input');
                el.dispatchEvent(ev);
            });
        }

        function setValue(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val || '';
        }

        function loadFileUrlIntoPreview(inputId, url) {
            if (!url || typeof url !== 'string' || !url.startsWith('http')) return;
            uploadedFileUrls[inputId] = url;
            const previewId = inputId.replace('-file', '-preview');
            const nameSpan = document.getElementById(inputId.replace('-file', '-name'));
            const linkAnchor = document.getElementById(inputId.replace('-file', '-link'));
            if (nameSpan) nameSpan.textContent = FRIENDLY_FILE_NAMES[inputId] || 'ملف مرفوع';
            const sizeSpan = document.getElementById(inputId.replace('-file', '-size'));
            if (sizeSpan) sizeSpan.style.display = 'none';
            if (linkAnchor) { 
                linkAnchor.href = url; 
                linkAnchor.style.display = 'inline-block'; 
                linkAnchor.textContent = 'عرض الملف';
            }
            const previewContainer = document.getElementById(previewId);
            if (previewContainer) previewContainer.style.display = 'block';
        }

        async function uploadFile(inputId) {
            const file = selectedFiles[inputId];
            if (!file) { showToast('⚠️ يرجى اختيار ملف أولاً', 'warning'); return; }
            if (!currentElectronicNumber) { showToast('❌ الرقم الإلكتروني غير موجود. حمّل السجل أولاً.', 'error'); return; }
            if (!currentRowNumber) { showToast('❌ لا يوجد سجل نشط. حمّل بيانات الموظف أولاً.', 'error'); return; }

            const originalName = file.name;
            const extension = originalName.substring(originalName.lastIndexOf('.'));
            const prefix = FILE_PREFIX[inputId] || 'FILE';
            const customFileName = `${prefix}/${currentElectronicNumber}${extension}`;

            const uploadBtn = document.getElementById(`upload-${inputId.replace('-file', '-btn')}`);
            const statusDiv = document.getElementById(inputId.replace('-file', '-status'));

            uploadBtn.disabled = true; 
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
            if (statusDiv) { 
                statusDiv.textContent = 'جاري رفع الملف... ⏳'; 
                statusDiv.className = 'upload-status loading'; 
            }

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(',')[1];
                    const response = await fetch(UPLOAD_WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            fileName: customFileName,
                            mimeType: file.type,
                            fileData: base64
                        })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        const newUrl = data.url;
                        const fileId = data.fileId;

                        uploadedFileTypes[inputId] = file.type;

                        const oldUrl = uploadedFileUrls[inputId];
                        if (oldUrl) {
                            const oldFileId = extractFileIdFromUrl(oldUrl);
                            if (oldFileId) {
                                try {
                                    await fetch(UPLOAD_WEB_APP_URL, {
                                        method: 'POST',
                                        body: JSON.stringify({ action: 'delete', fileId: oldFileId })
                                    });
                                    console.log('🗑️ تم حذف الملف القديم:', oldFileId);
                                } catch (delErr) { console.warn('فشل حذف الملف القديم', delErr); }
                            }
                        }

                        uploadedFileUrls[inputId] = newUrl;
                        const nameSpan = document.getElementById(inputId.replace('-file', '-name'));
                        if (nameSpan) nameSpan.textContent = FRIENDLY_FILE_NAMES[inputId] || 'ملف مرفوع';
                        const linkAnchor = document.getElementById(inputId.replace('-file', '-link'));
                        if (linkAnchor) { 
                            linkAnchor.href = newUrl; 
                            linkAnchor.style.display = 'inline-block'; 
                            linkAnchor.textContent = 'عرض الملف';
                        }
                        const sizeSpan = document.getElementById(inputId.replace('-file', '-size'));
                        if (sizeSpan) sizeSpan.style.display = 'none';
                        document.getElementById(inputId.replace('-file', '-preview')).style.display = 'block';
                        if (statusDiv) { 
                            statusDiv.textContent = '✅ تم رفع الملف'; 
                            statusDiv.className = 'upload-status success'; 
                        }

                        const fieldName = FILE_FIELD_MAP[inputId];
                        if (fieldName && currentRowNumber) {
                            const updateParams = new URLSearchParams();
                            updateParams.append('action', 'update');
                            updateParams.append('row', currentRowNumber);
                            updateParams.append(fieldName, newUrl);
                            const updateUrl = `${SCRIPT_URL}?${updateParams.toString()}&callback=handleUpdateCallback`;
                            jsonp(updateUrl);
                        }

                        showToast(`✅ تم رفع واستبدال الملف: ${customFileName}`, 'success');
                        
                        if (currentSection === 10) generateSummary();
                    } else {
                        if (statusDiv) { 
                            statusDiv.textContent = '❌ فشل الرفع'; 
                            statusDiv.className = 'upload-status error'; 
                        }
                        showToast('❌ فشل رفع الملف', 'error');
                    }
                    uploadBtn.disabled = false; 
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> رفع الملف';
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error(error);
                if (statusDiv) { 
                    statusDiv.textContent = '❌ خطأ'; 
                    statusDiv.className = 'upload-status error'; 
                }
                uploadBtn.disabled = false; 
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> رفع الملف';
                showToast('❌ فشل في رفع الملف', 'error');
            }
        }

        function extractFileIdFromUrl(url) {
            if (!url) return null;
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        window.handleUpdateCallback = function(res) {
            if (res.status === 'success') console.log('✅ تم تحديث الخلية في الشيت');
            else console.warn('⚠️ فشل تحديث الشيت', res);
        };

        function removeFile(inputId, previewId) {
            if (!confirm('⚠️ هل أنت متأكد من حذف هذا الملف من Drive؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            const fileInput = document.getElementById(inputId);
            if (fileInput) fileInput.value = '';
            delete selectedFiles[inputId];
            delete uploadedFileTypes[inputId];
            const oldUrl = uploadedFileUrls[inputId];
            if (oldUrl) {
                const fileId = extractFileIdFromUrl(oldUrl);
                if (fileId) {
                    fetch(UPLOAD_WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'delete', fileId: fileId })
                    }).catch(e => console.warn);
                }
                delete uploadedFileUrls[inputId];
                if (currentRowNumber) {
                    const fieldName = FILE_FIELD_MAP[inputId];
                    if (fieldName) {
                        const params = new URLSearchParams();
                        params.append('action', 'update');
                        params.append('row', currentRowNumber);
                        params.append(fieldName, '');
                        jsonp(`${SCRIPT_URL}?${params.toString()}&callback=handleUpdateCallback`);
                    }
                }
            }
            const previewContainer = document.getElementById(previewId);
            if (previewContainer) previewContainer.style.display = 'none';
            const statusDiv = document.getElementById(inputId.replace('-file', '-status'));
            if (statusDiv) { 
                statusDiv.textContent = ''; 
                statusDiv.className = 'upload-status'; 
            }
            showToast('🗑️ تم حذف الملف', 'info');
            
            if (currentSection === 10) generateSummary();
        }

        function jsonp(url) {
            const old = document.getElementById("jsonp");
            if(old) old.remove();
            const s = document.createElement("script");
            s.id = "jsonp";
            s.src = url;
            document.body.appendChild(s);
        }
        
        function initFileInputListeners() {
            const fileInputs = [
                'national-id-front-file',
                'national-id-back-file',
                'birth-certificate-file',
                'criminal-record-file',
                'military-certificate-file',
                'personal-photos-file',
                'graduation-certificate-file',
                'equivalency-file'
            ];
            
            fileInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', function(e) {
                        handleFileSelect(id, e.target.files[0]);
                    });
                    
                    const container = input.closest('.upload-container');
                    if (container) {
                        container.addEventListener('dragover', function(e) {
                            e.preventDefault();
                            this.classList.add('dragover');
                        });
                        
                        container.addEventListener('dragleave', function(e) {
                            e.preventDefault();
                            this.classList.remove('dragover');
                        });
                        
                        container.addEventListener('drop', function(e) {
                            e.preventDefault();
                            this.classList.remove('dragover');
                            if (e.dataTransfer.files.length > 0) {
                                handleFileSelect(id, e.dataTransfer.files[0]);
                            }
                        });
                    }
                }
            });
        }

        function handleFileSelect(inputId, file) {
            if (!file) return;
            
            if (!ALLOWED_TYPES.includes(file.type)) {
                showToast(`❌ فقط ملفات PNG, JPG, JPEG أو PDF مسموحة`, 'error');
                document.getElementById(inputId).value = '';
                return;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                showToast(`❌ حجم الملف كبير جداً (الحد الأقصى 10MB)`, 'error');
                document.getElementById(inputId).value = '';
                return;
            }
            
            selectedFiles[inputId] = file;
            
            const previewId = inputId.replace('-file', '-preview');
            const nameSpan = document.getElementById(inputId.replace('-file', '-name'));
            const sizeSpan = document.getElementById(inputId.replace('-file', '-size'));
            const linkAnchor = document.getElementById(inputId.replace('-file', '-link'));
            
            if (nameSpan) nameSpan.textContent = FRIENDLY_FILE_NAMES[inputId] || 'ملف مرفوع';
            if (sizeSpan) {
                sizeSpan.textContent = formatFileSize(file.size);
                sizeSpan.style.display = 'inline-block';
            }
            
            if (linkAnchor) linkAnchor.style.display = 'none';
            
            const previewContainer = document.getElementById(previewId);
            if (previewContainer) previewContainer.style.display = 'block';
            
            const statusDiv = document.getElementById(inputId.replace('-file', '-status'));
            if (statusDiv) {
                statusDiv.textContent = '';
                statusDiv.className = 'upload-status';
            }
            
            showToast(`✅ تم اختيار الملف: ${file.name}`, 'success', 3000);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' بايت';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' كيلوبايت';
            else return (bytes / 1048576).toFixed(1) + ' ميجابايت';
        }

        function initializeDatePickers() {
            if (flatpickrInstances.birthDate) flatpickrInstances.birthDate.destroy();
            if (flatpickrInstances.startDate) flatpickrInstances.startDate.destroy();
            if (flatpickrInstances.contractEndDate) flatpickrInstances.contractEndDate.destroy();
            
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: true,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                onReady: function(selectedDates, dateStr, instance) {
                    const monthDropdown = instance.monthNav.querySelector('.flatpickr-monthDropdown-months');
                    const yearInput = instance.monthNav.querySelector('.numInputWrapper');
                    
                    if (monthDropdown) {
                        monthDropdown.style.fontSize = '1rem';
                        monthDropdown.style.padding = '5px';
                        monthDropdown.style.minWidth = '100px';
                    }
                    
                    if (yearInput) {
                        yearInput.style.width = '70px';
                        const yearInputField = yearInput.querySelector('.numInput');
                        if (yearInputField) {
                            yearInputField.style.fontSize = '1rem';
                            yearInputField.style.padding = '3px 5px';
                        }
                    }
                }
            };
            
            flatpickrInstances.birthDate = flatpickr('#birth-date', dateOptions);
            flatpickrInstances.startDate = flatpickr('#start-date', dateOptions);
            flatpickrInstances.contractEndDate = flatpickr('#contract-end-date', dateOptions);
            
            initializeExperienceDatePickers(1);
            
            if (flatpickrInstances.birthDate) flatpickrInstances.birthDate.set('locale', 'ar');
            if (flatpickrInstances.startDate) flatpickrInstances.startDate.set('locale', 'ar');
            if (flatpickrInstances.contractEndDate) flatpickrInstances.contractEndDate.set('locale', 'ar');
        }
        
        function initializeExperienceDatePickers(experienceId) {
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: true,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                onReady: function(selectedDates, dateStr, instance) {
                    const monthDropdown = instance.monthNav.querySelector('.flatpickr-monthDropdown-months');
                    const yearInput = instance.monthNav.querySelector('.numInputWrapper');
                    
                    if (monthDropdown) {
                        monthDropdown.style.fontSize = '1rem';
                        monthDropdown.style.padding = '5px';
                        monthDropdown.style.minWidth = '100px';
                    }
                    
                    if (yearInput) {
                        yearInput.style.width = '70px';
                        const yearInputField = yearInput.querySelector('.numInput');
                        if (yearInputField) {
                            yearInputField.style.fontSize = '1rem';
                            yearInputField.style.padding = '3px 5px';
                        }
                    }
                }
            };
            
            flatpickrInstances[`work-start-date-${experienceId}`] = flatpickr(`#work-start-date-${experienceId}`, dateOptions);
            flatpickrInstances[`work-end-date-${experienceId}`] = flatpickr(`#work-end-date-${experienceId}`, dateOptions);
            
            if (flatpickrInstances[`work-start-date-${experienceId}`]) flatpickrInstances[`work-start-date-${experienceId}`].set('locale', 'ar');
            if (flatpickrInstances[`work-end-date-${experienceId}`]) flatpickrInstances[`work-end-date-${experienceId}`].set('locale', 'ar');
        }

        function setFlatpickrDateFromString(instanceId, dateString) {
            if (!flatpickrInstances[instanceId] || !dateString) return;
            const dateObj = parseDateDDMMYYYY(dateString);
            if (dateObj) flatpickrInstances[instanceId].setDate(dateObj, false);
        }
        
        function setDefaultDates() {
            if (!document.getElementById('birth-date').value.trim() && flatpickrInstances.birthDate) {
                const defaultBirthDate = new Date();
                defaultBirthDate.setFullYear(defaultBirthDate.getFullYear() - 25);
                flatpickrInstances.birthDate.setDate(defaultBirthDate, false);
            }
            
            if (!document.getElementById('start-date').value.trim() && flatpickrInstances.startDate) {
                const today = new Date();
                flatpickrInstances.startDate.setDate(today, false);
            }
            
            if (!document.getElementById('contract-end-date').value.trim() && flatpickrInstances.contractEndDate) {
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
                flatpickrInstances.contractEndDate.setDate(oneYearFromNow, false);
            }
            
            if (!document.getElementById('work-start-date-1').value.trim() && flatpickrInstances['work-start-date-1']) {
                const defaultWorkStartDate = new Date();
                defaultWorkStartDate.setFullYear(defaultWorkStartDate.getFullYear() - 2);
                flatpickrInstances['work-start-date-1'].setDate(defaultWorkStartDate, false);
            }
            
            if (!document.getElementById('work-end-date-1').value.trim() && flatpickrInstances['work-end-date-1']) {
                const defaultWorkEndDate = new Date();
                defaultWorkEndDate.setFullYear(defaultWorkEndDate.getFullYear() - 1);
                flatpickrInstances['work-end-date-1'].setDate(defaultWorkEndDate, false);
            }
        }

        function initAutoExpandTextareas() {
            document.querySelectorAll('.auto-expand').forEach(textarea => {
                initAutoExpandTextarea(textarea);
            });
        }
        
        function initAutoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            const computedStyle = window.getComputedStyle(textarea);
            const lineHeight = parseInt(computedStyle.lineHeight);
            const paddingTop = parseInt(computedStyle.paddingTop);
            const paddingBottom = parseInt(computedStyle.paddingBottom);
            
            let minHeight = lineHeight + paddingTop + paddingBottom;
            textarea.style.minHeight = minHeight + 'px';
            
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
            
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            textarea.addEventListener('focus', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            const event = new Event('input');
            textarea.dispatchEvent(event);
        }

        function toggleOtherInput(selectId, containerId) {
            const select = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            const otherInput = container.querySelector('textarea, input');
            
            if (select.value === 'آخر') {
                container.style.display = 'block';
                otherInput.required = true;
            } else {
                container.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        function addExperience() {
            if (experienceCount >= maxExperiences) {
                alert(`لا يمكن إضافة أكثر من ${maxExperiences} خبرات عمل`);
                document.getElementById('add-experience-btn').disabled = true;
                return;
            }
            
            experienceCount++;
            
            const experienceContainer = document.getElementById('experience-container');
            const newExperience = document.createElement('div');
            newExperience.className = 'experience-section';
            newExperience.id = `experience-${experienceCount}`;
            
            newExperience.innerHTML = `
                <div class="experience-header">
                    <div class="experience-title">الخبرة العملية #${experienceCount}</div>
                    <button type="button" class="remove-btn" onclick="removeExperience(${experienceCount})">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="company-${experienceCount}">الشركة السابقة</label>
                        <textarea id="company-${experienceCount}" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="اسم الشركة السابقة"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="job-title-${experienceCount}">المسمى الوظيفي</label>
                        <textarea id="job-title-${experienceCount}" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="المسمى الوظيفي"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="job-tasks-${experienceCount}">المهام الأساسية</label>
                        <textarea id="job-tasks-${experienceCount}" rows="2" class="form-input stretchable compact-input auto-expand" placeholder="المهام الأساسية التي قمت بها"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>مدة العمل</label>
                        <div class="work-period-container">
                            <div class="work-period-item">
                                <label for="work-start-date-${experienceCount}">تاريخ البدء</label>
                                <div class="date-input-wrapper">
                                    <input type="text" id="work-start-date-${experienceCount}" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                                    <i class="fas fa-calendar-alt date-icon"></i>
                                </div>
                            </div>
                            <div class="work-period-item">
                                <label for="work-end-date-${experienceCount}">تاريخ الانتهاء</label>
                                <div class="date-input-wrapper">
                                    <input type="text" id="work-end-date-${experienceCount}" class="form-input compact-input date-picker" placeholder="يوم/شهر/سنة" readonly>
                                    <i class="fas fa-calendar-alt date-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="leave-reason-${experienceCount}">سبب ترك العمل</label>
                        <textarea id="leave-reason-${experienceCount}" rows="1" class="form-input stretchable compact-input auto-expand" placeholder="سبب ترك العمل"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="experience-certificate-${experienceCount}">شهادة خبرة</label>
                        <select id="experience-certificate-${experienceCount}" class="form-input compact-input">
                            <option value="">اختر</option>
                            <option value="نعم">نعم</option>
                            <option value="لا">لا</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="social-security-${experienceCount}">تأمينات اجتماعية</label>
                        <select id="social-security-${experienceCount}" class="form-input compact-input">
                            <option value="">اختر</option>
                            <option value="نعم">نعم</option>
                            <option value="لا">لا</option>
                        </select>
                    </div>
                </div>
            `;
            
            experienceContainer.appendChild(newExperience);
            updateExperienceCounter();
            
            newExperience.querySelectorAll('.auto-expand').forEach(el => initAutoExpandTextarea(el));
            initializeExperienceDatePickers(experienceCount);
        }
        
        function removeExperience(id) {
            if (experienceCount <= 1) {
                alert('يجب أن يكون هناك خبرة عمل واحدة على الأقل');
                return;
            }
            
            const experienceToRemove = document.getElementById(`experience-${id}`);
            if (experienceToRemove) experienceToRemove.remove();
            
            const experiences = document.querySelectorAll('.experience-section');
            experienceCount = 0;
            
            experiences.forEach((exp, index) => {
                experienceCount++;
                exp.id = `experience-${experienceCount}`;
                exp.querySelector('.experience-title').textContent = `الخبرة العملية #${experienceCount}`;
                
                const inputs = exp.querySelectorAll('textarea, select, input');
                inputs.forEach(input => {
                    const oldId = input.id;
                    const newId = oldId.replace(/\d+$/, experienceCount);
                    input.id = newId;
                    
                    const label = exp.querySelector(`label[for="${oldId}"]`);
                    if (label) {
                        label.htmlFor = newId;
                    }
                });
                
                if (flatpickrInstances[`work-start-date-${id}`]) {
                    flatpickrInstances[`work-start-date-${experienceCount}`] = flatpickrInstances[`work-start-date-${id}`];
                    delete flatpickrInstances[`work-start-date-${id}`];
                }
                if (flatpickrInstances[`work-end-date-${id}`]) {
                    flatpickrInstances[`work-end-date-${experienceCount}`] = flatpickrInstances[`work-end-date-${id}`];
                    delete flatpickrInstances[`work-end-date-${id}`];
                }
                
                const removeBtn = exp.querySelector('.remove-btn');
                removeBtn.onclick = () => removeExperience(experienceCount);
            });
            
            updateExperienceCounter();
            
            if (experienceCount === 1) {
                document.querySelector('#experience-1 .remove-btn').style.display = 'none';
            }
            
            if (experienceCount < maxExperiences) {
                document.getElementById('add-experience-btn').disabled = false;
            }
        }
        
        function updateExperienceCounter() {
            document.getElementById('experience-counter').textContent = 
                `عدد الخبرات المضافة: ${experienceCount} من أصل ${maxExperiences}`;
        }

        function goToSection(sectionNumber) {
            if (sectionNumber < 1 || sectionNumber > totalSections) return;
            
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(`section-${sectionNumber}`).classList.add('active');
            
            currentSection = sectionNumber;
            updateNavigation();
            updateProgress();
            updateButtons();
            
            if (sectionNumber === 10) {
                generateSummary();
            }
            
            if (sectionNumber === 7) {
                setTimeout(() => {
                    applyPdfZoom('impartiality');
                    updateZoomDisplay('impartiality');
                }, 100);
            } else if (sectionNumber === 8) {
                setTimeout(() => {
                    applyPdfZoom('confidentiality');
                    updateZoomDisplay('confidentiality');
                }, 100);
            } else if (sectionNumber === 9) {
                setTimeout(() => {
                    applyPdfZoom('quality');
                    updateZoomDisplay('quality');
                }, 100);
            }
        }
        
        function nextSection() {
            if (currentSection < totalSections) {
                if (currentSection === 7 || currentSection === 8 || currentSection === 9) {
                    goToSection(currentSection + 1);
                } else {
                    if (validateCurrentSection()) {
                        goToSection(currentSection + 1);
                    }
                }
            }
        }
        
        function prevSection() {
            if (currentSection > 1) {
                goToSection(currentSection - 1);
            }
        }
        
        function updateNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (parseInt(tab.getAttribute('data-section')) === currentSection) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById('sectionCounter').textContent = `القسم ${currentSection} من ${totalSections}`;
        }
        
        function updateProgress() {
            const progressPercentage = (currentSection / totalSections) * 100;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
        }
        
        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const saveBtn = document.getElementById('saveBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.style.display = currentSection === 1 ? 'none' : 'flex';
            nextBtn.style.display = currentSection === totalSections ? 'none' : 'flex';
            
            if (currentSection === totalSections) {
                saveBtn.style.display = 'none';
                submitBtn.style.display = 'flex';
            } else {
                saveBtn.style.display = 'flex';
                submitBtn.style.display = 'none';
            }
        }

        function initializePdfDisplay(type) {
            const iframeId = type === 'impartiality' ? 'policyIframe' : 
                            type === 'confidentiality' ? 'confidentialityPolicyIframe' : 
                            'qualityPolicyIframe';
            const iframe = document.getElementById(iframeId);
            
            iframe.onload = function() {
                setTimeout(() => {
                    applyPdfZoom(type);
                }, 1000);
            };
        }
        
        function adjustPdfZoom(change, type) {
            const zoomVar = type === 'impartiality' ? 'impartialityPdfZoomLevel' : 
                           type === 'confidentiality' ? 'confidentialityPdfZoomLevel' : 
                           'qualityPdfZoomLevel';
            window[zoomVar] += change;
            
            if (window[zoomVar] < MIN_ZOOM) window[zoomVar] = MIN_ZOOM;
            if (window[zoomVar] > MAX_ZOOM) window[zoomVar] = MAX_ZOOM;
            
            applyPdfZoom(type);
            updateZoomDisplay(type);
            
            localStorage.setItem(`${type}ZoomLevel`, window[zoomVar]);
        }
        
        function resetPdfZoom(type) {
            const zoomVar = type === 'impartiality' ? 'impartialityPdfZoomLevel' : 
                           type === 'confidentiality' ? 'confidentialityPdfZoomLevel' : 
                           'qualityPdfZoomLevel';
            window[zoomVar] = 1.0;
            applyPdfZoom(type);
            updateZoomDisplay(type);
            
            localStorage.setItem(`${type}ZoomLevel`, window[zoomVar]);
        }
        
        function applyPdfZoom(type) {
            const iframeId = type === 'impartiality' ? 'policyIframe' : 
                            type === 'confidentiality' ? 'confidentialityPolicyIframe' : 
                            'qualityPolicyIframe';
            const containerId = type === 'impartiality' ? 'pdfContainer' : 
                               type === 'confidentiality' ? 'confidentialityPdfContainer' : 
                               'qualityPdfContainer';
            const zoomLevel = type === 'impartiality' ? impartialityPdfZoomLevel : 
                             type === 'confidentiality' ? confidentialityPdfZoomLevel : 
                             qualityPdfZoomLevel;
            
            const iframe = document.getElementById(iframeId);
            const container = document.getElementById(containerId);
            
            if (iframe && container) {
                container.style.transform = `scale(${zoomLevel})`;
                container.style.transformOrigin = 'top center';
                container.style.width = `${100 / zoomLevel}%`;
                container.style.height = `${700 / zoomLevel}px`;
                
                iframe.style.width = '100%';
                iframe.style.height = '100%';
            }
        }
        
        function updateZoomDisplay(type) {
            const zoomLevel = type === 'impartiality' ? impartialityPdfZoomLevel : 
                             type === 'confidentiality' ? confidentialityPdfZoomLevel : 
                             qualityPdfZoomLevel;
            const zoomElementId = type === 'impartiality' ? 'impartialityZoomLevel' : 
                                 type === 'confidentiality' ? 'confidentialityZoomLevel' : 
                                 'qualityZoomLevel';
            const zoomElement = document.getElementById(zoomElementId);
            
            if (zoomElement) {
                zoomElement.textContent = `${Math.round(zoomLevel * 100)}%`;
            }
        }

        function updateImpartialityStatus() {
            const agreement1 = document.getElementById('impartiality-agreement');
            const agreement2 = document.getElementById('impartiality-understanding');
            
            // تعتمد الحالة على خانة الاختيار فقط (وليس على تحميل iframe)
            const policyRead = agreement1 && agreement1.checked;
            const policyAgreed = agreement1 && agreement1.checked && agreement2 && agreement2.checked;
            
            impartialityAgreed = policyAgreed;
            
            const policyStatusIcon = document.getElementById('impartiality-policy-status-icon');
            const policyStatusText = document.getElementById('impartiality-policy-status-text');
            
            if (policyRead) {
                policyStatusIcon.className = 'status-icon complete';
                policyStatusIcon.innerHTML = '<i class="fas fa-check"></i>';
                policyStatusText.textContent = 'تمت قراءة السياسة';
            } else {
                policyStatusIcon.className = 'status-icon incomplete';
                policyStatusIcon.innerHTML = '<i class="fas fa-times"></i>';
                policyStatusText.textContent = 'لم تتم قراءة السياسة';
            }
            
            const agreementStatusIcon = document.getElementById('impartiality-agreement-status-icon');
            const agreementStatusText = document.getElementById('impartiality-agreement-status-text');
            
            if (policyAgreed) {
                agreementStatusIcon.className = 'status-icon complete';
                agreementStatusIcon.innerHTML = '<i class="fas fa-check"></i>';
                agreementStatusText.textContent = 'تمت الموافقة على السياسة';
            } else {
                agreementStatusIcon.className = 'status-icon incomplete';
                agreementStatusIcon.innerHTML = '<i class="fas fa-times"></i>';
                agreementStatusText.textContent = 'لم تتم الموافقة على السياسة';
            }
            
            if (policyAgreed) {
                savedSections.add(7);
            } else if (savedSections.has(7)) {
                savedSections.delete(7);
            }
        }
        
        function updateConfidentialityStatus() {
            const agreement1 = document.getElementById('confidentiality-agreement');
            const agreement2 = document.getElementById('confidentiality-understanding');
            
            const policyRead = agreement1 && agreement1.checked;
            const policyAgreed = agreement1 && agreement1.checked && agreement2 && agreement2.checked;
            
            confidentialityAgreed = policyAgreed;
            
            const policyStatusIcon = document.getElementById('confidentiality-policy-status-icon');
            const policyStatusText = document.getElementById('confidentiality-policy-status-text');
            
            if (policyRead) {
                policyStatusIcon.className = 'status-icon complete';
                policyStatusIcon.innerHTML = '<i class="fas fa-check"></i>';
                policyStatusText.textContent = 'تمت قراءة السياسة';
            } else {
                policyStatusIcon.className = 'status-icon incomplete';
                policyStatusIcon.innerHTML = '<i class="fas fa-times"></i>';
                policyStatusText.textContent = 'لم تتم قراءة السياسة';
            }
            
            const agreementStatusIcon = document.getElementById('confidentiality-agreement-status-icon');
            const agreementStatusText = document.getElementById('confidentiality-agreement-status-text');
            
            if (policyAgreed) {
                agreementStatusIcon.className = 'status-icon complete';
                agreementStatusIcon.innerHTML = '<i class="fas fa-check"></i>';
                agreementStatusText.textContent = 'تمت الموافقة على السياسة';
            } else {
                agreementStatusIcon.className = 'status-icon incomplete';
                agreementStatusIcon.innerHTML = '<i class="fas fa-times"></i>';
                agreementStatusText.textContent = 'لم تتم الموافقة على السياسة';
            }
            
            if (policyAgreed) {
                savedSections.add(8);
            } else if (savedSections.has(8)) {
                savedSections.delete(8);
            }
        }
        
        function updateQualityStatus() {
            const agreement1 = document.getElementById('quality-agreement');
            const agreement2 = document.getElementById('quality-understanding');
            
            const policyRead = agreement1 && agreement1.checked;
            const policyAgreed = agreement1 && agreement1.checked && agreement2 && agreement2.checked;
            
            qualityAgreed = policyAgreed;
            
            const policyStatusIcon = document.getElementById('quality-policy-status-icon');
            const policyStatusText = document.getElementById('quality-policy-status-text');
            
            if (policyRead) {
                policyStatusIcon.className = 'status-icon complete';
                policyStatusIcon.innerHTML = '<i class="fas fa-check"></i>';
                policyStatusText.textContent = 'تمت قراءة السياسة';
            } else {
                policyStatusIcon.className = 'status-icon incomplete';
                policyStatusIcon.innerHTML = '<i class="fas fa-times"></i>';
                policyStatusText.textContent = 'لم تتم قراءة السياسة';
            }
            
            const agreementStatusIcon = document.getElementById('quality-agreement-status-icon');
            const agreementStatusText = document.getElementById('quality-agreement-status-text');
            
            if (policyAgreed) {
                agreementStatusIcon.className = 'status-icon complete';
                agreementStatusIcon.innerHTML = '<i class="fas fa-check"></i>';
                agreementStatusText.textContent = 'تمت الموافقة على السياسة';
            } else {
                agreementStatusIcon.className = 'status-icon incomplete';
                agreementStatusIcon.innerHTML = '<i class="fas fa-times"></i>';
                agreementStatusText.textContent = 'لم تتم الموافقة على السياسة';
            }
            
            if (policyAgreed) {
                savedSections.add(9);
            } else if (savedSections.has(9)) {
                savedSections.delete(9);
            }
        }

        function generateSummary() {
            const summaryContainer = document.getElementById('summary-container');
            if (!summaryContainer) return;
            
            let summaryHTML = '';
            
            function getValue(id, isTextarea = true) {
                const element = document.getElementById(id);
                if (!element) return '<span class="empty">لم يتم إدخال البيانات</span>';
                
                if (element.type === 'checkbox') {
                    return element.checked ? 'نعم' : 'لا';
                }
                
                let value = element.value.trim();
                if (!value) return '<span class="empty">لم يتم إدخال البيانات</span>';
                
                const dateFields = ['birth-date', 'start-date', 'contract-end-date', 'work-start-date-', 'work-end-date-'];
                if (dateFields.some(df => id.startsWith(df))) {
                    const dateObj = parseDateDDMMYYYY(value);
                    if (dateObj) {
                        const dmyString = formatDateToDMY(dateObj);
                        return formatDMYForDisplay(dmyString);
                    }
                    return `<span class="english-date">${value}</span>`;
                }
                
                return value;
            }
            
            let religionValue = document.getElementById('religion').value;
            if (religionValue === 'آخر') {
                religionValue = document.getElementById('other-religion').value || 'آخر';
            }
            if (!religionValue) religionValue = '<span class="empty">لم يتم إدخال البيانات</span>';
            
            let nationalityValue = document.getElementById('nationality').value;
            if (nationalityValue === 'آخر') {
                nationalityValue = document.getElementById('other-nationality').value || 'آخر';
            }
            if (!nationalityValue) nationalityValue = '<span class="empty">لم يتم إدخال البيانات</span>';
            
            let companySiteValue = document.getElementById('company-site').value;
            if (!companySiteValue) companySiteValue = '<span class="empty">لم يتم إدخال البيانات</span>';
            
            // Section 1
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-user"></i> البيانات الشخصية</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">الاسم بالكامل</div>
                            <div class="summary-value">${getValue('full-name')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الاسم بالإنجليزي</div>
                            <div class="summary-value">${getValue('english-name')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الرقم القومي</div>
                            <div class="summary-value">${getValue('national-id')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">تاريخ الميلاد</div>
                            <div class="summary-value">${getValue('birth-date')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">محل الميلاد</div>
                            <div class="summary-value">${getValue('birth-place')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الجنسية</div>
                            <div class="summary-value">${nationalityValue}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الديانة</div>
                            <div class="summary-value">${religionValue}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الحالة الاجتماعية</div>
                            <div class="summary-value">${getValue('marital-status', false)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">عدد الأبناء</div>
                            <div class="summary-value">${getValue('children-count')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الموقف من التجنيد</div>
                            <div class="summary-value">${getValue('military-status', false)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Section 2
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-address-book"></i> بيانات الاتصال</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">العنوان</div>
                            <div class="summary-value">${getValue('address')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الهاتف الأساسي</div>
                            <div class="summary-value">${getValue('phone')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الهاتف البديل</div>
                            <div class="summary-value">${getValue('alt-phone')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">البريد الإلكتروني</div>
                            <div class="summary-value">${getValue('email')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">اسم شخص للطوارئ</div>
                            <div class="summary-value">${getValue('emergency-name')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">رقم هاتف شخص للطوارئ</div>
                            <div class="summary-value">${getValue('emergency-phone')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">صلة القرابة</div>
                            <div class="summary-value">${getValue('emergency-relation')}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Section 4
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-graduation-cap"></i> المؤهل العلمي</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">المؤهل</div>
                            <div class="summary-value">${getValue('qualification', false)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الجامعة / المعهد</div>
                            <div class="summary-value">${getValue('university')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">التخصص</div>
                            <div class="summary-value">${getValue('specialization')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">سنة التخرج</div>
                            <div class="summary-value">${getValue('graduation-year')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">التقدير العام</div>
                            <div class="summary-value">${getValue('grade', false)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Section 5: Experience
            let experienceHTML = '';
            let hasExperienceData = false;
            
            for (let i = 1; i <= experienceCount; i++) {
                const company = getValue(`company-${i}`);
                const jobTitle = getValue(`job-title-${i}`);
                const jobTasks = getValue(`job-tasks-${i}`);
                const workStartDate = getValue(`work-start-date-${i}`);
                const workEndDate = getValue(`work-end-date-${i}`);
                const leaveReason = getValue(`leave-reason-${i}`);
                const experienceCertificate = getValue(`experience-certificate-${i}`, false);
                const socialSecurity = getValue(`social-security-${i}`, false);
                
                const hasData = company !== '<span class="empty">لم يتم إدخال البيانات</span>' ||
                               jobTitle !== '<span class="empty">لم يتم إدخال البيانات</span>' ||
                               jobTasks !== '<span class="empty">لم يتم إدخال البيانات</span>';
                
                if (hasData) {
                    hasExperienceData = true;
                    const workPeriod = (workStartDate !== '<span class="empty">لم يتم إدخال البيانات</span>' || workEndDate !== '<span class="empty">لم يتم إدخال البيانات</span>') ? 
                        `من ${workStartDate} إلى ${workEndDate}` : 
                        '<span class="empty">غير محدد</span>';
                    
                    experienceHTML += `
                        <div class="summary-item">
                            <div class="summary-label">الخبرة ${i}</div>
                            <div class="summary-value">
                                <strong>الشركة:</strong> ${company}<br>
                                <strong>المسمى الوظيفي:</strong> ${jobTitle}<br>
                                <strong>المهام الأساسية:</strong> ${jobTasks}<br>
                                <strong>مدة العمل:</strong> ${workPeriod}<br>
                                <strong>سبب ترك العمل:</strong> ${leaveReason}<br>
                                <strong>شهادة خبرة:</strong> ${experienceCertificate}<br>
                                <strong>تأمينات اجتماعية:</strong> ${socialSecurity}
                            </div>
                        </div>
                    `;
                }
            }
            
            if (hasExperienceData) {
                summaryHTML += `
                    <div class="summary-section">
                        <h3><i class="fas fa-briefcase"></i> الخبرات العملية</h3>
                        <div class="summary-grid">
                            ${experienceHTML}
                        </div>
                    </div>
                `;
            } else {
                summaryHTML += `
                    <div class="summary-section">
                        <h3><i class="fas fa-briefcase"></i> الخبرات العملية</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">الخبرات العملية</div>
                                <div class="summary-value empty">لم يتم إدخال أي خبرات عمل</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Section 6
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-id-badge"></i> البطاقة الوظيفية بالمعمل</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">المسمى الوظيفي</div>
                            <div class="summary-value">${getValue('job-title')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">الدور الوظيفي</div>
                            <div class="summary-value">${getValue('job-role')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">القسم</div>
                            <div class="summary-value">${getValue('department')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">موقع الشركة</div>
                            <div class="summary-value">${companySiteValue}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">تاريخ بدء العمل</div>
                            <div class="summary-value">${getValue('start-date')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">نوع التعاقد</div>
                            <div class="summary-value">${getValue('contract-type', false)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">تاريخ انتهاء العقد</div>
                            <div class="summary-value">${getValue('contract-end-date')}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">المدير المباشر</div>
                            <div class="summary-value">${getValue('manager')}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Section 7
            const impartialityAgreement1 = document.getElementById('impartiality-agreement');
            const impartialityAgreement2 = document.getElementById('impartiality-understanding');
            const impartialityAgreedSummary = impartialityAgreement1 && impartialityAgreement1.checked && impartialityAgreement2 && impartialityAgreement2.checked;
            
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-balance-scale"></i> سياسة الحيادية</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">الموافقة على السياسة</div>
                            <div class="summary-value">${impartialityAgreedSummary ? 'نعم' : '<span class="empty">لا</span>'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">فهم السياسة</div>
                            <div class="summary-value">${impartialityAgreedSummary ? 'نعم' : '<span class="empty">لا</span>'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Section 8
            const confidentialityAgreement1 = document.getElementById('confidentiality-agreement');
            const confidentialityAgreement2 = document.getElementById('confidentiality-understanding');
            const confidentialityAgreedSummary = confidentialityAgreement1 && confidentialityAgreement1.checked && confidentialityAgreement2 && confidentialityAgreement2.checked;
            
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-user-secret"></i> سياسة السرية</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">الموافقة على السياسة</div>
                            <div class="summary-value">${confidentialityAgreedSummary ? 'نعم' : '<span class="empty">لا</span>'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">فهم السياسة</div>
                            <div class="summary-value">${confidentialityAgreedSummary ? 'نعم' : '<span class="empty">لا</span>'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Section 9
            const qualityAgreement1 = document.getElementById('quality-agreement');
            const qualityAgreement2 = document.getElementById('quality-understanding');
            const qualityAgreedSummary = qualityAgreement1 && qualityAgreement1.checked && qualityAgreement2 && qualityAgreement2.checked;
            
            summaryHTML += `
                <div class="summary-section">
                    <h3><i class="fas fa-award"></i> سياسة الجودة</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">الموافقة على السياسة</div>
                            <div class="summary-value">${qualityAgreedSummary ? 'نعم' : '<span class="empty">لا</span>'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">فهم السياسة</div>
                            <div class="summary-value">${qualityAgreedSummary ? 'نعم' : '<span class="empty">لا</span>'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Files summary with preview boxes
            let filesHTML = '';
            const fileLabels = {
                'national-id-front-file': 'البطاقة الشخصية (أمامي)',
                'national-id-back-file': 'البطاقة الشخصية (خلفي)',
                'birth-certificate-file': 'شهادة الميلاد',
                'criminal-record-file': 'صحيفة الحالة الجنائية',
                'military-certificate-file': 'شهادة التجنيد',
                'personal-photos-file': 'الصور الشخصية',
                'graduation-certificate-file': 'شهادة التخرج',
                'equivalency-file': 'معادلة الشهادة'
            };
            
            Object.keys(fileLabels).forEach(fileId => {
                const url = uploadedFileUrls[fileId];
                if (url) {
                    const fileIdFromUrl = extractFileIdFromUrl(url);
                    const previewUrl = fileIdFromUrl ? `https://drive.google.com/file/d/${fileIdFromUrl}/preview` : url;
                    const mimeType = uploadedFileTypes[fileId] || '';
                    
                    const isImage = mimeType.startsWith('image/');
                    
                    filesHTML += `
                        <div class="file-preview-summary">
                            <div class="file-preview-header">
                                <i class="fas fa-file"></i>
                                <span>${fileLabels[fileId]}</span>
                            </div>
                            <div class="file-preview-body">
                                ${isImage ? `<img src="${url}" alt="صورة الملف" onerror="this.onerror=null; this.parentElement.innerHTML='<iframe src=\\'${previewUrl}\\' frameborder=0 allowfullscreen></iframe>';">` : `<iframe src="${previewUrl}" frameborder="0" allowfullscreen></iframe>`}
                            </div>
                            <div class="file-preview-footer">
                                <a href="${url}" target="_blank" class="btn"><i class="fas fa-external-link-alt"></i> فتح في Drive</a>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (filesHTML) {
                summaryHTML += `
                    <div class="summary-section">
                        <h3><i class="fas fa-file-contract"></i> المستندات المرفوعة</h3>
                        <div class="preview-grid">
                            ${filesHTML}
                        </div>
                    </div>
                `;
            } else {
                summaryHTML += `
                    <div class="summary-section">
                        <h3><i class="fas fa-file-contract"></i> المستندات المرفوعة</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">المستندات</div>
                                <div class="summary-value empty">لم يتم رفع أي مستندات</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            summaryContainer.innerHTML = summaryHTML;
        }

        function generatePDF() {
            const btn = document.getElementById('downloadPdfBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري إنشاء PDF...';
            btn.disabled = true;
            
            generateSummary();
            
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '-9999px';
            tempContainer.style.width = '800px';
            tempContainer.style.backgroundColor = 'white';
            tempContainer.style.padding = '20px';
            tempContainer.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            
            const summaryClone = document.getElementById('summary-container').cloneNode(true);
            
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `
                <h1 style="text-align: center; color: #2c3e50; margin-bottom: 5px;">ملف البيانات الشخصية</h1>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">تاريخ الإنشاء: ${new Date().toLocaleDateString('ar-EG')}</p>
                <hr style="margin-bottom: 30px;">
            `;
            
            tempContainer.appendChild(titleDiv);
            tempContainer.appendChild(summaryClone);
            
            document.body.appendChild(tempContainer);
            
            html2canvas(tempContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                windowWidth: 800,
                onclone: function(clonedDoc) {
                    // Ensure all elements are visible and correctly styled
                    const clonedContainer = clonedDoc.querySelector('div');
                    if (clonedContainer) {
                        clonedContainer.style.width = '800px';
                        clonedContainer.style.margin = '0 auto';
                    }
                }
            }).then(canvas => {
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // احسب أبعاد الصورة بما يتناسب مع عرض الصفحة
                const imgWidth = pdfWidth - 20; // هوامش 10 مم من الجانبين
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // ارتفاع الصفحة القابل للاستخدام (بعد الهوامش)
                const pageHeight = pdfHeight - 20; // 10 مم أعلى وأسفل
                
                let currentPosition = 0;
                let remainingHeight = imgHeight;
                let page = 1;
                
                while (remainingHeight > 0) {
                    if (page > 1) {
                        pdf.addPage();
                    }
                    
                    // إذا كان الجزء المتبقي أكبر من ارتفاع الصفحة، نعرض جزءاً فقط
                    const partHeight = Math.min(remainingHeight, pageHeight);
                    
                    // قص الصورة لعرض الجزء المناسب
                    pdf.addImage(
                        imgData, 
                        'PNG', 
                        10, 
                        10 - currentPosition, // موضع الصورة (سالب لكشف الجزء المطلوب)
                        imgWidth, 
                        imgHeight, 
                        undefined, 
                        'FAST'
                    );
                    
                    currentPosition += partHeight;
                    remainingHeight -= partHeight;
                    page++;
                }
                
                const userName = document.getElementById('full-name').value.trim() || 'غير_محدد';
                const cleanName = userName.replace(/\s+/g, '_').replace(/[^\w\u0621-\u064A]/g, '');
                
                pdf.save(`ملف_البيانات_${cleanName}_${new Date().toISOString().slice(0, 10)}.pdf`);
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                showToast('تم تحميل ملف PDF بنجاح', 'success');
            }).catch(error => {
                console.error('Error generating PDF:', error);
                
                if (tempContainer.parentNode) {
                    document.body.removeChild(tempContainer);
                }
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('حدث خطأ أثناء إنشاء PDF', 'error');
            });
        }

        function validateCurrentSection() {
            const currentSectionElement = document.getElementById(`section-${currentSection}`);
            const requiredFields = currentSectionElement.querySelectorAll('[required]');
            let isValid = true;
            let firstInvalidField = null;
            
            if (currentSection === 7 || currentSection === 8 || currentSection === 9) {
                return true;
            }
            
            requiredFields.forEach(field => {
                if (field.type === 'checkbox') {
                    if (!field.checked) {
                        isValid = false;
                        field.parentElement.style.border = '2px solid #e74c3c';
                        field.parentElement.style.borderRadius = '4px';
                        field.parentElement.style.padding = '5px';
                        
                        if (!firstInvalidField) {
                            firstInvalidField = field;
                        }
                    } else {
                        field.parentElement.style.border = '';
                        field.parentElement.style.padding = '';
                    }
                } else if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#e74c3c';
                    
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                } else {
                    field.style.borderColor = '';
                }
            });
            
            if (currentSection === 1) {
                const religionSelect = document.getElementById('religion');
                const nationalitySelect = document.getElementById('nationality');
                
                if (religionSelect.value === 'آخر') {
                    const otherReligion = document.getElementById('other-religion');
                    if (!otherReligion.value.trim()) {
                        isValid = false;
                        otherReligion.style.borderColor = '#e74c3c';
                        if (!firstInvalidField) firstInvalidField = otherReligion;
                    }
                }
                
                if (nationalitySelect.value === 'آخر') {
                    const otherNationality = document.getElementById('other-nationality');
                    if (!otherNationality.value.trim()) {
                        isValid = false;
                        otherNationality.style.borderColor = '#e74c3c';
                        if (!firstInvalidField) firstInvalidField = otherNationality;
                    }
                }
                
                const birthDate = document.getElementById('birth-date').value;
                if (birthDate && !parseDateDDMMYYYY(birthDate)) {
                    isValid = false;
                    document.getElementById('birth-date').style.borderColor = '#e74c3c';
                    if (!firstInvalidField) firstInvalidField = document.getElementById('birth-date');
                }
            }
            
            if (currentSection === 6) {
                const startDate = document.getElementById('start-date').value;
                if (startDate && !parseDateDDMMYYYY(startDate)) {
                    isValid = false;
                    document.getElementById('start-date').style.borderColor = '#e74c3c';
                    if (!firstInvalidField) firstInvalidField = document.getElementById('start-date');
                }
                
                const contractEndDate = document.getElementById('contract-end-date').value;
                if (contractEndDate && !parseDateDDMMYYYY(contractEndDate)) {
                    isValid = false;
                    document.getElementById('contract-end-date').style.borderColor = '#e74c3c';
                    if (!firstInvalidField) firstInvalidField = document.getElementById('contract-end-date');
                }
            }
            
            if (!isValid) {
                alert('يرجى ملء جميع الحقول المطلوبة في هذا القسم');
                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }
            
            return isValid;
        }

        // ================ دالة جمع البيانات للتحديث (مع تجزئة الأسماء) ================
        function collectAllFormData() {
            const fields = [];
            
            function getFieldName(id) {
                const map = {
                    'full-name': 'fullName',
                    'english-name': 'englishName',
                    'national-id': 'nationalId',
                    'birth-date': 'birthDate',
                    'birth-place': 'birthPlace',
                    'nationality': 'nationality',
                    'religion': 'religion',
                    'marital-status': 'maritalStatus',
                    'children-count': 'childrenCount',
                    'military-status': 'militaryStatus',
                    'address': 'address',
                    'phone': 'phone',
                    'alt-phone': 'altPhone',
                    'email': 'email',
                    'emergency-name': 'emergencyName',
                    'emergency-phone': 'emergencyPhone',
                    'emergency-relation': 'emergencyRelation',
                    'qualification': 'qualification',
                    'university': 'university',
                    'specialization': 'specialization',
                    'graduation-year': 'graduationYear',
                    'grade': 'grade',
                    'job-title': 'jobTitle',
                    'job-role': 'jobRole',
                    'department': 'department',
                    'company-site': 'companySite',
                    'start-date': 'startDate',
                    'contract-type': 'contractType',
                    'contract-end-date': 'contractEndDate',
                    'manager': 'manager'
                };
                return map[id] || id;
            }
            
            const regularIds = [
                'full-name', 'english-name', 'national-id', 'birth-date', 'birth-place',
                'address', 'phone', 'alt-phone', 'email', 'emergency-name', 'emergency-phone', 'emergency-relation',
                'qualification', 'university', 'specialization', 'graduation-year', 'grade',
                'job-title', 'job-role', 'department', 'company-site', 'start-date', 'contract-type', 'contract-end-date', 'manager'
            ];
            
            regularIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    let value = el.value.trim();
                    if (id.includes('date') && value) {
                        const dateObj = parseDateDDMMYYYY(value);
                        if (dateObj) {
                            value = formatDateToDMY(dateObj);
                        }
                    }
                    fields.push({ field: getFieldName(id), value: value });
                }
            });
            
            let nationality = document.getElementById('nationality').value;
            if (nationality === 'آخر') {
                nationality = document.getElementById('other-nationality').value;
            }
            fields.push({ field: 'nationality', value: nationality });
            
            let religion = document.getElementById('religion').value;
            if (religion === 'آخر') {
                religion = document.getElementById('other-religion').value;
            }
            fields.push({ field: 'religion', value: religion });
            
            // تجزئة الاسم العربي إلى الأول والأخير
            const fullNameArabic = document.getElementById('full-name').value.trim();
            if (fullNameArabic) {
                const parts = fullNameArabic.split(' ');
                const firstNameArabic = parts[0] || '';
                const lastNameArabic = parts.slice(1).join(' ') || '';
                fields.push({ field: 'الاسم الأول عربى', value: firstNameArabic });
                fields.push({ field: 'الاسم الأخير عربى', value: lastNameArabic });
            } else {
                fields.push({ field: 'الاسم الأول عربى', value: '' });
                fields.push({ field: 'الاسم الأخير عربى', value: '' });
            }
            
            // تجزئة الاسم الإنجليزي إلى الأول والأخير
            const fullNameEnglish = document.getElementById('english-name').value.trim();
            if (fullNameEnglish) {
                const parts = fullNameEnglish.split(' ');
                const firstNameEnglish = parts[0] || '';
                const lastNameEnglish = parts.slice(1).join(' ') || '';
                fields.push({ field: 'الاسم الأول إنجليزي', value: firstNameEnglish });
                fields.push({ field: 'الاسم الأخير إنجليزي', value: lastNameEnglish });
            } else {
                fields.push({ field: 'الاسم الأول إنجليزي', value: '' });
                fields.push({ field: 'الاسم الأخير إنجليزي', value: '' });
            }
            
            const experiences = [];
            for (let i = 1; i <= experienceCount; i++) {
                const company = document.getElementById(`company-${i}`)?.value || '';
                const jobTitle = document.getElementById(`job-title-${i}`)?.value || '';
                const jobTasks = document.getElementById(`job-tasks-${i}`)?.value || '';
                let startDate = document.getElementById(`work-start-date-${i}`)?.value || '';
                let endDate = document.getElementById(`work-end-date-${i}`)?.value || '';
                const leaveReason = document.getElementById(`leave-reason-${i}`)?.value || '';
                const hasCertificate = document.getElementById(`experience-certificate-${i}`)?.value || '';
                const hasSocialSecurity = document.getElementById(`social-security-${i}`)?.value || '';
                
                if (startDate) {
                    const d = parseDateDDMMYYYY(startDate);
                    if (d) startDate = formatDateToDMY(d);
                }
                if (endDate) {
                    const d = parseDateDDMMYYYY(endDate);
                    if (d) endDate = formatDateToDMY(d);
                }
                
                if (company || jobTitle || jobTasks || startDate || endDate || leaveReason || hasCertificate || hasSocialSecurity) {
                    experiences.push({
                        company,
                        jobTitle,
                        jobTasks,
                        startDate,
                        endDate,
                        leaveReason,
                        hasCertificate,
                        hasSocialSecurity
                    });
                }
            }
            fields.push({ field: 'workExperiences', value: JSON.stringify(experiences) });
            
            // ========== سياسات الموافقة – نرسلها كـ 'true' / 'false' ليتم تحويلها إلى نعم/لا في الخادم ==========
            fields.push({ field: 'impartialityAgreement', value: document.getElementById('impartiality-agreement').checked ? 'true' : 'false' });
            fields.push({ field: 'impartialityUnderstanding', value: document.getElementById('impartiality-understanding').checked ? 'true' : 'false' });
            fields.push({ field: 'confidentialityAgreement', value: document.getElementById('confidentiality-agreement').checked ? 'true' : 'false' });
            fields.push({ field: 'confidentialityUnderstanding', value: document.getElementById('confidentiality-understanding').checked ? 'true' : 'false' });
            fields.push({ field: 'qualityAgreement', value: document.getElementById('quality-agreement').checked ? 'true' : 'false' });
            fields.push({ field: 'qualityUnderstanding', value: document.getElementById('quality-understanding').checked ? 'true' : 'false' });
            
            return fields;
        }

        // ================ دالة حفظ البيانات (تحديث السجل) ================
        function submitEmployeeData(setProfileStatusWaiting = false) {
            if (!currentRowNumber) { 
                showToast('❌ لا يوجد سجل نشط. حمّل بيانات الموظف أولاً.', 'error'); 
                return; 
            }
            
            const fields = collectAllFormData();
            let params = new URLSearchParams();
            params.append('action', 'update');
            params.append('row', currentRowNumber);
            
            fields.forEach(f => params.append(f.field, f.value));
            
            // إضافة روابط الملفات
            Object.keys(FILE_FIELD_MAP).forEach(inputId => {
                const fieldName = FILE_FIELD_MAP[inputId];
                if (uploadedFileUrls[inputId]) {
                    params.append(fieldName, uploadedFileUrls[inputId]);
                } else {
                    params.append(fieldName, '');
                }
            });
            
            // إذا كان الطلب هو حفظ وإرسال النموذج، نضيف Profile status = waiting عبر col_13
            if (setProfileStatusWaiting) {
                params.append('col_13', 'waiting'); // العمود 13 هو Profile status
            }
            
            jsonp(`${SCRIPT_URL}?${params.toString()}&callback=handleUpdateCallback`);
            showToast('💾 تم إرسال تحديث البيانات', 'success');
        }

        // ================ دالة تسجيل الخروج ================
        function logoutUser() {
            if (!currentUserEmail) {
                // إذا لم يكن هناك بريد إلكتروني، نحاول من sessionStorage
                currentUserEmail = sessionStorage.getItem('qualitech_email');
            }
            if (!currentUserEmail) {
                showToast('لا توجد جلسة نشطة', 'error');
                return;
            }
            
            const signOutDate = getCurrentDateTimeDMYHMS();
            
            // بناء طلب التحديث
            let params = new URLSearchParams();
            params.append('action', 'update');
            params.append('email', currentUserEmail);
            params.append('Online/Offline Status', '0');
            params.append('Sign out date', signOutDate);
            
            // يمكن أيضاً إضافة العمود المباشر
            params.append('col_10', '0'); // Online/Offline Status col 10
            params.append('col_12', signOutDate); // Sign out date col 12
            
            jsonp(`${SCRIPT_URL}?${params.toString()}&callback=handleLogoutCallback`);
        }

        window.handleLogoutCallback = function(response) {
            if (response.status === 'success') {
                showToast('تم تسجيل الخروج بنجاح', 'success');
                // مسح الجلسة
                sessionStorage.clear();
                localStorage.removeItem('qualitech_remember_email');
                // توجيه المستخدم إلى صفحة تسجيل الدخول
                setTimeout(() => {
                    window.location.href = 'https://qualinova7.github.io/QualiNova/'; // رابط صفحة تسجيل الدخول
                }, 1500);
            } else {
                showToast('فشل تسجيل الخروج: ' + response.message, 'error');
            }
        };

        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                e.preventDefault();
                
                if (e.key === 'ArrowRight' && currentSection > 1) {
                    prevSection();
                } else if (e.key === 'ArrowLeft' && currentSection < totalSections) {
                    nextSection();
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            updateProgress();
            updateButtons();
            
            initializeDatePickers();
            initAutoExpandTextareas();
            initFileInputListeners();
            
            generateSummary();
            
            document.getElementById('religion').addEventListener('change', function() {
                toggleOtherInput('religion', 'other-religion-container');
            });
            
            document.getElementById('nationality').addEventListener('change', function() {
                toggleOtherInput('nationality', 'other-nationality-container');
            });
            
            setDefaultDates();
            
            updateImpartialityStatus();
            updateConfidentialityStatus();
            updateQualityStatus();
            
            initializePdfDisplay('impartiality');
            initializePdfDisplay('confidentiality');
            initializePdfDisplay('quality');
            
            updateZoomDisplay('impartiality');
            updateZoomDisplay('confidentiality');
            updateZoomDisplay('quality');
            
            document.getElementById('saveBtn').addEventListener('click', function() { 
                submitEmployeeData(false); 
            });
            document.getElementById('submitBtn').addEventListener('click', function() { 
                submitEmployeeData(true); // تمرير true لتعيين Profile status = waiting
            });
            document.getElementById('prevBtn').addEventListener('click', prevSection);
            document.getElementById('nextBtn').addEventListener('click', nextSection);
            document.getElementById('downloadPdfBtn').addEventListener('click', generatePDF);
            document.getElementById('add-experience-btn').addEventListener('click', addExperience);
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    goToSection(parseInt(this.dataset.section));
                });
            });
            
            // استخراج المعرف الفريد من sessionStorage وتحميل السجل
            const uniqueId = sessionStorage.getItem('qualitech_unique_id');
            if (uniqueId) {
                loadEmployeeRecord(uniqueId);
            } else {
                showToast('⚠️ لا توجد جلسة نشطة. يرجى تسجيل الدخول أولاً.', 'error');
            }
        });
    </script>
</body>
</html>
