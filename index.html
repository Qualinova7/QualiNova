<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> نظام إدارة سجلات معمل كواليتك إنترناشيونال</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --calibration-color: #3498db;
            --impartiality-color: #9b59b6;
            --contract-color: #e74c3c;
            --supplier-color: #2ecc71;
            --calibration-mgmt-color: #1abc9c;
            --maintenance-color: #e67e22;
            --devices-color: #8e44ad;
            --fmea-color: #7d3c98;
            --corrective-color: #c0392b;
            --environmental-color: #16a085;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .main-header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .main-header .lead {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        /* Card Styles */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-custom {
            padding: 15px 20px;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .card-header-calibration {
            background: linear-gradient(135deg, var(--calibration-color), #2980b9);
        }
        
        .card-header-impartiality {
            background: linear-gradient(135deg, var(--impartiality-color), #8e44ad);
        }
        
        .card-header-contract {
            background: linear-gradient(135deg, var(--contract-color), #c0392b);
        }
        
        .card-header-supplier {
            background: linear-gradient(135deg, var(--supplier-color), #27ae60);
        }
        
        .card-header-calibration-mgmt {
            background: linear-gradient(135deg, var(--calibration-mgmt-color), #16a085);
        }
        
        .card-header-maintenance {
            background: linear-gradient(135deg, var(--maintenance-color), #d35400);
        }
        
        .card-header-devices {
            background: linear-gradient(135deg, var(--devices-color), #9b59b6);
        }
        
        .card-header-fmea {
            background: linear-gradient(135deg, var(--fmea-color), #7d3c98);
        }
        
        .card-header-corrective {
            background: linear-gradient(135deg, var(--corrective-color), #c0392b);
        }
        
        .card-header-environmental {
            background: linear-gradient(135deg, var(--environmental-color), #16a085);
        }
        
        /* Tabs Navigation */
        .nav-tabs-custom {
            border-bottom: 3px solid #e0e0e0;
            margin-bottom: 20px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        
        .nav-tabs-custom .nav-item {
            margin-bottom: -3px;
        }
        
        .nav-tabs-custom .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 10px 10px 0 0;
            margin-right: 3px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tabs-custom .nav-link.active {
            color: white;
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        /* Form Styles */
        .form-control-custom, .form-select-custom, .form-textarea-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control-custom:focus, .form-select-custom:focus, .form-textarea-custom:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
            background: white;
        }
        
        .form-textarea-custom {
            min-height: 70px;
            resize: vertical;
        }
        
        .form-label-custom {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 0;
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0;
            min-width: 1200px;
            width: 100%;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            border: none;
            padding: 15px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .table-custom tbody tr {
            transition: all 0.2s;
        }
        
        .table-custom tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.08);
        }
        
        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }
        
        /* Checkbox Group */
        .checkbox-group-custom {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin: 12px 0;
        }
        
        .checkbox-item-custom {
            margin-bottom: 6px;
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 2px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 70px;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: #212529;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        
        .spinner-border-custom {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.2rem;
        }
        
        /* System Indicator */
        .system-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* RPN Color Coding */
        .rpn-high {
            background: #ff4d4d !important;
            color: white !important;
            font-weight: bold;
        }
        
        .rpn-medium {
            background: #ffc107 !important;
            color: #212529 !important;
            font-weight: bold;
        }
        
        .rpn-low {
            background: #28a745 !important;
            color: white !important;
            font-weight: bold;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 1px;
                min-width: 60px;
            }
            
            .nav-tabs-custom .nav-link {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .table-custom {
                min-width: 1000px;
            }
        }
        
        /* Form Sections */
        .form-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        /* Scroll buttons */
        .scroll-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .scroll-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            border: none;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .scroll-btn:hover {
            transform: scale(1.1);
            background: var(--primary-color);
        }
        
        /* Table container with scroll indicator */
        .table-container-wrapper {
            position: relative;
            margin-top: 20px;
        }
        
        .scroll-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 10;
        }
        
        .scroll-indicator.left {
            left: 10px;
        }
        
        .scroll-indicator.right {
            right: 10px;
        }
        
        /* Modal Custom */
        .modal-header-custom {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Scroll Buttons -->
    <div class="scroll-buttons">
        <button class="scroll-btn mb-2" onclick="scrollTable('left')" title="تمرير لليسار">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="scroll-btn" onclick="scrollTable('right')" title="تمرير لليمين">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    
    <!-- Main Container -->
    <div class="container-fluid main-container">
        <!-- Main Header -->
        <div class="main-header fade-in">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-tasks me-2"></i> نظام إدارة سجلات معمل كواليتك إنترناشيونال</h1>
                    <p class="lead mb-0">إدارة 10 أنظمة متكاملة: السرية + إفصاحات الحيادية + العقود + الموردين + المعايرة والصيانة + أجهزة المعايرة + تحليل المخاطر (FMEA) + السجلات التصحيحية + الظروف البيئية</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="header-badge d-inline-block me-3">
                        <i class="fas fa-database me-2"></i>
                        <span id="totalRecords">0</span> سجلات
                    </div>
                    <div class="header-badge d-inline-block">
                        <i class="fas fa-calendar me-2"></i>
                        <span id="currentDate">--/--/----</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Selection Tabs -->
        <div class="row fade-in mb-3">
            <div class="col-12">
                <ul class="nav nav-tabs nav-tabs-custom" id="systemTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="calibration-tab" data-bs-toggle="tab" data-bs-target="#calibration" type="button" role="tab">
                            <i class="fas fa-file-contract me-2"></i> سجلات السرية
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="impartiality-tab" data-bs-toggle="tab" data-bs-target="#impartiality" type="button" role="tab">
                            <i class="fas fa-balance-scale me-2"></i> إفصاح الحيادية
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contract-tab" data-bs-toggle="tab" data-bs-target="#contract" type="button" role="tab">
                            <i class="fas fa-file-signature me-2"></i> إدارة العقود
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="supplier-tab" data-bs-toggle="tab" data-bs-target="#supplier" type="button" role="tab">
                            <i class="fas fa-truck me-2"></i> إدارة الموردين
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="calibration-mgmt-tab" data-bs-toggle="tab" data-bs-target="#calibration-mgmt" type="button" role="tab">
                            <i class="fas fa-tools me-2"></i> إدارة المعايرة
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab">
                            <i class="fas fa-wrench me-2"></i> إدارة الصيانة
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">
                            <i class="fas fa-microchip me-2"></i> أجهزة المعايرة
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="fmea-tab" data-bs-toggle="tab" data-bs-target="#fmea" type="button" role="tab">
                            <i class="fas fa-exclamation-triangle me-2"></i> تحليل المخاطر (FMEA)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="corrective-tab" data-bs-toggle="tab" data-bs-target="#corrective" type="button" role="tab">
                            <i class="fas fa-clipboard-check me-2"></i> السجلات التصحيحية
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="environmental-tab" data-bs-toggle="tab" data-bs-target="#environmental" type="button" role="tab">
                            <i class="fas fa-temperature-high me-2"></i> الظروف البيئية
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content fade-in">
            <!-- Calibration Records Tab -->
            <div class="tab-pane fade show active" id="calibration" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-calibration">
                                <i class="fas fa-file-alt me-2"></i> إدارة سجلات السرية
                            </div>
                            <div class="card-body">
                                <form id="calibrationForm">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم السجل</label>
                                            <input type="text" class="form-control form-control-custom" id="calibration_recordId" placeholder="اتركه فارغاً للتوليد التلقائي">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم الموظف *</label>
                                            <input type="text" class="form-control form-control-custom" id="calibration_employeeName" placeholder="اسم الموظف" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرقم الوظيفي *</label>
                                            <input type="text" class="form-control form-control-custom" id="calibration_employeeNumber" placeholder="الرقم الوظيفي" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">القسم *</label>
                                            <input type="text" class="form-control form-control-custom" id="calibration_department" placeholder="القسم" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">نوع العقد</label>
                                            <select class="form-select form-select-custom" id="calibration_contractType">
                                                <option value="">اختر نوع العقد</option>
                                                <option value="دائم">دائم</option>
                                                <option value="مؤقت">مؤقت</option>
                                                <option value="تدريب">تدريب</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم سجل السرية</label>
                                            <input type="text" class="form-control form-control-custom" id="calibration_secretRecordNumber" placeholder="رقم سجل السرية">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ بدء العمل</label>
                                            <input type="date" class="form-control form-control-custom" id="calibration_startDate">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ التوقيع</label>
                                            <input type="date" class="form-control form-control-custom" id="calibration_signDate">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-8 mb-2">
                                            <label class="form-label-custom">ملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="calibration_notes" placeholder="ملاحظات"></textarea>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">اسم المراجع</label>
                                            <input type="text" class="form-control form-control-custom" id="calibration_reviewerName" placeholder="اسم المراجع">
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetCalibrationForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addCalibrationRecord()" class="btn btn-success me-2" id="calibration_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateCalibrationRecord()" class="btn btn-primary" id="calibration_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="calibration_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-calibration d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة سجلات السرية</span>
                                <div>
                                    <button onclick="loadCalibrationData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportCalibrationCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="calibrationLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="calibrationTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="calibrationDataTable">
                                    </table>
                                </div>
                                
                                <div id="calibrationNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-file-alt fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد سجلات لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Impartiality Disclosure Tab -->
            <div class="tab-pane fade" id="impartiality" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-impartiality">
                                <i class="fas fa-balance-scale me-2"></i> إدارة إفصاحات الحيادية
                            </div>
                            <div class="card-body">
                                <form id="impartialityForm">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم السجل</label>
                                            <input type="text" class="form-control form-control-custom" id="impartiality_recordId" placeholder="اتركه فارغاً للتوليد التلقائي">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم الموظف *</label>
                                            <input type="text" class="form-control form-control-custom" id="impartiality_employeeName" placeholder="اسم الموظف" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرقم الوظيفي *</label>
                                            <input type="text" class="form-control form-control-custom" id="impartiality_employeeNumber" placeholder="الرقم الوظيفي" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم سجل مخاطر الحيادية</label>
                                            <input type="text" class="form-control form-control-custom" id="impartiality_impartialityRiskNumber" placeholder="رقم سجل مخاطر الحيادية">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ التوقيع *</label>
                                            <input type="date" class="form-control form-control-custom" id="impartiality_signDate" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم المراجع</label>
                                            <input type="text" class="form-control form-control-custom" id="impartiality_reviewerName" placeholder="اسم المراجع">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">المصادر المالية</label>
                                            <input type="text" class="form-control form-control-custom" id="impartiality_financialSources" placeholder="المصادر المالية">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">تفاصيل المصادر المالية</label>
                                            <textarea class="form-control form-textarea-custom" id="impartiality_financialDetails" placeholder="تفاصيل المصادر المالية"></textarea>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">العلاقات الشخصية</label>
                                            <textarea class="form-control form-textarea-custom" id="impartiality_personalRelationsDetails" placeholder="تفاصيل العلاقات الشخصية"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetImpartialityForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addImpartialityRecord()" class="btn btn-success me-2" id="impartiality_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateImpartialityRecord()" class="btn btn-primary" id="impartiality_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="impartiality_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-impartiality d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة إفصاحات الحيادية</span>
                                <div>
                                    <button onclick="loadImpartialityData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportImpartialityCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="impartialityLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="impartialityTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="impartialityDataTable">
                                    </table>
                                </div>
                                
                                <div id="impartialityNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-balance-scale fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد إفصاحات لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contract Management Tab -->
            <div class="tab-pane fade" id="contract" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-contract">
                                <i class="fas fa-file-signature me-2"></i> إدارة العقود
                            </div>
                            <div class="card-body">
                                <form id="contractForm">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم السجل (ID)</label>
                                            <input type="text" class="form-control form-control-custom" id="contract_recordId" placeholder="أدخل رقم السجل الفريد">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم العميل *</label>
                                            <input type="text" class="form-control form-control-custom" id="contract_clientName" placeholder="أدخل اسم العميل" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم العقد الرئيسي</label>
                                            <input type="text" class="form-control form-control-custom" id="contract_masterContractNumber" placeholder="رقم العقد الرئيسي">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">عنوان العميل</label>
                                            <input type="text" class="form-control form-control-custom" id="contract_clientAddress" placeholder="عنوان العميل الكامل">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الشخص المفوض</label>
                                            <input type="text" class="form-control form-control-custom" id="contract_authorizedPerson" placeholder="اسم الشخص المفوض">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ العقد</label>
                                            <input type="date" class="form-control form-control-custom" id="contract_contractDate">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ التوقيع</label>
                                            <input type="date" class="form-control form-control-custom" id="contract_signDate">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">نوع الخدمة</label>
                                            <select class="form-select form-select-custom" id="contract_serviceType">
                                                <option value="">اختر نوع الخدمة</option>
                                                <option value="استشارية">استشارية</option>
                                                <option value="تنفيذية">تنفيذية</option>
                                                <option value="صيانة">صيانة</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مدة الاتفاقية (أشهر)</label>
                                            <input type="number" class="form-control form-control-custom" id="contract_agreementDuration" placeholder="عدد الأشهر">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">قيمة العقد</label>
                                            <input type="text" class="form-control form-control-custom" id="contract_contractValue" placeholder="القيمة بالعملة المحلية">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">ملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="contract_notes" placeholder="ملاحظات إضافية"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetContractForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addContractRecord()" class="btn btn-success me-2" id="contract_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateContractRecord()" class="btn btn-primary" id="contract_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="contract_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-contract d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة العقود</span>
                                <div>
                                    <button onclick="loadContractData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportContractCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="contractLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="contractTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="contractDataTable">
                                    </table>
                                </div>
                                
                                <div id="contractNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-file-signature fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد عقود لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Supplier Management Tab -->
            <div class="tab-pane fade" id="supplier" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-supplier">
                                <i class="fas fa-truck me-2"></i> نظام إدارة وتقييم الموردين
                            </div>
                            <div class="card-body">
                                <form id="supplierForm">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم المورد</label>
                                            <input type="text" class="form-control form-control-custom" id="supplier_supplierId" placeholder="رقم المورد">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم المورد *</label>
                                            <input type="text" class="form-control form-control-custom" id="supplier_supplierName" placeholder="اسم المورد" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الهاتف</label>
                                            <input type="text" class="form-control form-control-custom" id="supplier_phone" placeholder="الهاتف">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">البريد الإلكتروني</label>
                                            <input type="email" class="form-control form-control-custom" id="supplier_email" placeholder="البريد الإلكتروني">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">جهة الاتصال</label>
                                            <input type="text" class="form-control form-control-custom" id="supplier_contactPerson" placeholder="جهة الاتصال">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الموقع الإلكتروني</label>
                                            <input type="text" class="form-control form-control-custom" id="supplier_website" placeholder="الموقع الإلكتروني">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ آخر معاملة</label>
                                            <input type="date" class="form-control form-control-custom" id="supplier_lastTransactionDate" placeholder="تاريخ آخر معاملة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الفئة</label>
                                            <select class="form-select form-select-custom" id="supplier_category">
                                                <option value="">-- اختر الفئة --</option>
                                                <option value="حرج">حرج</option>
                                                <option value="غير حرج">غير حرج</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الخدمة / المنتج</label>
                                            <input type="text" class="form-control form-control-custom" id="supplier_serviceProduct" placeholder="الخدمة / المنتج">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">قرار الاعتماد</label>
                                            <select class="form-select form-select-custom" id="supplier_approvalDecision">
                                                <option value="">-- قرار الاعتماد --</option>
                                                <option value="معتمد">معتمد</option>
                                                <option value="غير معتمد">غير معتمد</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">ملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="supplier_notes" placeholder="ملاحظات عامة"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetSupplierForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addSupplierRecord()" class="btn btn-success me-2" id="supplier_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateSupplierRecord()" class="btn btn-primary" id="supplier_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="supplier_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-supplier d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة الموردين</span>
                                <div>
                                    <button onclick="loadSupplierData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportSupplierCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="supplierLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="supplierTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="supplierDataTable">
                                    </table>
                                </div>
                                
                                <div id="supplierNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-truck fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد موردين لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calibration Management Tab -->
            <div class="tab-pane fade" id="calibration-mgmt" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-calibration-mgmt">
                                <i class="fas fa-tools me-2"></i> نظام إدارة سجلات المعايرة
                            </div>
                            <div class="card-body">
                                <form id="calibrationMgmtForm">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">رقم الشهادة *</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_certificateNumber" placeholder="رقم الشهادة" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">رقم الجهاز</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_deviceNumber" placeholder="رقم الجهاز">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">اسم الجهاز *</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_deviceName" placeholder="اسم الجهاز" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ المعايرة</label>
                                            <input type="date" class="form-control form-control-custom" id="calMgmt_calibrationDate">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ الاستحقاق</label>
                                            <input type="date" class="form-control form-control-custom" id="calMgmt_dueDate">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مختبر المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_calibrationLab" placeholder="مختبر المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم الاعتماد (ISO 17025)</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_accreditationNumber" placeholder="رقم الاعتماد">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">قابلية التتبع إلى</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_traceability" placeholder="قابلية التتبع إلى">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">عدم اليقين</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_uncertainty" placeholder="عدم اليقين">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة عند الاستلام</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_statusBefore" placeholder="الحالة عند الاستلام">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة بعد المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_statusAfter" placeholder="الحالة بعد المعايرة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">موقع الملف</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_fileLocation" placeholder="موقع الملف (Google Drive)">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الفني المسؤول</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_technician" placeholder="الفني المسؤول">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تكلفة المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_calibrationCost" placeholder="تكلفة المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مدة التوقف</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_downtime" placeholder="مدة التوقف">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">طريقة المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_calibrationMethod" placeholder="طريقة المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مراجعة الجودة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_qualityReview" placeholder="مراجعة الجودة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">المراجع</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_reviewer" placeholder="المراجع">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="calMgmt_notes" placeholder="الملاحظات"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetCalibrationMgmtForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addCalibrationMgmtRecord()" class="btn btn-success me-2" id="calibrationMgmt_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateCalibrationMgmtRecord()" class="btn btn-primary" id="calibrationMgmt_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="calibrationMgmt_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-calibration-mgmt d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة سجلات المعايرة</span>
                                <div>
                                    <button onclick="loadCalibrationMgmtData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportCalibrationMgmtCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="calibrationMgmtLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="calibrationMgmtTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="calibrationMgmtDataTable">
                                    </table>
                                </div>
                                
                                <div id="calibrationMgmtNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-tools fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد سجلات معايرة لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Maintenance Management Tab -->
            <div class="tab-pane fade" id="maintenance" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-maintenance">
                                <i class="fas fa-wrench me-2"></i> نظام إدارة سجلات الصيانة
                            </div>
                            <div class="card-body">
                                <form id="maintenanceForm">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرقم التعريفي *</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_recordId" placeholder="الرقم التعريفي" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم الجهاز *</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_deviceName" placeholder="اسم الجهاز" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الشركة المصنعة</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_manufacturer" placeholder="الشركة المصنعة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الطراز</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_model" placeholder="الطراز">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرقم التسلسلي</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_serialNumber" placeholder="الرقم التسلسلي">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الموقع</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_location" placeholder="الموقع">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">نوع العملية</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_operationType" placeholder="نوع العملية">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">السبب / المشكلة</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_problem" placeholder="السبب / المشكلة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">التاريخ</label>
                                            <input type="date" class="form-control form-control-custom" id="maintenance_date">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الفني المسؤول</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_technician" placeholder="الفني المسؤول">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">قطع الغيار المستخدمة</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_spareParts" placeholder="قطع الغيار المستخدمة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مدة التوقف</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_downtime" placeholder="مدة التوقف">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">التكلفة</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_cost" placeholder="التكلفة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">نتائج الاختبار بعد الصيانة</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_testResults" placeholder="نتائج الاختبار بعد الصيانة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة بعد الصيانة</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_statusAfterMaintenance" placeholder="الحالة بعد الصيانة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">المراجع</label>
                                            <input type="text" class="form-control form-control-custom" id="maintenance_reference" placeholder="المراجع">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-12 mb-2">
                                            <label class="form-label-custom">الملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="maintenance_notes" placeholder="الملاحظات"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetMaintenanceForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addMaintenanceRecord()" class="btn btn-success me-2" id="maintenance_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateMaintenanceRecord()" class="btn btn-primary" id="maintenance_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="maintenance_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-maintenance d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة سجلات الصيانة</span>
                                <div>
                                    <button onclick="loadMaintenanceData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportMaintenanceCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="maintenanceLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="maintenanceTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="maintenanceDataTable">
                                    </table>
                                </div>
                                
                                <div id="maintenanceNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-wrench fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد سجلات صيانة لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Devices Management Tab -->
            <div class="tab-pane fade" id="devices" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-devices">
                                <i class="fas fa-microchip me-2"></i> نظام إدارة أجهزة المعايرة
                            </div>
                            <div class="card-body">
                                <form id="devicesForm">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرقم التعريفي *</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_recordId" placeholder="الرقم التعريفي" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">اسم الجهاز *</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_deviceName" placeholder="اسم الجهاز" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مكانه</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_locationPlace" placeholder="مكانه">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الشركة المصنعة</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_manufacturer" placeholder="الشركة المصنعة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الطراز</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_model" placeholder="الطراز">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرقم التسلسلي</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_serialNumber" placeholder="الرقم التسلسلي">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الموقع</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_site" placeholder="الموقع">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الفئة</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_category" placeholder="الفئة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مجال القياس</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_measureRange" placeholder="مجال القياس">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">النطاق</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_rangeValue" placeholder="النطاق">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الدقة</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_accuracy" placeholder="الدقة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ الاستحقاق للمعايرة</label>
                                            <input type="date" class="form-control form-control-custom" id="devices_dueDate">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">فترة المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_calibrationPeriod" placeholder="فترة المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تاريخ آخر معايرة</label>
                                            <input type="date" class="form-control form-control-custom" id="devices_lastCalibrationDate">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة</label>
                                            <input type="text" class="form-control form-control-custom" id="devices_statusField" placeholder="الحالة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="devices_notes" placeholder="الملاحظات"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetDevicesForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addDevicesRecord()" class="btn btn-success me-2" id="devices_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateDevicesRecord()" class="btn btn-primary" id="devices_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="devices_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-devices d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة أجهزة المعايرة</span>
                                <div>
                                    <button onclick="loadDevicesData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportDevicesCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="devicesLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="devicesTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="devicesDataTable">
                                    </table>
                                </div>
                                
                                <div id="devicesNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-microchip fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد أجهزة معايرة لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- FMEA Analysis Tab -->
            <div class="tab-pane fade" id="fmea" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-fmea">
                                <i class="fas fa-exclamation-triangle me-2"></i> نظام تحليل المخاطر (FMEA)
                            </div>
                            <div class="card-body">
                                <form id="fmeaForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">الجهاز *</label>
                                            <input type="text" class="form-control form-control-custom" id="fmea_device" placeholder="الجهاز" required>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">العطل *</label>
                                            <input type="text" class="form-control form-control-custom" id="fmea_failure" placeholder="العطل" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">التأثير *</label>
                                            <textarea class="form-control form-textarea-custom" id="fmea_effect" placeholder="التأثير" required></textarea>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">السبب *</label>
                                            <textarea class="form-control form-textarea-custom" id="fmea_cause" placeholder="السبب" required></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">معدل التكرار (O) *</label>
                                            <input type="number" class="form-control form-control-custom" id="fmea_occurrence" placeholder="1-10" min="1" max="10" required>
                                            <small class="form-text text-muted">1 = نادر جداً, 10 = متكرر جداً</small>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">درجة الشدة (S) *</label>
                                            <input type="number" class="form-control form-control-custom" id="fmea_severity" placeholder="1-10" min="1" max="10" required>
                                            <small class="form-text text-muted">1 = غير خطير, 10 = خطير جداً</small>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">معدل الكشف (D) *</label>
                                            <input type="number" class="form-control form-control-custom" id="fmea_detection" placeholder="1-10" min="1" max="10" required>
                                            <small class="form-text text-muted">1 = كشف أكيد, 10 = كشف غير مؤكد</small>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-8 mb-2">
                                            <label class="form-label-custom">الإجراءات التصحيحية *</label>
                                            <textarea class="form-control form-textarea-custom" id="fmea_correctiveAction" placeholder="الإجراءات التصحيحية" required></textarea>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">المسؤول *</label>
                                            <input type="text" class="form-control form-control-custom" id="fmea_responsible" placeholder="المسؤول" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetFmeaForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addFmeaRecord()" class="btn btn-success me-2" id="fmea_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateFmeaRecord()" class="btn btn-primary" id="fmea_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="fmea_rowNumber">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-fmea d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة تحليل المخاطر (FMEA)</span>
                                <div>
                                    <button onclick="loadFmeaData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportFmeaCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="fmeaLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="fmeaTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="fmeaDataTable">
                                    </table>
                                </div>
                                
                                <div id="fmeaNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-exclamation-triangle fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد سجلات تحليل مخاطر لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Corrective Actions Tab -->
            <div class="tab-pane fade" id="corrective" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-corrective">
                                <i class="fas fa-clipboard-check me-2"></i> نظام إدارة السجلات التصحيحية (CAPA/NCR)
                            </div>
                            <div class="card-body">
                                <form id="correctiveForm">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">رقم السجل *</label>
                                            <input type="text" class="form-control form-control-custom" id="corrective_recordId" placeholder="رقم السجل" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">التاريخ *</label>
                                            <input type="date" class="form-control form-control-custom" id="corrective_date" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">الجهاز / العينة *</label>
                                            <input type="text" class="form-control form-control-custom" id="corrective_deviceSample" placeholder="الجهاز / العينة" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">السبب *</label>
                                            <textarea class="form-control form-textarea-custom" id="corrective_reason" placeholder="السبب" required></textarea>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label-custom">الإجراء التصحيحي *</label>
                                            <textarea class="form-control form-textarea-custom" id="corrective_correctiveAction" placeholder="الإجراء التصحيحي" required></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">عدد العملاء المتأثرين</label>
                                            <input type="number" class="form-control form-control-custom" id="corrective_affectedCustomers" placeholder="عدد العملاء المتأثرين" min="0">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الفني *</label>
                                            <input type="text" class="form-control form-control-custom" id="corrective_technician" placeholder="الفني" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">المشرف *</label>
                                            <input type="text" class="form-control form-control-custom" id="corrective_supervisor" placeholder="المشرف" required>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة النهائية *</label>
                                            <select class="form-select form-select-custom" id="corrective_finalStatus" required>
                                                <option value="">-- اختر الحالة --</option>
                                                <option value="مفتوح">مفتوح</option>
                                                <option value="قيد المتابعة">قيد المتابعة</option>
                                                <option value="مغلق">مغلق</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetCorrectiveForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addCorrectiveRecord()" class="btn btn-success me-2" id="corrective_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateCorrectiveRecord()" class="btn btn-primary" id="corrective_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="corrective_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-corrective d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة السجلات التصحيحية</span>
                                <div>
                                    <button onclick="loadCorrectiveData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportCorrectiveCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="correctiveLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="correctiveTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="correctiveDataTable">
                                    </table>
                                </div>
                                
                                <div id="correctiveNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-clipboard-check fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد سجلات تصحيحية لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Environmental Conditions Tab -->
            <div class="tab-pane fade" id="environmental" role="tabpanel">
                <!-- Form Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-environmental">
                                <i class="fas fa-temperature-high me-2"></i> نظام متابعة الظروف البيئية
                            </div>
                            <div class="card-body">
                                <form id="environmentalForm">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">رقم السجل *</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_recordId" placeholder="رقم السجل" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">الغرفة *</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_room" placeholder="الغرفة" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">أرقام أجهزة المراقبة</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_devices" placeholder="أرقام أجهزة المراقبة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">التاريخ *</label>
                                            <input type="date" class="form-control form-control-custom" id="environmental_date" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">الوقت</label>
                                            <input type="time" class="form-control form-control-custom" id="environmental_time">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">درجة الحرارة (°C)</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_temperature" placeholder="درجة الحرارة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الرطوبة (%RH)</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_humidity" placeholder="الرطوبة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الاهتزاز</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_vibration" placeholder="الاهتزاز">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مصدر الكهرباء (V)</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_power" placeholder="مصدر الكهرباء">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">شدة الإضاءة</label>
                                            <input type="text" class="form-control form-control-custom" id="environmental_light" placeholder="شدة الإضاءة">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">ضمن الحدود؟</label>
                                            <select class="form-select form-select-custom" id="environmental_withinLimits">
                                                <option value="">-- اختر الإجابة --</option>
                                                <option value="نعم">نعم</option>
                                                <option value="لا">لا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8 mb-2">
                                            <label class="form-label-custom">الملاحظات</label>
                                            <textarea class="form-control form-textarea-custom" id="environmental_notes" placeholder="الملاحظات"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12 d-flex justify-content-between">
                                            <button type="button" onclick="resetEnvironmentalForm()" class="btn btn-outline-secondary">
                                                <i class="fas fa-redo me-1"></i> مسح النموذج
                                            </button>
                                            <div>
                                                <button type="button" onclick="addEnvironmentalRecord()" class="btn btn-success me-2" id="environmental_addBtn">
                                                    <i class="fas fa-plus me-1"></i> إضافة جديد
                                                </button>
                                                <button type="button" onclick="updateEnvironmentalRecord()" class="btn btn-primary" id="environmental_updateBtn" style="display: none;">
                                                    <i class="fas fa-save me-1"></i> تحديث السجل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="environmental_editingId">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <div class="card-header-custom card-header-environmental d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i> قائمة سجلات الظروف البيئية</span>
                                <div>
                                    <button onclick="loadEnvironmentalData()" class="btn btn-light btn-sm me-2">
                                        <i class="fas fa-sync-alt"></i> تحديث
                                    </button>
                                    <button onclick="exportEnvironmentalCSV()" class="btn btn-light btn-sm">
                                        <i class="fas fa-download"></i> تصدير
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="loading-spinner" id="environmentalLoadingSpinner">
                                    <div class="spinner-border text-primary spinner-border-custom" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive" id="environmentalTableContainer" style="display: none;">
                                    <table class="table table-custom table-hover" id="environmentalDataTable">
                                    </table>
                                </div>
                                
                                <div id="environmentalNoRecords" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-temperature-high fa-4x text-muted mb-4"></i>
                                    <h4 class="text-muted">لا توجد سجلات ظروف بيئية لعرضها</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 fade-in">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-copyright me-1"></i> نظام إدارة السجلات المتكامل 
                    <span id="currentYear"></span> | 
                    <span id="appVersion" class="text-info">الإصدار 10.0</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تأكيد الحذف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-2x float-start me-3"></i>
                        <h5 class="alert-heading">تحذير!</h5>
                        <p>هل أنت متأكد من حذف هذا السجل؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                        <hr>
                        <p class="mb-0"><strong>النظام:</strong> <span id="deleteSystemType">غير معروف</span></p>
                        <p class="mb-0"><strong>رقم السجل:</strong> <span id="deleteRecordId">غير معروف</span></p>
                        <p class="mb-0"><strong>الاسم:</strong> <span id="deleteRecordName">غير معروف</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> نعم، احذف السجل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal (Dynamic) -->
    <div id="dynamicModalContainer"></div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ================ CONFIGURATION ================
        const CALIBRATION_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxxzUljzgWR0jBrrp61DWBUxVB-Ku5bH3I736KHlrpJAHaQlPOAaklbswpPOi1Wut14/exec";
        const IMPARTIALITY_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXSFMWC-nBHKu7iWUfihxiO5UKK4bjSybTpqV57sxDTGxtabgbi9m73KbIWpqn6o38jw/exec";
        const CONTRACT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwwQGNVgO33TgCISOpBGi2Gb06xIm4RYVGx9PKgwapour1g-21BbzlwsACAyAMMhyoZog/exec";
        const SUPPLIER_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzjLyLn0eia6MXUJ1KUuiTKq6bt-Ss0Z8b3Qs91xHZ0eWQ1f8hHbqlTJlrNA2rVUnkH/exec";
        const CALIBRATION_MGMT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFjbZUmkSTYseIG5L_i49f7s-xNduqMxSVQzKBRoAI-zw1vMD9q71VSCtR0JPHQacT/exec";
        const MAINTENANCE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkSfYOpZbOnYBlBuHoIJUzVqvhJGiHB9f7EnvY1O_w5Plf_iJ8U0-4CpjB2SyZLXl57w/exec";
        const DEVICES_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7dvO_bpNX9RaVt8q75N3EutSecivsNLthLtHZO2-CJobc6lAWGrD98reId_NAKY-I/exec";
        const FMEA_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby314ii-A-5OQrfCpd14wGcEXBIuQh9qlrFccf14QmRKuz9WbwtRp7lzuhERVw67UAzVg/exec";
        const CORRECTIVE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5I5LQAZg_nou7flikY-9qJRN8lmvjXYZlXF42PYID2kXluhnIrDtkFI2ck9Oj_HuZvA/exec";
        const ENVIRONMENTAL_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEKz485uet9gaYlrbqETzvk6xjw64wtKgG3yL6XPmC1VsD15ADFW1mXOfVbA0XGfxd/exec";
        
        // ================ GLOBAL VARIABLES ================
        let calibrationRecords = [];
        let impartialityRecords = [];
        let contractRecords = [];
        let supplierRecords = [];
        let calibrationMgmtRecords = [];
        let maintenanceRecords = [];
        let devicesRecords = [];
        let fmeaRecords = [];
        let correctiveRecords = [];
        let environmentalRecords = [];
        let deleteRecordId = '';
        let deleteSystemType = '';
        let deleteRecordName = '';
        
        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date and year
            setCurrentDate();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Set up tab change listeners
            setupTabListeners();
            
            // Load all records to get total count
            loadAllRecords();
            
            // Load data for active tab
            setTimeout(() => {
                loadActiveTabData();
            }, 500);
        });
        
        // ================ UNIFIED FUNCTIONS ================
        async function loadAllRecords() {
            try {
                const promises = [
                    callGoogleScript(CALIBRATION_SCRIPT_URL, 'getAll'),
                    callGoogleScript(IMPARTIALITY_SCRIPT_URL, 'getAll'),
                    callGoogleScript(CONTRACT_SCRIPT_URL, 'getAll'),
                    callGoogleScript(SUPPLIER_SCRIPT_URL, 'getAll'),
                    callGoogleScript(CALIBRATION_MGMT_SCRIPT_URL, 'getAll'),
                    callGoogleScript(MAINTENANCE_SCRIPT_URL, 'getAll'),
                    callGoogleScript(DEVICES_SCRIPT_URL, 'getAll'),
                    callGoogleScript(FMEA_SCRIPT_URL, 'getAll'),
                    callGoogleScript(CORRECTIVE_SCRIPT_URL, 'getAll'),
                    callGoogleScript(ENVIRONMENTAL_SCRIPT_URL, 'getAll')
                ];
                
                const results = await Promise.allSettled(promises);
                
                let totalCount = 0;
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.status === 'success') {
                        totalCount += result.value.data.length;
                        
                        // Store data for each system
                        switch(index) {
                            case 0: calibrationRecords = result.value.data; break;
                            case 1: impartialityRecords = result.value.data; break;
                            case 2: contractRecords = result.value.data; break;
                            case 3: supplierRecords = result.value.data; break;
                            case 4: calibrationMgmtRecords = result.value.data; break;
                            case 5: maintenanceRecords = result.value.data; break;
                            case 6: devicesRecords = result.value.data; break;
                            case 7: fmeaRecords = result.value.data; break;
                            case 8: correctiveRecords = result.value.data; break;
                            case 9: environmentalRecords = result.value.data; break;
                        }
                    }
                });
                
                document.getElementById('totalRecords').textContent = totalCount.toLocaleString('ar-SA');
            } catch (error) {
                console.error('Error loading all records:', error);
            }
        }
        
        function setCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateString = now.toLocaleDateString('ar-SA', options);
            document.getElementById('currentDate').textContent = dateString;
        }
        
        function setupTabListeners() {
            const tabIds = [
                'calibration-tab', 'impartiality-tab', 'contract-tab', 
                'supplier-tab', 'calibration-mgmt-tab', 'maintenance-tab', 
                'devices-tab', 'fmea-tab', 'corrective-tab', 'environmental-tab'
            ];
            
            tabIds.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.addEventListener('shown.bs.tab', function () {
                        switch(tabId) {
                            case 'calibration-tab': loadCalibrationData(); break;
                            case 'impartiality-tab': loadImpartialityData(); break;
                            case 'contract-tab': loadContractData(); break;
                            case 'supplier-tab': loadSupplierData(); break;
                            case 'calibration-mgmt-tab': loadCalibrationMgmtData(); break;
                            case 'maintenance-tab': loadMaintenanceData(); break;
                            case 'devices-tab': loadDevicesData(); break;
                            case 'fmea-tab': loadFmeaData(); break;
                            case 'corrective-tab': loadCorrectiveData(); break;
                            case 'environmental-tab': loadEnvironmentalData(); break;
                        }
                    });
                }
            });
        }
        
        function loadActiveTabData() {
            const activeTab = document.querySelector('.nav-link.active').id;
            switch(activeTab) {
                case 'calibration-tab': loadCalibrationData(); break;
                case 'impartiality-tab': loadImpartialityData(); break;
                case 'contract-tab': loadContractData(); break;
                case 'supplier-tab': loadSupplierData(); break;
                case 'calibration-mgmt-tab': loadCalibrationMgmtData(); break;
                case 'maintenance-tab': loadMaintenanceData(); break;
                case 'devices-tab': loadDevicesData(); break;
                case 'fmea-tab': loadFmeaData(); break;
                case 'corrective-tab': loadCorrectiveData(); break;
                case 'environmental-tab': loadEnvironmentalData(); break;
            }
        }
        
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getNotificationIcon(type)} me-3"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            return notification;
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('ar-SA');
            } catch (e) {
                return dateString;
            }
        }
        
        function formatTime(timeString) {
            if (!timeString) return '';
            return timeString;
        }
        
        function scrollTable(direction) {
            const activeTab = document.querySelector('.nav-link.active').id;
            let tableContainer;
            
            switch(activeTab) {
                case 'calibration-tab':
                    tableContainer = document.querySelector('#calibrationTableContainer .table-responsive');
                    break;
                case 'impartiality-tab':
                    tableContainer = document.querySelector('#impartialityTableContainer .table-responsive');
                    break;
                case 'contract-tab':
                    tableContainer = document.querySelector('#contractTableContainer .table-responsive');
                    break;
                case 'supplier-tab':
                    tableContainer = document.querySelector('#supplierTableContainer .table-responsive');
                    break;
                case 'calibration-mgmt-tab':
                    tableContainer = document.querySelector('#calibrationMgmtTableContainer .table-responsive');
                    break;
                case 'maintenance-tab':
                    tableContainer = document.querySelector('#maintenanceTableContainer .table-responsive');
                    break;
                case 'devices-tab':
                    tableContainer = document.querySelector('#devicesTableContainer .table-responsive');
                    break;
                case 'fmea-tab':
                    tableContainer = document.querySelector('#fmeaTableContainer .table-responsive');
                    break;
                case 'corrective-tab':
                    tableContainer = document.querySelector('#correctiveTableContainer .table-responsive');
                    break;
                case 'environmental-tab':
                    tableContainer = document.querySelector('#environmentalTableContainer .table-responsive');
                    break;
            }
            
            if (tableContainer) {
                const scrollAmount = 300;
                if (direction === 'left') {
                    tableContainer.scrollLeft -= scrollAmount;
                } else {
                    tableContainer.scrollLeft += scrollAmount;
                }
            }
        }
        
        // ================ API COMMUNICATION FUNCTIONS ================
        function jsonp(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
                const timeout = 60000;
                
                const timeoutId = setTimeout(() => {
                    cleanup();
                    reject(new Error('Request timeout'));
                }, timeout);
                
                function cleanup() {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    const script = document.querySelector(`script[data-callback="${callbackName}"]`);
                    if (script) script.remove();
                }
                
                window[callbackName] = function(response) {
                    cleanup();
                    resolve(response);
                };
                
                const script = document.createElement('script');
                script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.setAttribute('data-callback', callbackName);
                script.onerror = function() {
                    cleanup();
                    reject(new Error('Failed to load script'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        function callGoogleScript(scriptUrl, action, data = {}) {
            let url = scriptUrl + '?action=' + action;
            
            for (const key in data) {
                if (data[key] !== undefined && data[key] !== null) {
                    url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(data[key]);
                }
            }
            
            return jsonp(url);
        }
        
        // ================ VALIDATION HELPER ================
        function validateForm(requiredFields) {
            let isValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            return isValid;
        }
        
        // ================ CALIBRATION SYSTEM FUNCTIONS ================
        async function loadCalibrationData() {
            const spinner = document.getElementById('calibrationLoadingSpinner');
            const tableContainer = document.getElementById('calibrationTableContainer');
            const noRecords = document.getElementById('calibrationNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(CALIBRATION_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    calibrationRecords = result.data;
                    
                    if (calibrationRecords.length > 0) {
                        displayCalibrationRecords(calibrationRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل سجلات السرية`, 'error');
            }
        }
        
        function displayCalibrationRecords(records) {
            const table = document.getElementById('calibrationDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'اسم الموظف', 'الرقم الوظيفي', 'القسم', 'نوع العقد', 'تاريخ التوقيع', 'اسم المراجع', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${formatDate(record[6] || '')}</td>`;
                html += `<td>${escapeHtml(record[14] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editCalibrationRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'calibration')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'calibration')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addCalibrationRecord() {
            const requiredFields = ['calibration_employeeName', 'calibration_employeeNumber', 'calibration_department'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('calibration_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('calibration_recordId').value || 'CAL-' + Date.now(),
                employeeName: document.getElementById('calibration_employeeName').value,
                employeeNumber: document.getElementById('calibration_employeeNumber').value,
                department: document.getElementById('calibration_department').value,
                contractType: document.getElementById('calibration_contractType').value,
                startDate: document.getElementById('calibration_startDate').value,
                signDate: document.getElementById('calibration_signDate').value,
                notes: document.getElementById('calibration_notes').value,
                reviewerName: document.getElementById('calibration_reviewerName').value,
                secretRecordNumber: document.getElementById('calibration_secretRecordNumber').value
            };
            
            try {
                const result = await callGoogleScript(CALIBRATION_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetCalibrationForm();
                    await loadCalibrationData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editCalibrationRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات السجل...', 'info');
            
            const record = calibrationRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillCalibrationForm(record);
                document.getElementById('calibration_updateBtn').style.display = 'inline-block';
                document.getElementById('calibration_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات السجل', 'success');
            } else {
                showNotification('❌ لم يتم العثور على السجل', 'error');
            }
        }
        
        function fillCalibrationForm(record) {
            document.getElementById('calibration_recordId').value = record[0] || '';
            document.getElementById('calibration_employeeName').value = record[1] || '';
            document.getElementById('calibration_employeeNumber').value = record[2] || '';
            document.getElementById('calibration_department').value = record[3] || '';
            document.getElementById('calibration_contractType').value = record[4] || '';
            document.getElementById('calibration_secretRecordNumber').value = record[15] || '';
            document.getElementById('calibration_startDate').value = record[5] || '';
            document.getElementById('calibration_signDate').value = record[6] || '';
            document.getElementById('calibration_notes').value = record[13] || '';
            document.getElementById('calibration_reviewerName').value = record[14] || '';
            document.getElementById('calibration_editingId').value = record[0];
        }
        
        async function updateCalibrationRecord() {
            const recordId = document.getElementById('calibration_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد سجل للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('calibration_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('calibration_recordId').value,
                employeeName: document.getElementById('calibration_employeeName').value,
                employeeNumber: document.getElementById('calibration_employeeNumber').value,
                department: document.getElementById('calibration_department').value,
                contractType: document.getElementById('calibration_contractType').value,
                startDate: document.getElementById('calibration_startDate').value,
                signDate: document.getElementById('calibration_signDate').value,
                notes: document.getElementById('calibration_notes').value,
                reviewerName: document.getElementById('calibration_reviewerName').value,
                secretRecordNumber: document.getElementById('calibration_secretRecordNumber').value
            };
            
            try {
                const result = await callGoogleScript(CALIBRATION_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetCalibrationForm();
                    await loadCalibrationData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetCalibrationForm() {
            document.getElementById('calibrationForm').reset();
            document.getElementById('calibration_editingId').value = '';
            document.getElementById('calibration_addBtn').style.display = 'inline-block';
            document.getElementById('calibration_updateBtn').style.display = 'none';
            document.querySelectorAll('#calibrationForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportCalibrationCSV() {
            if (calibrationRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلات السرية...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'اسم الموظف', 'الرقم الوظيفي', 'القسم', 'نوع العقد',
                    'تاريخ بدء العمل', 'تاريخ التوقيع', 'ملاحظات',
                    'اسم المراجع', 'رقم سجل السرية'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                calibrationRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[13] || '',
                        record[14] || '',
                        record[15] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `سجلات_السرية_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${calibrationRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ IMPARTIALITY SYSTEM FUNCTIONS ================
        async function loadImpartialityData() {
            const spinner = document.getElementById('impartialityLoadingSpinner');
            const tableContainer = document.getElementById('impartialityTableContainer');
            const noRecords = document.getElementById('impartialityNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(IMPARTIALITY_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    impartialityRecords = result.data;
                    
                    if (impartialityRecords.length > 0) {
                        displayImpartialityRecords(impartialityRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل إفصاحات الحيادية`, 'error');
            }
        }
        
        function displayImpartialityRecords(records) {
            const table = document.getElementById('impartialityDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'اسم الموظف', 'الرقم الوظيفي', 'تاريخ التوقيع', 'رقم المخاطر', 'اسم المراجع', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${formatDate(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[13] || '')}</td>`;
                html += `<td>${escapeHtml(record[14] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editImpartialityRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'impartiality')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'impartiality')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addImpartialityRecord() {
            const requiredFields = ['impartiality_employeeName', 'impartiality_employeeNumber', 'impartiality_signDate'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('impartiality_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('impartiality_recordId').value || 'DISC-' + Date.now(),
                employeeName: document.getElementById('impartiality_employeeName').value,
                employeeNumber: document.getElementById('impartiality_employeeNumber').value,
                signDate: document.getElementById('impartiality_signDate').value,
                financialSources: document.getElementById('impartiality_financialSources').value,
                financialDetails: document.getElementById('impartiality_financialDetails').value,
                personalRelationsDetails: document.getElementById('impartiality_personalRelationsDetails').value,
                impartialityRiskNumber: document.getElementById('impartiality_impartialityRiskNumber').value,
                reviewerName: document.getElementById('impartiality_reviewerName').value
            };
            
            try {
                const result = await callGoogleScript(IMPARTIALITY_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetImpartialityForm();
                    await loadImpartialityData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editImpartialityRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات الإفصاح...', 'info');
            
            const record = impartialityRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillImpartialityForm(record);
                document.getElementById('impartiality_updateBtn').style.display = 'inline-block';
                document.getElementById('impartiality_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات الإفصاح', 'success');
            } else {
                showNotification('❌ لم يتم العثور على الإفصاح', 'error');
            }
        }
        
        function fillImpartialityForm(record) {
            document.getElementById('impartiality_recordId').value = record[0] || '';
            document.getElementById('impartiality_employeeName').value = record[1] || '';
            document.getElementById('impartiality_employeeNumber').value = record[2] || '';
            document.getElementById('impartiality_impartialityRiskNumber').value = record[13] || '';
            document.getElementById('impartiality_reviewerName').value = record[14] || '';
            document.getElementById('impartiality_signDate').value = record[3] || '';
            document.getElementById('impartiality_financialSources').value = record[4] || '';
            document.getElementById('impartiality_financialDetails').value = record[5] || '';
            document.getElementById('impartiality_personalRelationsDetails').value = record[7] || '';
            document.getElementById('impartiality_editingId').value = record[0];
        }
        
        async function updateImpartialityRecord() {
            const recordId = document.getElementById('impartiality_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد إفصاح للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('impartiality_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('impartiality_recordId').value,
                employeeName: document.getElementById('impartiality_employeeName').value,
                employeeNumber: document.getElementById('impartiality_employeeNumber').value,
                signDate: document.getElementById('impartiality_signDate').value,
                financialSources: document.getElementById('impartiality_financialSources').value,
                financialDetails: document.getElementById('impartiality_financialDetails').value,
                personalRelationsDetails: document.getElementById('impartiality_personalRelationsDetails').value,
                impartialityRiskNumber: document.getElementById('impartiality_impartialityRiskNumber').value,
                reviewerName: document.getElementById('impartiality_reviewerName').value
            };
            
            try {
                const result = await callGoogleScript(IMPARTIALITY_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetImpartialityForm();
                    await loadImpartialityData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetImpartialityForm() {
            document.getElementById('impartialityForm').reset();
            document.getElementById('impartiality_editingId').value = '';
            document.getElementById('impartiality_addBtn').style.display = 'inline-block';
            document.getElementById('impartiality_updateBtn').style.display = 'none';
            document.querySelectorAll('#impartialityForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportImpartialityCSV() {
            if (impartialityRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير إفصاحات الحيادية...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'اسم الموظف', 'الرقم الوظيفي', 'تاريخ التوقيع',
                    'المصادر المالية', 'تفاصيل المصادر المالية',
                    'تفاصيل العلاقات الشخصية',
                    'رقم سجل مخاطر الحيادية', 'اسم المراجع'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                impartialityRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[7] || '',
                        record[13] || '',
                        record[14] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `إفصاحات_الحيادية_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${impartialityRecords.length} إفصاح`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ CONTRACT SYSTEM FUNCTIONS ================
        async function loadContractData() {
            const spinner = document.getElementById('contractLoadingSpinner');
            const tableContainer = document.getElementById('contractTableContainer');
            const noRecords = document.getElementById('contractNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(CONTRACT_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    contractRecords = result.data;
                    
                    if (contractRecords.length > 0) {
                        displayContractRecords(contractRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل العقود`, 'error');
            }
        }
        
        function displayContractRecords(records) {
            const table = document.getElementById('contractDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'اسم العميل', 'رقم العقد', 'عنوان العميل', 'الشخص المفوض', 'تاريخ العقد', 'نوع الخدمة', 'قيمة العقد', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${formatDate(record[5] || '')}</td>`;
                html += `<td>${escapeHtml(record[7] || '')}</td>`;
                html += `<td>${escapeHtml(record[10] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editContractRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'contract')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'contract')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addContractRecord() {
            const requiredFields = ['contract_recordId', 'contract_clientName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('contract_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('contract_recordId').value,
                clientName: document.getElementById('contract_clientName').value,
                masterContractNumber: document.getElementById('contract_masterContractNumber').value,
                clientAddress: document.getElementById('contract_clientAddress').value,
                authorizedPerson: document.getElementById('contract_authorizedPerson').value,
                contractDate: document.getElementById('contract_contractDate').value,
                signDate: document.getElementById('contract_signDate').value,
                serviceType: document.getElementById('contract_serviceType').value,
                agreementDuration: document.getElementById('contract_agreementDuration').value,
                contractValue: document.getElementById('contract_contractValue').value,
                notes: document.getElementById('contract_notes').value
            };
            
            try {
                const result = await callGoogleScript(CONTRACT_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetContractForm();
                    await loadContractData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editContractRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات العقد...', 'info');
            
            const record = contractRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillContractForm(record);
                document.getElementById('contract_updateBtn').style.display = 'inline-block';
                document.getElementById('contract_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات العقد', 'success');
            } else {
                showNotification('❌ لم يتم العثور على العقد', 'error');
            }
        }
        
        function fillContractForm(record) {
            document.getElementById('contract_recordId').value = record[0] || '';
            document.getElementById('contract_clientName').value = record[1] || '';
            document.getElementById('contract_masterContractNumber').value = record[2] || '';
            document.getElementById('contract_clientAddress').value = record[3] || '';
            document.getElementById('contract_authorizedPerson').value = record[4] || '';
            document.getElementById('contract_contractDate').value = record[5] || '';
            document.getElementById('contract_signDate').value = record[6] || '';
            document.getElementById('contract_serviceType').value = record[7] || '';
            document.getElementById('contract_agreementDuration').value = record[9] || '';
            document.getElementById('contract_contractValue').value = record[10] || '';
            document.getElementById('contract_notes').value = record[13] || '';
            document.getElementById('contract_editingId').value = record[0];
        }
        
        async function updateContractRecord() {
            const recordId = document.getElementById('contract_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد عقد للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('contract_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('contract_recordId').value,
                clientName: document.getElementById('contract_clientName').value,
                masterContractNumber: document.getElementById('contract_masterContractNumber').value,
                clientAddress: document.getElementById('contract_clientAddress').value,
                authorizedPerson: document.getElementById('contract_authorizedPerson').value,
                contractDate: document.getElementById('contract_contractDate').value,
                signDate: document.getElementById('contract_signDate').value,
                serviceType: document.getElementById('contract_serviceType').value,
                agreementDuration: document.getElementById('contract_agreementDuration').value,
                contractValue: document.getElementById('contract_contractValue').value,
                notes: document.getElementById('contract_notes').value
            };
            
            try {
                const result = await callGoogleScript(CONTRACT_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetContractForm();
                    await loadContractData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetContractForm() {
            document.getElementById('contractForm').reset();
            document.getElementById('contract_editingId').value = '';
            document.getElementById('contract_addBtn').style.display = 'inline-block';
            document.getElementById('contract_updateBtn').style.display = 'none';
            document.querySelectorAll('#contractForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportContractCSV() {
            if (contractRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير العقود...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'اسم العميل', 'رقم العقد الرئيسي', 'عنوان العميل',
                    'الشخص المفوض', 'تاريخ العقد', 'تاريخ التوقيع', 'نوع الخدمة',
                    'مدة الاتفاقية', 'قيمة العقد', 'ملاحظات'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                contractRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[9] || '',
                        record[10] || '',
                        record[13] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `العقود_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${contractRecords.length} عقد`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ SUPPLIER SYSTEM FUNCTIONS ================
        async function loadSupplierData() {
            const spinner = document.getElementById('supplierLoadingSpinner');
            const tableContainer = document.getElementById('supplierTableContainer');
            const noRecords = document.getElementById('supplierNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(SUPPLIER_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    supplierRecords = result.data;
                    
                    if (supplierRecords.length > 0) {
                        displaySupplierRecords(supplierRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل الموردين`, 'error');
            }
        }
        
        function displaySupplierRecords(records) {
            const table = document.getElementById('supplierDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم المورد', 'اسم المورد', 'الهاتف', 'البريد الإلكتروني', 'جهة الاتصال', 'الفئة', 'قرار الاعتماد', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${escapeHtml(record[5] || '')}</td>`;
                html += `<td>${escapeHtml(record[9] || '')}</td>`;
                html += `<td>${escapeHtml(record[24] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editSupplierRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'supplier')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'supplier')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addSupplierRecord() {
            const requiredFields = ['supplier_supplierId', 'supplier_supplierName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('supplier_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                supplierId: document.getElementById('supplier_supplierId').value,
                supplierName: document.getElementById('supplier_supplierName').value,
                phone: document.getElementById('supplier_phone').value,
                email: document.getElementById('supplier_email').value,
                contactPerson: document.getElementById('supplier_contactPerson').value,
                website: document.getElementById('supplier_website').value,
                lastTransactionDate: document.getElementById('supplier_lastTransactionDate').value,
                category: document.getElementById('supplier_category').value,
                serviceProduct: document.getElementById('supplier_serviceProduct').value,
                approvalDecision: document.getElementById('supplier_approvalDecision').value,
                notes: document.getElementById('supplier_notes').value
            };
            
            try {
                const result = await callGoogleScript(SUPPLIER_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetSupplierForm();
                    await loadSupplierData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editSupplierRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات المورد...', 'info');
            
            const record = supplierRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillSupplierForm(record);
                document.getElementById('supplier_updateBtn').style.display = 'inline-block';
                document.getElementById('supplier_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات المورد', 'success');
            } else {
                showNotification('❌ لم يتم العثور على المورد', 'error');
            }
        }
        
        function fillSupplierForm(record) {
            document.getElementById('supplier_supplierId').value = record[0] || '';
            document.getElementById('supplier_supplierName').value = record[1] || '';
            document.getElementById('supplier_phone').value = record[3] || '';
            document.getElementById('supplier_email').value = record[4] || '';
            document.getElementById('supplier_contactPerson').value = record[5] || '';
            document.getElementById('supplier_website').value = record[6] || '';
            document.getElementById('supplier_lastTransactionDate').value = record[8] || '';
            document.getElementById('supplier_category').value = record[9] || '';
            document.getElementById('supplier_serviceProduct').value = record[10] || '';
            document.getElementById('supplier_approvalDecision').value = record[24] || '';
            document.getElementById('supplier_notes').value = record[42] || '';
            document.getElementById('supplier_editingId').value = record[0];
        }
        
        async function updateSupplierRecord() {
            const recordId = document.getElementById('supplier_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد مورد للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('supplier_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                supplierId: document.getElementById('supplier_supplierId').value,
                supplierName: document.getElementById('supplier_supplierName').value,
                phone: document.getElementById('supplier_phone').value,
                email: document.getElementById('supplier_email').value,
                contactPerson: document.getElementById('supplier_contactPerson').value,
                website: document.getElementById('supplier_website').value,
                lastTransactionDate: document.getElementById('supplier_lastTransactionDate').value,
                category: document.getElementById('supplier_category').value,
                serviceProduct: document.getElementById('supplier_serviceProduct').value,
                approvalDecision: document.getElementById('supplier_approvalDecision').value,
                notes: document.getElementById('supplier_notes').value
            };
            
            try {
                const result = await callGoogleScript(SUPPLIER_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetSupplierForm();
                    await loadSupplierData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetSupplierForm() {
            document.getElementById('supplierForm').reset();
            document.getElementById('supplier_editingId').value = '';
            document.getElementById('supplier_addBtn').style.display = 'inline-block';
            document.getElementById('supplier_updateBtn').style.display = 'none';
            document.querySelectorAll('#supplierForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportSupplierCSV() {
            if (supplierRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير الموردين...', 'info');
            
            try {
                const headers = [
                    'رقم المورد', 'اسم المورد', 'الهاتف', 'البريد الإلكتروني',
                    'جهة الاتصال', 'الموقع الإلكتروني', 'تاريخ آخر معاملة', 'الفئة',
                    'الخدمة / المنتج', 'قرار الاعتماد', 'ملاحظات'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                supplierRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[24] || '',
                        record[42] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `الموردين_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${supplierRecords.length} مورد`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ CALIBRATION MANAGEMENT SYSTEM FUNCTIONS ================
        async function loadCalibrationMgmtData() {
            const spinner = document.getElementById('calibrationMgmtLoadingSpinner');
            const tableContainer = document.getElementById('calibrationMgmtTableContainer');
            const noRecords = document.getElementById('calibrationMgmtNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(CALIBRATION_MGMT_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    calibrationMgmtRecords = result.data;
                    
                    if (calibrationMgmtRecords.length > 0) {
                        displayCalibrationMgmtRecords(calibrationMgmtRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل سجلات المعايرة`, 'error');
            }
        }
        
        function displayCalibrationMgmtRecords(records) {
            const table = document.getElementById('calibrationMgmtDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم الشهادة', 'اسم الجهاز', 'رقم الجهاز', 'تاريخ المعايرة', 'تاريخ الاستحقاق', 'مختبر المعايرة', 'عدم اليقين', 'الحالة بعد المعايرة', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${formatDate(record[3] || '')}</td>`;
                html += `<td>${formatDate(record[4] || '')}</td>`;
                html += `<td>${escapeHtml(record[5] || '')}</td>`;
                html += `<td>${escapeHtml(record[8] || '')}</td>`;
                html += `<td>${escapeHtml(record[10] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editCalibrationMgmtRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[2])}', 'calibration-mgmt')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'calibration-mgmt')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addCalibrationMgmtRecord() {
            const requiredFields = ['calMgmt_certificateNumber', 'calMgmt_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('calibrationMgmt_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                certificateNumber: document.getElementById('calMgmt_certificateNumber').value,
                deviceNumber: document.getElementById('calMgmt_deviceNumber').value,
                deviceName: document.getElementById('calMgmt_deviceName').value,
                calibrationDate: document.getElementById('calMgmt_calibrationDate').value,
                dueDate: document.getElementById('calMgmt_dueDate').value,
                calibrationLab: document.getElementById('calMgmt_calibrationLab').value,
                accreditationNumber: document.getElementById('calMgmt_accreditationNumber').value,
                traceability: document.getElementById('calMgmt_traceability').value,
                uncertainty: document.getElementById('calMgmt_uncertainty').value,
                statusBefore: document.getElementById('calMgmt_statusBefore').value,
                statusAfter: document.getElementById('calMgmt_statusAfter').value,
                fileLocation: document.getElementById('calMgmt_fileLocation').value,
                notes: document.getElementById('calMgmt_notes').value,
                technician: document.getElementById('calMgmt_technician').value,
                calibrationCost: document.getElementById('calMgmt_calibrationCost').value,
                downtime: document.getElementById('calMgmt_downtime').value,
                calibrationMethod: document.getElementById('calMgmt_calibrationMethod').value,
                qualityReview: document.getElementById('calMgmt_qualityReview').value,
                reviewer: document.getElementById('calMgmt_reviewer').value
            };
            
            try {
                const result = await callGoogleScript(CALIBRATION_MGMT_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetCalibrationMgmtForm();
                    await loadCalibrationMgmtData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editCalibrationMgmtRecord(certificateNumber) {
            showNotification('🔍 جاري تحميل بيانات سجل المعايرة...', 'info');
            
            const record = calibrationMgmtRecords.find(r => 
                String(r[0] || '').trim() === String(certificateNumber).trim()
            );
            
            if (record) {
                fillCalibrationMgmtForm(record);
                document.getElementById('calibrationMgmt_updateBtn').style.display = 'inline-block';
                document.getElementById('calibrationMgmt_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات سجل المعايرة', 'success');
            } else {
                showNotification('❌ لم يتم العثور على سجل المعايرة', 'error');
            }
        }
        
        function fillCalibrationMgmtForm(record) {
            document.getElementById('calMgmt_certificateNumber').value = record[0] || '';
            document.getElementById('calMgmt_deviceNumber').value = record[1] || '';
            document.getElementById('calMgmt_deviceName').value = record[2] || '';
            document.getElementById('calMgmt_calibrationDate').value = record[3] || '';
            document.getElementById('calMgmt_dueDate').value = record[4] || '';
            document.getElementById('calMgmt_calibrationLab').value = record[5] || '';
            document.getElementById('calMgmt_accreditationNumber').value = record[6] || '';
            document.getElementById('calMgmt_traceability').value = record[7] || '';
            document.getElementById('calMgmt_uncertainty').value = record[8] || '';
            document.getElementById('calMgmt_statusBefore').value = record[9] || '';
            document.getElementById('calMgmt_statusAfter').value = record[10] || '';
            document.getElementById('calMgmt_fileLocation').value = record[11] || '';
            document.getElementById('calMgmt_notes').value = record[12] || '';
            document.getElementById('calMgmt_technician').value = record[13] || '';
            document.getElementById('calMgmt_calibrationCost').value = record[14] || '';
            document.getElementById('calMgmt_downtime').value = record[15] || '';
            document.getElementById('calMgmt_calibrationMethod').value = record[16] || '';
            document.getElementById('calMgmt_qualityReview').value = record[17] || '';
            document.getElementById('calMgmt_reviewer').value = record[18] || '';
            document.getElementById('calibrationMgmt_editingId').value = record[0];
        }
        
        async function updateCalibrationMgmtRecord() {
            const certificateNumber = document.getElementById('calibrationMgmt_editingId').value;
            if (!certificateNumber) {
                showNotification('❌ لم يتم تحديد سجل معايرة للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('calibrationMgmt_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                certificateNumber: document.getElementById('calMgmt_certificateNumber').value,
                deviceNumber: document.getElementById('calMgmt_deviceNumber').value,
                deviceName: document.getElementById('calMgmt_deviceName').value,
                calibrationDate: document.getElementById('calMgmt_calibrationDate').value,
                dueDate: document.getElementById('calMgmt_dueDate').value,
                calibrationLab: document.getElementById('calMgmt_calibrationLab').value,
                accreditationNumber: document.getElementById('calMgmt_accreditationNumber').value,
                traceability: document.getElementById('calMgmt_traceability').value,
                uncertainty: document.getElementById('calMgmt_uncertainty').value,
                statusBefore: document.getElementById('calMgmt_statusBefore').value,
                statusAfter: document.getElementById('calMgmt_statusAfter').value,
                fileLocation: document.getElementById('calMgmt_fileLocation').value,
                notes: document.getElementById('calMgmt_notes').value,
                technician: document.getElementById('calMgmt_technician').value,
                calibrationCost: document.getElementById('calMgmt_calibrationCost').value,
                downtime: document.getElementById('calMgmt_downtime').value,
                calibrationMethod: document.getElementById('calMgmt_calibrationMethod').value,
                qualityReview: document.getElementById('calMgmt_qualityReview').value,
                reviewer: document.getElementById('calMgmt_reviewer').value
            };
            
            try {
                const result = await callGoogleScript(CALIBRATION_MGMT_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetCalibrationMgmtForm();
                    await loadCalibrationMgmtData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetCalibrationMgmtForm() {
            document.getElementById('calibrationMgmtForm').reset();
            document.getElementById('calibrationMgmt_editingId').value = '';
            document.getElementById('calibrationMgmt_addBtn').style.display = 'inline-block';
            document.getElementById('calibrationMgmt_updateBtn').style.display = 'none';
            document.querySelectorAll('#calibrationMgmtForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportCalibrationMgmtCSV() {
            if (calibrationMgmtRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلات المعايرة...', 'info');
            
            try {
                const headers = [
                    'رقم الشهادة', 'رقم الجهاز', 'اسم الجهاز', 'تاريخ المعايرة', 'تاريخ الاستحقاق',
                    'مختبر المعايرة', 'رقم الاعتماد', 'قابلية التتبع', 'عدم اليقين',
                    'الحالة عند الاستلام', 'الحالة بعد المعايرة', 'موقع الملف', 'الملاحظات',
                    'الفني المسؤول', 'تكلفة المعايرة', 'مدة التوقف', 'طريقة المعايرة',
                    'مراجعة الجودة', 'المراجع'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                calibrationMgmtRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[11] || '',
                        record[12] || '',
                        record[13] || '',
                        record[14] || '',
                        record[15] || '',
                        record[16] || '',
                        record[17] || '',
                        record[18] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `سجلات_المعايرة_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${calibrationMgmtRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ MAINTENANCE SYSTEM FUNCTIONS ================
        async function loadMaintenanceData() {
            const spinner = document.getElementById('maintenanceLoadingSpinner');
            const tableContainer = document.getElementById('maintenanceTableContainer');
            const noRecords = document.getElementById('maintenanceNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(MAINTENANCE_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    maintenanceRecords = result.data;
                    
                    if (maintenanceRecords.length > 0) {
                        displayMaintenanceRecords(maintenanceRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل سجلات الصيانة`, 'error');
            }
        }
        
        function displayMaintenanceRecords(records) {
            const table = document.getElementById('maintenanceDataTable');
            
            let html = '<thead><tr>';
            const headers = ['الرقم التعريفي', 'اسم الجهاز', 'الشركة المصنعة', 'الطراز', 'الموقع', 'نوع العملية', 'التاريخ', 'الفني المسؤول', 'التكلفة', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[5] || '')}</td>`;
                html += `<td>${escapeHtml(record[6] || '')}</td>`;
                html += `<td>${formatDate(record[8] || '')}</td>`;
                html += `<td>${escapeHtml(record[9] || '')}</td>`;
                html += `<td>${escapeHtml(record[12] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editMaintenanceRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'maintenance')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'maintenance')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addMaintenanceRecord() {
            const requiredFields = ['maintenance_recordId', 'maintenance_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('maintenance_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('maintenance_recordId').value,
                deviceName: document.getElementById('maintenance_deviceName').value,
                manufacturer: document.getElementById('maintenance_manufacturer').value,
                model: document.getElementById('maintenance_model').value,
                serialNumber: document.getElementById('maintenance_serialNumber').value,
                location: document.getElementById('maintenance_location').value,
                operationType: document.getElementById('maintenance_operationType').value,
                problem: document.getElementById('maintenance_problem').value,
                date: document.getElementById('maintenance_date').value,
                technician: document.getElementById('maintenance_technician').value,
                spareParts: document.getElementById('maintenance_spareParts').value,
                downtime: document.getElementById('maintenance_downtime').value,
                cost: document.getElementById('maintenance_cost').value,
                testResults: document.getElementById('maintenance_testResults').value,
                statusAfterMaintenance: document.getElementById('maintenance_statusAfterMaintenance').value,
                reference: document.getElementById('maintenance_reference').value,
                notes: document.getElementById('maintenance_notes').value
            };
            
            try {
                const result = await callGoogleScript(MAINTENANCE_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetMaintenanceForm();
                    await loadMaintenanceData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editMaintenanceRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات سجل الصيانة...', 'info');
            
            const record = maintenanceRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillMaintenanceForm(record);
                document.getElementById('maintenance_updateBtn').style.display = 'inline-block';
                document.getElementById('maintenance_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات سجل الصيانة', 'success');
            } else {
                showNotification('❌ لم يتم العثور على سجل الصيانة', 'error');
            }
        }
        
        function fillMaintenanceForm(record) {
            document.getElementById('maintenance_recordId').value = record[0] || '';
            document.getElementById('maintenance_deviceName').value = record[1] || '';
            document.getElementById('maintenance_manufacturer').value = record[2] || '';
            document.getElementById('maintenance_model').value = record[3] || '';
            document.getElementById('maintenance_serialNumber').value = record[4] || '';
            document.getElementById('maintenance_location').value = record[5] || '';
            document.getElementById('maintenance_operationType').value = record[6] || '';
            document.getElementById('maintenance_problem').value = record[7] || '';
            document.getElementById('maintenance_date').value = record[8] || '';
            document.getElementById('maintenance_technician').value = record[9] || '';
            document.getElementById('maintenance_spareParts').value = record[10] || '';
            document.getElementById('maintenance_downtime').value = record[11] || '';
            document.getElementById('maintenance_cost').value = record[12] || '';
            document.getElementById('maintenance_testResults').value = record[13] || '';
            document.getElementById('maintenance_statusAfterMaintenance').value = record[14] || '';
            document.getElementById('maintenance_reference').value = record[15] || '';
            document.getElementById('maintenance_notes').value = record[16] || '';
            document.getElementById('maintenance_editingId').value = record[0];
        }
        
        async function updateMaintenanceRecord() {
            const recordId = document.getElementById('maintenance_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد سجل صيانة للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('maintenance_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('maintenance_recordId').value,
                deviceName: document.getElementById('maintenance_deviceName').value,
                manufacturer: document.getElementById('maintenance_manufacturer').value,
                model: document.getElementById('maintenance_model').value,
                serialNumber: document.getElementById('maintenance_serialNumber').value,
                location: document.getElementById('maintenance_location').value,
                operationType: document.getElementById('maintenance_operationType').value,
                problem: document.getElementById('maintenance_problem').value,
                date: document.getElementById('maintenance_date').value,
                technician: document.getElementById('maintenance_technician').value,
                spareParts: document.getElementById('maintenance_spareParts').value,
                downtime: document.getElementById('maintenance_downtime').value,
                cost: document.getElementById('maintenance_cost').value,
                testResults: document.getElementById('maintenance_testResults').value,
                statusAfterMaintenance: document.getElementById('maintenance_statusAfterMaintenance').value,
                reference: document.getElementById('maintenance_reference').value,
                notes: document.getElementById('maintenance_notes').value
            };
            
            try {
                const result = await callGoogleScript(MAINTENANCE_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetMaintenanceForm();
                    await loadMaintenanceData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetMaintenanceForm() {
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenance_editingId').value = '';
            document.getElementById('maintenance_addBtn').style.display = 'inline-block';
            document.getElementById('maintenance_updateBtn').style.display = 'none';
            document.querySelectorAll('#maintenanceForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportMaintenanceCSV() {
            if (maintenanceRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلات الصيانة...', 'info');
            
            try {
                const headers = [
                    'الرقم التعريفي', 'اسم الجهاز', 'الشركة المصنعة', 'الطراز', 'الرقم التسلسلي',
                    'الموقع', 'نوع العملية', 'السبب / المشكلة', 'التاريخ', 'الفني المسؤول',
                    'قطع الغيار المستخدمة', 'مدة التوقف', 'التكلفة', 'نتائج الاختبار بعد الصيانة',
                    'الحالة بعد الصيانة', 'المراجع', 'الملاحظات'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                maintenanceRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[11] || '',
                        record[12] || '',
                        record[13] || '',
                        record[14] || '',
                        record[15] || '',
                        record[16] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `سجلات_الصيانة_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${maintenanceRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ DEVICES SYSTEM FUNCTIONS ================
        async function loadDevicesData() {
            const spinner = document.getElementById('devicesLoadingSpinner');
            const tableContainer = document.getElementById('devicesTableContainer');
            const noRecords = document.getElementById('devicesNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(DEVICES_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    devicesRecords = result.data;
                    
                    if (devicesRecords.length > 0) {
                        displayDevicesRecords(devicesRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل أجهزة المعايرة`, 'error');
            }
        }
        
        function displayDevicesRecords(records) {
            const table = document.getElementById('devicesDataTable');
            
            let html = '<thead><tr>';
            const headers = ['الرقم التعريفي', 'اسم الجهاز', 'مكانه', 'الشركة المصنعة', 'الطراز', 'الرقم التسلسلي', 'الموقع', 'الفئة', 'تاريخ الاستحقاق', 'الحالة', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${escapeHtml(record[5] || '')}</td>`;
                html += `<td>${escapeHtml(record[6] || '')}</td>`;
                html += `<td>${escapeHtml(record[7] || '')}</td>`;
                html += `<td>${formatDate(record[11] || '')}</td>`;
                html += `<td>${escapeHtml(record[15] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editDevicesRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'devices')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'devices')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addDevicesRecord() {
            const requiredFields = ['devices_recordId', 'devices_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('devices_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('devices_recordId').value,
                deviceName: document.getElementById('devices_deviceName').value,
                locationPlace: document.getElementById('devices_locationPlace').value,
                manufacturer: document.getElementById('devices_manufacturer').value,
                model: document.getElementById('devices_model').value,
                serialNumber: document.getElementById('devices_serialNumber').value,
                site: document.getElementById('devices_site').value,
                category: document.getElementById('devices_category').value,
                measureRange: document.getElementById('devices_measureRange').value,
                rangeValue: document.getElementById('devices_rangeValue').value,
                accuracy: document.getElementById('devices_accuracy').value,
                dueDate: document.getElementById('devices_dueDate').value,
                calibrationPeriod: document.getElementById('devices_calibrationPeriod').value,
                lastCalibrationDate: document.getElementById('devices_lastCalibrationDate').value,
                status: document.getElementById('devices_statusField').value,
                notes: document.getElementById('devices_notes').value
            };
            
            try {
                const result = await callGoogleScript(DEVICES_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetDevicesForm();
                    await loadDevicesData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editDevicesRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات الجهاز...', 'info');
            
            const record = devicesRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillDevicesForm(record);
                document.getElementById('devices_updateBtn').style.display = 'inline-block';
                document.getElementById('devices_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات الجهاز', 'success');
            } else {
                showNotification('❌ لم يتم العثور على الجهاز', 'error');
            }
        }
        
        function fillDevicesForm(record) {
            document.getElementById('devices_recordId').value = record[0] || '';
            document.getElementById('devices_deviceName').value = record[1] || '';
            document.getElementById('devices_locationPlace').value = record[2] || '';
            document.getElementById('devices_manufacturer').value = record[3] || '';
            document.getElementById('devices_model').value = record[4] || '';
            document.getElementById('devices_serialNumber').value = record[5] || '';
            document.getElementById('devices_site').value = record[6] || '';
            document.getElementById('devices_category').value = record[7] || '';
            document.getElementById('devices_measureRange').value = record[8] || '';
            document.getElementById('devices_rangeValue').value = record[9] || '';
            document.getElementById('devices_accuracy').value = record[10] || '';
            document.getElementById('devices_dueDate').value = record[11] || '';
            document.getElementById('devices_calibrationPeriod').value = record[12] || '';
            document.getElementById('devices_lastCalibrationDate').value = record[13] || '';
            document.getElementById('devices_statusField').value = record[15] || '';
            document.getElementById('devices_notes').value = record[16] || '';
            document.getElementById('devices_editingId').value = record[0];
        }
        
        async function updateDevicesRecord() {
            const recordId = document.getElementById('devices_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد جهاز للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('devices_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('devices_recordId').value,
                deviceName: document.getElementById('devices_deviceName').value,
                locationPlace: document.getElementById('devices_locationPlace').value,
                manufacturer: document.getElementById('devices_manufacturer').value,
                model: document.getElementById('devices_model').value,
                serialNumber: document.getElementById('devices_serialNumber').value,
                site: document.getElementById('devices_site').value,
                category: document.getElementById('devices_category').value,
                measureRange: document.getElementById('devices_measureRange').value,
                rangeValue: document.getElementById('devices_rangeValue').value,
                accuracy: document.getElementById('devices_accuracy').value,
                dueDate: document.getElementById('devices_dueDate').value,
                calibrationPeriod: document.getElementById('devices_calibrationPeriod').value,
                lastCalibrationDate: document.getElementById('devices_lastCalibrationDate').value,
                status: document.getElementById('devices_statusField').value,
                notes: document.getElementById('devices_notes').value
            };
            
            try {
                const result = await callGoogleScript(DEVICES_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetDevicesForm();
                    await loadDevicesData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetDevicesForm() {
            document.getElementById('devicesForm').reset();
            document.getElementById('devices_editingId').value = '';
            document.getElementById('devices_addBtn').style.display = 'inline-block';
            document.getElementById('devices_updateBtn').style.display = 'none';
            document.querySelectorAll('#devicesForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportDevicesCSV() {
            if (devicesRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير أجهزة المعايرة...', 'info');
            
            try {
                const headers = [
                    'الرقم التعريفي', 'اسم الجهاز', 'مكانه', 'الشركة المصنعة', 'الطراز',
                    'الرقم التسلسلي', 'الموقع', 'الفئة', 'مجال القياس', 'النطاق',
                    'الدقة', 'تاريخ الاستحقاق للمعايرة', 'فترة المعايرة', 'تاريخ آخر معايرة',
                    'الحالة', 'الملاحظات'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                devicesRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[11] || '',
                        record[12] || '',
                        record[13] || '',
                        record[15] || '',
                        record[16] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `أجهزة_المعايرة_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${devicesRecords.length} جهاز`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ FMEA ANALYSIS FUNCTIONS ================
        async function loadFmeaData() {
            const spinner = document.getElementById('fmeaLoadingSpinner');
            const tableContainer = document.getElementById('fmeaTableContainer');
            const noRecords = document.getElementById('fmeaNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(FMEA_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    fmeaRecords = result.data;
                    
                    if (fmeaRecords.length > 0) {
                        displayFmeaRecords(fmeaRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل تحليل المخاطر`, 'error');
            }
        }
        
        function displayFmeaRecords(records) {
            const table = document.getElementById('fmeaDataTable');
            
            let html = '<thead><tr>';
            const headers = ['#', 'الجهاز', 'العطل', 'التأثير', 'السبب', 'التكرار (O)', 'الشدة (S)', 'الكشف (D)', 'RPN', 'الإجراءات التصحيحية', 'المسؤول', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                const occurrence = parseInt(record[4] || 0);
                const severity = parseInt(record[5] || 0);
                const detection = parseInt(record[6] || 0);
                const rpn = occurrence * severity * detection;
                
                let rpnClass = 'rpn-low';
                if (rpn >= 200) {
                    rpnClass = 'rpn-high';
                } else if (rpn >= 100) {
                    rpnClass = 'rpn-medium';
                }
                
                html += '<tr>';
                html += `<td>${index + 1}</td>`;
                html += `<td>${escapeHtml(record[0] || '')}</td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${occurrence}</td>`;
                html += `<td>${severity}</td>`;
                html += `<td>${detection}</td>`;
                html += `<td class="${rpnClass}">${rpn}</td>`;
                html += `<td>${escapeHtml(record[7] || '')}</td>`;
                html += `<td>${escapeHtml(record[8] || '')}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editFmeaRecord(${index + 2})" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${index + 2}', '${escapeHtml(record[0])}', 'fmea')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${index + 2}', 'fmea')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addFmeaRecord() {
            const requiredFields = ['fmea_device', 'fmea_failure', 'fmea_effect', 'fmea_cause', 
                                 'fmea_occurrence', 'fmea_severity', 'fmea_detection',
                                 'fmea_correctiveAction', 'fmea_responsible'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('fmea_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                device: document.getElementById('fmea_device').value,
                failure: document.getElementById('fmea_failure').value,
                effect: document.getElementById('fmea_effect').value,
                cause: document.getElementById('fmea_cause').value,
                occurrence: document.getElementById('fmea_occurrence').value,
                severity: document.getElementById('fmea_severity').value,
                detection: document.getElementById('fmea_detection').value,
                correctiveAction: document.getElementById('fmea_correctiveAction').value,
                responsible: document.getElementById('fmea_responsible').value
            };
            
            try {
                const result = await callGoogleScript(FMEA_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetFmeaForm();
                    await loadFmeaData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function editFmeaRecord(rowNumber) {
            showNotification('🔍 جاري تحميل بيانات تحليل المخاطر...', 'info');
            
            // FMEA records use row number, not ID
            document.getElementById('fmea_rowNumber').value = rowNumber;
            
            // Find the record (subtract 2 because array is 0-based and header row is row 1)
            const recordIndex = rowNumber - 2;
            if (recordIndex >= 0 && recordIndex < fmeaRecords.length) {
                const record = fmeaRecords[recordIndex];
                
                fillFmeaForm(record);
                document.getElementById('fmea_updateBtn').style.display = 'inline-block';
                document.getElementById('fmea_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات تحليل المخاطر', 'success');
            } else {
                showNotification('❌ لم يتم العثور على تحليل المخاطر', 'error');
            }
        }
        
        function fillFmeaForm(record) {
            document.getElementById('fmea_device').value = record[0] || '';
            document.getElementById('fmea_failure').value = record[1] || '';
            document.getElementById('fmea_effect').value = record[2] || '';
            document.getElementById('fmea_cause').value = record[3] || '';
            document.getElementById('fmea_occurrence').value = record[4] || '';
            document.getElementById('fmea_severity').value = record[5] || '';
            document.getElementById('fmea_detection').value = record[6] || '';
            document.getElementById('fmea_correctiveAction').value = record[7] || '';
            document.getElementById('fmea_responsible').value = record[8] || '';
        }
        
        async function updateFmeaRecord() {
            const rowNumber = document.getElementById('fmea_rowNumber').value;
            if (!rowNumber) {
                showNotification('❌ لم يتم تحديد تحليل مخاطر للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('fmea_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                id: rowNumber,
                device: document.getElementById('fmea_device').value,
                failure: document.getElementById('fmea_failure').value,
                effect: document.getElementById('fmea_effect').value,
                cause: document.getElementById('fmea_cause').value,
                occurrence: document.getElementById('fmea_occurrence').value,
                severity: document.getElementById('fmea_severity').value,
                detection: document.getElementById('fmea_detection').value,
                correctiveAction: document.getElementById('fmea_correctiveAction').value,
                responsible: document.getElementById('fmea_responsible').value
            };
            
            try {
                const result = await callGoogleScript(FMEA_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetFmeaForm();
                    await loadFmeaData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetFmeaForm() {
            document.getElementById('fmeaForm').reset();
            document.getElementById('fmea_rowNumber').value = '';
            document.getElementById('fmea_addBtn').style.display = 'inline-block';
            document.getElementById('fmea_updateBtn').style.display = 'none';
            document.querySelectorAll('#fmeaForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportFmeaCSV() {
            if (fmeaRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير تحليل المخاطر...', 'info');
            
            try {
                const headers = [
                    'الجهاز', 'العطل', 'التأثير', 'السبب',
                    'التكرار (O)', 'الشدة (S)', 'الكشف (D)', 'RPN',
                    'الإجراءات التصحيحية', 'المسؤول'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                fmeaRecords.forEach(record => {
                    const occurrence = parseInt(record[4] || 0);
                    const severity = parseInt(record[5] || 0);
                    const detection = parseInt(record[6] || 0);
                    const rpn = occurrence * severity * detection;
                    
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        occurrence,
                        severity,
                        detection,
                        rpn,
                        record[7] || '',
                        record[8] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `تحليل_المخاطر_FMEA_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${fmeaRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ CORRECTIVE ACTIONS FUNCTIONS ================
        async function loadCorrectiveData() {
            const spinner = document.getElementById('correctiveLoadingSpinner');
            const tableContainer = document.getElementById('correctiveTableContainer');
            const noRecords = document.getElementById('correctiveNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(CORRECTIVE_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    correctiveRecords = result.data;
                    
                    if (correctiveRecords.length > 0) {
                        displayCorrectiveRecords(correctiveRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل السجلات التصحيحية`, 'error');
            }
        }
        
        function displayCorrectiveRecords(records) {
            const table = document.getElementById('correctiveDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'التاريخ', 'الجهاز / العينة', 'السبب', 'عدد العملاء المتأثرين', 'الإجراء التصحيحي', 'الفني', 'المشرف', 'الحالة النهائية', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${formatDate(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '').substring(0, 30)}${escapeHtml(record[3] || '').length > 30 ? '...' : ''}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${escapeHtml(record[5] || '').substring(0, 30)}${escapeHtml(record[5] || '').length > 30 ? '...' : ''}</td>`;
                html += `<td>${escapeHtml(record[6] || '')}</td>`;
                html += `<td>${escapeHtml(record[7] || '')}</td>`;
                
                let statusClass = 'badge bg-secondary';
                if (record[8] === 'مفتوح') {
                    statusClass = 'badge bg-danger';
                } else if (record[8] === 'قيد المتابعة') {
                    statusClass = 'badge bg-warning text-dark';
                } else if (record[8] === 'مغلق') {
                    statusClass = 'badge bg-success';
                }
                html += `<td><span class="${statusClass}">${escapeHtml(record[8] || '')}</span></td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editCorrectiveRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[2])}', 'corrective')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'corrective')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addCorrectiveRecord() {
            const requiredFields = ['corrective_recordId', 'corrective_date', 'corrective_deviceSample', 
                                 'corrective_reason', 'corrective_correctiveAction', 'corrective_technician',
                                 'corrective_supervisor', 'corrective_finalStatus'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('corrective_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('corrective_recordId').value,
                date: document.getElementById('corrective_date').value,
                deviceSample: document.getElementById('corrective_deviceSample').value,
                reason: document.getElementById('corrective_reason').value,
                affectedCustomers: document.getElementById('corrective_affectedCustomers').value,
                correctiveAction: document.getElementById('corrective_correctiveAction').value,
                technician: document.getElementById('corrective_technician').value,
                supervisor: document.getElementById('corrective_supervisor').value,
                finalStatus: document.getElementById('corrective_finalStatus').value
            };
            
            try {
                const result = await callGoogleScript(CORRECTIVE_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetCorrectiveForm();
                    await loadCorrectiveData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editCorrectiveRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات السجل التصحيحي...', 'info');
            
            const record = correctiveRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillCorrectiveForm(record);
                document.getElementById('corrective_updateBtn').style.display = 'inline-block';
                document.getElementById('corrective_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات السجل التصحيحي', 'success');
            } else {
                showNotification('❌ لم يتم العثور على السجل التصحيحي', 'error');
            }
        }
        
        function fillCorrectiveForm(record) {
            document.getElementById('corrective_recordId').value = record[0] || '';
            document.getElementById('corrective_date').value = record[1] || '';
            document.getElementById('corrective_deviceSample').value = record[2] || '';
            document.getElementById('corrective_reason').value = record[3] || '';
            document.getElementById('corrective_affectedCustomers').value = record[4] || '';
            document.getElementById('corrective_correctiveAction').value = record[5] || '';
            document.getElementById('corrective_technician').value = record[6] || '';
            document.getElementById('corrective_supervisor').value = record[7] || '';
            document.getElementById('corrective_finalStatus').value = record[8] || '';
            document.getElementById('corrective_editingId').value = record[0];
        }
        
        async function updateCorrectiveRecord() {
            const recordId = document.getElementById('corrective_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد سجل تصحيحي للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('corrective_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('corrective_recordId').value,
                date: document.getElementById('corrective_date').value,
                deviceSample: document.getElementById('corrective_deviceSample').value,
                reason: document.getElementById('corrective_reason').value,
                affectedCustomers: document.getElementById('corrective_affectedCustomers').value,
                correctiveAction: document.getElementById('corrective_correctiveAction').value,
                technician: document.getElementById('corrective_technician').value,
                supervisor: document.getElementById('corrective_supervisor').value,
                finalStatus: document.getElementById('corrective_finalStatus').value
            };
            
            try {
                const result = await callGoogleScript(CORRECTIVE_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetCorrectiveForm();
                    await loadCorrectiveData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetCorrectiveForm() {
            document.getElementById('correctiveForm').reset();
            document.getElementById('corrective_editingId').value = '';
            document.getElementById('corrective_addBtn').style.display = 'inline-block';
            document.getElementById('corrective_updateBtn').style.display = 'none';
            document.querySelectorAll('#correctiveForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportCorrectiveCSV() {
            if (correctiveRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير السجلات التصحيحية...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'التاريخ', 'الجهاز / العينة', 'السبب',
                    'عدد العملاء المتأثرين', 'الإجراء التصحيحي', 'الفني',
                    'المشرف', 'الحالة النهائية'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                correctiveRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[8] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `السجلات_التصحيحية_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${correctiveRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ ENVIRONMENTAL CONDITIONS FUNCTIONS ================
        async function loadEnvironmentalData() {
            const spinner = document.getElementById('environmentalLoadingSpinner');
            const tableContainer = document.getElementById('environmentalTableContainer');
            const noRecords = document.getElementById('environmentalNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const result = await callGoogleScript(ENVIRONMENTAL_SCRIPT_URL, 'getAll');
                
                spinner.style.display = 'none';
                
                if (result.status === 'success') {
                    environmentalRecords = result.data;
                    
                    if (environmentalRecords.length > 0) {
                        displayEnvironmentalRecords(environmentalRecords);
                        tableContainer.style.display = 'block';
                        updateTotalRecordsCount();
                    } else {
                        noRecords.style.display = 'block';
                    }
                } else {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification(`❌ خطأ في تحميل سجلات الظروف البيئية`, 'error');
            }
        }
        
        function displayEnvironmentalRecords(records) {
            const table = document.getElementById('environmentalDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'الغرفة', 'أجهزة المراقبة', 'التاريخ', 'الوقت', 'درجة الحرارة', 'الرطوبة', 'الاهتزاز', 'مصدر الكهرباء', 'شدة الإضاءة', 'ضمن الحدود', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[0] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${formatDate(record[3] || '')}</td>`;
                html += `<td>${formatTime(record[4] || '')}</td>`;
                html += `<td>${escapeHtml(record[5] || '')}°C</td>`;
                html += `<td>${escapeHtml(record[6] || '')}%RH</td>`;
                html += `<td>${escapeHtml(record[7] || '')}</td>`;
                html += `<td>${escapeHtml(record[8] || '')}V</td>`;
                html += `<td>${escapeHtml(record[9] || '')}</td>`;
                
                let withinLimitsClass = 'badge bg-secondary';
                let withinLimitsText = escapeHtml(record[10] || '');
                if (withinLimitsText === 'نعم') {
                    withinLimitsClass = 'badge bg-success';
                } else if (withinLimitsText === 'لا') {
                    withinLimitsClass = 'badge bg-danger';
                }
                html += `<td><span class="${withinLimitsClass}">${withinLimitsText}</span></td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editEnvironmentalRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', 'environmental')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}', 'environmental')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addEnvironmentalRecord() {
            const requiredFields = ['environmental_recordId', 'environmental_room', 'environmental_date'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const button = document.getElementById('environmental_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const formData = {
                recordId: document.getElementById('environmental_recordId').value,
                room: document.getElementById('environmental_room').value,
                devices: document.getElementById('environmental_devices').value,
                date: document.getElementById('environmental_date').value,
                time: document.getElementById('environmental_time').value,
                temperature: document.getElementById('environmental_temperature').value,
                humidity: document.getElementById('environmental_humidity').value,
                vibration: document.getElementById('environmental_vibration').value,
                power: document.getElementById('environmental_power').value,
                light: document.getElementById('environmental_light').value,
                withinLimits: document.getElementById('environmental_withinLimits').value,
                notes: document.getElementById('environmental_notes').value
            };
            
            try {
                const result = await callGoogleScript(ENVIRONMENTAL_SCRIPT_URL, 'add', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetEnvironmentalForm();
                    await loadEnvironmentalData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الإضافة`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editEnvironmentalRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات سجل الظروف البيئية...', 'info');
            
            const record = environmentalRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillEnvironmentalForm(record);
                document.getElementById('environmental_updateBtn').style.display = 'inline-block';
                document.getElementById('environmental_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات سجل الظروف البيئية', 'success');
            } else {
                showNotification('❌ لم يتم العثور على سجل الظروف البيئية', 'error');
            }
        }
        
        function fillEnvironmentalForm(record) {
            document.getElementById('environmental_recordId').value = record[0] || '';
            document.getElementById('environmental_room').value = record[1] || '';
            document.getElementById('environmental_devices').value = record[2] || '';
            document.getElementById('environmental_date').value = record[3] || '';
            document.getElementById('environmental_time').value = record[4] || '';
            document.getElementById('environmental_temperature').value = record[5] || '';
            document.getElementById('environmental_humidity').value = record[6] || '';
            document.getElementById('environmental_vibration').value = record[7] || '';
            document.getElementById('environmental_power').value = record[8] || '';
            document.getElementById('environmental_light').value = record[9] || '';
            document.getElementById('environmental_withinLimits').value = record[10] || '';
            document.getElementById('environmental_notes').value = record[11] || '';
            document.getElementById('environmental_editingId').value = record[0];
        }
        
        async function updateEnvironmentalRecord() {
            const recordId = document.getElementById('environmental_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد سجل ظروف بيئية للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('environmental_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const formData = {
                recordId: document.getElementById('environmental_recordId').value,
                room: document.getElementById('environmental_room').value,
                devices: document.getElementById('environmental_devices').value,
                date: document.getElementById('environmental_date').value,
                time: document.getElementById('environmental_time').value,
                temperature: document.getElementById('environmental_temperature').value,
                humidity: document.getElementById('environmental_humidity').value,
                vibration: document.getElementById('environmental_vibration').value,
                power: document.getElementById('environmental_power').value,
                light: document.getElementById('environmental_light').value,
                withinLimits: document.getElementById('environmental_withinLimits').value,
                notes: document.getElementById('environmental_notes').value
            };
            
            try {
                const result = await callGoogleScript(ENVIRONMENTAL_SCRIPT_URL, 'update', formData);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    resetEnvironmentalForm();
                    await loadEnvironmentalData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في التحديث`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetEnvironmentalForm() {
            document.getElementById('environmentalForm').reset();
            document.getElementById('environmental_editingId').value = '';
            document.getElementById('environmental_addBtn').style.display = 'inline-block';
            document.getElementById('environmental_updateBtn').style.display = 'none';
            document.querySelectorAll('#environmentalForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }
        
        function exportEnvironmentalCSV() {
            if (environmentalRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلات الظروف البيئية...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'الغرفة', 'أجهزة المراقبة', 'التاريخ', 'الوقت',
                    'درجة الحرارة (°C)', 'الرطوبة (%RH)', 'الاهتزاز',
                    'مصدر الكهرباء (V)', 'شدة الإضاءة', 'ضمن الحدود', 'الملاحظات'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                environmentalRecords.forEach(record => {
                    const row = [
                        record[0] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[11] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `الظروف_البيئية_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${environmentalRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ DETAILS VIEW FUNCTION ================
        async function viewDetails(recordId, systemType) {
            let record, title, detailsHTML;
            
            switch(systemType) {
                case 'calibration':
                    record = calibrationRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'سجل السرية';
                    break;
                case 'impartiality':
                    record = impartialityRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'إفصاح الحيادية';
                    break;
                case 'contract':
                    record = contractRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'عقد';
                    break;
                case 'supplier':
                    record = supplierRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'مورد';
                    break;
                case 'calibration-mgmt':
                    record = calibrationMgmtRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'سجل المعايرة';
                    break;
                case 'maintenance':
                    record = maintenanceRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'سجل الصيانة';
                    break;
                case 'devices':
                    record = devicesRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'جهاز المعايرة';
                    break;
                case 'fmea':
                    // For FMEA, recordId is row number
                    const rowIndex = parseInt(recordId) - 2;
                    if (rowIndex >= 0 && rowIndex < fmeaRecords.length) {
                        record = fmeaRecords[rowIndex];
                        title = 'تحليل المخاطر (FMEA)';
                    }
                    break;
                case 'corrective':
                    record = correctiveRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'سجل تصحيحي';
                    break;
                case 'environmental':
                    record = environmentalRecords.find(r => String(r[0] || '').trim() === String(recordId).trim());
                    title = 'سجل الظروف البيئية';
                    break;
                default:
                    showNotification('❌ نظام غير معروف', 'error');
                    return;
            }
            
            if (!record) {
                showNotification('❌ لم يتم العثور على السجل', 'error');
                return;
            }
            
            switch(systemType) {
                case 'calibration':
                    detailsHTML = generateCalibrationDetails(record, title);
                    break;
                case 'impartiality':
                    detailsHTML = generateImpartialityDetails(record, title);
                    break;
                case 'contract':
                    detailsHTML = generateContractDetails(record, title);
                    break;
                case 'supplier':
                    detailsHTML = generateSupplierDetails(record, title);
                    break;
                case 'calibration-mgmt':
                    detailsHTML = generateCalibrationMgmtDetails(record, title);
                    break;
                case 'maintenance':
                    detailsHTML = generateMaintenanceDetails(record, title);
                    break;
                case 'devices':
                    detailsHTML = generateDevicesDetails(record, title);
                    break;
                case 'fmea':
                    detailsHTML = generateFmeaDetails(record, title);
                    break;
                case 'corrective':
                    detailsHTML = generateCorrectiveDetails(record, title);
                    break;
                case 'environmental':
                    detailsHTML = generateEnvironmentalDetails(record, title);
                    break;
            }
            
            const existingModal = document.getElementById('detailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.getElementById('dynamicModalContainer').innerHTML = detailsHTML;
            
            const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
            detailsModal.show();
        }
        
        function generateCalibrationDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>اسم الموظف:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>الرقم الوظيفي:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>القسم:</strong> ${escapeHtml(record[3])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>نوع العقد:</strong> ${escapeHtml(record[4])}</p>
                                        <p><strong>تاريخ بدء العمل:</strong> ${formatDate(record[5])}</p>
                                        <p><strong>تاريخ التوقيع:</strong> ${formatDate(record[6])}</p>
                                        <p><strong>رقم سجل السرية:</strong> ${escapeHtml(record[15])}</p>
                                    </div>
                                </div>
                                ${record[13] ? `<p><strong>ملاحظات:</strong> ${escapeHtml(record[13])}</p>` : ''}
                                ${record[14] ? `<p><strong>اسم المراجع:</strong> ${escapeHtml(record[14])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateImpartialityDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>اسم الموظف:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>الرقم الوظيفي:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>تاريخ التوقيع:</strong> ${formatDate(record[3])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>رقم مخاطر الحيادية:</strong> ${escapeHtml(record[13])}</p>
                                        <p><strong>اسم المراجع:</strong> ${escapeHtml(record[14])}</p>
                                    </div>
                                </div>
                                ${record[4] ? `<p><strong>المصادر المالية:</strong> ${escapeHtml(record[4])}</p>` : ''}
                                ${record[5] ? `<p><strong>تفاصيل المصادر المالية:</strong> ${escapeHtml(record[5])}</p>` : ''}
                                ${record[7] ? `<p><strong>تفاصيل العلاقات الشخصية:</strong> ${escapeHtml(record[7])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateContractDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>اسم العميل:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>رقم العقد الرئيسي:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>عنوان العميل:</strong> ${escapeHtml(record[3])}</p>
                                        <p><strong>الشخص المفوض:</strong> ${escapeHtml(record[4])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>تاريخ العقد:</strong> ${formatDate(record[5])}</p>
                                        <p><strong>تاريخ التوقيع:</strong> ${formatDate(record[6])}</p>
                                        <p><strong>نوع الخدمة:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>مدة الاتفاقية:</strong> ${escapeHtml(record[9])} شهر</p>
                                        <p><strong>قيمة العقد:</strong> ${escapeHtml(record[10])}</p>
                                    </div>
                                </div>
                                ${record[13] ? `<p><strong>ملاحظات:</strong> ${escapeHtml(record[13])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateSupplierDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم المورد:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>اسم المورد:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>الهاتف:</strong> ${escapeHtml(record[3])}</p>
                                        <p><strong>البريد الإلكتروني:</strong> ${escapeHtml(record[4])}</p>
                                        <p><strong>جهة الاتصال:</strong> ${escapeHtml(record[5])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>الموقع الإلكتروني:</strong> ${escapeHtml(record[6])}</p>
                                        <p><strong>تاريخ آخر معاملة:</strong> ${formatDate(record[8])}</p>
                                        <p><strong>الفئة:</strong> ${escapeHtml(record[9])}</p>
                                        <p><strong>الخدمة/المنتج:</strong> ${escapeHtml(record[10])}</p>
                                        <p><strong>قرار الاعتماد:</strong> ${escapeHtml(record[24])}</p>
                                    </div>
                                </div>
                                ${record[42] ? `<p><strong>ملاحظات:</strong> ${escapeHtml(record[42])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateCalibrationMgmtDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم الشهادة:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>رقم الجهاز:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>اسم الجهاز:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>تاريخ المعايرة:</strong> ${formatDate(record[3])}</p>
                                        <p><strong>تاريخ الاستحقاق:</strong> ${formatDate(record[4])}</p>
                                        <p><strong>مختبر المعايرة:</strong> ${escapeHtml(record[5])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>رقم الاعتماد:</strong> ${escapeHtml(record[6])}</p>
                                        <p><strong>قابلية التتبع:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>عدم اليقين:</strong> ${escapeHtml(record[8])}</p>
                                        <p><strong>الحالة عند الاستلام:</strong> ${escapeHtml(record[9])}</p>
                                        <p><strong>الحالة بعد المعايرة:</strong> ${escapeHtml(record[10])}</p>
                                        <p><strong>موقع الملف:</strong> ${escapeHtml(record[11])}</p>
                                    </div>
                                </div>
                                ${record[12] ? `<p><strong>ملاحظات:</strong> ${escapeHtml(record[12])}</p>` : ''}
                                ${record[13] ? `<p><strong>الفني المسؤول:</strong> ${escapeHtml(record[13])}</p>` : ''}
                                ${record[14] ? `<p><strong>تكلفة المعايرة:</strong> ${escapeHtml(record[14])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateMaintenanceDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>الرقم التعريفي:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>اسم الجهاز:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>الشركة المصنعة:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>الطراز:</strong> ${escapeHtml(record[3])}</p>
                                        <p><strong>الرقم التسلسلي:</strong> ${escapeHtml(record[4])}</p>
                                        <p><strong>الموقع:</strong> ${escapeHtml(record[5])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>نوع العملية:</strong> ${escapeHtml(record[6])}</p>
                                        <p><strong>السبب / المشكلة:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>التاريخ:</strong> ${formatDate(record[8])}</p>
                                        <p><strong>الفني المسؤول:</strong> ${escapeHtml(record[9])}</p>
                                        <p><strong>قطع الغيار المستخدمة:</strong> ${escapeHtml(record[10])}</p>
                                        <p><strong>مدة التوقف:</strong> ${escapeHtml(record[11])}</p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <p><strong>التكلفة:</strong> ${escapeHtml(record[12])}</p>
                                        <p><strong>نتائج الاختبار بعد الصيانة:</strong> ${escapeHtml(record[13])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>الحالة بعد الصيانة:</strong> ${escapeHtml(record[14])}</p>
                                        <p><strong>المراجع:</strong> ${escapeHtml(record[15])}</p>
                                    </div>
                                </div>
                                ${record[16] ? `<p><strong>ملاحظات:</strong> ${escapeHtml(record[16])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateDevicesDetails(record, title) {
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>الرقم التعريفي:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>اسم الجهاز:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>مكانه:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>الشركة المصنعة:</strong> ${escapeHtml(record[3])}</p>
                                        <p><strong>الطراز:</strong> ${escapeHtml(record[4])}</p>
                                        <p><strong>الرقم التسلسلي:</strong> ${escapeHtml(record[5])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>الموقع:</strong> ${escapeHtml(record[6])}</p>
                                        <p><strong>الفئة:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>مجال القياس:</strong> ${escapeHtml(record[8])}</p>
                                        <p><strong>النطاق:</strong> ${escapeHtml(record[9])}</p>
                                        <p><strong>الدقة:</strong> ${escapeHtml(record[10])}</p>
                                        <p><strong>تاريخ الاستحقاق:</strong> ${formatDate(record[11])}</p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <p><strong>فترة المعايرة:</strong> ${escapeHtml(record[12])}</p>
                                        <p><strong>تاريخ آخر معايرة:</strong> ${formatDate(record[13])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>الحالة:</strong> ${escapeHtml(record[15])}</p>
                                    </div>
                                </div>
                                ${record[16] ? `<p><strong>ملاحظات:</strong> ${escapeHtml(record[16])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateFmeaDetails(record, title) {
            const occurrence = parseInt(record[4] || 0);
            const severity = parseInt(record[5] || 0);
            const detection = parseInt(record[6] || 0);
            const rpn = occurrence * severity * detection;
            
            let rpnClass = 'badge bg-success';
            if (rpn >= 200) {
                rpnClass = 'badge bg-danger';
            } else if (rpn >= 100) {
                rpnClass = 'badge bg-warning text-dark';
            }
            
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>الجهاز:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>العطل:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>التأثير:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>السبب:</strong> ${escapeHtml(record[3])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>معدل التكرار (O):</strong> ${occurrence}</p>
                                        <p><strong>درجة الشدة (S):</strong> ${severity}</p>
                                        <p><strong>معدل الكشف (D):</strong> ${detection}</p>
                                        <p><strong>RPN (O×S×D):</strong> <span class="${rpnClass}">${rpn}</span></p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <p><strong>الإجراءات التصحيحية:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>المسؤول:</strong> ${escapeHtml(record[8])}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateCorrectiveDetails(record, title) {
            let statusClass = 'badge bg-secondary';
            if (record[8] === 'مفتوح') {
                statusClass = 'badge bg-danger';
            } else if (record[8] === 'قيد المتابعة') {
                statusClass = 'badge bg-warning text-dark';
            } else if (record[8] === 'مغلق') {
                statusClass = 'badge bg-success';
            }
            
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>التاريخ:</strong> ${formatDate(record[1])}</p>
                                        <p><strong>الجهاز / العينة:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>عدد العملاء المتأثرين:</strong> ${escapeHtml(record[4])}</p>
                                        <p><strong>الفني:</strong> ${escapeHtml(record[6])}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>المشرف:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>الحالة النهائية:</strong> <span class="${statusClass}">${escapeHtml(record[8])}</span></p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <p><strong>السبب:</strong> ${escapeHtml(record[3])}</p>
                                        <p><strong>الإجراء التصحيحي:</strong> ${escapeHtml(record[5])}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateEnvironmentalDetails(record, title) {
            let withinLimitsClass = 'badge bg-secondary';
            let withinLimitsText = escapeHtml(record[10] || '');
            if (withinLimitsText === 'نعم') {
                withinLimitsClass = 'badge bg-success';
            } else if (withinLimitsText === 'لا') {
                withinLimitsClass = 'badge bg-danger';
            }
            
            return `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header modal-header-custom">
                                <h5 class="modal-title">${title}: ${escapeHtml(record[0])}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0])}</p>
                                        <p><strong>الغرفة:</strong> ${escapeHtml(record[1])}</p>
                                        <p><strong>أجهزة المراقبة:</strong> ${escapeHtml(record[2])}</p>
                                        <p><strong>التاريخ:</strong> ${formatDate(record[3])}</p>
                                        <p><strong>الوقت:</strong> ${formatTime(record[4])}</p>
                                        <p><strong>درجة الحرارة:</strong> ${escapeHtml(record[5])}°C</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>الرطوبة:</strong> ${escapeHtml(record[6])}%RH</p>
                                        <p><strong>الاهتزاز:</strong> ${escapeHtml(record[7])}</p>
                                        <p><strong>مصدر الكهرباء:</strong> ${escapeHtml(record[8])}V</p>
                                        <p><strong>شدة الإضاءة:</strong> ${escapeHtml(record[9])}</p>
                                        <p><strong>ضمن الحدود:</strong> <span class="${withinLimitsClass}">${withinLimitsText}</span></p>
                                    </div>
                                </div>
                                ${record[11] ? `<p><strong>الملاحظات:</strong> ${escapeHtml(record[11])}</p>` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ================ DELETE FUNCTIONALITY ================
        function showDeleteModal(recordId, recordName, systemType) {
            deleteRecordId = recordId;
            deleteRecordName = recordName;
            deleteSystemType = systemType;
            
            document.getElementById('deleteRecordId').textContent = recordId || 'غير معروف';
            document.getElementById('deleteRecordName').textContent = recordName || 'غير معروف';
            
            let systemName = '';
            switch(systemType) {
                case 'calibration': systemName = 'سجلات السرية'; break;
                case 'impartiality': systemName = 'إفصاح الحيادية'; break;
                case 'contract': systemName = 'إدارة العقود'; break;
                case 'supplier': systemName = 'إدارة الموردين'; break;
                case 'calibration-mgmt': systemName = 'إدارة المعايرة'; break;
                case 'maintenance': systemName = 'إدارة الصيانة'; break;
                case 'devices': systemName = 'أجهزة المعايرة'; break;
                case 'fmea': systemName = 'تحليل المخاطر (FMEA)'; break;
                case 'corrective': systemName = 'السجلات التصحيحية'; break;
                case 'environmental': systemName = 'الظروف البيئية'; break;
                default: systemName = 'غير معروف';
            }
            
            document.getElementById('deleteSystemType').textContent = systemName;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
        
        async function confirmDelete() {
            if (!deleteRecordId || !deleteSystemType) return;
            
            const button = document.getElementById('confirmDeleteBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحذف...';
            
            try {
                let result;
                let scriptUrl;
                let deleteParam = {};
                
                switch(deleteSystemType) {
                    case 'calibration':
                        scriptUrl = CALIBRATION_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'impartiality':
                        scriptUrl = IMPARTIALITY_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'contract':
                        scriptUrl = CONTRACT_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'supplier':
                        scriptUrl = SUPPLIER_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'calibration-mgmt':
                        scriptUrl = CALIBRATION_MGMT_SCRIPT_URL;
                        deleteParam = { certificateNumber: deleteRecordId };
                        break;
                    case 'maintenance':
                        scriptUrl = MAINTENANCE_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'devices':
                        scriptUrl = DEVICES_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'fmea':
                        scriptUrl = FMEA_SCRIPT_URL;
                        deleteParam = { rowNumber: deleteRecordId };
                        break;
                    case 'corrective':
                        scriptUrl = CORRECTIVE_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    case 'environmental':
                        scriptUrl = ENVIRONMENTAL_SCRIPT_URL;
                        deleteParam = { recordId: deleteRecordId };
                        break;
                    default:
                        throw new Error('نظام غير معروف');
                }
                
                result = await callGoogleScript(scriptUrl, 'delete', deleteParam);
                
                if (result.status === 'success') {
                    showNotification(`✅ ${result.message}`, 'success');
                    
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    deleteModal.hide();
                    
                    deleteRecordId = '';
                    deleteRecordName = '';
                    deleteSystemType = '';
                    
                    loadActiveTabData();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ خطأ في الحذف`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        // ================ HELPER FUNCTIONS ================
        function updateTotalRecordsCount() {
            const total = calibrationRecords.length + impartialityRecords.length + contractRecords.length + 
                         supplierRecords.length + calibrationMgmtRecords.length + maintenanceRecords.length + 
                         devicesRecords.length + fmeaRecords.length + correctiveRecords.length + environmentalRecords.length;
            document.getElementById('totalRecords').textContent = total.toLocaleString('ar-SA');
        }
    </script>
</body>
</html>
