<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qualitech International - MechNova</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        // Debugging flag - set to true to see console logs
        const DEBUG = true;
        
        // Your GitHub repository details
        const repoOwner = 'Qualinova7';
        const repoName = 'QualiNova';
        
        // Mock data for fallback
        const mockVisitFiles = [
            "A_CTOR_05_25_2025.xlsx",
            "A_ABC_05_20_2025.xlsx",
            "A_ABC_04_15_2025.xlsx",
            "A_DELTA_03_10_2025.xlsx",
            "A_GLOBAL_02_05_2025.xlsx"
        ];

        // Function to log debug messages
        function debugLog(message) {
            if (DEBUG) {
                console.log(`[DEBUG] ${message}`);
            }
        }

        // Function to update Egypt date and time
        function updateEgyptDateTime() {
            const options = {
                timeZone: 'Africa/Cairo',
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            
            const now = new Date();
            const egyptDateTime = now.toLocaleString('en-US', options);
            document.getElementById('egyptDateTime').textContent = egyptDateTime;
        }

        // Function to fetch visit files from GitHub recursively
        async function fetchVisitFiles() {
            try {
                debugLog("Attempting to fetch files from GitHub...");
                const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`GitHub API responded with status ${response.status}`);
                }
                
                const contents = await response.json();
                debugLog("Successfully fetched initial contents from GitHub");
                
                // Get all folders (directories) in the root
                const folders = contents.filter(item => item.type === 'dir');
                
                // Fetch files from each folder
                let allFiles = [];
                for (const folder of folders) {
                    try {
                        const folderResponse = await fetch(folder.url);
                        if (!folderResponse.ok) continue;
                        
                        const folderContents = await folderResponse.json();
                        const folderFiles = folderContents
                            .filter(item => item.type === 'file')
                            .map(item => ({
                                name: item.name,
                                path: `${folder.name}/${item.name}`,
                                client: folder.name.toUpperCase()
                            }));
                        
                        allFiles = [...allFiles, ...folderFiles];
                    } catch (error) {
                        debugLog(`Error fetching folder ${folder.name}: ${error.message}`);
                        continue;
                    }
                }
                
                // Filter for Excel files with the correct naming pattern
                const visitFiles = allFiles
                    .filter(file => file.name.match(/^A_[^_]+_\d{2}_\d{2}_\d{4}\.xlsx$/i))
                    .map(file => ({
                        filename: file.path,
                        client: file.client
                    }));
                
                debugLog(`Found ${visitFiles.length} valid visit files`);
                return visitFiles.length > 0 ? visitFiles : mockVisitFiles.map(f => ({ filename: f, client: f.split('_')[1].toUpperCase() }));
                
            } catch (error) {
                debugLog(`Error fetching files: ${error.message}. Using mock data as fallback.`);
                return mockVisitFiles.map(f => ({ filename: f, client: f.split('_')[1].toUpperCase() }));
            }
        }

        // Function to extract client names from visit files
        function getClientNamesFromFiles(files) {
            const clients = new Set();
            files.forEach(file => {
                clients.add(file.client);
            });
            return Array.from(clients).sort();
        }

        // Function to process visits for a specific client
        function processVisitsForClient(files, clientName) {
            return files
                .filter(file => file.client === clientName.toUpperCase())
                .map(file => {
                    const dateMatch = file.filename.match(/_(\d{2})_(\d{2})_(\d{4})\./i);
                    if (dateMatch) {
                        const [_, month, day, year] = dateMatch;
                        return {
                            filename: file.filename,
                            date: new Date(`${year}-${month}-${day}`),
                            displayName: `Visit ${month}/${day}/${year}`,
                            client: file.client
                        };
                    }
                    return {
                        filename: file.filename,
                        date: new Date(0),
                        displayName: file.filename,
                        client: file.client
                    };
                })
                .sort((a, b) => b.date - a.date);
        }

        // [Rest of your existing JavaScript functions remain exactly the same until displayExcelDataFromUrl]

        // Modified function to display Excel data from a URL with the new path structure
async function displayExcelDataFromUrl(url, clientName, visitDate) {
    debugLog(`Fetching Excel file from: ${url}`);

    const dataDisplayContainer = document.getElementById('dataDisplayContainer');
    const calibrationData = document.getElementById('calibrationData');

    dataDisplayContainer.style.display = 'block';
    calibrationData.innerHTML = '<div class="loading">Loading calibration data...</div>';

    try {
        // Fixed raw URL format
        const fileUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${url}`;
        debugLog(`Constructed file URL: ${fileUrl}`);

        const response = await fetch(fileUrl);
        if (!response.ok) {
            throw new Error(`Failed to fetch Excel file: ${response.status}`);
        }

        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });

        // Process the workbook
        processExcelData(workbook, clientName, visitDate);

    } catch (error) {
        debugLog(`Error processing Excel file: ${error.message}`);
        calibrationData.innerHTML = `<div class="error-message">Error loading calibration data: ${error.message}</div>`;
    }
}

        // [All remaining JavaScript functions stay exactly the same]

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            updateEgyptDateTime();
            setInterval(updateEgyptDateTime, 1000);
            
            document.getElementById('visitsButton').addEventListener('click', showAllVisits);
            document.getElementById('backButton').addEventListener('click', () => {
                document.getElementById('mainContent').style.display = 'flex';
                document.getElementById('visitsContainer').style.display = 'none';
                document.getElementById('fileUploadContainer').style.display = 'none';
                document.getElementById('dataDisplayContainer').style.display = 'none';
            });
            
            document.getElementById('uploadButton').addEventListener('click', () => {
                document.getElementById('excelFileInput').click();
            });
            
            document.getElementById('excelFileInput').addEventListener('change', handleFileUpload);
            
            populateClientList();
        });
    </script>
</body>
</html>
