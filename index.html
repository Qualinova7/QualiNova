<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous meta tags and styles remain the same -->
    <style>
        /* Add these new styles */
        .device-table {
            width: 100%;
            margin: 30px 0;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .device-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 2px solid #2c3e50;
        }

        .device-table td {
            padding: 12px;
            border: 1px solid #e0e0e0;
        }

        .vertical-table {
            display: grid;
            grid-template-columns: 200px auto;
        }

        .vertical-table-row {
            display: contents;
        }

        .vertical-table-row > div {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .vertical-table-header {
            font-weight: bold;
            background: #f8f9fa;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .results-table th {
            background: #3498db;
            color: white;
            padding: 8px;
        }

        .results-table td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        .status-cell {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }

        .data-container {
            padding: 20px;
            background: white;
            margin: 20px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
    <!-- Include SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Previous HTML structure remains the same until the visits-container -->

    <div class="visits-container" id="visitsContainer">
        <button class="back-button" id="backButton">← Back to Dashboard</button>
        <h2>Client Visits</h2>
        <div id="clientVisitsList" class="loading">Loading visits...</div>
        <div id="excelDataContainer" class="data-container"></div>
    </div>

    <script>
        // Add these new functions for Excel processing
        async function parseExcel(fileUrl) {
            try {
                const response = await fetch(fileUrl);
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const container = document.getElementById('excelDataContainer');
                container.innerHTML = '';
                
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    processSheetData(jsonData, container);
                });
                
            } catch (error) {
                console.error('Error processing Excel file:', error);
                alert('Error processing Excel file. Please check the format.');
            }
        }

        function processSheetData(data, container) {
            let currentDevice = null;
            let refReadPairs = [];
            let clientName = '';
            let visitDate = '';

            data.forEach((row, index) => {
                if (row[0] && row[0].includes('$#')) {
                    if (currentDevice) {
                        createDeviceTable(currentDevice, refReadPairs, container, clientName, visitDate);
                    }
                    
                    // Extract client name and visit date from filename
                    const filename = decodeURIComponent(window.location.href.split('/').pop());
                    const clientMatch = filename.match(/A_([^_]+)_/);
                    clientName = clientMatch ? clientMatch[1] : 'Unknown Client';
                    const dateMatch = filename.match(/(\d{2})_(\d{2})_(\d{4})/);
                    visitDate = dateMatch ? `${dateMatch[1]}/${dateMatch[2]}/${dateMatch[3]}` : 'Unknown Date';

                    currentDevice = {
                        line: row[1],
                        location: row[2],
                        equipment: row[3],
                        snCode: row[4],
                        rangeMin: row[5],
                        rangeMax: row[6],
                        equipmentRange: row[7],
                        maxDeviation: row[8],
                        calibrationDate: row[9],
                        expiryDate: row[10],
                        model: row[11],
                        unit: row[12],
                        resolution: row[13],
                        temp: row[14],
                        humidity: row.slice(15, 20).filter(Boolean).join(', '),
                        status: determineStatus(row.slice(-4))
                    };
                    refReadPairs = [];
                } else if (currentDevice) {
                    if (row[0] && row[0].includes('$#')) return;
                    
                    const refReads = row.slice(1).filter(Boolean);
                    for (let i = 0; i < refReads.length; i += 2) {
                        if (refReads[i]) {
                            refReadPairs.push({
                                ref: refReads[i],
                                read: refReads[i+1] || 'N/A'
                            });
                        }
                    }
                }
            });

            if (currentDevice) {
                createDeviceTable(currentDevice, refReadPairs, container, clientName, visitDate);
            }
        }

        function createDeviceTable(device, refReads, container, clientName, visitDate) {
            const table = document.createElement('div');
            table.className = 'device-table';
            
            // Create header with client name and visit date
            const header = document.createElement('div');
            header.className = 'device-header';
            header.innerHTML = `
                <div>Client: ${clientName}</div>
                <div>Visit Date: ${visitDate}</div>
            `;
            table.appendChild(header);

            // Create vertical table for device data
            const verticalTable = document.createElement('div');
            verticalTable.className = 'vertical-table';
            
            const fields = [
                ['Line', device.line],
                ['Location', device.location],
                ['Description Of Equipment', device.equipment],
                ['S/N Code', device.snCode],
                ['Working Range min', device.rangeMin],
                ['Working Range max', device.rangeMax],
                ['Equipment Range', device.equipmentRange],
                ['Max Accepted Deviation', device.maxDeviation],
                ['Calibration Date', device.calibrationDate],
                ['Calibration Expiry Date', device.expiryDate],
                ['Model', device.model],
                ['Unit', device.unit],
                ['Resolution', device.resolution],
                ['Environment ºC', device.temp],
                ['Environment % rH', device.humidity]
            ];

            fields.forEach(([label, value]) => {
                const row = document.createElement('div');
                row.className = 'vertical-table-row';
                row.innerHTML = `
                    <div class="vertical-table-header">${label}</div>
                    <div>${value || 'N/A'}</div>
                `;
                verticalTable.appendChild(row);
            });

            // Add Results section
            const resultsHeader = document.createElement('div');
            resultsHeader.className = 'vertical-table-row';
            resultsHeader.innerHTML = `
                <div class="vertical-table-header">Results</div>
                <div></div>
            `;
            verticalTable.appendChild(resultsHeader);

            refReads.forEach((pair, index) => {
                const resultRow = document.createElement('div');
                resultRow.className = 'vertical-table-row';
                resultRow.innerHTML = `
                    <div></div>
                    <div style="display: flex; gap: 20px;">
                        <span>Ref${index + 1}: ${pair.ref}</span>
                        <span>Read${index + 1}: ${pair.read}</span>
                    </div>
                `;
                verticalTable.appendChild(resultRow);
            });

            // Add Status
            const statusRow = document.createElement('div');
            statusRow.className = 'vertical-table-row';
            statusRow.innerHTML = `
                <div class="vertical-table-header">Status</div>
                <div class="status-cell">${device.status}</div>
            `;
            verticalTable.appendChild(statusRow);

            table.appendChild(verticalTable);
            container.appendChild(table);
        }

        function determineStatus(statusFields) {
            if (statusFields.includes('Pass')) return 'Pass';
            if (statusFields.includes('Fail')) return 'Fail';
            if (statusFields.includes('Internal Calibration')) return 'Internal Calibration';
            if (statusFields.includes('External Calibration')) return 'External Calibration';
            return 'No Status Available';
        }

        // Modify the visit file click handler
        function handleVisitFileClick(visit) {
            const fileUrl = `https://github.com/${repoOwner}/${repoName}/raw/main/${encodeURIComponent(visit.filename)}`;
            parseExcel(fileUrl);
            document.getElementById('excelDataContainer').scrollIntoView();
        }

        // Update the click handlers in showAllVisits and showClientVisits:
        // Change window.open to handleVisitFileClick
        visitElement.addEventListener('click', () => handleVisitFileClick(visit));
    </script>
</body>
</html>
