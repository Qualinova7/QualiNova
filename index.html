<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qualitech International - MechNova</title>
    <style>
        /* [Previous CSS styles remain the same...] */

        /* New styles for device data display */
        .device-container {
            display: none;
            padding: 20px;
        }
        .device-table-container {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .device-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .device-title {
            font-weight: bold;
            font-size: 18px;
        }
        .device-date {
            color: #666;
        }
        .device-table {
            width: 100%;
            border-collapse: collapse;
        }
        .device-table th, .device-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .device-table th {
            background-color: #f2f2f2;
            width: 30%;
        }
        .device-table td {
            width: 70%;
        }
        .readings-table {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        .readings-table th, .readings-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .readings-table th {
            background-color: #f2f2f2;
        }
        .status-cell {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .status-pass {
            background-color: #d4edda;
            color: #155724;
        }
        .status-fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        .search-highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains the same until nav-bar...] -->

    <div class="nav-bar">
        <button class="nav-button">Prepare Visit</button>
        <span class="separator">|</span>
        <button class="nav-button" id="visitsButton">Visits</button>
        <span class="separator">|</span>
        <button class="nav-button" id="devicesButton">Devices</button>
        <span class="separator">|</span>
        <button class="nav-button">Reports</button>
        <span class="separator">|</span>
        <button class="nav-button">Calendar</button>
    </div>

    <!-- [Previous main-content and visits-container remain the same...] -->

    <div class="device-container" id="deviceContainer">
        <button class="back-button" id="backButtonDevices">‚Üê Back to Dashboard</button>
        <h2>Device Calibration Data</h2>
        <input type="text" class="search-bar" id="deviceSearch" placeholder="Search by S/N Code...">
        <div id="deviceDataList"></div>
    </div>

    <script>
        // [Previous constants and helper functions remain the same until...]

        // New function to parse Excel file and extract device data
        async function parseExcelFile(fileUrl) {
            try {
                debugLog(`Fetching Excel file: ${fileUrl}`);
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error('Failed to fetch Excel file');
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                
                return parseDeviceData(jsonData);
            } catch (error) {
                debugLog(`Error parsing Excel file: ${error.message}`);
                throw error;
            }
        }

        // Function to parse raw Excel data into device objects
        function parseDeviceData(data) {
            const devices = [];
            let currentDevice = null;
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                
                // Check for new device marker
                if (row[0] && row[0].toString().trim() === '$#') {
                    // Save previous device if exists
                    if (currentDevice) {
                        devices.push(currentDevice);
                    }
                    
                    // Create new device
                    currentDevice = {
                        line: row[1] || '',
                        location: row[2] || '',
                        description: row[3] || '',
                        snCode: row[4] || '',
                        workingRangeMin: row[5] || '',
                        workingRangeMax: row[6] || '',
                        equipmentRange: row[7] || '',
                        maxDeviation: row[8] || '',
                        calibrationDate: row[9] || '',
                        expiryDate: row[10] || '',
                        model: row[11] || '',
                        unit: row[12] || '',
                        resolution: row[13] || '',
                        environmentTemp: row[14] || '',
                        environmentHumidity: row[15] || '',
                        readings: [],
                        status: ''
                    };
                    
                    // Check for status in last 4 columns
                    for (let j = row.length - 4; j < row.length; j++) {
                        if (row[j] && row[j].toString().toUpperCase().includes('C')) {
                            currentDevice.status = row[j];
                            break;
                        }
                    }
                } 
                // If we're processing readings for current device
                else if (currentDevice && row[1]) {
                    const readingsRow = [];
                    for (let j = 1; j < row.length; j += 2) {
                        if (row[j] || row[j+1]) {
                            readingsRow.push({
                                ref: row[j] || '',
                                read: row[j+1] || ''
                            });
                        } else {
                            break;
                        }
                    }
                    if (readingsRow.length > 0) {
                        currentDevice.readings.push(...readingsRow);
                    }
                }
            }
            
            // Add the last device if exists
            if (currentDevice) {
                devices.push(currentDevice);
            }
            
            return devices;
        }

        // Function to display device data for a visit
        async function displayDeviceData(visitFilename, clientName, visitDate) {
            try {
                const fileUrl = `https://github.com/${repoOwner}/${repoName}/raw/main/${encodeURIComponent(visitFilename)}`;
                const devices = await parseExcelFile(fileUrl);
                
                const container = document.createElement('div');
                container.className = 'visit-devices-container';
                
                const visitHeader = document.createElement('h3');
                visitHeader.textContent = `${clientName} - ${visitDate}`;
                container.appendChild(visitHeader);
                
                devices.forEach(device => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.className = 'device-table-container';
                    deviceDiv.dataset.snCode = device.snCode.toLowerCase();
                    deviceDiv.dataset.visitDate = visitDate;
                    
                    // Device header with client name and date
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'device-header';
                    headerDiv.innerHTML = `
                        <div class="device-title">${device.description}</div>
                        <div class="device-date">${visitDate}</div>
                    `;
                    deviceDiv.appendChild(headerDiv);
                    
                    // Main device table
                    const table = document.createElement('table');
                    table.className = 'device-table';
                    table.innerHTML = `
                        <tr><th>Line</th><td>${device.line}</td></tr>
                        <tr><th>Location</th><td>${device.location}</td></tr>
                        <tr><th>Description</th><td>${device.description}</td></tr>
                        <tr><th>S/N Code</th><td>${device.snCode}</td></tr>
                        <tr><th>Working Range Min</th><td>${device.workingRangeMin}</td></tr>
                        <tr><th>Working Range Max</th><td>${device.workingRangeMax}</td></tr>
                        <tr><th>Equipment Range</th><td>${device.equipmentRange}</td></tr>
                        <tr><th>Max Accepted Deviation</th><td>${device.maxDeviation}</td></tr>
                        <tr><th>Calibration Date</th><td>${device.calibrationDate}</td></tr>
                        <tr><th>Calibration Expiry</th><td>${device.expiryDate}</td></tr>
                        <tr><th>Model</th><td>${device.model}</td></tr>
                        <tr><th>Unit</th><td>${device.unit}</td></tr>
                        <tr><th>Resolution</th><td>${device.resolution}</td></tr>
                        <tr><th>Environment Temp</th><td>${device.environmentTemp}</td></tr>
                        <tr><th>Environment Humidity</th><td>${device.environmentHumidity}</td></tr>
                    `;
                    deviceDiv.appendChild(table);
                    
                    // Readings table if exists
                    if (device.readings.length > 0) {
                        const readingsHeader = document.createElement('h4');
                        readingsHeader.textContent = 'Readings';
                        deviceDiv.appendChild(readingsHeader);
                        
                        const readingsTable = document.createElement('table');
                        readingsTable.className = 'readings-table';
                        
                        // Create header row
                        const headerRow = document.createElement('tr');
                        for (let i = 0; i < device.readings.length; i++) {
                            const th = document.createElement('th');
                            th.textContent = `Ref${i+1}`;
                            headerRow.appendChild(th);
                            
                            const th2 = document.createElement('th');
                            th2.textContent = `Read${i+1}`;
                            headerRow.appendChild(th2);
                        }
                        readingsTable.appendChild(headerRow);
                        
                        // Create data row
                        const dataRow = document.createElement('tr');
                        device.readings.forEach(reading => {
                            const td = document.createElement('td');
                            td.textContent = reading.ref;
                            dataRow.appendChild(td);
                            
                            const td2 = document.createElement('td');
                            td2.textContent = reading.read;
                            dataRow.appendChild(td2);
                        });
                        readingsTable.appendChild(dataRow);
                        
                        deviceDiv.appendChild(readingsTable);
                    }
                    
                    // Status
                    const statusDiv = document.createElement('div');
                    statusDiv.className = `status-cell ${device.status.includes('P') ? 'status-pass' : 'status-fail'}`;
                    statusDiv.textContent = device.status || 'Status not available';
                    deviceDiv.appendChild(statusDiv);
                    
                    container.appendChild(deviceDiv);
                });
                
                return container;
            } catch (error) {
                debugLog(`Error displaying device data: ${error.message}`);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'Error loading device data';
                return errorDiv;
            }
        }

        // Function to show all devices grouped by client
        async function showAllDevices() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('visitsContainer').style.display = 'none';
            const deviceContainer = document.getElementById('deviceContainer');
            deviceContainer.style.display = 'block';
            
            const deviceList = document.getElementById('deviceDataList');
            deviceList.innerHTML = '<div class="loading">Loading device data...</div>';
            
            try {
                const visitFiles = await fetchVisitFiles();
                const clients = getClientNamesFromFiles(visitFiles);
                deviceList.innerHTML = '';
                
                for (const client of clients) {
                    const clientHeader = document.createElement('h3');
                    clientHeader.textContent = client;
                    deviceList.appendChild(clientHeader);
                    
                    const clientDevicesContainer = document.createElement('div');
                    clientDevicesContainer.className = 'client-devices-container';
                    
                    // Get visits for this client (newest first)
                    const visits = await getVisitsForClient(client.replace(/\s+/g, '').toLowerCase());
                    
                    for (const visit of visits) {
                        const dateMatch = visit.filename.match(/_(\d{2})_(\d{2})_(\d{4})\./);
                        const visitDate = dateMatch ? `${dateMatch[1]}/${dateMatch[2]}/${dateMatch[3]}` : '';
                        
                        const visitDevices = await displayDeviceData(visit.filename, client, visitDate);
                        clientDevicesContainer.appendChild(visitDevices);
                    }
                    
                    deviceList.appendChild(clientDevicesContainer);
                }
                
                // Setup search functionality
                document.getElementById('deviceSearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const allDevices = document.querySelectorAll('.device-table-container');
                    
                    allDevices.forEach(device => {
                        const snCode = device.dataset.snCode;
                        const matches = snCode.includes(searchTerm);
                        device.style.display = matches ? 'block' : 'none';
                        
                        // Highlight matching text
                        if (matches && searchTerm) {
                            const snCells = device.querySelectorAll('td');
                            snCells.forEach(cell => {
                                const text = cell.textContent.toLowerCase();
                                if (text.includes(searchTerm)) {
                                    cell.innerHTML = cell.textContent.replace(
                                        new RegExp(searchTerm, 'gi'),
                                        match => `<span class="search-highlight">${match}</span>`
                                    );
                                }
                            });
                        }
                    });
                });
                
            } catch (error) {
                debugLog(`Error showing all devices: ${error.message}`);
                deviceList.innerHTML = '<div class="error-message">Error loading device data</div>';
            }
        }

        // [Previous event listeners...]

        // Add new event listeners
        document.getElementById('devicesButton').addEventListener('click', showAllDevices);
        document.getElementById('backButtonDevices').addEventListener('click', () => {
            document.getElementById('mainContent').style.display = 'flex';
            document.getElementById('deviceContainer').style.display = 'none';
        });

        // Modify visit click handler to show device data
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('visit-file')) {
                e.preventDefault();
                const visitItem = e.target.closest('.visit-file');
                const visitFilename = visitItem.dataset.filename;
                const clientName = visitItem.closest('.client-arrow').querySelector('span').textContent;
                const visitDate = visitItem.textContent.replace('VISIT ', '');
                
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('visitsContainer').style.display = 'none';
                const deviceContainer = document.getElementById('deviceContainer');
                deviceContainer.style.display = 'block';
                
                const deviceList = document.getElementById('deviceDataList');
                deviceList.innerHTML = '<div class="loading">Loading device data...</div>';
                
                try {
                    const devices = await displayDeviceData(visitFilename, clientName, visitDate);
                    deviceList.innerHTML = '';
                    deviceList.appendChild(devices);
                } catch (error) {
                    deviceList.innerHTML = '<div class="error-message">Error loading device data</div>';
                }
            }
        });

        // [Rest of your initialization code...]

        // Load XLSX library dynamically
        function loadXLSX() {
            return new Promise((resolve, reject) => {
                if (typeof XLSX !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize the page with XLSX loading
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadXLSX();
                updateEgyptDateTime();
                setInterval(updateEgyptDateTime, 1000);
                
                document.getElementById('visitsButton').addEventListener('click', showAllVisits);
                document.getElementById('backButton').addEventListener('click', () => {
                    document.getElementById('mainContent').style.display = 'flex';
                    document.getElementById('visitsContainer').style.display = 'none';
                });
                
                populateClientList();
            } catch (error) {
                console.error('Failed to load XLSX library:', error);
            }
        });
    </script>
</body>
</html>
