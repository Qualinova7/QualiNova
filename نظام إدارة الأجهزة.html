<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة معايرة الأجهزة المتكامل - معمل كواليتك إنترناشيونال</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --calibration-color: #3498db;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, var(--calibration-color), #2980b9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .main-header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .main-header .lead {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        /* Home Button */
        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
            white-space: nowrap;
        }
        
        .home-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .home-button i {
            margin-right: 5px;
        }
        
        /* Statistics Cards */
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stats-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .stats-icon.total { background: rgba(52, 152, 219, 0.1); color: var(--calibration-color); }
        .stats-icon.active { background: rgba(39, 174, 96, 0.1); color: var(--success-color); }
        .stats-icon.due { background: rgba(243, 156, 18, 0.1); color: var(--warning-color); }
        .stats-icon.category { background: rgba(155, 89, 182, 0.1); color: #9b59b6; }
        
        /* Card Styles */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-custom {
            padding: 15px 20px;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .card-header-calibration {
            background: linear-gradient(135deg, var(--calibration-color), #2980b9);
        }
        
        /* Form Styles */
        .form-control-custom, .form-select-custom, .form-textarea-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control-custom:focus, .form-select-custom:focus, .form-textarea-custom:focus {
            border-color: var(--calibration-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
            background: white;
        }
        
        .form-textarea-custom {
            min-height: 70px;
            resize: vertical;
        }
        
        .form-label-custom {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Form Sections */
        .form-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section-title {
            color: var(--calibration-color);
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Upload File Button Styles */
        .upload-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .upload-container:hover {
            background: #e9ecef;
            border-color: var(--calibration-color);
        }
        
        .upload-container.dragover {
            background: #e3f2fd;
            border-color: var(--calibration-color);
            border-style: solid;
        }
        
        .upload-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #5a6268;
        }
        
        .upload-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        
        .upload-status {
            margin-top: 10px;
            font-size: 0.85rem;
            min-height: 20px;
        }
        
        .upload-status.success {
            color: var(--success-color);
        }
        
        .upload-status.error {
            color: var(--danger-color);
        }
        
        .upload-status.loading {
            color: var(--calibration-color);
        }
        
        .file-link-btn {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .file-link-btn:hover {
            background: #219653;
            color: white;
            text-decoration: none;
        }
        
        /* Date Input Styling */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .date-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--calibration-color);
            pointer-events: none;
        }
        
        .date-input-wrapper .form-control-custom {
            padding-right: 40px;
            direction: ltr;
            text-align: right;
        }
        
        /* DataTables Customization */
        .dataTables_wrapper {
            padding: 0;
        }
        
        .dataTables_length select {
            border-radius: 5px;
            padding: 5px;
        }
        
        .dataTables_filter input {
            border-radius: 5px;
            padding: 5px 10px;
            border: 1px solid #dee2e6;
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 2px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 70px;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .status-inactive {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        .status-maintenance {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--calibration-color), #2980b9);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: #212529;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        
        .spinner-border-custom {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.2rem;
        }
        
        /* FIX FOR ENGLISH DATE DISPLAY IN RTL CONTEXT */
        .english-date {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed !important;
            display: inline-block;
        }
        
        /* Frequency Input Group */
        .frequency-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .frequency-input {
            flex: 1;
        }
        
        .frequency-options {
            display: flex;
            gap: 5px;
        }
        
        .frequency-btn {
            padding: 5px 10px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .frequency-btn:hover {
            background: #dee2e6;
        }
        
        .frequency-btn.active {
            background: var(--calibration-color);
            color: white;
            border-color: var(--calibration-color);
        }
        
        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .filter-btn.active {
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }
        
        .filter-btn-all {
            background: var(--calibration-color);
            color: white;
        }
        
        .filter-btn-due {
            background: var(--warning-color);
            color: white;
        }
        
        .filter-btn-inactive {
            background: var(--danger-color);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 1px;
                min-width: 60px;
            }
            
            .home-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
            
            .main-header {
                padding-top: 60px;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--calibration-color);
            border-radius: 10px;
        }
        
        /* Modal Custom */
        .modal-header-custom {
            background: linear-gradient(135deg, var(--calibration-color), #2980b9);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Autofill dropdown styles */
        .autofill-options {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 5px;
            display: none;
        }
        
        .autofill-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autofill-option:hover {
            background-color: #f0f0f0;
        }
        
        .autofill-container {
            position: relative;
        }
        
        /* Due date warning */
        .due-soon {
            color: var(--warning-color) !important;
            font-weight: bold;
        }
        
        .overdue {
            color: var(--danger-color) !important;
            font-weight: bold;
        }
        
        /* Filter active indicator */
        .filter-active {
            position: relative;
        }
        
        .filter-active::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--calibration-color);
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Main Container -->
    <div class="container-fluid main-container">
        <!-- Main Header -->
        <div class="main-header fade-in">
            <!-- Return to Home Button -->
            <a href="https://qualinova7.github.io/QualiNova/" class="home-button">
                <i class="fas fa-home"></i> العودة للرئيسية
            </a>
            
            <div class="header-content">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="fas fa-tools me-2"></i> نظام إدارة معايرة الأجهزة المتكامل</h1>
                        <p class="lead mb-0">نظام متكامل لتسجيل وإدارة معايرة الأجهزة والمعايير الداخلية والخارجية</p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <div class="header-badge d-inline-block me-3">
                            <i class="fas fa-database me-2"></i>
                            <span id="totalRecords">0</span> جهاز
                        </div>
                        <div class="header-badge d-inline-block">
                            <i class="fas fa-calendar me-2"></i>
                            <span id="currentDate">--/--/----</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Section -->
        <div class="row mb-4" id="statisticsSection">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-icon total">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h4 id="statsTotal">0</h4>
                    <p class="text-muted mb-0">إجمالي الأجهزة</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-icon active">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h4 id="statsActive">0</h4>
                    <p class="text-muted mb-0">أجهزة نشطة</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-icon due">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h4 id="statsDue">0</h4>
                    <p class="text-muted mb-0">معايرة مستحقة</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-icon category">
                        <i class="fas fa-list"></i>
                    </div>
                    <h4 id="statsCategories">0</h4>
                    <p class="text-muted mb-0">فئة مختلفة</p>
                </div>
            </div>
        </div>
        
        <!-- Form Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-calibration d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tools me-2"></i> إدارة أجهزة المعايرة</span>
                        <button type="button" class="btn btn-light btn-sm" onclick="toggleFormSection()">
                            <i class="fas fa-chevron-up" id="formToggleIcon"></i>
                        </button>
                    </div>
                    <div class="card-body" id="formSection">
                        <form id="calibrationForm">
                            <!-- Section 1: Basic Information -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-info-circle"></i> المعلومات الأساسية
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">رقم السجل *</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_recordId" placeholder="رقم السجل" required oninput="checkDuplicateRecordNumber()">
                                        <div class="form-text text-danger duplicate-warning" id="duplicateRecordNumberWarning" style="display: none;">
                                            <i class="fas fa-exclamation-triangle me-1"></i> هذا الرقم موجود مسبقاً في النظام!
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">اسم الجهاز *</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_deviceName" placeholder="اسم الجهاز" required>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الشركة المصنعة</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_manufacturer" placeholder="الشركة المصنعة">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الطراز</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_model" placeholder="طراز الجهاز">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الموقع</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_location" placeholder="موقع الجهاز">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الرقم التسلسلي</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_serialNumber" placeholder="الرقم التسلسلي">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الكود الداخلي</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_internalCode" placeholder="الكود الداخلي">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الفئة</label>
                                        <select class="form-select form-select-custom" id="calibration_category">
                                            <option value="">اختر الفئة</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label-custom">الوصف</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_description" placeholder="وصف الجهاز">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label-custom">الأولوية</label>
                                        <select class="form-select form-select-custom" id="calibration_priority">
                                            <option value="">اختر الأولوية</option>
                                            <option value="عالية">عالية</option>
                                            <option value="متوسطة">متوسطة</option>
                                            <option value="منخفضة">منخفضة</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label-custom">حالة الجهاز</label>
                                        <select class="form-select form-select-custom" id="calibration_deviceStatus">
                                            <option value="نشط">نشط</option>
                                            <option value="غير نشط">غير نشط</option>
                                            <option value="صيانة">صيانة</option>
                                            <option value="معطّل">معطّل</option>
                                            <option value="مستبعد">مستبعد</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section 2: Device Specifications -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-ruler"></i> مواصفات الجهاز
                                </div>
                                <div class="row">
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">نطاق الجهاز من</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_deviceRangeFrom" placeholder="من">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">نطاق الجهاز إلى</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_deviceRangeTo" placeholder="إلى">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">وحدة نطاق الجهاز</label>
                                        <select class="form-select form-select-custom" id="calibration_deviceRangeUnit">
                                            <option value="">اختر الوحدة</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">نطاق التشغيل من</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_operatingRangeFrom" placeholder="من">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">نطاق التشغيل إلى</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_operatingRangeTo" placeholder="إلى">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">وحدة نطاق التشغيل</label>
                                        <select class="form-select form-select-custom" id="calibration_operatingRangeUnit">
                                            <option value="">اختر الوحدة</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">أقصى انحراف</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_maxDeviation" placeholder="أقصى انحراف">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">وحدة أقصى انحراف</label>
                                        <select class="form-select form-select-custom" id="calibration_maxDeviationUnit">
                                            <option value="">اختر الوحدة</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">عدم اليقين</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_uncertainty" placeholder="عدم اليقين">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">وحدة عدم اليقين</label>
                                        <select class="form-select form-select-custom" id="calibration_uncertaintyUnit">
                                            <option value="">اختر الوحدة</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section 3: Internal Calibration -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-cogs"></i> معايرة داخلية
                                </div>
                                
                                <!-- Internal Calibration Certificate Upload -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="upload-container" id="internalUploadContainer">
                                            <h6><i class="fas fa-cloud-upload-alt me-2"></i>رفع شهادة المعايرة الداخلية (PDF أو صورة)</h6>
                                            <p class="text-muted mb-2" style="font-size: 0.85rem;">الحد الأقصى لحجم الملف: 10 ميجابايت. الأنواع المسموحة: PNG, JPG, JPEG, PDF</p>
                                            
                                            <input type="file" id="internalFileInput" 
                                                   accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf"
                                                   style="display: none">
                                            <button type="button" class="upload-btn" onclick="document.getElementById('internalFileInput').click()">
                                                <i class="fas fa-folder-open me-1"></i> اختر ملف للرفع
                                            </button>
                                            <button type="button" class="upload-btn" onclick="uploadInternalFile()" id="internalUploadBtn">
                                                <i class="fas fa-upload me-1"></i> رفع الملف
                                            </button>
                                            
                                            <div class="upload-status" id="internalUploadStatus"></div>
                                            
                                            <div id="internalUploadedFileInfo" style="display: none; margin-top: 10px;">
                                                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                                                    <div>
                                                        <i class="fas fa-file me-2"></i>
                                                        <span id="internalUploadedFileName"></span>
                                                        <span class="badge bg-success ms-2" id="internalUploadedFileSize"></span>
                                                    </div>
                                                    <a href="#" target="_blank" class="file-link-btn" id="internalUploadedFileLink" style="display: none;">
                                                        <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ المعايرة الداخلية</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="calibration_internalCalibrationDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">التكرار (بالأيام)</label>
                                        <div class="frequency-group">
                                            <div class="frequency-input">
                                                <input type="number" class="form-control form-control-custom" id="calibration_internalCalibrationFrequency" placeholder="عدد الأيام" min="1" value="365" onchange="calculateInternalDueDate()" oninput="calculateInternalDueDate()">
                                            </div>
                                            <div class="frequency-options">
                                                <button type="button" class="frequency-btn active" onclick="setInternalFrequency(365)">365</button>
                                                <button type="button" class="frequency-btn" onclick="setInternalFrequency(180)">180</button>
                                                <button type="button" class="frequency-btn" onclick="setInternalFrequency(90)">90</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ استحقاق المعايرة الداخلية</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="calibration_internalCalibrationDueDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2 autofill-container">
                                        <label class="form-label-custom">تمت المعايرة بواسطة</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_internalCalibratedBy" placeholder="اسم المعاير" list="employeeList">
                                        <datalist id="employeeList"></datalist>
                                        <div class="autofill-options" id="internalCalibratorOptions"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section 4: External Calibration -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-industry"></i> معايرة خارجية
                                </div>
                                
                                <!-- External Calibration Certificate Upload -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="upload-container" id="externalUploadContainer">
                                            <h6><i class="fas fa-cloud-upload-alt me-2"></i>رفع شهادة المعايرة الخارجية (PDF أو صورة)</h6>
                                            <p class="text-muted mb-2" style="font-size: 0.85rem;">الحد الأقصى لحجم الملف: 10 ميجابايت. الأنواع المسموحة: PNG, JPG, JPEG, PDF</p>
                                            
                                            <input type="file" id="externalFileInput" 
                                                   accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf"
                                                   style="display: none">
                                            <button type="button" class="upload-btn" onclick="document.getElementById('externalFileInput').click()">
                                                <i class="fas fa-folder-open me-1"></i> اختر ملف للرفع
                                            </button>
                                            <button type="button" class="upload-btn" onclick="uploadExternalFile()" id="externalUploadBtn">
                                                <i class="fas fa-upload me-1"></i> رفع الملف
                                            </button>
                                            
                                            <div class="upload-status" id="externalUploadStatus"></div>
                                            
                                            <div id="externalUploadedFileInfo" style="display: none; margin-top: 10px;">
                                                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                                                    <div>
                                                        <i class="fas fa-file me-2"></i>
                                                        <span id="externalUploadedFileName"></span>
                                                        <span class="badge bg-success ms-2" id="externalUploadedFileSize"></span>
                                                    </div>
                                                    <a href="#" target="_blank" class="file-link-btn" id="externalUploadedFileLink" style="display: none;">
                                                        <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ المعايرة الخارجية</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="calibration_externalCalibrationDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">التكرار (بالأيام)</label>
                                        <div class="frequency-group">
                                            <div class="frequency-input">
                                                <input type="number" class="form-control form-control-custom" id="calibration_externalCalibrationFrequency" placeholder="عدد الأيام" min="1" value="365" onchange="calculateExternalDueDate()" oninput="calculateExternalDueDate()">
                                            </div>
                                            <div class="frequency-options">
                                                <button type="button" class="frequency-btn active" onclick="setExternalFrequency(365)">365</button>
                                                <button type="button" class="frequency-btn" onclick="setExternalFrequency(180)">180</button>
                                                <button type="button" class="frequency-btn" onclick="setExternalFrequency(90)">90</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ استحقاق المعايرة الخارجية</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="calibration_externalCalibrationDueDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2 autofill-container">
                                        <label class="form-label-custom">تمت المعايرة بواسطة</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_externalCalibratedBy" placeholder="اسم المزود" list="companiesList">
                                        <datalist id="companiesList"></datalist>
                                        <div class="autofill-options" id="externalCalibratorOptions"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section 5: Additional Information -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-link"></i> معلومات إضافية
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-2">
                                        <label class="form-label-custom">رابط البيانات ذات الصلة</label>
                                        <input type="text" class="form-control form-control-custom" id="calibration_relatedDataLink" placeholder="أدخل الرابط بالضبط كما تريده">
                                    </div>
                                    <div class="col-md-12 mb-2">
                                        <label class="form-label-custom">معلومات إضافية</label>
                                        <textarea class="form-control form-textarea-custom" id="calibration_additionalInfo" placeholder="أي معلومات إضافية عن الجهاز" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Form Buttons -->
                            <div class="row mt-3">
                                <div class="col-12 d-flex justify-content-between">
                                    <button type="button" onclick="resetCalibrationForm()" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-1"></i> مسح النموذج
                                    </button>
                                    <div>
                                        <button type="button" onclick="addCalibrationRecord()" class="btn btn-success me-2" id="calibration_addBtn">
                                            <i class="fas fa-plus me-1"></i> إضافة جديد
                                        </button>
                                        <button type="button" onclick="updateCalibrationRecord()" class="btn btn-primary" id="calibration_updateBtn" style="display: none;">
                                            <i class="fas fa-save me-1"></i> تحديث السجل
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden Fields -->
                            <input type="hidden" id="calibration_editingId">
                            <input type="hidden" id="calibration_internalRecordId">
                            <input type="hidden" id="calibration_internalCertificateLink">
                            <input type="hidden" id="calibration_externalCertificateLink">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Records Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-calibration d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i> قائمة أجهزة المعايرة</span>
                        <div>
                            <button onclick="loadCalibrationData()" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                            <button onclick="exportCalibrationCSV()" class="btn btn-light btn-sm">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                            <button onclick="printTable()" class="btn btn-light btn-sm ms-2">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <!-- Filter Buttons -->
                        <div class="filter-buttons mb-3">
                            <button onclick="filterTable('all')" class="filter-btn filter-btn-all active" id="filterAll">
                                <i class="fas fa-list"></i> عرض الكل
                            </button>
                            <button onclick="filterTable('due')" class="filter-btn filter-btn-due" id="filterDue">
                                <i class="fas fa-exclamation-triangle"></i> أجهزة تحتاج معايرة
                            </button>
                            <button onclick="filterTable('inactive')" class="filter-btn filter-btn-inactive" id="filterInactive">
                                <i class="fas fa-ban"></i> أجهزة غير نشطة
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="calibrationDataTable" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>رقم السجل</th>
                                        <th>اسم الجهاز</th>
                                        <th>الشركة المصنعة</th>
                                        <th>الطراز</th>
                                        <th>الموقع</th>
                                        <th>الرقم التسلسلي</th>
                                        <th>الفئة</th>
                                        <th>حالة الجهاز</th>
                                        <th>تاريخ استحقاق داخلي</th>
                                        <th>تاريخ استحقاق خارجي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by DataTables -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 fade-in">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-copyright me-1"></i> نظام إدارة معايرة الأجهزة المتكامل 
                    <span id="currentYear"></span> | 
                    <span class="text-info">الإصدار 2.0 </span>
                    <span class="mx-2">|</span>
                    <span id="lastUpdateTime">آخر تحديث: --:--</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تأكيد الحذف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-2x float-start me-3"></i>
                        <h5 class="alert-heading">تحذير!</h5>
                        <p>هل أنت متأكد من حذف هذا الجهاز؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                        <hr>
                        <p class="mb-0"><strong>رقم السجل:</strong> <span id="deleteRecordId">غير معروف</span></p>
                        <p class="mb-0"><strong>اسم الجهاز:</strong> <span id="deleteRecordName">غير معروف</span></p>
                        <p class="mb-0"><strong>الشركة المصنعة:</strong> <span id="deleteManufacturer">غير معروف</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> نعم، احذف السجل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تفاصيل جهاز المعايرة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-primary" onclick="printDetails()">
                        <i class="fas fa-print me-1"></i> طباعة التفاصيل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr Calendar -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    <!-- DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ================ CONFIGURATION ================
        const CALIBRATION_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZn8ah4jxwJ0jk9JtYWKJxWQIM7mArgM2qt1ZmnjGygvJwrWub4Y_MAjjVKSjEtopl1g/exec";
        const UNITS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQG8RwDs5YpVRZ56M3z4-QwjTJCR-qefAM0PrKfMZiBVnPuqfrC2mawsrXLTcCeWGG/exec";
        const UPLOAD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwj4u5FnGHcCto7LPvolgvUdifPxVAbAUBUt3mD3thFJzNm47mIkDWYPv_2YFpNkIlUGg/exec";
        const EMPLOYEE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiKkgfhdI3xaW6biMBZCCkuIN9P_6mvUQVHJWgj35kHOUvuQjduHzYfAnOCG0aHWlcpA/exec";
        
        // ================ GLOBAL VARIABLES ================
        let calibrationRecords = [];
        let unitsData = [];
        let categoriesData = [];
        let companiesData = [];
        let employeeData = [];
        let deleteRecordId = '';
        let deleteRecordName = '';
        let deleteManufacturer = '';
        let flatpickrInstances = {};
        let deleteModalInstance = null;
        let detailsModalInstance = null;
        let selectedInternalFile = null;
        let selectedExternalFile = null;
        let uploadedInternalFileUrl = '';
        let uploadedExternalFileUrl = '';
        let isDuplicateRecordNumber = false;
        let dataTable = null;
        let currentFilter = 'all';
        
        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteModal'));
            detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal'));
            
            initializeDatePickers();
            initializeFileUpload();
            initializeDataTable();
            
            setTimeout(() => {
                loadCalibrationData();
                loadStatistics();
                loadUnitsData();
                loadEmployeeData();
            }, 500);
            
            setInterval(() => {
                loadStatistics();
            }, 300000);
        });
        
        function initializeDataTable() {
            dataTable = $('#calibrationDataTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json'
                },
                responsive: true,
                pageLength: 25,
                order: [[0, 'desc']],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
                columnDefs: [
                    { responsivePriority: 1, targets: 0 },
                    { responsivePriority: 2, targets: 1 },
                    { responsivePriority: 3, targets: 10 },
                    { responsivePriority: 4, targets: 7 },
                    { responsivePriority: 5, targets: 4 }
                ]
            });
        }
        
        function initializeDatePickers() {
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: true,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        const date = selectedDates[0];
                        const formattedDate = formatDateToDDMMYYYY(date);
                        instance.input.value = formattedDate;
                        
                        if (instance.input.id === 'calibration_internalCalibrationDate') {
                            calculateInternalDueDate();
                        } else if (instance.input.id === 'calibration_externalCalibrationDate') {
                            calculateExternalDueDate();
                        }
                    }
                }
            };
            
            flatpickrInstances.internalCalibrationDate = flatpickr('#calibration_internalCalibrationDate', dateOptions);
            flatpickrInstances.internalCalibrationDueDate = flatpickr('#calibration_internalCalibrationDueDate', dateOptions);
            flatpickrInstances.externalCalibrationDate = flatpickr('#calibration_externalCalibrationDate', dateOptions);
            flatpickrInstances.externalCalibrationDueDate = flatpickr('#calibration_externalCalibrationDueDate', dateOptions);
            
            const today = new Date();
            const todayFormatted = formatDateToDDMMYYYY(today);
            
            document.getElementById('calibration_internalCalibrationDate').value = todayFormatted;
            if (flatpickrInstances.internalCalibrationDate) {
                flatpickrInstances.internalCalibrationDate.setDate(today, false);
            }
            
            document.getElementById('calibration_externalCalibrationDate').value = todayFormatted;
            if (flatpickrInstances.externalCalibrationDate) {
                flatpickrInstances.externalCalibrationDate.setDate(today, false);
            }
            
            calculateInternalDueDate();
            calculateExternalDueDate();
        }
        
        function toggleFormSection() {
            const formSection = document.getElementById('formSection');
            const toggleIcon = document.getElementById('formToggleIcon');
            
            if (formSection.style.display === 'none') {
                formSection.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                formSection.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // ================ EMPLOYEE DATA FUNCTIONS ================
        async function loadEmployeeData() {
            try {
                const res = await jsonp(`${EMPLOYEE_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                
                if (res && res.status === 'success') {
                    let records = [];
                    
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (Array.isArray(res)) {
                        records = res;
                    }
                    
                    employeeData = records;
                    populateEmployeeDatalists();
                } else {
                    console.log('Failed to load employee data');
                }
            } catch (error) {
                console.error('Error loading employee data:', error);
            }
        }
        
        function populateEmployeeDatalists() {
            const employeeList = document.getElementById('employeeList');
            employeeList.innerHTML = '';
            
            const names = new Set();
            
            employeeData.forEach(record => {
                if (record && record.length > 1 && record[1]) {
                    names.add(String(record[1]).trim());
                }
            });
            
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                employeeList.appendChild(option);
            });
        }
        
        // ================ UNITS DATA FUNCTIONS ================
        async function loadUnitsData() {
            try {
                const res = await jsonp(`${UNITS_SCRIPT_URL}?action=getAllData&t=${Date.now()}`);
                
                if (res && res.status === 'success') {
                    unitsData = res.units || [];
                    categoriesData = res.categories || [];
                    companiesData = res.companies || [];
                    
                    populateDropdowns();
                } else {
                    console.log('Failed to load units data');
                }
            } catch (error) {
                console.error('Error loading units data:', error);
            }
        }
        
        function populateDropdowns() {
            // Populate units dropdowns
            const unitSelects = [
                'calibration_deviceRangeUnit',
                'calibration_operatingRangeUnit',
                'calibration_maxDeviationUnit',
                'calibration_uncertaintyUnit'
            ];
            
            unitSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">اختر الوحدة</option>';
                
                unitsData.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    select.appendChild(option);
                });
            });
            
            // Populate categories dropdown
            const categorySelect = document.getElementById('calibration_category');
            categorySelect.innerHTML = '<option value="">اختر الفئة</option>';
            
            categoriesData.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Populate companies datalist for external calibration
            const companiesList = document.getElementById('companiesList');
            companiesList.innerHTML = '';
            
            companiesData.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                companiesList.appendChild(option);
            });
        }
        
        // ================ DATE FUNCTIONS ================
        function formatDateToDMY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `D${day} M${month} Y${year}`;
        }
        
        function parseDateFromDMY(dmyString) {
            if (!dmyString) return null;
            
            dmyString = dmyString.toString().trim();
            
            const match = dmyString.match(/^D(\d+)\s+M(\d+)\s+Y(\d+)$/);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10) - 1;
                const year = parseInt(match[3], 10);
                
                const dateObj = new Date(year, month, day);
                if (dateObj.getDate() !== day || dateObj.getMonth() !== month || dateObj.getFullYear() !== year) {
                    return null;
                }
                
                return dateObj;
            }
            
            return null;
        }
        
        function formatDMYForDisplay(dmyString) {
            if (!dmyString) return '';
            
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    if (!isNaN(regularDate.getTime())) {
                        return `<span class="english-date">${formatDateToDayMonthYear(regularDate)}</span>`;
                    }
                } catch (e) {}
                return `<span class="english-date">${dmyString}</span>`;
            }
            
            const formattedDate = formatDateToDayMonthYear(dateObj);
            return `<span class="english-date">${formattedDate}</span>`;
        }
        
        function formatDateToDayMonthYear(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            
            const day = date.getDate();
            const monthIndex = date.getMonth();
            const year = date.getFullYear();
            
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            
            return `${day} ${monthNames[monthIndex]} ${year}`;
        }
        
        function formatDMYForInput(dmyString) {
            if (!dmyString) return '';
            
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    if (!isNaN(regularDate.getTime())) {
                        return formatDateToDDMMYYYY(regularDate);
                    }
                } catch (e) {}
                return '';
            }
            
            return formatDateToDDMMYYYY(dateObj);
        }
        
        function formatDateToDDMMYYYY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    return new Date(year, month, day);
                }
            }
            
            return null;
        }
        
        function setCurrentDate() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('currentDate').textContent = `${day}/${month}/${year}`;
        }
        
        // ================ FREQUENCY FUNCTIONS - FIXED ================
        function setInternalFrequency(days) {
            const frequencyInput = document.getElementById('calibration_internalCalibrationFrequency');
            frequencyInput.value = days;
            
            // Update active button
            const frequencyGroup = frequencyInput.closest('.frequency-group');
            frequencyGroup.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === days) {
                    btn.classList.add('active');
                }
            });
            
            calculateInternalDueDate();
        }
        
        function setExternalFrequency(days) {
            const frequencyInput = document.getElementById('calibration_externalCalibrationFrequency');
            frequencyInput.value = days;
            
            // Update active button
            const frequencyGroup = frequencyInput.closest('.frequency-group');
            frequencyGroup.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === days) {
                    btn.classList.add('active');
                }
            });
            
            calculateExternalDueDate();
        }
        
        function calculateInternalDueDate() {
            const calibrationDateInput = document.getElementById('calibration_internalCalibrationDate');
            const frequencyInput = document.getElementById('calibration_internalCalibrationFrequency');
            const dueDateInput = document.getElementById('calibration_internalCalibrationDueDate');
            
            if (!calibrationDateInput.value || !frequencyInput.value) return;
            
            try {
                const calibrationDate = parseDateDDMMYYYY(calibrationDateInput.value);
                if (!calibrationDate) return;
                
                const frequency = parseInt(frequencyInput.value) || 365;
                const dueDate = new Date(calibrationDate);
                dueDate.setDate(dueDate.getDate() + frequency);
                
                const formattedDueDate = formatDateToDDMMYYYY(dueDate);
                dueDateInput.value = formattedDueDate;
                
                if (flatpickrInstances.internalCalibrationDueDate) {
                    flatpickrInstances.internalCalibrationDueDate.setDate(dueDate, false);
                }
            } catch (e) {
                console.error('Error calculating internal due date:', e);
            }
        }
        
        function calculateExternalDueDate() {
            const calibrationDateInput = document.getElementById('calibration_externalCalibrationDate');
            const frequencyInput = document.getElementById('calibration_externalCalibrationFrequency');
            const dueDateInput = document.getElementById('calibration_externalCalibrationDueDate');
            
            if (!calibrationDateInput.value || !frequencyInput.value) return;
            
            try {
                const calibrationDate = parseDateDDMMYYYY(calibrationDateInput.value);
                if (!calibrationDate) return;
                
                const frequency = parseInt(frequencyInput.value) || 365;
                const dueDate = new Date(calibrationDate);
                dueDate.setDate(dueDate.getDate() + frequency);
                
                const formattedDueDate = formatDateToDDMMYYYY(dueDate);
                dueDateInput.value = formattedDueDate;
                
                if (flatpickrInstances.externalCalibrationDueDate) {
                    flatpickrInstances.externalCalibrationDueDate.setDate(dueDate, false);
                }
            } catch (e) {
                console.error('Error calculating external due date:', e);
            }
        }
        
        // ================ FILE UPLOAD FUNCTIONS ================
        function initializeFileUpload() {
            // Internal file upload
            const internalFileInput = document.getElementById('internalFileInput');
            const internalUploadContainer = document.getElementById('internalUploadContainer');
            
            internalFileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], 'internal');
                }
            });
            
            internalUploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                internalUploadContainer.classList.add('dragover');
            });
            
            internalUploadContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                internalUploadContainer.classList.remove('dragover');
            });
            
            internalUploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                internalUploadContainer.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0], 'internal');
                }
            });
            
            // External file upload
            const externalFileInput = document.getElementById('externalFileInput');
            const externalUploadContainer = document.getElementById('externalUploadContainer');
            
            externalFileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], 'external');
                }
            });
            
            externalUploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                externalUploadContainer.classList.add('dragover');
            });
            
            externalUploadContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                externalUploadContainer.classList.remove('dragover');
            });
            
            externalUploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                externalUploadContainer.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0], 'external');
                }
            });
        }
        
        function handleFileSelect(file, type) {
            const allowedTypes = [
                "image/png",
                "image/jpeg",
                "application/pdf"
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showNotification("❌ فقط ملفات PNG, JPG, JPEG أو PDF مسموحة", "error");
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification("❌ حجم الملف كبير جداً (الحد الأقصى 10MB)", "error");
                return;
            }
            
            if (type === 'internal') {
                selectedInternalFile = file;
                document.getElementById('internalUploadedFileName').textContent = file.name;
                document.getElementById('internalUploadedFileSize').textContent = formatFileSize(file.size);
                document.getElementById('internalUploadedFileInfo').style.display = 'block';
                document.getElementById('internalUploadedFileLink').style.display = 'none';
                
                const uploadStatus = document.getElementById('internalUploadStatus');
                uploadStatus.textContent = '';
                uploadStatus.className = 'upload-status';
            } else {
                selectedExternalFile = file;
                document.getElementById('externalUploadedFileName').textContent = file.name;
                document.getElementById('externalUploadedFileSize').textContent = formatFileSize(file.size);
                document.getElementById('externalUploadedFileInfo').style.display = 'block';
                document.getElementById('externalUploadedFileLink').style.display = 'none';
                
                const uploadStatus = document.getElementById('externalUploadStatus');
                uploadStatus.textContent = '';
                uploadStatus.className = 'upload-status';
            }
            
            showNotification(`✅ تم اختيار الملف: ${file.name}`, 'success', 3000);
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' بايت';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' كيلوبايت';
            else return (bytes / 1048576).toFixed(1) + ' ميجابايت';
        }
        
        async function uploadFile(file, type) {
            const uploadBtn = type === 'internal' ? document.getElementById('internalUploadBtn') : document.getElementById('externalUploadBtn');
            const uploadStatus = type === 'internal' ? document.getElementById('internalUploadStatus') : document.getElementById('externalUploadStatus');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الرفع...';
            uploadStatus.textContent = 'جاري رفع الملف... ⏳';
            uploadStatus.className = 'upload-status loading';
            
            try {
                const reader = new FileReader();
                
                reader.onload = async function() {
                    const base64 = reader.result.split(",")[1];
                    
                    const response = await fetch(UPLOAD_WEB_APP_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            fileName: file.name,
                            mimeType: file.type,
                            fileData: base64
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === "success") {
                        if (type === 'internal') {
                            uploadedInternalFileUrl = data.url;
                            document.getElementById('calibration_internalCertificateLink').value = uploadedInternalFileUrl;
                            
                            const fileLinkBtn = document.getElementById('internalUploadedFileLink');
                            fileLinkBtn.href = uploadedInternalFileUrl;
                            fileLinkBtn.style.display = 'inline-block';
                        } else {
                            uploadedExternalFileUrl = data.url;
                            document.getElementById('calibration_externalCertificateLink').value = uploadedExternalFileUrl;
                            
                            const fileLinkBtn = document.getElementById('externalUploadedFileLink');
                            fileLinkBtn.href = uploadedExternalFileUrl;
                            fileLinkBtn.style.display = 'inline-block';
                        }
                        
                        uploadStatus.textContent = '✅ تم رفع الملف بنجاح';
                        uploadStatus.className = 'upload-status success';
                        
                        showNotification(`✅ تم رفع الملف بنجاح: ${file.name}`, 'success');
                    } else {
                        uploadStatus.textContent = '❌ فشل في رفع الملف: ' + (data.message || 'خطأ غير معروف');
                        uploadStatus.className = 'upload-status error';
                        showNotification(`❌ فشل في رفع الملف: ${data.message || 'خطأ غير معروف'}`, 'error');
                    }
                    
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                };
                
                reader.onerror = function() {
                    uploadStatus.textContent = '❌ خطأ في قراءة الملف';
                    uploadStatus.className = 'upload-status error';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                    showNotification('❌ خطأ في قراءة الملف', 'error');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                uploadStatus.textContent = '❌ فشل في رفع الملف: ' + error;
                uploadStatus.className = 'upload-status error';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                showNotification('❌ فشل في رفع الملف: ' + error, 'error');
            }
        }
        
        function uploadInternalFile() {
            if (!selectedInternalFile) {
                showNotification("⚠️ يرجى اختيار ملف أولاً", "warning");
                return;
            }
            uploadFile(selectedInternalFile, 'internal');
        }
        
        function uploadExternalFile() {
            if (!selectedExternalFile) {
                showNotification("⚠️ يرجى اختيار ملف أولاً", "warning");
                return;
            }
            uploadFile(selectedExternalFile, 'external');
        }
        
        // ================ NOTIFICATION SYSTEM ================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getNotificationIcon(type)} me-3"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            return notification;
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // ================ JSONP FUNCTION ================
        function jsonp(url, callbackParam = 'callback') {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + callbackParam + '=' + callbackName;
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // ================ STATISTICS FUNCTIONS - FIXED ================
        async function loadStatistics() {
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=getStats&t=${Date.now()}`);
                
                if (res && res.status === 'success') {
                    document.getElementById('statsTotal').textContent = res.totalDevices.toLocaleString('ar-SA');
                    document.getElementById('statsActive').textContent = res.activeDevices.toLocaleString('ar-SA');
                    
                    // Calculate due devices count locally
                    const dueCount = countDueDevices();
                    document.getElementById('statsDue').textContent = dueCount.toLocaleString('ar-SA');
                    
                    document.getElementById('statsCategories').textContent = Object.keys(res.byCategory || {}).length;
                    document.getElementById('totalRecords').textContent = res.totalDevices.toLocaleString('ar-SA');
                    
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('lastUpdateTime').textContent = `آخر تحديث: ${timeString}`;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        function countDueDevices() {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Set to beginning of day for accurate comparison
            
            let dueCount = 0;
            
            calibrationRecords.forEach(record => {
                // Column indices based on your data structure:
                // record[23] = internal due date, record[28] = external due date
                const internalDueDate = parseDateFromDMY(record[23] || '');
                const externalDueDate = parseDateFromDMY(record[28] || '');
                
                // Check if either due date has passed
                if ((internalDueDate && internalDueDate < now) || 
                    (externalDueDate && externalDueDate < now)) {
                    dueCount++;
                }
            });
            
            return dueCount;
        }
        
        // ================ DUPLICATE CHECK ================
        function checkDuplicateRecordNumber() {
            const recordNumberInput = document.getElementById('calibration_recordId');
            const recordNumber = recordNumberInput.value.trim();
            const editingId = document.getElementById('calibration_editingId').value;
            const warningElement = document.getElementById('duplicateRecordNumberWarning');
            
            if (!recordNumber) {
                warningElement.style.display = 'none';
                recordNumberInput.classList.remove('is-invalid');
                isDuplicateRecordNumber = false;
                return false;
            }
            
            const duplicateRecord = calibrationRecords.find(record => {
                if (editingId && record[0] === editingId) {
                    return false;
                }
                return record[1] && record[1].toString().trim() === recordNumber;
            });
            
            if (duplicateRecord) {
                warningElement.style.display = 'block';
                recordNumberInput.classList.add('is-invalid');
                isDuplicateRecordNumber = true;
                return true;
            } else {
                warningElement.style.display = 'none';
                recordNumberInput.classList.remove('is-invalid');
                isDuplicateRecordNumber = false;
                return false;
            }
        }
        
        // ================ VALIDATION FUNCTIONS ================
        function validateForm(requiredFields) {
            let isValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }
        
        // ================ FILTER FUNCTIONS ================
        function filterTable(filterType) {
            currentFilter = filterType;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`filter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`).classList.add('active');
            
            // Apply filter
            if (dataTable) {
                dataTable.clear();
                
                let filteredRecords = calibrationRecords;
                
                if (filterType === 'due') {
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    
                    filteredRecords = calibrationRecords.filter(record => {
                        const internalDueDate = parseDateFromDMY(record[23] || '');
                        const externalDueDate = parseDateFromDMY(record[28] || '');
                        
                        // Check if either due date has passed or is within 30 days
                        const isDue = (internalDueDate && internalDueDate < now) || 
                                     (externalDueDate && externalDueDate < now);
                        
                        // Check if due within next 30 days
                        const thirtyDaysFromNow = new Date();
                        thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                        const isDueSoon = (internalDueDate && internalDueDate <= thirtyDaysFromNow && internalDueDate >= now) ||
                                         (externalDueDate && externalDueDate <= thirtyDaysFromNow && externalDueDate >= now);
                        
                        return isDue || isDueSoon;
                    });
                } else if (filterType === 'inactive') {
                    filteredRecords = calibrationRecords.filter(record => {
                        const status = record[33] || 'نشط';
                        return status !== 'نشط';
                    });
                }
                
                // Populate table with filtered records
                filteredRecords.forEach(record => {
                    const statusClass = getStatusClass(record[33]);
                    
                    // Check if due dates are expired or near expiration
                    const internalDueDate = parseDateFromDMY(record[23] || '');
                    const externalDueDate = parseDateFromDMY(record[28] || '');
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    
                    let internalDueClass = '';
                    let externalDueClass = '';
                    
                    if (internalDueDate) {
                        if (internalDueDate < now) {
                            internalDueClass = 'overdue';
                        } else {
                            const thirtyDaysFromNow = new Date();
                            thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                            if (internalDueDate <= thirtyDaysFromNow) {
                                internalDueClass = 'due-soon';
                            }
                        }
                    }
                    
                    if (externalDueDate) {
                        if (externalDueDate < now) {
                            externalDueClass = 'overdue';
                        } else {
                            const thirtyDaysFromNow = new Date();
                            thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                            if (externalDueDate <= thirtyDaysFromNow) {
                                externalDueClass = 'due-soon';
                            }
                        }
                    }
                    
                    dataTable.row.add([
                        escapeHtml(record[1] || ''),
                        escapeHtml(record[2] || ''),
                        escapeHtml(record[3] || ''),
                        escapeHtml(record[4] || ''),
                        escapeHtml(record[5] || ''),
                        escapeHtml(record[6] || ''),
                        escapeHtml(record[9] || ''),
                        `<span class="status-badge ${statusClass}">${escapeHtml(record[33] || 'نشط')}</span>`,
                        `<span class="${internalDueClass}">${formatDMYForDisplay(record[23] || '')}</span>`,
                        `<span class="${externalDueClass}">${formatDMYForDisplay(record[28] || '')}</span>`,
                        `
                        <div class="action-buttons">
                            <button onclick="editCalibrationRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[2])}', '${escapeHtml(record[1] || '')}', '${escapeHtml(record[3] || '')}')" class="btn btn-sm btn-danger" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="viewDetails('${escapeHtml(record[0])}')" class="btn btn-sm btn-info" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        `
                    ]);
                });
                
                dataTable.draw();
                
                // Show notification
                if (filterType === 'all') {
                    showNotification(`✅ عرض جميع الأجهزة (${filteredRecords.length} جهاز)`, 'success', 3000);
                } else if (filterType === 'due') {
                    showNotification(`⚠️ عرض الأجهزة التي تحتاج معايرة (${filteredRecords.length} جهاز)`, 'warning', 3000);
                } else if (filterType === 'inactive') {
                    showNotification(`⏸️ عرض الأجهزة غير النشطة (${filteredRecords.length} جهاز)`, 'info', 3000);
                }
            }
        }
        
        // ================ CALIBRATION SYSTEM FUNCTIONS ================
        async function loadCalibrationData() {
            showNotification('📥 جاري تحميل بيانات الأجهزة...', 'info');
            
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                
                if (res && res.status === 'success') {
                    calibrationRecords = res.records || [];
                    
                    filterTable(currentFilter);
                    
                    loadStatistics();
                    showNotification(`✅ تم تحميل ${calibrationRecords.length} جهاز`, 'success');
                } else {
                    showNotification('❌ فشل في تحميل بيانات الأجهزة', 'error');
                }
            } catch (error) {
                console.error('Error loading calibration data:', error);
                showNotification('❌ خطأ في تحميل بيانات الأجهزة', 'error');
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'نشط': return 'status-active';
                case 'غير نشط': return 'status-inactive';
                case 'صيانة': return 'status-maintenance';
                case 'معطّل': return 'status-inactive';
                case 'مستبعد': return 'status-inactive';
                default: return 'status-active';
            }
        }
        
        async function addCalibrationRecord() {
            if (checkDuplicateRecordNumber()) {
                showNotification('❌ رقم السجل هذا موجود مسبقاً. يرجى استخدام رقم آخر.', 'error');
                return;
            }

            const requiredFields = ['calibration_recordId', 'calibration_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }

            const internalCalibrationDate = document.getElementById('calibration_internalCalibrationDate').value;
            const internalCalibrationDueDate = document.getElementById('calibration_internalCalibrationDueDate').value;
            const externalCalibrationDate = document.getElementById('calibration_externalCalibrationDate').value;
            const externalCalibrationDueDate = document.getElementById('calibration_externalCalibrationDueDate').value;

            const button = document.getElementById('calibration_addBtn');
            const originalHtml = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';

            const internalRecordId = 'CAL-' + Date.now();
            document.getElementById('calibration_internalRecordId').value = internalRecordId;

            const internalCertLink = document.getElementById('calibration_internalCertificateLink').value;
            const externalCertLink = document.getElementById('calibration_externalCertificateLink').value;

            const internalCalibrationDateDMY = internalCalibrationDate ? formatDateToDMY(parseDateDDMMYYYY(internalCalibrationDate)) : '';
            const internalCalibrationDueDateDMY = internalCalibrationDueDate ? formatDateToDMY(parseDateDDMMYYYY(internalCalibrationDueDate)) : '';
            const externalCalibrationDateDMY = externalCalibrationDate ? formatDateToDMY(parseDateDDMMYYYY(externalCalibrationDate)) : '';
            const externalCalibrationDueDateDMY = externalCalibrationDueDate ? formatDateToDMY(parseDateDDMMYYYY(externalCalibrationDueDate)) : '';

            const internalFrequency = document.getElementById('calibration_internalCalibrationFrequency').value;
            const externalFrequency = document.getElementById('calibration_externalCalibrationFrequency').value;

            const fields = [
                'calibration_recordId',
                'calibration_deviceName',
                'calibration_manufacturer',
                'calibration_model',
                'calibration_location',
                'calibration_serialNumber',
                'calibration_internalCode',
                'calibration_description',
                'calibration_category',
                'calibration_priority',
                'calibration_deviceRangeFrom',
                'calibration_deviceRangeTo',
                'calibration_deviceRangeUnit',
                'calibration_operatingRangeFrom',
                'calibration_operatingRangeTo',
                'calibration_operatingRangeUnit',
                'calibration_maxDeviation',
                'calibration_maxDeviationUnit',
                'calibration_uncertainty',
                'calibration_uncertaintyUnit',
                'calibration_internalCalibratedBy',
                'calibration_externalCalibratedBy',
                'calibration_relatedDataLink',
                'calibration_additionalInfo',
                'calibration_deviceStatus'
            ];

            const paramMap = {
                'calibration_recordId': 'recordId',
                'calibration_deviceName': 'deviceName',
                'calibration_manufacturer': 'manufacturer',
                'calibration_model': 'model',
                'calibration_location': 'location',
                'calibration_serialNumber': 'serialNumber',
                'calibration_internalCode': 'internalCode',
                'calibration_description': 'description',
                'calibration_category': 'category',
                'calibration_priority': 'priority',
                'calibration_deviceRangeFrom': 'deviceRangeFrom',
                'calibration_deviceRangeTo': 'deviceRangeTo',
                'calibration_deviceRangeUnit': 'deviceRangeUnit',
                'calibration_operatingRangeFrom': 'operatingRangeFrom',
                'calibration_operatingRangeTo': 'operatingRangeTo',
                'calibration_operatingRangeUnit': 'operatingRangeUnit',
                'calibration_maxDeviation': 'maxDeviation',
                'calibration_maxDeviationUnit': 'maxDeviationUnit',
                'calibration_uncertainty': 'uncertainty',
                'calibration_uncertaintyUnit': 'uncertaintyUnit',
                'calibration_internalCalibratedBy': 'internalCalibratedBy',
                'calibration_externalCalibratedBy': 'externalCalibratedBy',
                'calibration_relatedDataLink': 'relatedDataLink',
                'calibration_additionalInfo': 'additionalInfo',
                'calibration_deviceStatus': 'deviceStatus'
            };

            let q = '';
            
            fields.forEach(f => {
                const paramName = paramMap[f];
                q += `${paramName}=${encodeURIComponent(document.getElementById(f).value || '')}&`;
            });

            q += `internalCalibrationFrequency=${encodeURIComponent(internalFrequency || '365')}&`;
            q += `externalCalibrationFrequency=${encodeURIComponent(externalFrequency || '365')}&`;
            
            q += `internalCalibrationDate=${encodeURIComponent(internalCalibrationDateDMY)}&`;
            q += `internalCalibrationDueDate=${encodeURIComponent(internalCalibrationDueDateDMY)}&`;
            q += `externalCalibrationDate=${encodeURIComponent(externalCalibrationDateDMY)}&`;
            q += `externalCalibrationDueDate=${encodeURIComponent(externalCalibrationDueDateDMY)}&`;
            q += `internalCertificateLink=${encodeURIComponent(internalCertLink || '')}&`;
            q += `externalCertificateLink=${encodeURIComponent(externalCertLink || '')}`;

            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=add&${q}`);

                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    resetCalibrationForm();
                    await loadCalibrationData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في الإضافة', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editCalibrationRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات الجهاز...', 'info');
            
            const record = calibrationRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillCalibrationForm(record);
                document.getElementById('calibration_updateBtn').style.display = 'inline-block';
                document.getElementById('calibration_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات الجهاز', 'success');
            } else {
                showNotification('❌ لم يتم العثور على الجهاز', 'error');
            }
        }
        
        function fillCalibrationForm(record) {
            document.getElementById('calibration_recordId').value = record[1] || '';
            document.getElementById('calibration_deviceName').value = record[2] || '';
            document.getElementById('calibration_manufacturer').value = record[3] || '';
            document.getElementById('calibration_model').value = record[4] || '';
            document.getElementById('calibration_location').value = record[5] || '';
            document.getElementById('calibration_serialNumber').value = record[6] || '';
            document.getElementById('calibration_internalCode').value = record[7] || '';
            document.getElementById('calibration_description').value = record[8] || '';
            document.getElementById('calibration_category').value = record[9] || '';
            document.getElementById('calibration_priority').value = record[10] || '';
            document.getElementById('calibration_deviceRangeFrom').value = record[11] || '';
            document.getElementById('calibration_deviceRangeTo').value = record[12] || '';
            document.getElementById('calibration_deviceRangeUnit').value = record[13] || '';
            document.getElementById('calibration_operatingRangeFrom').value = record[14] || '';
            document.getElementById('calibration_operatingRangeTo').value = record[15] || '';
            document.getElementById('calibration_operatingRangeUnit').value = record[16] || '';
            document.getElementById('calibration_maxDeviation').value = record[17] || '';
            document.getElementById('calibration_maxDeviationUnit').value = record[18] || '';
            document.getElementById('calibration_uncertainty').value = record[19] || '';
            document.getElementById('calibration_uncertaintyUnit').value = record[20] || '';
            document.getElementById('calibration_internalCalibratedBy').value = record[24] || '';
            document.getElementById('calibration_externalCalibratedBy').value = record[29] || '';
            document.getElementById('calibration_relatedDataLink').value = record[31] || '';
            document.getElementById('calibration_additionalInfo').value = record[32] || '';
            document.getElementById('calibration_deviceStatus').value = record[33] || 'نشط';
            
            const internalCertLink = record[25] || '';
            const externalCertLink = record[30] || '';
            
            document.getElementById('calibration_internalCertificateLink').value = internalCertLink;
            document.getElementById('calibration_externalCertificateLink').value = externalCertLink;
            
            if (internalCertLink && internalCertLink.trim() !== '') {
                document.getElementById('internalUploadedFileName').textContent = 'شهادة معايرة داخلية';
                document.getElementById('internalUploadedFileInfo').style.display = 'block';
                
                const fileLinkBtn = document.getElementById('internalUploadedFileLink');
                fileLinkBtn.href = internalCertLink;
                fileLinkBtn.style.display = 'inline-block';
                
                const uploadStatus = document.getElementById('internalUploadStatus');
                uploadStatus.textContent = '✅ ملف مرفق مسبقاً';
                uploadStatus.className = 'upload-status success';
            }
            
            if (externalCertLink && externalCertLink.trim() !== '') {
                document.getElementById('externalUploadedFileName').textContent = 'شهادة معايرة خارجية';
                document.getElementById('externalUploadedFileInfo').style.display = 'block';
                
                const fileLinkBtn = document.getElementById('externalUploadedFileLink');
                fileLinkBtn.href = externalCertLink;
                fileLinkBtn.style.display = 'inline-block';
                
                const uploadStatus = document.getElementById('externalUploadStatus');
                uploadStatus.textContent = '✅ ملف مرفق مسبقاً';
                uploadStatus.className = 'upload-status success';
            }
            
            const internalFrequency = record[22] || '365';
            const externalFrequency = record[27] || '365';
            
            document.getElementById('calibration_internalCalibrationFrequency').value = internalFrequency;
            document.getElementById('calibration_externalCalibrationFrequency').value = externalFrequency;
            
            updateFrequencyButtons('calibration_internalCalibrationFrequency', internalFrequency);
            updateFrequencyButtons('calibration_externalCalibrationFrequency', externalFrequency);
            
            document.getElementById('calibration_internalCalibrationDate').value = formatDMYForInput(record[21] || '');
            document.getElementById('calibration_internalCalibrationDueDate').value = formatDMYForInput(record[23] || '');
            document.getElementById('calibration_externalCalibrationDate').value = formatDMYForInput(record[26] || '');
            document.getElementById('calibration_externalCalibrationDueDate').value = formatDMYForInput(record[28] || '');
            
            updateFlatpickrDate(flatpickrInstances.internalCalibrationDate, formatDMYForInput(record[21] || ''));
            updateFlatpickrDate(flatpickrInstances.internalCalibrationDueDate, formatDMYForInput(record[23] || ''));
            updateFlatpickrDate(flatpickrInstances.externalCalibrationDate, formatDMYForInput(record[26] || ''));
            updateFlatpickrDate(flatpickrInstances.externalCalibrationDueDate, formatDMYForInput(record[28] || ''));
            
            document.getElementById('calibration_editingId').value = record[0];
            document.getElementById('calibration_internalRecordId').value = record[0];
            
            setTimeout(() => {
                checkDuplicateRecordNumber();
            }, 100);
        }
        
        function updateFrequencyButtons(frequencyInputId, frequencyValue) {
            const frequencyInput = document.getElementById(frequencyInputId);
            const frequencyGroup = frequencyInput.closest('.frequency-group');
            if (frequencyGroup) {
                const buttons = frequencyGroup.querySelectorAll('.frequency-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.textContent) === parseInt(frequencyValue)) {
                        btn.classList.add('active');
                    }
                });
            }
        }
        
        function updateFlatpickrDate(instance, dateString) {
            if (instance && dateString) {
                try {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        instance.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting date:', e);
                }
            }
        }
        
        async function updateCalibrationRecord() {
            if (checkDuplicateRecordNumber()) {
                showNotification('❌ رقم السجل هذا موجود مسبقاً. يرجى استخدام رقم آخر.', 'error');
                return;
            }

            const recordId = document.getElementById('calibration_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد جهاز للتحديث', 'error');
                return;
            }

            const requiredFields = ['calibration_recordId', 'calibration_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }

            const internalCalibrationDate = document.getElementById('calibration_internalCalibrationDate').value;
            const internalCalibrationDueDate = document.getElementById('calibration_internalCalibrationDueDate').value;
            const externalCalibrationDate = document.getElementById('calibration_externalCalibrationDate').value;
            const externalCalibrationDueDate = document.getElementById('calibration_externalCalibrationDueDate').value;

            const button = document.getElementById('calibration_updateBtn');
            const originalHtml = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';

            const internalCertLink = document.getElementById('calibration_internalCertificateLink').value;
            const externalCertLink = document.getElementById('calibration_externalCertificateLink').value;

            const internalCalibrationDateDMY = internalCalibrationDate ? formatDateToDMY(parseDateDDMMYYYY(internalCalibrationDate)) : '';
            const internalCalibrationDueDateDMY = internalCalibrationDueDate ? formatDateToDMY(parseDateDDMMYYYY(internalCalibrationDueDate)) : '';
            const externalCalibrationDateDMY = externalCalibrationDate ? formatDateToDMY(parseDateDDMMYYYY(externalCalibrationDate)) : '';
            const externalCalibrationDueDateDMY = externalCalibrationDueDate ? formatDateToDMY(parseDateDDMMYYYY(externalCalibrationDueDate)) : '';

            const internalFrequency = document.getElementById('calibration_internalCalibrationFrequency').value;
            const externalFrequency = document.getElementById('calibration_externalCalibrationFrequency').value;

            const fields = [
                'calibration_recordId',
                'calibration_deviceName',
                'calibration_manufacturer',
                'calibration_model',
                'calibration_location',
                'calibration_serialNumber',
                'calibration_internalCode',
                'calibration_description',
                'calibration_category',
                'calibration_priority',
                'calibration_deviceRangeFrom',
                'calibration_deviceRangeTo',
                'calibration_deviceRangeUnit',
                'calibration_operatingRangeFrom',
                'calibration_operatingRangeTo',
                'calibration_operatingRangeUnit',
                'calibration_maxDeviation',
                'calibration_maxDeviationUnit',
                'calibration_uncertainty',
                'calibration_uncertaintyUnit',
                'calibration_internalCalibratedBy',
                'calibration_externalCalibratedBy',
                'calibration_relatedDataLink',
                'calibration_additionalInfo',
                'calibration_deviceStatus'
            ];

            const paramMap = {
                'calibration_recordId': 'recordId',
                'calibration_deviceName': 'deviceName',
                'calibration_manufacturer': 'manufacturer',
                'calibration_model': 'model',
                'calibration_location': 'location',
                'calibration_serialNumber': 'serialNumber',
                'calibration_internalCode': 'internalCode',
                'calibration_description': 'description',
                'calibration_category': 'category',
                'calibration_priority': 'priority',
                'calibration_deviceRangeFrom': 'deviceRangeFrom',
                'calibration_deviceRangeTo': 'deviceRangeTo',
                'calibration_deviceRangeUnit': 'deviceRangeUnit',
                'calibration_operatingRangeFrom': 'operatingRangeFrom',
                'calibration_operatingRangeTo': 'operatingRangeTo',
                'calibration_operatingRangeUnit': 'operatingRangeUnit',
                'calibration_maxDeviation': 'maxDeviation',
                'calibration_maxDeviationUnit': 'maxDeviationUnit',
                'calibration_uncertainty': 'uncertainty',
                'calibration_uncertaintyUnit': 'uncertaintyUnit',
                'calibration_internalCalibratedBy': 'internalCalibratedBy',
                'calibration_externalCalibratedBy': 'externalCalibratedBy',
                'calibration_relatedDataLink': 'relatedDataLink',
                'calibration_additionalInfo': 'additionalInfo',
                'calibration_deviceStatus': 'deviceStatus'
            };

            let q = `internalRecordId=${encodeURIComponent(recordId)}&`;

            fields.forEach(f => {
                const paramName = paramMap[f];
                q += `${paramName}=${encodeURIComponent(document.getElementById(f).value || '')}&`;
            });

            q += `internalCalibrationFrequency=${encodeURIComponent(internalFrequency || '365')}&`;
            q += `externalCalibrationFrequency=${encodeURIComponent(externalFrequency || '365')}&`;
            
            q += `internalCalibrationDate=${encodeURIComponent(internalCalibrationDateDMY)}&`;
            q += `internalCalibrationDueDate=${encodeURIComponent(internalCalibrationDueDateDMY)}&`;
            q += `externalCalibrationDate=${encodeURIComponent(externalCalibrationDateDMY)}&`;
            q += `externalCalibrationDueDate=${encodeURIComponent(externalCalibrationDueDateDMY)}&`;
            q += `internalCertificateLink=${encodeURIComponent(internalCertLink || '')}&`;
            q += `externalCertificateLink=${encodeURIComponent(externalCertLink || '')}`;

            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=update&${q}`);

                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    resetCalibrationForm();
                    await loadCalibrationData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في التحديث', 'error');
                console.error('Update error:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetCalibrationForm() {
            document.getElementById('calibrationForm').reset();
            document.getElementById('calibration_editingId').value = '';
            document.getElementById('calibration_internalRecordId').value = '';
            document.getElementById('calibration_internalCertificateLink').value = '';
            document.getElementById('calibration_externalCertificateLink').value = '';
            document.getElementById('calibration_addBtn').style.display = 'inline-block';
            document.getElementById('calibration_updateBtn').style.display = 'none';
            document.querySelectorAll('#calibrationForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            document.getElementById('duplicateRecordNumberWarning').style.display = 'none';
            isDuplicateRecordNumber = false;
            
            document.getElementById('calibration_category').value = '';
            document.getElementById('calibration_priority').value = '';
            document.getElementById('calibration_deviceStatus').value = 'نشط';
            document.getElementById('calibration_deviceRangeUnit').value = '';
            document.getElementById('calibration_operatingRangeUnit').value = '';
            document.getElementById('calibration_maxDeviationUnit').value = '';
            document.getElementById('calibration_uncertaintyUnit').value = '';
            
            document.getElementById('calibration_internalCalibrationFrequency').value = '365';
            document.getElementById('calibration_externalCalibrationFrequency').value = '365';
            
            updateFrequencyButtons('calibration_internalCalibrationFrequency', '365');
            updateFrequencyButtons('calibration_externalCalibrationFrequency', '365');
            
            selectedInternalFile = null;
            selectedExternalFile = null;
            uploadedInternalFileUrl = '';
            uploadedExternalFileUrl = '';
            
            document.getElementById('internalUploadedFileInfo').style.display = 'none';
            document.getElementById('internalUploadedFileLink').style.display = 'none';
            document.getElementById('internalUploadStatus').textContent = '';
            document.getElementById('internalUploadStatus').className = 'upload-status';
            document.getElementById('internalFileInput').value = '';
            
            document.getElementById('externalUploadedFileInfo').style.display = 'none';
            document.getElementById('externalUploadedFileLink').style.display = 'none';
            document.getElementById('externalUploadStatus').textContent = '';
            document.getElementById('externalUploadStatus').className = 'upload-status';
            document.getElementById('externalFileInput').value = '';
            
            const today = new Date();
            const todayFormatted = formatDateToDDMMYYYY(today);
            
            if (flatpickrInstances.internalCalibrationDate) {
                document.getElementById('calibration_internalCalibrationDate').value = todayFormatted;
                flatpickrInstances.internalCalibrationDate.setDate(today, false);
            }
            
            if (flatpickrInstances.externalCalibrationDate) {
                document.getElementById('calibration_externalCalibrationDate').value = todayFormatted;
                flatpickrInstances.externalCalibrationDate.setDate(today, false);
            }
            
            if (flatpickrInstances.internalCalibrationDueDate) flatpickrInstances.internalCalibrationDueDate.clear();
            if (flatpickrInstances.externalCalibrationDueDate) flatpickrInstances.externalCalibrationDueDate.clear();
            
            calculateInternalDueDate();
            calculateExternalDueDate();
        }
        
        function exportCalibrationCSV() {
            if (calibrationRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير بيانات الأجهزة...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'اسم الجهاز', 'الشركة المصنعة', 'الطراز', 'الموقع',
                    'الرقم التسلسلي', 'الكود الداخلي', 'الوصف', 'الفئة', 'الأولوية',
                    'نطاق الجهاز من', 'نطاق الجهاز إلى', 'وحدة نطاق الجهاز',
                    'نطاق التشغيل من', 'نطاق التشغيل إلى', 'وحدة نطاق التشغيل',
                    'أقصى انحراف', 'وحدة أقصى انحراف', 'عدم اليقين', 'وحدة عدم اليقين',
                    'تاريخ المعايرة الداخلية', 'تكرار المعايرة الداخلية (أيام)', 'تاريخ استحقاق المعايرة الداخلية',
                    'تمت المعايرة الداخلية بواسطة', 'رابط شهادة المعايرة الداخلية',
                    'تاريخ المعايرة الخارجية', 'تكرار المعايرة الخارجية (أيام)', 'تاريخ استحقاق المعايرة الخارجية',
                    'تمت المعايرة الخارجية بواسطة', 'رابط شهادة المعايرة الخارجية',
                    'رابط البيانات ذات الصلة', 'معلومات إضافية', 'حالة الجهاز'
                ];
                
            let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                calibrationRecords.forEach(record => {
                    const row = [
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        record[5] || '',
                        record[6] || '',
                        record[7] || '',
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[11] || '',
                        record[12] || '',
                        record[13] || '',
                        record[14] || '',
                        record[15] || '',
                        record[16] || '',
                        record[17] || '',
                        record[18] || '',
                        record[19] || '',
                        record[20] || '',
                        formatDMYForDisplay(record[21] || '').replace(/<[^>]*>/g, ''),
                        record[22] || '',
                        formatDMYForDisplay(record[23] || '').replace(/<[^>]*>/g, ''),
                        record[24] || '',
                        record[25] || '',
                        formatDMYForDisplay(record[26] || '').replace(/<[^>]*>/g, ''),
                        record[27] || '',
                        formatDMYForDisplay(record[28] || '').replace(/<[^>]*>/g, ''),
                        record[29] || '',
                        record[30] || '',
                        record[31] || '',
                        record[32] || '',
                        record[33] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `أجهزة_المعايرة_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${calibrationRecords.length} جهاز`, 'success');
            } catch (error) {
                showNotification('❌ خطأ في التصدير', 'error');
            }
        }
        
        function printTable() {
            window.print();
        }
        
        function printDetails() {
            const detailsContent = document.getElementById('detailsModalBody').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>تفاصيل جهاز المعايرة</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; direction: rtl; padding: 20px; }
                        h1 { color: #3498db; }
                        .section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
                        .label { font-weight: bold; color: #2c3e50; }
                        .value { margin-right: 10px; }
                        .print-header { text-align: center; margin-bottom: 30px; }
                        .print-footer { text-align: center; margin-top: 30px; color: #7f8c8d; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>تفاصيل جهاز المعايرة</h1>
                        <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    ${detailsContent}
                    <div class="print-footer">
                        <p>نظام إدارة معايرة الأجهزة المتكامل - معمل كواليتك إنترناشيونال</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function viewDetails(recordId) {
            const record = calibrationRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (!record) {
                showNotification('❌ لم يتم العثور على الجهاز', 'error');
                return;
            }
            
            const internalCertLink = record[25] || '';
            const externalCertLink = record[30] || '';
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="section mb-3">
                            <h6 class="border-bottom pb-2 text-primary">المعلومات الأساسية</h6>
                            <p><span class="label">رقم السجل:</span> <span class="value">${escapeHtml(record[1] || '')}</span></p>
                            <p><span class="label">اسم الجهاز:</span> <span class="value">${escapeHtml(record[2])}</span></p>
                            <p><span class="label">الشركة المصنعة:</span> <span class="value">${escapeHtml(record[3])}</span></p>
                            <p><span class="label">الطراز:</span> <span class="value">${escapeHtml(record[4])}</span></p>
                            <p><span class="label">الموقع:</span> <span class="value">${escapeHtml(record[5])}</span></p>
                            <p><span class="label">الرقم التسلسلي:</span> <span class="value">${escapeHtml(record[6])}</span></p>
                            <p><span class="label">الكود الداخلي:</span> <span class="value">${escapeHtml(record[7])}</span></p>
                            <p><span class="label">الوصف:</span> <span class="value">${escapeHtml(record[8])}</span></p>
                            <p><span class="label">الفئة:</span> <span class="value">${escapeHtml(record[9])}</span></p>
                            <p><span class="label">الأولوية:</span> <span class="value">${escapeHtml(record[10])}</span></p>
                            <p><span class="label">حالة الجهاز:</span> <span class="value"><span class="status-badge ${getStatusClass(record[33])}">${escapeHtml(record[33] || 'نشط')}</span></span></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="section mb-3">
                            <h6 class="border-bottom pb-2 text-primary">مواصفات الجهاز</h6>
                            <p><span class="label">نطاق الجهاز:</span> <span class="value">${escapeHtml(record[11])} - ${escapeHtml(record[12])} ${escapeHtml(record[13])}</span></p>
                            <p><span class="label">نطاق التشغيل:</span> <span class="value">${escapeHtml(record[14])} - ${escapeHtml(record[15])} ${escapeHtml(record[16])}</span></p>
                            <p><span class="label">أقصى انحراف:</span> <span class="value">${escapeHtml(record[17])} ${escapeHtml(record[18])}</span></p>
                            <p><span class="label">عدم اليقين:</span> <span class="value">${escapeHtml(record[19])} ${escapeHtml(record[20])}</span></p>
                            <p><span class="label">رابط البيانات:</span> <span class="value">${record[31] ? `<a href="${escapeHtml(record[31])}" target="_blank">${escapeHtml(record[31])}</a>` : 'لا يوجد'}</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="section mb-3">
                            <h6 class="border-bottom pb-2 text-primary">المعايرة الداخلية</h6>
                            <p><span class="label">التاريخ:</span> <span class="value">${formatDMYForDisplay(record[21] || '')}</span></p>
                            <p><span class="label">التكرار:</span> <span class="value">${escapeHtml(record[22])} يوم</span></p>
                            <p><span class="label">تاريخ الاستحقاق:</span> <span class="value">${formatDMYForDisplay(record[23] || '')}</span></p>
                            <p><span class="label">تمت بواسطة:</span> <span class="value">${escapeHtml(record[24])}</span></p>
                            <p><span class="label">الشهادة:</span> <span class="value">
                                ${internalCertLink ? 
                                    `<a href="${escapeHtml(internalCertLink)}" target="_blank" class="file-link-btn">
                                        <i class="fas fa-external-link-alt me-1"></i> فتح الشهادة
                                    </a>` : 
                                    'لا يوجد شهادة'
                                }
                            </span></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="section mb-3">
                            <h6 class="border-bottom pb-2 text-primary">المعايرة الخارجية</h6>
                            <p><span class="label">التاريخ:</span> <span class="value">${formatDMYForDisplay(record[26] || '')}</span></p>
                            <p><span class="label">التكرار:</span> <span class="value">${escapeHtml(record[27])} يوم</span></p>
                            <p><span class="label">تاريخ الاستحقاق:</span> <span class="value">${formatDMYForDisplay(record[28] || '')}</span></p>
                            <p><span class="label">تمت بواسطة:</span> <span class="value">${escapeHtml(record[29])}</span></p>
                            <p><span class="label">الشهادة:</span> <span class="value">
                                ${externalCertLink ? 
                                    `<a href="${escapeHtml(externalCertLink)}" target="_blank" class="file-link-btn">
                                        <i class="fas fa-external-link-alt me-1"></i> فتح الشهادة
                                    </a>` : 
                                    'لا يوجد شهادة'
                                }
                            </span></p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="section">
                            <h6 class="border-bottom pb-2 text-primary">معلومات إضافية</h6>
                            <p>${escapeHtml(record[32] || 'لا توجد معلومات إضافية')}</p>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>تاريخ الإنشاء: ${record[34] ? new Date(record[34]).toLocaleString('ar-SA') : 'غير معروف'} | تاريخ آخر تحديث: ${record[35] ? new Date(record[35]).toLocaleString('ar-SA') : 'غير معروف'}</small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailsModalBody').innerHTML = detailsHTML;
            detailsModalInstance.show();
        }
        
        function showDeleteModal(recordId, recordName, recordNumber, manufacturer) {
            deleteRecordId = recordId;
            deleteRecordName = recordName;
            deleteManufacturer = manufacturer;
            
            document.getElementById('deleteRecordId').textContent = recordNumber || 'غير معروف';
            document.getElementById('deleteRecordName').textContent = recordName || 'غير معروف';
            document.getElementById('deleteManufacturer').textContent = manufacturer || 'غير معروف';
            
            deleteModalInstance.show();
        }
        
        async function confirmDelete() {
            if (!deleteRecordId) return;
            
            const button = document.getElementById('confirmDeleteBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحذف...';
            
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=delete&recordId=${encodeURIComponent(deleteRecordId)}`);
                
                button.disabled = false;
                button.innerHTML = originalHtml;
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    
                    deleteModalInstance.hide();
                    
                    deleteRecordId = '';
                    deleteRecordName = '';
                    deleteManufacturer = '';
                    
                    loadCalibrationData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ أثناء الحذف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting record:', error);
                button.disabled = false;
                button.innerHTML = originalHtml;
                showNotification('❌ خطأ في الاتصال بالخادم', 'error');
            }
        }
    </script>
</body>
</html>
