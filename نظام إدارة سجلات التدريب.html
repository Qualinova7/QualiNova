<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة التدريب - معمل كواليتك إنترناشيونال</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --training-color: #8e44ad;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .main-header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .main-header .lead {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        /* Home Button */
        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        .home-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .home-button i {
            margin-right: 5px;
        }
        
        /* Card Styles */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-custom {
            padding: 15px 20px;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .card-header-training {
            background: linear-gradient(135deg, var(--training-color), #8e44ad);
        }
        
        /* Form Styles */
        .form-control-custom, .form-select-custom, .form-textarea-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control-custom:focus, .form-select-custom:focus, .form-textarea-custom:focus {
            border-color: var(--training-color);
            box-shadow: 0 0 0 0.25rem rgba(142, 68, 173, 0.25);
            background: white;
        }
        
        .form-textarea-custom {
            min-height: 70px;
            resize: vertical;
        }
        
        .form-label-custom {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Date Input Styling */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .date-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--training-color);
            pointer-events: none;
        }
        
        .date-input-wrapper .form-control-custom {
            padding-right: 40px;
            direction: ltr;
            text-align: right;
        }
        
        /* Flatpickr Customization */
        .flatpickr-calendar {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }
        
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--training-color);
            border-color: var(--training-color);
        }
        
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-family: 'Cairo', sans-serif;
        }
        
        .flatpickr-weekdays {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 0;
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0;
            min-width: 1200px;
            width: 100%;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, var(--training-color), #8e44ad);
            color: white;
            border: none;
            padding: 15px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .table-custom tbody tr {
            transition: all 0.2s;
        }
        
        .table-custom tbody tr:hover {
            background-color: rgba(142, 68, 173, 0.08);
        }
        
        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 2px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 70px;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: #212529;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        
        .spinner-border-custom {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.2rem;
        }
        
        /* Status Message */
        .status-message {
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        
        /* FIX FOR ENGLISH DATE DISPLAY IN RTL CONTEXT */
        .english-date {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed !important;
            display: inline-block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 1px;
                min-width: 60px;
            }
            
            .table-custom {
                min-width: 1000px;
            }
            
            /* Home Button Responsive Styles */
            .home-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
            
            .main-header {
                padding-top: 60px;
            }
        }
        
        /* Form Sections */
        .form-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section-title {
            color: var(--training-color);
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--training-color);
            border-radius: 10px;
        }
        
        /* Badge Styles */
        .badge {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        /* Additional Info Section */
        .additional-info-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        /* Status Colors */
        .status-success {
            background-color: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }
        
        .status-error {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .status-info {
            background-color: rgba(52, 152, 219, 0.1);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Main Container -->
    <div class="container-fluid main-container">
        <!-- Main Header -->
        <div class="main-header fade-in">
            <!-- Return to Home Button -->
            <a href="https://qualinova7.github.io/QualiNova/" class="home-button">
                <i class="fas fa-home"></i> العودة للرئيسية
            </a>
            
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-graduation-cap me-2"></i> نظام إدارة التدريب - معمل كواليتك إنترناشيونال</h1>
                    <p class="lead mb-0">إدارة سجلات التدريب للموظفين: التسجيل والمتابعة والتقييم</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="header-badge d-inline-block me-3">
                        <i class="fas fa-database me-2"></i>
                        <span id="totalRecords">0</span> سجلات تدريب
                    </div>
                    <div class="header-badge d-inline-block">
                        <i class="fas fa-calendar me-2"></i>
                        <span id="currentDate">--/--/----</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Training Management Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-training">
                        <i class="fas fa-graduation-cap me-2"></i> إدارة سجلات التدريب
                    </div>
                    <div class="card-body">
                        <form id="trainingForm">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-info-circle"></i> المعلومات الأساسية
                                </div>
                                <div class="row">
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">رقم السجل *</label>
                                        <input type="text" class="form-control form-control-custom" id="training_id" placeholder="رقم السجل" required>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">العام *</label>
                                        <input type="number" class="form-control form-control-custom" id="training_year" placeholder="العام" min="2000" max="2100" required>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">اسم الموظف *</label>
                                        <input type="text" class="form-control form-control-custom" id="training_name" placeholder="الاسم" required list="employeeNameList">
                                        <datalist id="employeeNameList"></datalist>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الرقم الوظيفي *</label>
                                        <input type="text" class="form-control form-control-custom" id="training_employeeNumber" placeholder="الرقم الوظيفي" required list="employeeNumberList">
                                        <datalist id="employeeNumberList"></datalist>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label-custom">الوظيفة *</label>
                                        <input type="text" class="form-control form-control-custom" id="training_jobTitle" placeholder="الوظيفة" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-chalkboard-teacher"></i> تفاصيل التدريب
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label-custom">مسمى التدريب *</label>
                                        <input type="text" class="form-control form-control-custom" id="training_trainingTitle" placeholder="مسمى التدريب" required>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label-custom">الهدف من التدريب</label>
                                        <textarea class="form-control form-textarea-custom" id="training_trainingNeed" placeholder="الهدف من التدريب" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label-custom">مكان الانعقاد</label>
                                        <input type="text" class="form-control form-control-custom" id="training_location" placeholder="مكان الانعقاد">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label-custom">الجهة المنظمة</label>
                                        <input type="text" class="form-control form-control-custom" id="training_organization" placeholder="الجهة">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label-custom">نوع التدريب</label>
                                        <select class="form-select form-select-custom" id="training_type">
                                            <option value="">اختر نوع التدريب</option>
                                            <option value="داخلي">داخلي</option>
                                            <option value="خارجي">خارجي</option>
                                            <option value="أونلاين">أونلاين</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ البداية</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="training_startDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ الانتهاء</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="training_endDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">المدة بالأيام</label>
                                        <input type="number" class="form-control form-control-custom" id="training_duration" placeholder="المدة بالأيام" min="1" max="365">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">حالة التدريب</label>
                                        <select class="form-select form-select-custom" id="training_status">
                                            <option value="مخطط له">مخطط له</option>
                                            <option value="جاري التنفيذ">جاري التنفيذ</option>
                                            <option value="مكتمل">مكتمل</option>
                                            <option value="ملغي">ملغي</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-file-certificate"></i> تقييم التدريب
                                </div>
                                <div class="additional-info-section">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">التقييم</label>
                                            <select class="form-select form-select-custom" id="training_evaluation">
                                                <option value="">اختر التقييم</option>
                                                <option value="ممتاز">ممتاز</option>
                                                <option value="جيد جداً">جيد جداً</option>
                                                <option value="جيد">جيد</option>
                                                <option value="مقبول">مقبول</option>
                                                <option value="ضعيف">ضعيف</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">الدرجة النهائية</label>
                                            <input type="number" class="form-control form-control-custom" id="training_grade" placeholder="الدرجة" min="0" max="100" step="0.1">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">الشهادة</label>
                                            <select class="form-select form-select-custom" id="training_certificate">
                                                <option value="نعم">نعم</option>
                                                <option value="لا">لا</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="form-label-custom">ملاحظات إضافية</label>
                                            <textarea class="form-control form-textarea-custom" id="training_notes" placeholder="ملاحظات إضافية حول التدريب" rows="2"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label-custom">اسم المشرف</label>
                                            <input type="text" class="form-control form-control-custom" id="training_supervisor" placeholder="اسم المشرف">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label-custom">تاريخ الإدخال</label>
                                            <div class="date-input-wrapper">
                                                <input type="text" class="form-control form-control-custom date-picker" id="training_entryDate" placeholder="يوم/شهر/سنة" readonly>
                                                <i class="fas fa-calendar-alt date-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status Message -->
                            <div id="status" class="status-message"></div>
                            
                            <div class="row mt-3">
                                <div class="col-12 d-flex justify-content-between">
                                    <button type="button" onclick="resetTrainingForm()" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-1"></i> مسح النموذج
                                    </button>
                                    <div>
                                        <button type="button" onclick="addTrainingRecord()" class="btn btn-success me-2" id="training_addBtn">
                                            <i class="fas fa-plus me-1"></i> إضافة جديد
                                        </button>
                                        <button type="button" onclick="updateTrainingRecord()" class="btn btn-primary" id="training_updateBtn" style="display: none;">
                                            <i class="fas fa-save me-1"></i> تحديث السجل
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="training_editingId">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Records Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-training d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i> قائمة سجلات التدريب</span>
                        <div>
                            <button onclick="loadTrainingData()" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                            <button onclick="exportTrainingCSV()" class="btn btn-light btn-sm">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading-spinner" id="trainingLoadingSpinner" style="display: none;">
                            <div class="spinner-border text-primary spinner-border-custom" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive" id="trainingTableContainer">
                            <table class="table table-custom table-hover" id="trainingDataTable">
                            </table>
                        </div>
                        
                        <div id="trainingNoRecords" class="text-center py-5" style="display: none;">
                            <i class="fas fa-graduation-cap fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted">لا توجد سجلات تدريب لعرضها</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 fade-in">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-copyright me-1"></i> نظام إدارة التدريب 
                    <span id="currentYear"></span> | 
                    <span class="text-info">الإصدار 2.0</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تأكيد الحذف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-2x float-start me-3"></i>
                        <h5 class="alert-heading">تحذير!</h5>
                        <p>هل أنت متأكد من حذف هذا السجل؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                        <hr>
                        <p class="mb-0"><strong>النظام:</strong> <span id="deleteSystemType">إدارة التدريب</span></p>
                        <p class="mb-0"><strong>رقم السجل:</strong> <span id="deleteRecordId">غير معروف</span></p>
                        <p class="mb-0"><strong>اسم الموظف:</strong> <span id="deleteRecordName">غير معروف</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> نعم، احذف السجل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تفاصيل سجل التدريب</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr Calendar -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ================ CONFIGURATION ================
        const TRAINING_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzK1FGd_qDpT_q6iEItaJXYHJ6wWHUtw3FMmfWuAUfPgANUfGxoLn0qpbLM0hrU1klLxg/exec";
        const EMPLOYEE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiKkgfhdI3xaW6biMBZCCkuIN9P_6mvUQVHJWgj35kHOUvuQjduHzYfAnOCG0aHWlcpA/exec";
        
        // ================ GLOBAL VARIABLES ================
        let trainingRecords = [];
        let employeeRecords = [];
        let deleteRecordId = '';
        let deleteRecordName = '';
        let flatpickrInstances = {};
        let employeeDataLoaded = false;
        
        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date and year
            setCurrentDate();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize calendar pickers with FIXED approach
            initializeDatePickers();
            
            // Set current date for entry date
            const now = new Date();
            const today = formatDateToDDMMYYYY(now);
            document.getElementById('training_entryDate').value = today;
            
            // Load data - تحميل بيانات التدريب وبيانات الموظفين
            setTimeout(() => {
                loadTrainingData(); // تحميل بيانات التدريب
                loadEmployeeData(); // تحميل بيانات الموظفين للقوائم المنسدلة
            }, 500);
            
            // إضافة event listeners للحقول
            setupEmployeeAutocomplete();
            
            // إضافة حدث لحساب المدة تلقائياً
            setupDurationCalculation();
        });
        
        // ================ FIXED DATE PICKER INITIALIZATION ================
        function initializeDatePickers() {
            // Destroy existing instances if any
            if (flatpickrInstances.startDate) {
                flatpickrInstances.startDate.destroy();
            }
            if (flatpickrInstances.endDate) {
                flatpickrInstances.endDate.destroy();
            }
            if (flatpickrInstances.entryDate) {
                flatpickrInstances.entryDate.destroy();
            }
            
            // Simple Flatpickr configuration that works in RTL
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",  // Use d/m/Y format for display
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: false,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                // IMPORTANT: Set the calendar to RTL mode
                nextArrow: '<i class="fas fa-chevron-right"></i>',
                prevArrow: '<i class="fas fa-chevron-left"></i>',
                // Force RTL for the calendar
                onReady: function(selectedDates, dateStr, instance) {
                    // Force RTL direction on calendar container
                    if (instance.calendarContainer) {
                        instance.calendarContainer.style.direction = 'rtl';
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    // The date will be automatically set in d/m/Y format
                    // Update duration if both dates are set
                    calculateDuration();
                    
                    // Force the input value to update (in case Flatpickr didn't)
                    if (selectedDates.length > 0) {
                        const date = selectedDates[0];
                        const formattedDate = formatDateToDDMMYYYY(date);
                        instance.input.value = formattedDate;
                    }
                }
            };
            
            // Initialize start date picker
            flatpickrInstances.startDate = flatpickr('#training_startDate', dateOptions);
            
            // Initialize end date picker
            flatpickrInstances.endDate = flatpickr('#training_endDate', dateOptions);
            
            // Initialize entry date picker
            flatpickrInstances.entryDate = flatpickr('#training_entryDate', {
                ...dateOptions,
                defaultDate: 'today'
            });
            
            // Force Arabic locale on instances
            if (flatpickrInstances.startDate) {
                flatpickrInstances.startDate.set('locale', 'ar');
            }
            if (flatpickrInstances.endDate) {
                flatpickrInstances.endDate.set('locale', 'ar');
            }
            if (flatpickrInstances.entryDate) {
                flatpickrInstances.entryDate.set('locale', 'ar');
            }
        }
        
        // ================ HELPER FUNCTION TO FORMAT DATE AS DD/MM/YYYY ================
        function formatDateToDDMMYYYY(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // ================ DATE VALIDATION: END DATE NOT BEFORE START DATE ================
        function validateEndDateNotBeforeStartDate() {
            const startDateStr = document.getElementById('training_startDate').value;
            const endDateStr = document.getElementById('training_endDate').value;
            
            if (!startDateStr || !endDateStr) return;
            
            try {
                const startDate = parseDateDDMMYYYY(startDateStr);
                const endDate = parseDateDDMMYYYY(endDateStr);
                
                if (startDate && endDate && endDate < startDate) {
                    showNotification('❌ تاريخ الانتهاء يجب أن يكون بعد تاريخ البداية أو مساوياً له', 'error');
                    // Clear the end date
                    if (flatpickrInstances.endDate) {
                        flatpickrInstances.endDate.clear();
                    }
                    document.getElementById('training_endDate').value = '';
                }
            } catch (e) {
                console.error('Error validating dates:', e);
            }
        }
        
        // ================ DURATION CALCULATION ================
        function setupDurationCalculation() {
            const startDateInput = document.getElementById('training_startDate');
            const endDateInput = document.getElementById('training_endDate');
            
            startDateInput.addEventListener('change', calculateDuration);
            endDateInput.addEventListener('change', calculateDuration);
        }
        
        function calculateDuration() {
            const startDateStr = document.getElementById('training_startDate').value;
            const endDateStr = document.getElementById('training_endDate').value;
            
            if (!startDateStr || !endDateStr) return;
            
            try {
                const startDate = parseDateDDMMYYYY(startDateStr);
                const endDate = parseDateDDMMYYYY(endDateStr);
                
                if (startDate && endDate) {
                    // Calculate difference in days
                    const diffTime = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both dates
                    
                    if (diffDays > 0) {
                        document.getElementById('training_duration').value = diffDays;
                    }
                }
            } catch (e) {
                console.error('Error calculating duration:', e);
            }
        }
        
        // ================ SIMPLIFIED DATE FORMAT FUNCTIONS ================
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            // Handle dd/mm/yyyy format only
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    // Basic validation
                    if (day < 1 || day > 31) return null;
                    if (month < 0 || month > 11) return null;
                    if (year < 1900 || year > 2100) return null;
                    
                    return new Date(year, month, day);
                }
            }
            
            return null;
        }
        
        // ================ FIXED DATE DISPLAY FORMAT FUNCTION ================
        // This function converts dates from Google Sheets format to display format
        // AND fixes the RTL display issue by wrapping in a span with LTR direction
        function formatDateForDisplay(dateString) {
            if (!dateString || dateString.trim() === '') return '';
            
            // Check if it's already in the desired format (like "30 September 2026")
            const englishMonthRegex = /^\d{1,2}\s+(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{4}$/i;
            const arabicMonthRegex = /^\d{1,2}\s+(يناير|فبراير|مارس|أبريل|مايو|يونيو|يوليو|أغسطس|سبتمبر|أكتوبر|نوفمبر|ديسمبر)\s+\d{4}$/;
            
            if (englishMonthRegex.test(dateString) || arabicMonthRegex.test(dateString)) {
                return `<span class="english-date">${dateString}</span>`;
            }
            
            // Try different date formats that might come from Google Sheets
            let dateObj = null;
            
            // Format 1: YYYY/MM/DD (Google Sheets format)
            if (dateString.includes('/') && dateString.split('/')[0].length === 4) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    
                    if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                        dateObj = new Date(year, month, day);
                    }
                }
            }
            // Format 2: DD/MM/YYYY (our display format)
            else if (dateString.includes('/') && dateString.split('/')[2].length === 4) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                        dateObj = new Date(year, month, day);
                    }
                }
            }
            // Format 3: YYYY-MM-DD (ISO format)
            else if (dateString.includes('-') && dateString.split('-')[0].length === 4) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    
                    if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                        dateObj = new Date(year, month, day);
                    }
                }
            }
            // Format 4: Already a Date object
            else if (dateString instanceof Date) {
                dateObj = dateString;
            }
            // Format 5: Try parsing as is
            else {
                dateObj = new Date(dateString);
            }
            
            // If we couldn't parse the date, return the original string
            if (!dateObj || isNaN(dateObj.getTime())) {
                console.log("Could not parse date:", dateString);
                return `<span class="english-date">${dateString}</span>`;
            }
            
            // Format the date as "30 September 2026"
            const day = dateObj.getDate();
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const month = monthNames[dateObj.getMonth()];
            const year = dateObj.getFullYear();
            
            const formattedDate = `${day} ${month} ${year}`;
            return `<span class="english-date">${formattedDate}</span>`;
        }
        
        // ================ NEW FUNCTION FOR FORM INPUT DISPLAY ================
        function formatDateForInput(dateString) {
            if (!dateString || dateString.trim() === '') return '';
            
            // Check if it's already in dd/mm/yyyy format
            const ddMMyyyyRegex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (ddMMyyyyRegex.test(dateString)) {
                return dateString;
            }
            
            // Try to parse the date
            // First, remove any HTML tags if present
            const cleanDateString = dateString.replace(/<[^>]*>/g, '');
            
            const parts = cleanDateString.split(' ');
            if (parts.length === 3 && isNaN(parts[1])) {
                // This is in "30 September 2026" format
                const day = parseInt(parts[0], 10).toString().padStart(2, '0');
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const monthIndex = monthNames.findIndex(name => name.toLowerCase() === parts[1].toLowerCase());
                const month = (monthIndex + 1).toString().padStart(2, '0');
                const year = parts[2];
                
                if (monthIndex !== -1) {
                    return `${day}/${month}/${year}`;
                }
            }
            
            // Try to parse as a date
            try {
                const dateObj = new Date(cleanDateString);
                if (!isNaN(dateObj.getTime())) {
                    const day = dateObj.getDate().toString().padStart(2, '0');
                    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    const year = dateObj.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.error('Error parsing date for input:', e);
            }
            
            // Fallback: return empty string
            return '';
        }
        
        function formatDateForStorage(dateString) {
            if (!dateString) return '';
            
            // If it's already in dd/mm/yyyy format, return as is
            const ddMMyyyyRegex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (ddMMyyyyRegex.test(dateString)) {
                return dateString;
            }
            
            // Clean any HTML tags
            const cleanDateString = dateString.replace(/<[^>]*>/g, '');
            
            // Try to convert from display format to dd/mm/yyyy
            const parts = cleanDateString.split(' ');
            if (parts.length === 3 && isNaN(parts[1])) {
                // This is in "30 September 2026" format
                const day = parseInt(parts[0], 10).toString().padStart(2, '0');
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const monthIndex = monthNames.findIndex(name => name.toLowerCase() === parts[1].toLowerCase());
                const month = (monthIndex + 1).toString().padStart(2, '0');
                const year = parts[2];
                
                if (monthIndex !== -1) {
                    return `${day}/${month}/${year}`;
                }
            }
            
            // Fallback: try to parse as a date
            try {
                const dateObj = new Date(cleanDateString);
                if (!isNaN(dateObj.getTime())) {
                    const day = dateObj.getDate().toString().padStart(2, '0');
                    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    const year = dateObj.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.error('Error parsing date for storage:', e);
            }
            
            return '';
        }
        
        function validateDate(dateString) {
            if (!dateString) return true; // Empty date is valid
            
            // Accept both dd/mm/yyyy and display format (30 September 2026)
            const ddMMyyyyRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const displayFormatRegex = /^(\d{1,2})\s+(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{4})$/i;
            
            if (ddMMyyyyRegex.test(dateString)) {
                const match = dateString.match(ddMMyyyyRegex);
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                const year = parseInt(match[3], 10);
                
                // Basic date validation
                if (year < 1900 || year > 2100) return false;
                if (month < 1 || month > 12) return false;
                if (day < 1 || day > 31) return false;
                
                // Check for specific month days
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            if (displayFormatRegex.test(dateString)) {
                const match = dateString.match(displayFormatRegex);
                const day = parseInt(match[1], 10);
                const monthName = match[2];
                const year = parseInt(match[3], 10);
                
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const month = monthNames.findIndex(name => name.toLowerCase() === monthName.toLowerCase()) + 1;
                
                if (month === 0) return false; // Month not found
                if (year < 1900 || year > 2100) return false;
                if (day < 1 || day > 31) return false;
                
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            return false;
        }
        
        function setCurrentDate() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('currentDate').textContent = `${day}/${month}/${year}`;
        }
        
        // ================ NOTIFICATION SYSTEM ================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getNotificationIcon(type)} me-3"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            return notification;
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        // ================ JSONP Loader ================
        function jsonp(url) {
            const old = document.getElementById("jsonp");
            if (old) old.remove();

            const s = document.createElement('script');
            s.id = "jsonp";
            s.src = url;
            document.body.appendChild(s);
        }
        
        // ================ UTILITY FUNCTIONS ================
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // ================ STATUS MESSAGE FUNCTIONS ================
        function setStatus(msg, type = 'info') {
            const statusDiv = document.getElementById("status");
            statusDiv.innerHTML = msg;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (statusDiv.innerHTML === msg) {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }
        
        // ================ EMPLOYEE DATA FUNCTIONS ================
        function loadEmployeeData() {
            if (employeeDataLoaded) return;
            
            showNotification('📥 جاري تحميل بيانات الموظفين...', 'info', 3000);
            jsonp(`${EMPLOYEE_SCRIPT_URL}?action=getAll&callback=handleEmployeeData`);
        }
        
        function handleEmployeeData(res) {
            console.log('Employee data response:', res);
            
            if (res && res.status === 'success') {
                // Extract data from response - handle multiple possible formats
                let records = [];
                
                if (Array.isArray(res.records)) {
                    records = res.records;
                } else if (Array.isArray(res.data)) {
                    records = res.data;
                } else if (Array.isArray(res)) {
                    records = res;
                }
                
                employeeRecords = records;
                employeeDataLoaded = true;
                
                populateEmployeeDatalists();
                setupEmployeeAutocomplete();
                showNotification('✅ تم تحميل بيانات الموظفين بنجاح (' + employeeRecords.length + ' موظف)', 'success', 3000);
            } else {
                showNotification('❌ فشل في تحميل بيانات الموظفين. تأكد من صحة سكريبت الويب', 'error');
                console.error('Employee data response:', res);
            }
        }
        
        function populateEmployeeDatalists() {
            const nameList = document.getElementById('employeeNameList');
            const numberList = document.getElementById('employeeNumberList');
            
            // Clear existing options
            nameList.innerHTML = '';
            numberList.innerHTML = '';
            
            // Use Sets for unique values
            const names = new Set();
            const numbers = new Set();
            
            employeeRecords.forEach(record => {
                // Assuming record structure: [id, name, empNo, job, department, contract, startDate]
                // Index: 0=id, 1=name, 2=employee number, 3=job, 4=department, 5=contract type, 6=start date
                if (record && record.length > 1) {
                    if (record[1] && String(record[1]).trim() !== '') names.add(String(record[1]).trim());
                    if (record[2] && String(record[2]).trim() !== '') numbers.add(String(record[2]).trim());
                }
            });
            
            // Populate employee names
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                nameList.appendChild(option);
            });
            
            // Populate employee numbers
            numbers.forEach(number => {
                const option = document.createElement('option');
                option.value = number;
                numberList.appendChild(option);
            });
            
            console.log('Employee datalists populated:', {
                names: names.size,
                numbers: numbers.size
            });
        }
        
        function setupEmployeeAutocomplete() {
            const employeeNameField = document.getElementById('training_name');
            const employeeNumberField = document.getElementById('training_employeeNumber');
            
            // Auto-fill when employee name is selected
            employeeNameField.addEventListener('change', function() {
                autoFillFromEmployee('name', this.value);
            });
            
            // Auto-fill when employee number is selected
            employeeNumberField.addEventListener('change', function() {
                autoFillFromEmployee('number', this.value);
            });
            
            // Also trigger on input for better UX
            employeeNameField.addEventListener('input', function() {
                if (this.value.length > 2) {
                    autoFillFromEmployee('name', this.value);
                }
            });
            
            employeeNumberField.addEventListener('input', function() {
                if (this.value.length > 2) {
                    autoFillFromEmployee('number', this.value);
                }
            });
        }
        
        function autoFillFromEmployee(fieldType, value) {
            if (!value || !employeeDataLoaded || employeeRecords.length === 0) return;
            
            let record = null;
            
            if (fieldType === 'name') {
                // Find record by name (case insensitive)
                record = employeeRecords.find(r => 
                    r && r[1] && String(r[1]).trim().toLowerCase() === String(value).trim().toLowerCase()
                );
                
                if (record && record[2]) {
                    document.getElementById('training_employeeNumber').value = record[2] || '';
                }
            } else if (fieldType === 'number') {
                // Find record by employee number
                record = employeeRecords.find(r => 
                    r && r[2] && String(r[2]).trim() === String(value).trim()
                );
                
                if (record && record[1]) {
                    document.getElementById('training_name').value = record[1] || '';
                }
            }
            
            // Fill job title if record found
            if (record && record[3]) {
                document.getElementById('training_jobTitle').value = record[3] || '';
                
                // Show success notification
                showNotification(`✅ تم تحميل بيانات الموظف: ${record[1] || ''}`, 'success', 2000);
            }
        }
        
        // ================ LOAD TRAINING DATA ================
        function loadTrainingData() {
            setStatus("جاري تحميل البيانات...", 'info');
            
            const spinner = document.getElementById('trainingLoadingSpinner');
            const tableContainer = document.getElementById('trainingTableContainer');
            const noRecords = document.getElementById('trainingNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            jsonp(`${TRAINING_SCRIPT_URL}?action=getAll&callback=showTrainingData&t=${timestamp}`);
        }
        
        function showTrainingData(res) {
            console.log('Training data response:', res);
            
            const spinner = document.getElementById('trainingLoadingSpinner');
            const tableContainer = document.getElementById('trainingTableContainer');
            const noRecords = document.getElementById('trainingNoRecords');
            
            spinner.style.display = 'none';
            
            // Handle multiple response formats
            let records = [];
            let responseStatus = 'error';
            let responseMessage = 'خطأ غير معروف';
            
            // Check if response has status field
            if (res && res.status) {
                responseStatus = res.status;
                responseMessage = res.message || 'بدون رسالة';
                
                if (responseStatus === 'success') {
                    // Try to extract records from various possible locations
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (res.records && typeof res.records === 'object') {
                        // If records is an object with array inside
                        const keys = Object.keys(res.records);
                        if (keys.length > 0 && Array.isArray(res.records[keys[0]])) {
                            records = res.records[keys[0]];
                        }
                    }
                }
            } else if (Array.isArray(res)) {
                // If response is directly an array
                records = res;
                responseStatus = 'success';
                responseMessage = 'تم تحميل البيانات بنجاح';
            }
            
            if (responseStatus !== 'success') {
                noRecords.style.display = 'block';
                showNotification(`❌ ${responseMessage}`, 'error');
                setStatus(responseMessage, 'error');
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            trainingRecords = records;
            
            if (trainingRecords.length > 0) {
                displayTrainingRecords(trainingRecords);
                tableContainer.style.display = 'block';
                document.getElementById('totalRecords').textContent = trainingRecords.length.toLocaleString('ar-SA');
            } else {
                noRecords.style.display = 'block';
                document.getElementById('totalRecords').textContent = '0';
            }
            
            setStatus("تم تحميل البيانات بنجاح ✅", 'success');
            showNotification(`✅ تم تحميل ${trainingRecords.length} سجل تدريب`, 'success', 3000);
        }
        
        function displayTrainingRecords(records) {
            const table = document.getElementById('trainingDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'العام', 'الاسم', 'الوظيفة', 'مسمى التدريب', 'الجهة', 'تاريخ البداية', 
                           'تاريخ الانتهاء', 'المدة', 'حالة التدريب', 'التقييم', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                // Handle different record structures (assuming original format)
                // Original: [id, year, empNo, name, jobTitle, trainingNeed, trainingTitle, location, organization, startDate, endDate]
                // New format with additional fields: [id, year, empNo, name, jobTitle, trainingNeed, trainingTitle, location, organization, startDate, endDate, type, status, duration, evaluation, grade, certificate, notes, supervisor, entryDate]
                
                const recordId = record[0] || record.id || record.recordId || '';
                const year = record[1] || record.year || '';
                const employeeName = record[3] || record.name || '';
                const jobTitle = record[4] || record.jobTitle || '';
                const trainingTitle = record[6] || record.trainingTitle || '';
                const organization = record[8] || record.organization || '';
                const startDate = record[9] || record.startDate || '';
                const endDate = record[10] || record.endDate || '';
                const duration = record[13] || record.duration || '';
                const status = record[12] || record.status || '';
                const evaluation = record[14] || record.evaluation || '';
                
                html += `<td><strong>${escapeHtml(recordId)}</strong></td>`;
                html += `<td>${escapeHtml(year)}</td>`;
                html += `<td>${escapeHtml(employeeName)}</td>`;
                html += `<td>${escapeHtml(jobTitle)}</td>`;
                html += `<td>${escapeHtml(trainingTitle)}</td>`;
                html += `<td>${escapeHtml(organization)}</td>`;
                html += `<td>${formatDateForDisplay(startDate)}</td>`;
                html += `<td>${formatDateForDisplay(endDate)}</td>`;
                html += `<td>${escapeHtml(duration)}</td>`;
                html += `<td>${escapeHtml(status)}</td>`;
                html += `<td>${escapeHtml(evaluation)}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editTrainingRecord('${escapeHtml(recordId)}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(recordId)}', '${escapeHtml(employeeName)}')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewTrainingDetails('${escapeHtml(recordId)}')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        // ================ CRUD OPERATIONS ================
        function addTrainingRecord() { 
            const requiredFields = ['training_id', 'training_year', 'training_name', 'training_employeeNumber', 'training_jobTitle', 'training_trainingTitle'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            // Validate dates if provided
            const startDate = document.getElementById('training_startDate').value;
            const endDate = document.getElementById('training_endDate').value;
            const entryDate = document.getElementById('training_entryDate').value;
            
            if (startDate && !validateDate(startDate)) {
                document.getElementById('training_startDate').classList.add('is-invalid');
                showNotification('❌ تاريخ البداية غير صحيح', 'error');
                return;
            } else {
                document.getElementById('training_startDate').classList.remove('is-invalid');
            }
            
            if (endDate && !validateDate(endDate)) {
                document.getElementById('training_endDate').classList.add('is-invalid');
                showNotification('❌ تاريخ الانتهاء غير صحيح', 'error');
                return;
            } else {
                document.getElementById('training_endDate').classList.remove('is-invalid');
            }
            
            if (entryDate && !validateDate(entryDate)) {
                document.getElementById('training_entryDate').classList.add('is-invalid');
                showNotification('❌ تاريخ الإدخال غير صحيح', 'error');
                return;
            } else {
                document.getElementById('training_entryDate').classList.remove('is-invalid');
            }
            
            // Validate end date is not before start date
            if (startDate && endDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const endDateObj = parseDateDDMMYYYY(endDate);
                    
                    if (startDateObj && endDateObj && endDateObj < startDateObj) {
                        showNotification('❌ تاريخ الانتهاء يجب أن يكون بعد تاريخ البداية أو مساوياً له', 'error');
                        document.getElementById('training_endDate').classList.add('is-invalid');
                        return;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            setStatus("جاري الإرسال...", 'info');
            
            // Get date values from date inputs (already in dd/mm/yyyy format)
            const startDateForStorage = formatDateForStorage(startDate);
            const endDateForStorage = formatDateForStorage(endDate);
            const entryDateForStorage = formatDateForStorage(entryDate);
            
            const fields = [
                'training_id',
                'training_year',
                'training_employeeNumber',
                'training_name',
                'training_jobTitle',
                'training_trainingNeed',
                'training_trainingTitle',
                'training_location',
                'training_organization',
                'training_type',
                'training_status',
                'training_duration',
                'training_evaluation',
                'training_grade',
                'training_certificate',
                'training_notes',
                'training_supervisor'
            ];
            
            // Include date fields
            const startDateField = 'training_startDate';
            const endDateField = 'training_endDate';
            const entryDateField = 'training_entryDate';
            
            let q = fields.map(f =>
                `${f.replace('training_', '')}=${encodeURIComponent(document.getElementById(f).value || '')}`
            ).join('&');
            
            // Add date fields
            q += `&startDate=${encodeURIComponent(startDateForStorage)}`;
            q += `&endDate=${encodeURIComponent(endDateForStorage)}`;
            q += `&entryDate=${encodeURIComponent(entryDateForStorage)}`;
            
            jsonp(`${TRAINING_SCRIPT_URL}?action=add&${q}&callback=alertTrainingResult`);
        }
        
        function updateTrainingRecord() { 
            const requiredFields = ['training_id', 'training_year', 'training_name', 'training_employeeNumber', 'training_jobTitle', 'training_trainingTitle'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            // Validate dates if provided
            const startDate = document.getElementById('training_startDate').value;
            const endDate = document.getElementById('training_endDate').value;
            const entryDate = document.getElementById('training_entryDate').value;
            
            if (startDate && !validateDate(startDate)) {
                document.getElementById('training_startDate').classList.add('is-invalid');
                showNotification('❌ تاريخ البداية غير صحيح', 'error');
                return;
            } else {
                document.getElementById('training_startDate').classList.remove('is-invalid');
            }
            
            if (endDate && !validateDate(endDate)) {
                document.getElementById('training_endDate').classList.add('is-invalid');
                showNotification('❌ تاريخ الانتهاء غير صحيح', 'error');
                return;
            } else {
                document.getElementById('training_endDate').classList.remove('is-invalid');
            }
            
            if (entryDate && !validateDate(entryDate)) {
                document.getElementById('training_entryDate').classList.add('is-invalid');
                showNotification('❌ تاريخ الإدخال غير صحيح', 'error');
                return;
            } else {
                document.getElementById('training_entryDate').classList.remove('is-invalid');
            }
            
            // Validate end date is not before start date
            if (startDate && endDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const endDateObj = parseDateDDMMYYYY(endDate);
                    
                    if (startDateObj && endDateObj && endDateObj < startDateObj) {
                        showNotification('❌ تاريخ الانتهاء يجب أن يكون بعد تاريخ البداية أو مساوياً له', 'error');
                        document.getElementById('training_endDate').classList.add('is-invalid');
                        return;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            setStatus("جاري الإرسال...", 'info');
            
            // Get date values from date inputs (already in dd/mm/yyyy format)
            const startDateForStorage = formatDateForStorage(startDate);
            const endDateForStorage = formatDateForStorage(endDate);
            const entryDateForStorage = formatDateForStorage(entryDate);
            
            // Update the hidden fields with correct dates
            document.getElementById('training_startDate').value = startDateForStorage;
            document.getElementById('training_endDate').value = endDateForStorage;
            document.getElementById('training_entryDate').value = entryDateForStorage;
            
            const fields = [
                'training_id',
                'training_year',
                'training_employeeNumber',
                'training_name',
                'training_jobTitle',
                'training_trainingNeed',
                'training_trainingTitle',
                'training_location',
                'training_organization',
                'training_type',
                'training_status',
                'training_duration',
                'training_evaluation',
                'training_grade',
                'training_certificate',
                'training_notes',
                'training_supervisor'
            ];
            
            // Include date fields
            const startDateField = 'training_startDate';
            const endDateField = 'training_endDate';
            const entryDateField = 'training_entryDate';
            
            let q = fields.map(f =>
                `${f.replace('training_', '')}=${encodeURIComponent(document.getElementById(f).value || '')}`
            ).join('&');
            
            // Add date fields
            q += `&startDate=${encodeURIComponent(startDateForStorage)}`;
            q += `&endDate=${encodeURIComponent(endDateForStorage)}`;
            q += `&entryDate=${encodeURIComponent(entryDateForStorage)}`;
            
            jsonp(`${TRAINING_SCRIPT_URL}?action=update&${q}&callback=alertTrainingResult`);
        }
        
        function alertTrainingResult(res) {
            console.log('CRUD operation result:', res);
            
            if (res && res.status === 'success') {
                showNotification(`✅ ${res.message}`, 'success');
                setStatus(res.message, 'success');
                resetTrainingForm();
            } else {
                const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                showNotification(`❌ ${errorMsg}`, 'error');
                setStatus(errorMsg, 'error');
            }
            loadTrainingData();
        }
        
        function editTrainingRecord(recordId) {
            setStatus('🔍 جاري تحميل بيانات سجل التدريب...', 'info');
            
            const record = trainingRecords.find(r => {
                const id = r[0] || r.id || r.recordId || '';
                return String(id).trim() === String(recordId).trim();
            });
            
            if (record) {
                fillTrainingForm(record);
                document.getElementById('training_updateBtn').style.display = 'inline-block';
                document.getElementById('training_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات سجل التدريب', 'success');
                setStatus('تم تحميل بيانات سجل التدريب', 'success');
            } else {
                showNotification('❌ لم يتم العثور على سجل التدريب', 'error');
                setStatus('لم يتم العثور على سجل التدريب', 'error');
            }
        }
        
        function fillTrainingForm(record) {
            // Handle multiple record formats
            // Expected format: [id, year, empNo, name, jobTitle, trainingNeed, trainingTitle, location, organization, startDate, endDate, type, status, duration, evaluation, grade, certificate, notes, supervisor, entryDate]
            
            const recordId = record[0] || record.id || record.recordId || '';
            const year = record[1] || record.year || '';
            const employeeNumber = record[2] || record.employeeNumber || '';
            const employeeName = record[3] || record.name || '';
            const jobTitle = record[4] || record.jobTitle || '';
            const trainingNeed = record[5] || record.trainingNeed || '';
            const trainingTitle = record[6] || record.trainingTitle || '';
            const location = record[7] || record.location || '';
            const organization = record[8] || record.organization || '';
            const trainingType = record[11] || record.type || '';
            const status = record[12] || record.status || '';
            const duration = record[13] || record.duration || '';
            const evaluation = record[14] || record.evaluation || '';
            const grade = record[15] || record.grade || '';
            const certificate = record[16] || record.certificate || '';
            const notes = record[17] || record.notes || '';
            const supervisor = record[18] || record.supervisor || '';
            const entryDate = record[19] || record.entryDate || '';
            
            const startDate = record[9] || record.startDate || '';
            const endDate = record[10] || record.endDate || '';
            
            document.getElementById('training_id').value = recordId;
            document.getElementById('training_year').value = year;
            document.getElementById('training_employeeNumber').value = employeeNumber;
            document.getElementById('training_name').value = employeeName;
            document.getElementById('training_jobTitle').value = jobTitle;
            document.getElementById('training_trainingNeed').value = trainingNeed;
            document.getElementById('training_trainingTitle').value = trainingTitle;
            document.getElementById('training_location').value = location;
            document.getElementById('training_organization').value = organization;
            document.getElementById('training_type').value = trainingType;
            document.getElementById('training_status').value = status;
            document.getElementById('training_duration').value = duration;
            document.getElementById('training_evaluation').value = evaluation;
            document.getElementById('training_grade').value = grade;
            document.getElementById('training_certificate').value = certificate || 'نعم';
            document.getElementById('training_notes').value = notes;
            document.getElementById('training_supervisor').value = supervisor;
            
            // Set date values - convert from Google Sheets format to input format
            const startDateFormatted = formatDateForInput(startDate);
            const endDateFormatted = formatDateForInput(endDate);
            const entryDateFormatted = formatDateForInput(entryDate);
            
            // Set the input values directly
            document.getElementById('training_startDate').value = startDateFormatted;
            document.getElementById('training_endDate').value = endDateFormatted;
            document.getElementById('training_entryDate').value = entryDateFormatted;
            
            // Update Flatpickr instances WITHOUT triggering onChange
            if (flatpickrInstances.startDate && startDateFormatted) {
                try {
                    const parts = startDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.startDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting start date:', e);
                }
            }
            
            if (flatpickrInstances.endDate && endDateFormatted) {
                try {
                    const parts = endDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.endDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting end date:', e);
                }
            }
            
            if (flatpickrInstances.entryDate && entryDateFormatted) {
                try {
                    const parts = entryDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.entryDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting entry date:', e);
                }
            }
            
            document.getElementById('training_editingId').value = recordId;
        }
        
        function resetTrainingForm() {
            document.getElementById('trainingForm').reset();
            document.getElementById('training_editingId').value = '';
            document.getElementById('training_addBtn').style.display = 'inline-block';
            document.getElementById('training_updateBtn').style.display = 'none';
            document.querySelectorAll('#trainingForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            // Set default values for dropdowns
            document.getElementById('training_type').value = '';
            document.getElementById('training_status').value = 'مخطط له';
            document.getElementById('training_evaluation').value = '';
            document.getElementById('training_certificate').value = 'نعم';
            
            // Set current date for entry date
            const now = new Date();
            const today = formatDateToDDMMYYYY(now);
            document.getElementById('training_entryDate').value = today;
            
            // Clear Flatpickr instances
            if (flatpickrInstances.startDate) {
                flatpickrInstances.startDate.clear();
            }
            if (flatpickrInstances.endDate) {
                flatpickrInstances.endDate.clear();
            }
            if (flatpickrInstances.entryDate) {
                flatpickrInstances.entryDate.setDate('today', false);
            }
            
            setStatus('تم مسح النموذج', 'success');
        }
        
        function showDeleteModal(recordId, recordName) {
            deleteRecordId = recordId;
            deleteRecordName = recordName;
            
            document.getElementById('deleteRecordId').textContent = recordId || 'غير معروف';
            document.getElementById('deleteRecordName').textContent = recordName || 'غير معروف';
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
        
        function confirmDelete() {
            if (!deleteRecordId) return;
            
            const button = document.getElementById('confirmDeleteBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحذف...';
            
            setStatus("جاري الحذف...", 'info');
            
            jsonp(`${TRAINING_SCRIPT_URL}?action=delete&id=${encodeURIComponent(deleteRecordId)}&callback=deleteTrainingResult`);
            
            function deleteTrainingResult(res) {
                button.disabled = false;
                button.innerHTML = originalHtml;
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    setStatus(res.message, 'success');
                    
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    deleteModal.hide();
                    
                    deleteRecordId = '';
                    deleteRecordName = '';
                    
                    loadTrainingData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ أثناء الحذف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                    setStatus(errorMsg, 'error');
                }
            }
        }
        
        // ================ DETAILS VIEW FUNCTION ================
        function viewTrainingDetails(recordId) {
            const record = trainingRecords.find(r => {
                const id = r[0] || r.id || r.recordId || '';
                return String(id).trim() === String(recordId).trim();
            });
            
            if (!record) {
                showNotification('❌ لم يتم العثور على سجل التدريب', 'error');
                return;
            }
            
            // Expected format: [id, year, empNo, name, jobTitle, trainingNeed, trainingTitle, location, organization, startDate, endDate, type, status, duration, evaluation, grade, certificate, notes, supervisor, entryDate]
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0] || record.id || record.recordId || '')}</p>
                        <p><strong>العام:</strong> ${escapeHtml(record[1] || record.year || '')}</p>
                        <p><strong>اسم الموظف:</strong> ${escapeHtml(record[3] || record.name || '')}</p>
                        <p><strong>الرقم الوظيفي:</strong> ${escapeHtml(record[2] || record.employeeNumber || '')}</p>
                        <p><strong>الوظيفة:</strong> ${escapeHtml(record[4] || record.jobTitle || '')}</p>
                        <p><strong>نوع التدريب:</strong> ${escapeHtml(record[11] || record.type || '')}</p>
                        <p><strong>حالة التدريب:</strong> ${escapeHtml(record[12] || record.status || '')}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>مسمى التدريب:</strong> ${escapeHtml(record[6] || record.trainingTitle || '')}</p>
                        <p><strong>مكان الانعقاد:</strong> ${escapeHtml(record[7] || record.location || '')}</p>
                        <p><strong>الجهة المنظمة:</strong> ${escapeHtml(record[8] || record.organization || '')}</p>
                        <p><strong>تاريخ البداية:</strong> <span class="english-date">${formatDateForDisplay(record[9] || record.startDate || '').replace(/<[^>]*>/g, '')}</span></p>
                        <p><strong>تاريخ الانتهاء:</strong> <span class="english-date">${formatDateForDisplay(record[10] || record.endDate || '').replace(/<[^>]*>/g, '')}</span></p>
                        <p><strong>المدة بالأيام:</strong> ${escapeHtml(record[13] || record.duration || '')}</p>
                        <p><strong>تاريخ الإدخال:</strong> <span class="english-date">${formatDateForDisplay(record[19] || record.entryDate || '').replace(/<[^>]*>/g, '')}</span></p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <p><strong>الهدف من التدريب:</strong> ${escapeHtml(record[5] || record.trainingNeed || '')}</p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p><strong>التقييم:</strong> ${escapeHtml(record[14] || record.evaluation || '')}</p>
                        <p><strong>الدرجة النهائية:</strong> ${escapeHtml(record[15] || record.grade || '')}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>الشهادة:</strong> ${escapeHtml(record[16] || record.certificate || '')}</p>
                        <p><strong>اسم المشرف:</strong> ${escapeHtml(record[18] || record.supervisor || '')}</p>
                    </div>
                </div>
                
                ${record[17] ? `<div class="row mt-3">
                    <div class="col-md-12">
                        <p><strong>ملاحظات إضافية:</strong> ${escapeHtml(record[17] || record.notes || '')}</p>
                    </div>
                </div>` : ''}
            `;
            
            document.getElementById('detailsModalBody').innerHTML = detailsHTML;
            
            const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
            detailsModal.show();
        }
        
        // ================ EXPORT FUNCTION ================
        function exportTrainingCSV() {
            if (trainingRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلات التدريب...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'العام', 'الرقم الوظيفي', 'اسم الموظف', 'الوظيفة',
                    'الهدف من التدريب', 'مسمى التدريب', 'مكان الانعقاد', 'الجهة المنظمة',
                    'تاريخ البداية', 'تاريخ الانتهاء', 'نوع التدريب', 'حالة التدريب',
                    'المدة بالأيام', 'التقييم', 'الدرجة النهائية', 'الشهادة',
                    'ملاحظات إضافية', 'اسم المشرف', 'تاريخ الإدخال'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                trainingRecords.forEach(record => {
                    // Clean HTML tags from dates for CSV export
                    const startDateDisplay = formatDateForDisplay(record[9] || record.startDate || '').replace(/<[^>]*>/g, '');
                    const endDateDisplay = formatDateForDisplay(record[10] || record.endDate || '').replace(/<[^>]*>/g, '');
                    const entryDateDisplay = formatDateForDisplay(record[19] || record.entryDate || '').replace(/<[^>]*>/g, '');
                    
                    const row = [
                        record[0] || record.id || record.recordId || '',
                        record[1] || record.year || '',
                        record[2] || record.employeeNumber || '',
                        record[3] || record.name || '',
                        record[4] || record.jobTitle || '',
                        record[5] || record.trainingNeed || '',
                        record[6] || record.trainingTitle || '',
                        record[7] || record.location || '',
                        record[8] || record.organization || '',
                        startDateDisplay,
                        endDateDisplay,
                        record[11] || record.type || '',
                        record[12] || record.status || '',
                        record[13] || record.duration || '',
                        record[14] || record.evaluation || '',
                        record[15] || record.grade || '',
                        record[16] || record.certificate || '',
                        record[17] || record.notes || '',
                        record[18] || record.supervisor || '',
                        entryDateDisplay
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `سجلات_التدريب_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${trainingRecords.length} سجل تدريب`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
        
        // ================ REFRESH EMPLOYEE DATA ================
        function refreshEmployeeData() {
            employeeDataLoaded = false;
            loadEmployeeData();
            showNotification('🔄 جاري تحديث بيانات الموظفين...', 'info');
        }
        
        // ================ DEBUGGING HELPER ================
        function testTrainingScript() {
            console.log('Testing training script...');
            loadTrainingData();
        }
        
        function testEmployeeScript() {
            console.log('Testing employee script...');
            loadEmployeeData();
        }
    </script>
</body>
</html>
