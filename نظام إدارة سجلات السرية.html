<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> نظام إدارة سجلات السرية - معمل كواليتك إنترناشيونال</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --calibration-color: #3498db;
            --file-color: #9b59b6;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles - Updated to match second code layout */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .main-header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .main-header .lead {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        /* Home Button - Updated position to match second code */
        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
            white-space: nowrap;
        }
        
        .home-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .home-button i {
            margin-right: 5px;
        }
        
        /* Header adjustments for home button - Added from second code */
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        /* Ensure the date badge doesn't overlap with home button - Added from second code */
        @media (min-width: 769px) {
            .header-badge-container {
                position: relative;
                padding-left: 130px; /* Space for home button */
            }
        }
        
        /* Card Styles */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-custom {
            padding: 15px 20px;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .card-header-calibration {
            background: linear-gradient(135deg, var(--calibration-color), #2980b9);
        }
        
        .card-header-agreement {
            background: linear-gradient(135deg, #27ae60, #219653);
        }
        
        .card-header-file {
            background: linear-gradient(135deg, var(--file-color), #8e44ad);
        }
        
        /* Form Styles */
        .form-control-custom, .form-select-custom, .form-textarea-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control-custom:focus, .form-select-custom:focus, .form-textarea-custom:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
            background: white;
        }
        
        .form-textarea-custom {
            min-height: 70px;
            resize: vertical;
        }
        
        .form-label-custom {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Agreement Checkboxes Styles */
        .agreement-container {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }
        
        .agreement-checkbox {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .agreement-checkbox:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .agreement-checkbox .form-check-input {
            width: 20px;
            height: 20px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .agreement-checkbox .form-check-label {
            cursor: pointer;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .agreement-checkbox .form-check-input:checked {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        /* Upload File Button Styles */
        .upload-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .upload-container:hover {
            background: #e9ecef;
            border-color: var(--secondary-color);
        }
        
        .upload-container.dragover {
            background: #e3f2fd;
            border-color: var(--secondary-color);
            border-style: solid;
        }
        
        .upload-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #5a6268;
        }
        
        .upload-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        
        .upload-status {
            margin-top: 10px;
            font-size: 0.85rem;
            min-height: 20px;
        }
        
        .upload-status.success {
            color: var(--success-color);
        }
        
        .upload-status.error {
            color: var(--danger-color);
        }
        
        .upload-status.loading {
            color: var(--secondary-color);
        }
        
        .file-link-btn {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .file-link-btn:hover {
            background: #219653;
            color: white;
            text-decoration: none;
        }
        
        /* Date Input Styling */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .date-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            pointer-events: none;
        }
        
        .date-input-wrapper .form-control-custom {
            padding-right: 40px;
            direction: ltr;
            text-align: right;
        }
        
        /* Flatpickr Customization */
        .flatpickr-calendar {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }
        
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-family: 'Cairo', sans-serif;
        }
        
        .flatpickr-weekdays {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 0;
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0;
            min-width: 1300px;
            width: 100%;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            border: none;
            padding: 15px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .table-custom tbody tr {
            transition: all 0.2s;
        }
        
        .table-custom tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.08);
        }
        
        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 2px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 70px;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: #212529;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        
        .spinner-border-custom {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.2rem;
        }
        
        /* FIX FOR ENGLISH DATE DISPLAY IN RTL CONTEXT */
        .english-date {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed !important;
            display: inline-block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 1px;
                min-width: 60px;
            }
            
            /* Home Button Responsive Styles - Updated to match second code */
            .home-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
            
            .main-header {
                padding-top: 60px;
            }
            
            /* Header badge container responsive - Added from second code */
            .header-badge-container {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
            }
            
            .table-custom {
                min-width: 1100px;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }
        
        /* Modal Custom */
        .modal-header-custom {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Modal Fix - Prevent background scroll - Added from second code */
        body.modal-open {
            overflow: hidden;
            padding-right: 0 !important;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Main Container -->
    <div class="container-fluid main-container">
        <!-- Main Header - Updated to match second code layout -->
        <div class="main-header fade-in">
            <!-- Return to Home Button -->
            <a href="https://qualinova7.github.io/QualiNova/" class="home-button">
                <i class="fas fa-home"></i> العودة للرئيسية
            </a>
            
            <div class="header-content">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="fas fa-file-contract me-2"></i> نظام إدارة سجلات السرية - معمل كواليتك إنترناشيونال</h1>
                        <p class="lead mb-0">نظام متكامل لإدارة سجلات السرية للموظفين والعقود والالتزامات القانونية</p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0 header-badge-container">
                        <div class="header-badge d-inline-block me-3">
                            <i class="fas fa-database me-2"></i>
                            <span id="totalRecords">0</span> سجلات
                        </div>
                        <div class="header-badge d-inline-block">
                            <i class="fas fa-calendar me-2"></i>
                            <span id="currentDate">--/--/----</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-calibration">
                        <i class="fas fa-file-alt me-2"></i> إدارة سجلات السرية
                    </div>
                    <div class="card-body">
                        <form id="calibrationForm">
                            <!-- File Upload Section -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="upload-container" id="uploadContainer">
                                        <h6><i class="fas fa-cloud-upload-alt me-2"></i>رفع ملف السرية (PDF أو صورة)</h6>
                                        <p class="text-muted mb-2" style="font-size: 0.85rem;">الحد الأقصى لحجم الملف: 10 ميجابايت. الأنواع المسموحة: PNG, JPG, JPEG, PDF</p>
                                        
                                        <input type="file" id="fileInput" 
                                               accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf"
                                               style="display: none">
                                        <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-folder-open me-1"></i> اختر ملف للرفع
                                        </button>
                                        <button type="button" class="upload-btn" onclick="uploadFile()" id="uploadBtn">
                                            <i class="fas fa-upload me-1"></i> رفع الملف
                                        </button>
                                        
                                        <div class="upload-status" id="uploadStatus"></div>
                                        
                                        <div id="uploadedFileInfo" style="display: none; margin-top: 10px;">
                                            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                                                <div>
                                                    <i class="fas fa-file me-2"></i>
                                                    <span id="uploadedFileName"></span>
                                                    <span class="badge bg-success ms-2" id="uploadedFileSize"></span>
                                                </div>
                                                <a href="#" target="_blank" class="file-link-btn" id="uploadedFileLink" style="display: none;">
                                                    <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">رقم سجل السرية *</label>
                                    <input type="text" class="form-control form-control-custom" id="calibration_secretRecordNumber" placeholder="رقم سجل السرية" required>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">اسم الموظف *</label>
                                    <input type="text" class="form-control form-control-custom" id="calibration_employeeName" placeholder="اسم الموظف" required list="employeeNameList">
                                    <datalist id="employeeNameList"></datalist>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">الرقم الوظيفي *</label>
                                    <input type="text" class="form-control form-control-custom" id="calibration_employeeNumber" placeholder="الرقم الوظيفي" required list="employeeNumberList">
                                    <datalist id="employeeNumberList"></datalist>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">القسم *</label>
                                    <input type="text" class="form-control form-control-custom" id="calibration_department" placeholder="القسم" required list="departmentList">
                                    <datalist id="departmentList"></datalist>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">نوع العقد</label>
                                    <input type="text" class="form-control form-control-custom" id="calibration_contractType" placeholder="اختر نوع العقد" list="contractTypeList">
                                    <datalist id="contractTypeList">
                                        <option value="دائم">دائم</option>
                                        <option value="مؤقت">مؤقت</option>
                                        <option value="تدريب">تدريب</option>
                                    </datalist>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">تاريخ بدء العمل</label>
                                    <div class="date-input-wrapper">
                                        <input type="text" class="form-control form-control-custom date-picker" id="calibration_startDate" placeholder="يوم/شهر/سنة" readonly>
                                        <i class="fas fa-calendar-alt date-icon"></i>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">تاريخ التوقيع</label>
                                    <div class="date-input-wrapper">
                                        <input type="text" class="form-control form-control-custom date-picker" id="calibration_signDate" placeholder="يوم/شهر/سنة" readonly>
                                        <i class="fas fa-calendar-alt date-icon"></i>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label-custom">اسم المراجع</label>
                                    <input type="text" class="form-control form-control-custom" id="calibration_reviewerName" placeholder="اسم المراجع">
                                </div>
                            </div>
                            
                            <!-- Confidentiality Agreement Section -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="custom-card">
                                        <div class="card-header-custom card-header-agreement">
                                            <i class="fas fa-shield-alt me-2"></i> بنود السرية والالتزامات
                                        </div>
                                        <div class="card-body">
                                            <div class="agreement-container">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="agreement-checkbox">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="calibration_confidentiality" checked>
                                                                <label class="form-check-label" for="calibration_confidentiality">
                                                                    عدم إفشاء المعلومات السرية
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="agreement-checkbox">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="calibration_officialUse" checked>
                                                                <label class="form-check-label" for="calibration_officialUse">
                                                                    استخدام المعلومات للأغراض الرسمية فقط
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="agreement-checkbox">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="calibration_accessProtection" checked>
                                                                <label class="form-check-label" for="calibration_accessProtection">
                                                                    حماية المعلومات من الوصول غير المصرح به
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="agreement-checkbox">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="calibration_breachReporting" checked>
                                                                <label class="form-check-label" for="calibration_breachReporting">
                                                                    الإبلاغ الفوري عن خروقات السرية
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="agreement-checkbox">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="calibration_passwordProtection" checked>
                                                                <label class="form-check-label" for="calibration_passwordProtection">
                                                                    حماية أجهزة الحاسب بكلمات مرور قوية
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="agreement-checkbox">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="calibration_noSocialMedia" checked>
                                                                <label class="form-check-label" for="calibration_noSocialMedia">
                                                                    عدم نشر المعلومات على وسائل التواصل
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label class="form-label-custom">ملاحظات</label>
                                    <textarea class="form-control form-textarea-custom" id="calibration_notes" placeholder="ملاحظات" rows="2"></textarea>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12 d-flex justify-content-between">
                                    <button type="button" onclick="resetCalibrationForm()" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-1"></i> مسح النموذج
                                    </button>
                                    <div>
                                        <button type="button" onclick="addCalibrationRecord()" class="btn btn-success me-2" id="calibration_addBtn">
                                            <i class="fas fa-plus me-1"></i> إضافة جديد
                                        </button>
                                        <button type="button" onclick="updateCalibrationRecord()" class="btn btn-primary" id="calibration_updateBtn" style="display: none;">
                                            <i class="fas fa-save me-1"></i> تحديث السجل
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="calibration_editingId">
                            <input type="hidden" id="calibration_recordId">
                            <input type="hidden" id="calibration_fileLink">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Records Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-calibration d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i> قائمة سجلات السرية</span>
                        <div>
                            <button onclick="loadCalibrationData()" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                            <button onclick="exportCalibrationCSV()" class="btn btn-light btn-sm">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading-spinner" id="calibrationLoadingSpinner">
                            <div class="spinner-border text-primary spinner-border-custom" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive" id="calibrationTableContainer" style="display: none;">
                            <table class="table table-custom table-hover" id="calibrationDataTable">
                            </table>
                        </div>
                        
                        <div id="calibrationNoRecords" class="text-center py-5" style="display: none;">
                            <i class="fas fa-file-alt fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted">لا توجد سجلات لعرضها</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 fade-in">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-copyright me-1"></i> نظام إدارة سجلال السرية 
                    <span id="currentYear"></span> | 
                    <span id="appVersion" class="text-info">الإصدار 1.1 (مع بنود السرية)</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal - FIXED -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تأكيد الحذف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-2x float-start me-3"></i>
                        <h5 class="alert-heading">تحذير!</h5>
                        <p>هل أنت متأكد من حذف هذا السجل؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                        <hr>
                        <p class="mb-0"><strong>النظام:</strong> <span id="deleteSystemType">سجلال السرية</span></p>
                        <p class="mb-0"><strong>رقم سجل السرية:</strong> <span id="deleteRecordId">غير معروف</span></p>
                        <p class="mb-0"><strong>الاسم:</strong> <span id="deleteRecordName">غير معروف</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> نعم، احذف السجل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تفاصيل سجل السرية</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr Calendar -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ================ CONFIGURATION ================
        const CALIBRATION_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxb3OzEoKoOhmXlyar5Lxk0Ku_Nj7UjLBoUmbneiKWKdlYgxAphcgzgvnGa5g0iK5_tYQ/exec";
        const EMPLOYEE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiKkgfhdI3xaW6biMBZCCkuIN9P_6mvUQVHJWgj35kHOUvuQjduHzYfAnOCG0aHWlcpA/exec";
        const UPLOAD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyAAiQ7MyV68RWvAzborRzTC77kfe8NjpJHT98WQhxIVRaJAbeVVmTAsjMhYrMQaphuNw/exec";
        
        // ================ GLOBAL VARIABLES ================
        let calibrationRecords = [];
        let employeeRecords = [];
        let deleteRecordId = '';
        let deleteRecordName = '';
        let flatpickrInstances = {};
        let deleteModalInstance = null;
        let detailsModalInstance = null;
        let selectedFile = null;
        let uploadedFileUrl = '';
        
        // ================ FILE UPLOAD FUNCTIONS ================
        function initializeFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadContainer = document.getElementById('uploadContainer');
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // Drag and drop functionality
            uploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadContainer.classList.add('dragover');
            });
            
            uploadContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');
            });
            
            uploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
        }
        
        function handleFileSelect(file) {
            const allowedTypes = [
                "image/png",
                "image/jpeg",
                "application/pdf"
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showNotification("❌ فقط ملفات PNG, JPG, JPEG أو PDF مسموحة", "error");
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification("❌ حجم الملف كبير جداً (الحد الأقصى 10MB)", "error");
                return;
            }
            
            selectedFile = file;
            
            // Display file info
            document.getElementById('uploadedFileName').textContent = file.name;
            document.getElementById('uploadedFileSize').textContent = formatFileSize(file.size);
            document.getElementById('uploadedFileInfo').style.display = 'block';
            document.getElementById('uploadedFileLink').style.display = 'none';
            
            // Reset upload status
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = '';
            uploadStatus.className = 'upload-status';
            
            showNotification(`✅ تم اختيار الملف: ${file.name}`, 'success', 3000);
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' بايت';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' كيلوبايت';
            else return (bytes / 1048576).toFixed(1) + ' ميجابايت';
        }
        
        async function uploadFile() {
            if (!selectedFile) {
                showNotification("⚠️ يرجى اختيار ملف أولاً", "warning");
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الرفع...';
            uploadStatus.textContent = 'جاري رفع الملف... ⏳';
            uploadStatus.className = 'upload-status loading';
            
            try {
                const reader = new FileReader();
                
                reader.onload = async function() {
                    const base64 = reader.result.split(",")[1];
                    
                    const response = await fetch(UPLOAD_WEB_APP_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            fileName: selectedFile.name,
                            mimeType: selectedFile.type,
                            fileData: base64
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === "success") {
                        uploadedFileUrl = data.url;
                        
                        // Update the hidden field
                        document.getElementById('calibration_fileLink').value = uploadedFileUrl;
                        
                        // Display success message and file link
                        uploadStatus.textContent = '✅ تم رفع الملف بنجاح';
                        uploadStatus.className = 'upload-status success';
                        
                        // Show the file link button
                        const fileLinkBtn = document.getElementById('uploadedFileLink');
                        fileLinkBtn.href = uploadedFileUrl;
                        fileLinkBtn.style.display = 'inline-block';
                        
                        showNotification(`✅ تم رفع الملف بنجاح: ${selectedFile.name}`, 'success');
                    } else {
                        uploadStatus.textContent = '❌ فشل في رفع الملف: ' + (data.message || 'خطأ غير معروف');
                        uploadStatus.className = 'upload-status error';
                        showNotification(`❌ فشل في رفع الملف: ${data.message || 'خطأ غير معروف'}`, 'error');
                    }
                    
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                };
                
                reader.onerror = function() {
                    uploadStatus.textContent = '❌ خطأ في قراءة الملف';
                    uploadStatus.className = 'upload-status error';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                    showNotification('❌ خطأ في قراءة الملف', 'error');
                };
                
                reader.readAsDataURL(selectedFile);
                
            } catch (error) {
                uploadStatus.textContent = '❌ فشل في رفع الملف: ' + error;
                uploadStatus.className = 'upload-status error';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                showNotification('❌ فشل في رفع الملف: ' + error, 'error');
            }
        }
        
        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date and year
            setCurrentDate();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize modals
            deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteModal'));
            detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal'));
            
            // Initialize calendar pickers
            initializeDatePickers();
            
            // Initialize file upload
            initializeFileUpload();
            
            // Load data
            setTimeout(() => {
                loadCalibrationData();
                loadEmployeeData();
            }, 500);
            
            // Fix modal backdrop issue
            document.getElementById('deleteModal').addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            });
            
            document.getElementById('detailsModal').addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            });
        });
        
        // ================ FIXED DATE PICKER INITIALIZATION ================
        function initializeDatePickers() {
            // Destroy existing instances if any
            if (flatpickrInstances.startDate) flatpickrInstances.startDate.destroy();
            if (flatpickrInstances.signDate) flatpickrInstances.signDate.destroy();
            
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: true,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                onChange: function(selectedDates, dateStr, instance) {
                    validateSignDateNotOlder();
                    
                    if (selectedDates.length > 0) {
                        const date = selectedDates[0];
                        const formattedDate = formatDateToDDMMYYYY(date);
                        instance.input.value = formattedDate;
                    }
                }
            };
            
            flatpickrInstances.startDate = flatpickr('#calibration_startDate', dateOptions);
            flatpickrInstances.signDate = flatpickr('#calibration_signDate', dateOptions);
            
            if (flatpickrInstances.startDate) flatpickrInstances.startDate.set('locale', 'ar');
            if (flatpickrInstances.signDate) flatpickrInstances.signDate.set('locale', 'ar');
        }
        
        // ================ DATE FORMATTING FUNCTIONS ================
        function formatDateToDDMMYYYY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    if (day < 1 || day > 31) return null;
                    if (month < 0 || month > 11) return null;
                    if (year < 1900 || year > 2100) return null;
                    
                    return new Date(year, month, day);
                }
            }
            
            return null;
        }
        
        function formatDateForDisplay(dateString) {
            if (!dateString || dateString.trim() === '') return '';
            
            // If already in dd/mm/yyyy format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString.trim())) {
                return `<span class="english-date">${dateString}</span>`;
            }
            
            // Try to parse the date
            let dateObj = null;
            
            // Format YYYY/MM/DD (Google Sheets format)
            if (dateString.includes('/') && dateString.split('/')[0].length === 4) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    dateObj = new Date(year, month, day);
                }
            }
            // Format DD/MM/YYYY
            else if (dateString.includes('/') && dateString.split('/')[2].length === 4) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    dateObj = new Date(year, month, day);
                }
            }
            // Try other formats
            else {
                dateObj = new Date(dateString);
            }
            
            if (!dateObj || isNaN(dateObj.getTime())) {
                return `<span class="english-date">${dateString}</span>`;
            }
            
            const formattedDate = formatDateToDDMMYYYY(dateObj);
            return `<span class="english-date">${formattedDate}</span>`;
        }
        
        function formatDateForInput(dateString) {
            if (!dateString || dateString.trim() === '') return '';
            
            const cleanDateString = dateString.replace(/<[^>]*>/g, '');
            
            // If already in dd/mm/yyyy format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(cleanDateString.trim())) {
                return cleanDateString;
            }
            
            // Try to parse "30 September 2026" format
            const parts = cleanDateString.split(' ');
            if (parts.length === 3 && isNaN(parts[1])) {
                const day = parseInt(parts[0], 10);
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const monthIndex = monthNames.findIndex(name => 
                    name.toLowerCase() === parts[1].toLowerCase()
                );
                
                if (monthIndex !== -1) {
                    const month = (monthIndex + 1).toString().padStart(2, '0');
                    const year = parts[2];
                    return `${day.toString().padStart(2, '0')}/${month}/${year}`;
                }
            }
            
            // Try to parse as date
            try {
                const dateObj = new Date(cleanDateString);
                if (!isNaN(dateObj.getTime())) {
                    return formatDateToDDMMYYYY(dateObj);
                }
            } catch (e) {
                console.error('Error parsing date for input:', e);
            }
            
            return '';
        }
        
        function validateDate(dateString) {
            if (!dateString) return true;
            
            const ddMMyyyyRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const displayFormatRegex = /^(\d{1,2})\s+(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{4})$/i;
            
            if (ddMMyyyyRegex.test(dateString)) {
                const match = dateString.match(ddMMyyyyRegex);
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                const year = parseInt(match[3], 10);
                
                if (year < 1900 || year > 2100) return false;
                if (month < 1 || month > 12) return false;
                if (day < 1 || day > 31) return false;
                
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 
                                    31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            if (displayFormatRegex.test(dateString)) {
                const match = dateString.match(displayFormatRegex);
                const day = parseInt(match[1], 10);
                const monthName = match[2];
                const year = parseInt(match[3], 10);
                
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const month = monthNames.findIndex(name => 
                    name.toLowerCase() === monthName.toLowerCase()
                ) + 1;
                
                if (month === 0) return false;
                if (year < 1900 || year > 2100) return false;
                if (day < 1 || day > 31) return false;
                
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 
                                    31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            return false;
        }
        
        // ================ DATE VALIDATION ================
        function validateSignDateNotOlder() {
            const startDateStr = document.getElementById('calibration_startDate').value;
            const signDateStr = document.getElementById('calibration_signDate').value;
            
            if (!startDateStr || !signDateStr) return;
            
            try {
                const startDate = parseDateDDMMYYYY(startDateStr);
                const signDate = parseDateDDMMYYYY(signDateStr);
                
                if (startDate && signDate && signDate < startDate) {
                    showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                    if (flatpickrInstances.signDate) {
                        flatpickrInstances.signDate.clear();
                    }
                    document.getElementById('calibration_signDate').value = '';
                }
            } catch (e) {
                console.error('Error validating dates:', e);
            }
        }
        
        function setCurrentDate() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('currentDate').textContent = `${day}/${month}/${year}`;
        }
        
        // ================ NOTIFICATION SYSTEM ================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getNotificationIcon(type)} me-3"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            return notification;
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // ================ JSONP FUNCTION ================
        function jsonp(url, callbackParam = 'callback') {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + callbackParam + '=' + callbackName;
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // ================ VALIDATION HELPER ================
        function validateForm(requiredFields) {
            let isValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            const startDate = document.getElementById('calibration_startDate').value;
            const signDate = document.getElementById('calibration_signDate').value;
            
            if (startDate && !validateDate(startDate)) {
                document.getElementById('calibration_startDate').classList.add('is-invalid');
                showNotification('❌ تاريخ بدء العمل غير صحيح', 'error');
                isValid = false;
            } else {
                document.getElementById('calibration_startDate').classList.remove('is-invalid');
            }
            
            if (signDate && !validateDate(signDate)) {
                document.getElementById('calibration_signDate').classList.add('is-invalid');
                showNotification('❌ تاريخ التوقيع غير صحيح', 'error');
                isValid = false;
            } else {
                document.getElementById('calibration_signDate').classList.remove('is-invalid');
            }
            
            if (startDate && signDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const signDateObj = parseDateDDMMYYYY(signDate);
                    
                    if (startDateObj && signDateObj && signDateObj < startDateObj) {
                        showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                        document.getElementById('calibration_signDate').classList.add('is-invalid');
                        isValid = false;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            return isValid;
        }
        
        // ================ EMPLOYEE DATA FUNCTIONS ================
        async function loadEmployeeData() {
            try {
                const res = await jsonp(`${EMPLOYEE_SCRIPT_URL}?action=getAll`);
                
                if (res && res.status === 'success') {
                    let records = [];
                    
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (Array.isArray(res)) {
                        records = res;
                    }
                    
                    employeeRecords = records;
                    populateEmployeeDatalists();
                    setupEmployeeAutocomplete();
                    showNotification(`✅ تم تحميل ${employeeRecords.length} موظف`, 'success', 3000);
                } else {
                    showNotification('❌ فشل في تحميل بيانات الموظفين', 'error');
                }
            } catch (error) {
                console.error('Error loading employee data:', error);
                showNotification('❌ خطأ في تحميل بيانات الموظفين', 'error');
            }
        }
        
        function populateEmployeeDatalists() {
            const nameList = document.getElementById('employeeNameList');
            const numberList = document.getElementById('employeeNumberList');
            const deptList = document.getElementById('departmentList');
            const contractList = document.getElementById('contractTypeList');
            
            nameList.innerHTML = '';
            numberList.innerHTML = '';
            deptList.innerHTML = '';
            
            const names = new Set();
            const numbers = new Set();
            const departments = new Set();
            
            employeeRecords.forEach(record => {
                if (record && record.length > 1) {
                    if (record[1]) names.add(String(record[1]).trim());
                    if (record[2]) numbers.add(String(record[2]).trim());
                    if (record[4]) departments.add(String(record[4]).trim());
                }
            });
            
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                nameList.appendChild(option);
            });
            
            numbers.forEach(number => {
                const option = document.createElement('option');
                option.value = number;
                numberList.appendChild(option);
            });
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                deptList.appendChild(option);
            });
            
            // Contract type datalist already has the three values
        }
        
        function setupEmployeeAutocomplete() {
            const employeeNameField = document.getElementById('calibration_employeeName');
            const employeeNumberField = document.getElementById('calibration_employeeNumber');
            
            employeeNameField.addEventListener('change', function() {
                autoFillFromEmployee('name', this.value);
            });
            
            employeeNumberField.addEventListener('change', function() {
                autoFillFromEmployee('number', this.value);
            });
        }
        
        function autoFillFromEmployee(fieldType, value) {
            if (!value || !employeeRecords.length) return;
            
            let record = null;
            
            if (fieldType === 'name') {
                record = employeeRecords.find(r => 
                    r && r[1] && String(r[1]).trim().toLowerCase() === String(value).trim().toLowerCase()
                );
                
                if (record && record[2]) {
                    document.getElementById('calibration_employeeNumber').value = record[2] || '';
                }
            } else if (fieldType === 'number') {
                record = employeeRecords.find(r => 
                    r && r[2] && String(r[2]).trim() === String(value).trim()
                );
                
                if (record && record[1]) {
                    document.getElementById('calibration_employeeName').value = record[1] || '';
                }
            }
            
            if (record) {
                document.getElementById('calibration_department').value = record[4] || '';
                
                // Set contract type from employee record if it's one of the allowed values
                const allowedContracts = ['دائم', 'مؤقت', 'تدريب'];
                if (record[5] && allowedContracts.includes(String(record[5]).trim())) {
                    document.getElementById('calibration_contractType').value = record[5];
                }
                
                // Set start date if available
                if (record[6]) {
                    const startDateFormatted = formatDateForInput(record[6]);
                    if (startDateFormatted) {
                        document.getElementById('calibration_startDate').value = startDateFormatted;
                        
                        if (flatpickrInstances.startDate) {
                            try {
                                const parts = startDateFormatted.split('/');
                                if (parts.length === 3) {
                                    const day = parseInt(parts[0], 10);
                                    const month = parseInt(parts[1], 10) - 1;
                                    const year = parseInt(parts[2], 10);
                                    const dateObj = new Date(year, month, day);
                                    flatpickrInstances.startDate.setDate(dateObj, false);
                                }
                            } catch (e) {
                                console.error('Error setting start date:', e);
                            }
                        }
                    }
                }
                
                showNotification(`✅ تم تحميل بيانات الموظف: ${record[1] || ''}`, 'success', 2000);
            }
        }
        
        // ================ CALIBRATION SYSTEM FUNCTIONS ================
        async function loadCalibrationData() {
            const spinner = document.getElementById('calibrationLoadingSpinner');
            const tableContainer = document.getElementById('calibrationTableContainer');
            const noRecords = document.getElementById('calibrationNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                
                spinner.style.display = 'none';
                
                let records = [];
                let responseStatus = 'error';
                
                if (res && res.status === 'success') {
                    responseStatus = 'success';
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (res.records && typeof res.records === 'object') {
                        const keys = Object.keys(res.records);
                        if (keys.length > 0 && Array.isArray(res.records[keys[0]])) {
                            records = res.records[keys[0]];
                        }
                    }
                } else if (Array.isArray(res)) {
                    records = res;
                    responseStatus = 'success';
                }
                
                if (responseStatus !== 'success') {
                    noRecords.style.display = 'block';
                    showNotification('❌ فشل في تحميل سجلال السرية', 'error');
                    document.getElementById('totalRecords').textContent = '0';
                    return;
                }
                
                calibrationRecords = records;
                
                if (calibrationRecords.length > 0) {
                    displayCalibrationRecords(calibrationRecords);
                    tableContainer.style.display = 'block';
                    document.getElementById('totalRecords').textContent = calibrationRecords.length.toLocaleString('ar-SA');
                } else {
                    noRecords.style.display = 'block';
                    document.getElementById('totalRecords').textContent = '0';
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification('❌ خطأ في تحميل سجلال السرية', 'error');
                document.getElementById('totalRecords').textContent = '0';
            }
        }
        
        function displayCalibrationRecords(records) {
            const table = document.getElementById('calibrationDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم سجل السرية', 'اسم الموظف', 'الرقم الوظيفي', 'القسم', 'نوع العقد', 'تاريخ التوقيع', 'اسم المراجع', 'الملف المرفوع', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record) => {
                const fileLink = record[17] || ''; // Column 18 (0-based index 17) is the file link
                
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[15] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[1] || '')}</td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${formatDateForDisplay(record[6] || '')}</td>`;
                html += `<td>${escapeHtml(record[14] || '')}</td>`;
                
                // File link column
                if (fileLink && fileLink.trim() !== '') {
                    html += `<td>
                        <a href="${escapeHtml(fileLink)}" target="_blank" class="file-link-btn">
                            <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                        </a>
                    </td>`;
                } else {
                    html += `<td><span class="text-muted">لا يوجد ملف</span></td>`;
                }
                
                html += `<td class="action-buttons">
                    <button onclick="editCalibrationRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[1])}', '${escapeHtml(record[15] || '')}')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addCalibrationRecord() {
            const requiredFields = ['calibration_secretRecordNumber', 'calibration_employeeName', 'calibration_employeeNumber', 'calibration_department'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const startDate = document.getElementById('calibration_startDate').value;
            const signDate = document.getElementById('calibration_signDate').value;
            
            if (startDate && signDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const signDateObj = parseDateDDMMYYYY(signDate);
                    
                    if (startDateObj && signDateObj && signDateObj < startDateObj) {
                        showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                        return;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            const button = document.getElementById('calibration_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            // Validate dates
            if (startDate && !validateDate(startDate)) {
                showNotification('❌ تاريخ بدء العمل غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            if (signDate && !validateDate(signDate)) {
                showNotification('❌ تاريخ التوقيع غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            // Generate internal recordId
            const recordId = 'CAL-' + Date.now();
            document.getElementById('calibration_recordId').value = recordId;
            
            // Get file link from hidden field
            const fileLink = document.getElementById('calibration_fileLink').value;
            
            // Get confidentiality agreement checkbox values (نعم/لا)
            const confidentiality = document.getElementById('calibration_confidentiality').checked ? 'نعم' : 'لا';
            const officialUse = document.getElementById('calibration_officialUse').checked ? 'نعم' : 'لا';
            const accessProtection = document.getElementById('calibration_accessProtection').checked ? 'نعم' : 'لا';
            const breachReporting = document.getElementById('calibration_breachReporting').checked ? 'نعم' : 'لا';
            const passwordProtection = document.getElementById('calibration_passwordProtection').checked ? 'نعم' : 'لا';
            const noSocialMedia = document.getElementById('calibration_noSocialMedia').checked ? 'نعم' : 'لا';
            
            // Build query string like training system
            const fields = [
                'calibration_secretRecordNumber',
                'calibration_employeeName',
                'calibration_employeeNumber',
                'calibration_department',
                'calibration_contractType',
                'calibration_reviewerName',
                'calibration_notes'
            ];
            
            let q = `recordId=${encodeURIComponent(recordId)}&`;
            q += fields.map(f =>
                `${f.replace('calibration_', '')}=${encodeURIComponent(document.getElementById(f).value || '')}`
            ).join('&');
            
            q += `&startDate=${encodeURIComponent(startDate)}`;
            q += `&signDate=${encodeURIComponent(signDate)}`;
            q += `&fileLink=${encodeURIComponent(fileLink || '')}`;
            
            // Add confidentiality agreement values
            q += `&confidentiality=${encodeURIComponent(confidentiality)}`;
            q += `&officialUse=${encodeURIComponent(officialUse)}`;
            q += `&accessProtection=${encodeURIComponent(accessProtection)}`;
            q += `&breachReporting=${encodeURIComponent(breachReporting)}`;
            q += `&passwordProtection=${encodeURIComponent(passwordProtection)}`;
            q += `&noSocialMedia=${encodeURIComponent(noSocialMedia)}`;
            
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=add&${q}`);
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    resetCalibrationForm();
                    await loadCalibrationData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في الإضافة', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editCalibrationRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات السجل...', 'info');
            
            const record = calibrationRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillCalibrationForm(record);
                document.getElementById('calibration_updateBtn').style.display = 'inline-block';
                document.getElementById('calibration_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات السجل', 'success');
            } else {
                showNotification('❌ لم يتم العثور على السجل', 'error');
            }
        }
        
        function fillCalibrationForm(record) {
            document.getElementById('calibration_secretRecordNumber').value = record[15] || '';
            document.getElementById('calibration_employeeName').value = record[1] || '';
            document.getElementById('calibration_employeeNumber').value = record[2] || '';
            document.getElementById('calibration_department').value = record[3] || '';
            document.getElementById('calibration_contractType').value = record[4] || '';
            document.getElementById('calibration_notes').value = record[13] || '';
            document.getElementById('calibration_reviewerName').value = record[14] || '';
            
            // Set the file link
            const fileLink = record[17] || '';
            document.getElementById('calibration_fileLink').value = fileLink;
            
            // Set confidentiality agreement checkboxes (نعم/لا)
            // Note: These should be in columns 7-12 (0-based indices)
            document.getElementById('calibration_confidentiality').checked = record[7] === 'نعم';
            document.getElementById('calibration_officialUse').checked = record[8] === 'نعم';
            document.getElementById('calibration_accessProtection').checked = record[9] === 'نعم';
            document.getElementById('calibration_breachReporting').checked = record[10] === 'نعم';
            document.getElementById('calibration_passwordProtection').checked = record[11] === 'نعم';
            document.getElementById('calibration_noSocialMedia').checked = record[12] === 'نعم';
            
            // Display file info if there's a file link
            if (fileLink && fileLink.trim() !== '') {
                // Try to extract filename from URL or use a generic name
                const fileName = 'ملف مرفق';
                document.getElementById('uploadedFileName').textContent = fileName;
                document.getElementById('uploadedFileSize').textContent = '';
                document.getElementById('uploadedFileInfo').style.display = 'block';
                
                const fileLinkBtn = document.getElementById('uploadedFileLink');
                fileLinkBtn.href = fileLink;
                fileLinkBtn.style.display = 'inline-block';
                
                const uploadStatus = document.getElementById('uploadStatus');
                uploadStatus.textContent = '✅ ملف مرفق مسبقاً';
                uploadStatus.className = 'upload-status success';
            }
            
            // Set date values - FIXED: Use exact date from record without changes
            const startDateFormatted = formatDateForInput(record[5] || '');
            const signDateFormatted = formatDateForInput(record[6] || '');
            
            document.getElementById('calibration_startDate').value = startDateFormatted;
            document.getElementById('calibration_signDate').value = signDateFormatted;
            
            // Update Flatpickr instances
            if (flatpickrInstances.startDate && startDateFormatted) {
                try {
                    const parts = startDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.startDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting start date:', e);
                }
            }
            
            if (flatpickrInstances.signDate && signDateFormatted) {
                try {
                    const parts = signDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.signDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting sign date:', e);
                }
            }
            
            document.getElementById('calibration_editingId').value = record[0];
            document.getElementById('calibration_recordId').value = record[0];
        }
        
        async function updateCalibrationRecord() {
            const recordId = document.getElementById('calibration_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد سجل للتحديث', 'error');
                return;
            }
            
            const requiredFields = ['calibration_secretRecordNumber', 'calibration_employeeName', 'calibration_employeeNumber', 'calibration_department'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const startDate = document.getElementById('calibration_startDate').value;
            const signDate = document.getElementById('calibration_signDate').value;
            
            if (startDate && signDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const signDateObj = parseDateDDMMYYYY(signDate);
                    
                    if (startDateObj && signDateObj && signDateObj < startDateObj) {
                        showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                        return;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            const button = document.getElementById('calibration_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            if (startDate && !validateDate(startDate)) {
                showNotification('❌ تاريخ بدء العمل غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            if (signDate && !validateDate(signDate)) {
                showNotification('❌ تاريخ التوقيع غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            // Get file link from hidden field
            const fileLink = document.getElementById('calibration_fileLink').value;
            
            // Get confidentiality agreement checkbox values (نعم/لا)
            const confidentiality = document.getElementById('calibration_confidentiality').checked ? 'نعم' : 'لا';
            const officialUse = document.getElementById('calibration_officialUse').checked ? 'نعم' : 'لا';
            const accessProtection = document.getElementById('calibration_accessProtection').checked ? 'نعم' : 'لا';
            const breachReporting = document.getElementById('calibration_breachReporting').checked ? 'نعم' : 'لا';
            const passwordProtection = document.getElementById('calibration_passwordProtection').checked ? 'نعم' : 'لا';
            const noSocialMedia = document.getElementById('calibration_noSocialMedia').checked ? 'نعم' : 'لا';
            
            // Build query string like training system
            const fields = [
                'calibration_secretRecordNumber',
                'calibration_employeeName',
                'calibration_employeeNumber',
                'calibration_department',
                'calibration_contractType',
                'calibration_reviewerName',
                'calibration_notes'
            ];
            
            let q = `recordId=${encodeURIComponent(recordId)}&`;
            q += fields.map(f =>
                `${f.replace('calibration_', '')}=${encodeURIComponent(document.getElementById(f).value || '')}`
            ).join('&');
            
            q += `&startDate=${encodeURIComponent(startDate)}`;
            q += `&signDate=${encodeURIComponent(signDate)}`;
            q += `&fileLink=${encodeURIComponent(fileLink || '')}`;
            
            // Add confidentiality agreement values
            q += `&confidentiality=${encodeURIComponent(confidentiality)}`;
            q += `&officialUse=${encodeURIComponent(officialUse)}`;
            q += `&accessProtection=${encodeURIComponent(accessProtection)}`;
            q += `&breachReporting=${encodeURIComponent(breachReporting)}`;
            q += `&passwordProtection=${encodeURIComponent(passwordProtection)}`;
            q += `&noSocialMedia=${encodeURIComponent(noSocialMedia)}`;
            
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=update&${q}`);
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    resetCalibrationForm();
                    await loadCalibrationData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في التحديث', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetCalibrationForm() {
            document.getElementById('calibrationForm').reset();
            document.getElementById('calibration_editingId').value = '';
            document.getElementById('calibration_recordId').value = '';
            document.getElementById('calibration_fileLink').value = '';
            document.getElementById('calibration_addBtn').style.display = 'inline-block';
            document.getElementById('calibration_updateBtn').style.display = 'none';
            document.querySelectorAll('#calibrationForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            // Reset confidentiality agreement checkboxes to checked
            document.getElementById('calibration_confidentiality').checked = true;
            document.getElementById('calibration_officialUse').checked = true;
            document.getElementById('calibration_accessProtection').checked = true;
            document.getElementById('calibration_breachReporting').checked = true;
            document.getElementById('calibration_passwordProtection').checked = true;
            document.getElementById('calibration_noSocialMedia').checked = true;
            
            // Reset file upload section
            selectedFile = null;
            uploadedFileUrl = '';
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('uploadedFileLink').style.display = 'none';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('uploadStatus').className = 'upload-status';
            document.getElementById('fileInput').value = '';
            
            if (flatpickrInstances.startDate) flatpickrInstances.startDate.clear();
            if (flatpickrInstances.signDate) flatpickrInstances.signDate.clear();
        }
        
        function exportCalibrationCSV() {
            if (calibrationRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلال السرية...', 'info');
            
            try {
                const headers = [
                    'رقم سجل السرية', 'اسم الموظف', 'الرقم الوظيفي', 'القسم', 'نوع العقد',
                    'تاريخ بدء العمل', 'تاريخ التوقيع', 'عدم إفشاء المعلومات السرية',
                    'استخدام المعلومات للأغراض الرسمية فقط', 'حماية المعلومات من الوصول غير المصرح به',
                    'الإبلاغ الفوري عن خروقات السرية', 'حماية أجهزة الحاسب بكلمات مرور قوية',
                    'عدم نشر المعلومات على وسائل التواصل', 'ملاحظات', 'اسم المراجع', 'لينك الملف'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                calibrationRecords.forEach(record => {
                    const startDateDisplay = formatDateForDisplay(record[5] || '').replace(/<[^>]*>/g, '');
                    const signDateDisplay = formatDateForDisplay(record[6] || '').replace(/<[^>]*>/g, '');
                    
                    const row = [
                        record[15] || '',
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        startDateDisplay,
                        signDateDisplay,
                        record[7] || '', // confidentiality
                        record[8] || '', // officialUse
                        record[9] || '', // accessProtection
                        record[10] || '', // breachReporting
                        record[11] || '', // passwordProtection
                        record[12] || '', // noSocialMedia
                        record[13] || '',
                        record[14] || '',
                        record[17] || '' // File link
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `سجلال السرية_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${calibrationRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification('❌ خطأ في التصدير', 'error');
            }
        }
        
        // ================ DETAILS VIEW FUNCTION ================
        function viewDetails(recordId) {
            const record = calibrationRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (!record) {
                showNotification('❌ لم يتم العثور على السجل', 'error');
                return;
            }
            
            const fileLink = record[17] || '';
            
            // Create agreement items list
            const agreementItems = [
                { label: 'عدم إفشاء المعلومات السرية', value: record[7] || 'لا' },
                { label: 'استخدام المعلومات للأغراض الرسمية فقط', value: record[8] || 'لا' },
                { label: 'حماية المعلومات من الوصول غير المصرح به', value: record[9] || 'لا' },
                { label: 'الإبلاغ الفوري عن خروقات السرية', value: record[10] || 'لا' },
                { label: 'حماية أجهزة الحاسب بكلمات مرور قوية', value: record[11] || 'لا' },
                { label: 'عدم نشر المعلومات على وسائل التواصل', value: record[12] || 'لا' }
            ];
            
            let agreementHTML = '';
            agreementItems.forEach(item => {
                const icon = item.value === 'نعم' ? '✅' : '❌';
                agreementHTML += `<p>${icon} ${item.label}: <strong>${item.value}</strong></p>`;
            });
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>رقم سجل السرية:</strong> ${escapeHtml(record[15] || '')}</p>
                        <p><strong>اسم الموظف:</strong> ${escapeHtml(record[1])}</p>
                        <p><strong>الرقم الوظيفي:</strong> ${escapeHtml(record[2])}</p>
                        <p><strong>القسم:</strong> ${escapeHtml(record[3])}</p>
                        <p><strong>نوع العقد:</strong> ${escapeHtml(record[4])}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>تاريخ بدء العمل:</strong> <span class="english-date">${formatDateForDisplay(record[5]).replace(/<[^>]*>/g, '')}</span></p>
                        <p><strong>تاريخ التوقيع:</strong> <span class="english-date">${formatDateForDisplay(record[6]).replace(/<[^>]*>/g, '')}</span></p>
                        <p><strong>اسم المراجع:</strong> ${escapeHtml(record[14])}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5><i class="fas fa-shield-alt me-2"></i> بنود السرية والالتزامات:</h5>
                        ${agreementHTML}
                    </div>
                </div>
                ${fileLink ? `<div class="row mt-3">
                    <div class="col-md-12">
                        <p><strong>الملف المرفوع:</strong> 
                            <a href="${escapeHtml(fileLink)}" target="_blank" class="file-link-btn ms-2">
                                <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                            </a>
                        </p>
                    </div>
                </div>` : ''}
                ${record[13] ? `<div class="row mt-3">
                    <div class="col-md-12">
                        <p><strong>ملاحظات:</strong> ${escapeHtml(record[13])}</p>
                    </div>
                </div>` : ''}
            `;
            
            document.getElementById('detailsModalBody').innerHTML = detailsHTML;
            detailsModalInstance.show();
        }
        
        // ================ FIXED DELETE FUNCTIONALITY ================
        function showDeleteModal(recordId, recordName, secretRecordNumber = '') {
            deleteRecordId = recordId;
            deleteRecordName = recordName;
            
            document.getElementById('deleteRecordId').textContent = secretRecordNumber || 'غير معروف';
            document.getElementById('deleteRecordName').textContent = recordName || 'غير معروف';
            
            deleteModalInstance.show();
        }
        
        async function confirmDelete() {
            if (!deleteRecordId) return;
            
            const button = document.getElementById('confirmDeleteBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحذف...';
            
            try {
                const res = await jsonp(`${CALIBRATION_SCRIPT_URL}?action=delete&recordId=${encodeURIComponent(deleteRecordId)}`);
                
                button.disabled = false;
                button.innerHTML = originalHtml;
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    
                    deleteModalInstance.hide();
                    
                    deleteRecordId = '';
                    deleteRecordName = '';
                    
                    loadCalibrationData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ أثناء الحذف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting record:', error);
                button.disabled = false;
                button.innerHTML = originalHtml;
                showNotification('❌ خطأ في الاتصال بالخادم', 'error');
            }
        }
    </script>
</body>
</html>
