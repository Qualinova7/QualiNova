<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة إفصاحات الحيادية</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --impartiality-color: #9b59b6;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, var(--impartiality-color), #8e44ad);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .main-header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .main-header .lead {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        /* Home Button */
        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        .home-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .home-button i {
            margin-right: 5px;
        }
        
        /* Card Styles */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-custom {
            padding: 15px 20px;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .card-header-impartiality {
            background: linear-gradient(135deg, var(--impartiality-color), #8e44ad);
        }
        
        /* Form Styles */
        .form-control-custom, .form-select-custom, .form-textarea-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control-custom:focus, .form-select-custom:focus, .form-textarea-custom:focus {
            border-color: var(--impartiality-color);
            box-shadow: 0 0 0 0.25rem rgba(155, 89, 182, 0.25);
            background: white;
        }
        
        .form-textarea-custom {
            min-height: 70px;
            resize: vertical;
        }
        
        .form-label-custom {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Date Input Styling */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .date-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--impartiality-color);
            pointer-events: none;
        }
        
        .date-input-wrapper .form-control-custom {
            padding-right: 40px;
            direction: ltr;
            text-align: right;
        }
        
        /* Flatpickr Customization */
        .flatpickr-calendar {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }
        
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--impartiality-color);
            border-color: var(--impartiality-color);
        }
        
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-family: 'Cairo', sans-serif;
        }
        
        .flatpickr-weekdays {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 0;
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0;
            min-width: 1000px;
            width: 100%;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, var(--impartiality-color), #8e44ad);
            color: white;
            border: none;
            padding: 15px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .table-custom tbody tr {
            transition: all 0.2s;
        }
        
        .table-custom tbody tr:hover {
            background-color: rgba(155, 89, 182, 0.08);
        }
        
        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 2px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 70px;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: #212529;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        
        .spinner-border-custom {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.2rem;
        }
        
        /* Status Message */
        .status-message {
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        
        /* FIX FOR ENGLISH DATE DISPLAY IN RTL CONTEXT */
        .english-date {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed !important;
            display: inline-block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 1px;
                min-width: 60px;
            }
            
            .table-custom {
                min-width: 800px;
            }
            
            /* Home Button Responsive Styles */
            .home-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
            
            .main-header {
                padding-top: 60px;
            }
        }
        
        /* Form Sections */
        .form-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section-title {
            color: var(--impartiality-color);
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--impartiality-color);
            border-radius: 10px;
        }
        
        /* Badge Styles */
        .badge {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        /* Risk Item Container */
        .risk-item-container {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .risk-item-container:last-child {
            margin-bottom: 0;
        }
        
        /* Additional Info Section */
        .additional-info-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        /* Status Colors */
        .status-success {
            background-color: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }
        
        .status-error {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .status-info {
            background-color: rgba(52, 152, 219, 0.1);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Main Container -->
    <div class="container-fluid main-container">
        <!-- Main Header -->
        <div class="main-header fade-in">
            <!-- Return to Home Button -->
            <a href="https://qualinova7.github.io/QualiNova/" class="home-button">
                <i class="fas fa-home"></i> العودة للرئيسية
            </a>
            
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-balance-scale me-2"></i> نظام الإفصاح عن تضارب المصالح</h1>
                    <p class="lead mb-0">نظام متكامل لتسجيل وإدارة إفصاحات الحيادية لموظفي معمل كواليتك إنترناشيونال</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="header-badge d-inline-block me-3">
                        <i class="fas fa-database me-2"></i>
                        <span id="totalRecords">0</span> إفصاح
                    </div>
                    <div class="header-badge d-inline-block">
                        <i class="fas fa-calendar me-2"></i>
                        <span id="currentDate">--/--/----</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-impartiality">
                        <i class="fas fa-balance-scale me-2"></i> إدارة إفصاحات الحيادية
                    </div>
                    <div class="card-body">
                        <form id="impartialityForm">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-user-tie"></i> المعلومات الأساسية
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">رقم السجل *</label>
                                        <input type="text" class="form-control form-control-custom" id="recordId" placeholder="رقم السجل" required>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">اسم الموظف *</label>
                                        <input type="text" class="form-control form-control-custom" id="employeeName" placeholder="اسم الموظف" required list="employeeNameList">
                                        <datalist id="employeeNameList"></datalist>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">الرقم الوظيفي *</label>
                                        <input type="text" class="form-control form-control-custom" id="employeeNumber" placeholder="الرقم الوظيفي" required list="employeeNumberList">
                                        <datalist id="employeeNumberList"></datalist>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">نوع العقد</label>
                                        <input type="text" class="form-control form-control-custom" id="contractType" placeholder="اختر نوع العقد" list="contractTypeList">
                                        <datalist id="contractTypeList">
                                            <!-- سيتم تعبئته تلقائياً من بيانات الموظفين -->
                                        </datalist>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ بدء العمل</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="startDate" placeholder="يوم/شهر/سنة" readonly>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">تاريخ التوقيع *</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="form-control form-control-custom date-picker" id="signDate" placeholder="يوم/شهر/سنة" readonly required>
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label-custom">رقم سجل مخاطر الحيادية</label>
                                        <input type="text" class="form-control form-control-custom" id="neutralityRiskNumber" placeholder="رقم سجل مخاطر الحيادية">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-handshake"></i> الإفصاحات التفصيلية
                                </div>
                                
                                <!-- المصادر المالية -->
                                <div class="risk-item-container">
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label-custom">المصادر المالية</label>
                                            <select class="form-select form-select-custom" id="financialSources">
                                                <option value="لا يوجد">لا يوجد</option>
                                                <option value="نعم يوجد">نعم يوجد</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="form-label-custom">تفاصيل المصادر المالية</label>
                                            <textarea class="form-control form-textarea-custom" id="financialDetails" placeholder="تفاصيل المصادر المالية" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- العلاقات الشخصية -->
                                <div class="risk-item-container">
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label-custom">العلاقات الشخصية</label>
                                            <select class="form-select form-select-custom" id="personalRelations">
                                                <option value="لا يوجد">لا يوجد</option>
                                                <option value="نعم يوجد">نعم يوجد</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="form-label-custom">تفاصيل العلاقات الشخصية</label>
                                            <textarea class="form-control form-textarea-custom" id="personalRelationsDetails" placeholder="تفاصيل العلاقات الشخصية (أقارب، أصدقاء، معارف)" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- الأنشطة الخارجية -->
                                <div class="risk-item-container">
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label-custom">الأنشطة الخارجية</label>
                                            <select class="form-select form-select-custom" id="externalActivities">
                                                <option value="لا يوجد">لا يوجد</option>
                                                <option value="نعم يوجد">نعم يوجد</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="form-label-custom">تفاصيل الأنشطة الخارجية</label>
                                            <textarea class="form-control form-textarea-custom" id="externalActivitiesDetails" placeholder="تفاصيل الأنشطة الخارجية (عمل آخر، عضوية في مجالس)" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- الهدايا والضيافة -->
                                <div class="risk-item-container">
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label-custom">الهدايا والضيافة</label>
                                            <select class="form-select form-select-custom" id="giftsHospitality">
                                                <option value="لا يوجد">لا يوجد</option>
                                                <option value="نعم يوجد">نعم يوجد</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="form-label-custom">تفاصيل الهدايا</label>
                                            <textarea class="form-control form-textarea-custom" id="giftsDetails" placeholder="تفاصيل الهدايا والضيافة (هدايا، تذاكر، دعوات)" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-info-circle"></i> معلومات إضافية
                                </div>
                                <div class="additional-info-section">
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label-custom">أي إفصاح آخر</label>
                                            <textarea class="form-control form-textarea-custom" id="otherDisclosure" placeholder="أي إفصاح آخر" rows="2"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label-custom">اسم المراجع</label>
                                            <input type="text" class="form-control form-control-custom" id="reviewerName" placeholder="اسم المراجع">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status Message -->
                            <div id="status" class="status-message"></div>
                            
                            <div class="row mt-3">
                                <div class="col-12 d-flex justify-content-between">
                                    <button type="button" onclick="resetForm()" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-1"></i> مسح النموذج
                                    </button>
                                    <div>
                                        <button type="button" onclick="addRecord()" class="btn btn-success me-2" id="addBtn">
                                            <i class="fas fa-plus me-1"></i> إضافة جديد
                                        </button>
                                        <button type="button" onclick="updateRecord()" class="btn btn-primary" id="updateBtn" style="display: none;">
                                            <i class="fas fa-save me-1"></i> تحديث السجل
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="editingId">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Records Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="custom-card">
                    <div class="card-header-custom card-header-impartiality d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list me-2"></i> قائمة إفصاحات الحيادية</span>
                        <div>
                            <button onclick="loadData()" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                            <button onclick="exportCSV()" class="btn btn-light btn-sm">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                            <div class="spinner-border text-primary spinner-border-custom" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive" id="dataTableContainer">
                            <table class="table table-custom table-hover" id="dataTable">
                            </table>
                        </div>
                        
                        <div id="noRecords" class="text-center py-5" style="display: none;">
                            <i class="fas fa-balance-scale fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted">لا توجد إفصاحات لعرضها</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 fade-in">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-copyright me-1"></i> نظام إدارة إفصاحات الحيادية 
                    <span id="currentYear"></span> | 
                    <span class="text-info">الإصدار 1.0</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تأكيد الحذف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-2x float-start me-3"></i>
                        <h5 class="alert-heading">تحذير!</h5>
                        <p>هل أنت متأكد من حذف هذا الإفصاح؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                        <hr>
                        <p class="mb-0"><strong>النظام:</strong> <span id="deleteSystemType">إفصاح الحيادية</span></p>
                        <p class="mb-0"><strong>رقم السجل:</strong> <span id="deleteRecordId">غير معروف</span></p>
                        <p class="mb-0"><strong>اسم الموظف:</strong> <span id="deleteRecordName">غير معروف</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> نعم، احذف السجل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تفاصيل إفصاح الحيادية</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr Calendar -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ================ CONFIGURATION ================
        const IMPARTIALITY_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXbv_kRECCylUqVlaWrSXrd8iSUAsEBL9CufhuDOw7DMsLASZgpwknpUcCfdq5irO3/exec";
        const EMPLOYEE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiKkgfhdI3xaW6biMBZCCkuIN9P_6mvUQVHJWgj35kHOUvuQjduHzYfAnOCG0aHWlcpA/exec";
        
        // ================ GLOBAL VARIABLES ================
        let impartialityRecords = [];
        let employeeRecords = [];
        let deleteRecordId = '';
        let deleteRecordName = '';
        let flatpickrInstances = {};
        let employeeDataLoaded = false;
        let deleteModalInstance = null;
        
        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date and year
            setCurrentDate();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize calendar pickers with the SAME procedure as calibration system
            initializeDatePickers();
            
            // Initialize delete modal
            const deleteModalElement = document.getElementById('deleteModal');
            if (deleteModalElement) {
                deleteModalInstance = new bootstrap.Modal(deleteModalElement);
            }
            
            // Load data - تحميل بيانات الإفصاحات وبيانات الموظفين
            setTimeout(() => {
                loadData(); // تحميل بيانات الإفصاحات
                loadEmployeeData(); // تحميل بيانات الموظفين للقوائم المنسدلة
            }, 500);
            
            // إضافة event listeners للحقول
            setupEmployeeAutocomplete();
        });
        
        // ================ DATE PICKER INITIALIZATION - SAME AS CALIBRATION SYSTEM ================
        function initializeDatePickers() {
            // Destroy existing instances if any
            if (flatpickrInstances.startDate) {
                flatpickrInstances.startDate.destroy();
            }
            if (flatpickrInstances.signDate) {
                flatpickrInstances.signDate.destroy();
            }
            
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: true,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                onChange: function(selectedDates, dateStr, instance) {
                    validateSignDateNotOlder();
                    
                    if (selectedDates.length > 0) {
                        const date = selectedDates[0];
                        const formattedDate = formatDateToDDMMYYYY(date);
                        instance.input.value = formattedDate;
                    }
                }
            };
            
            // Initialize start date picker
            flatpickrInstances.startDate = flatpickr('#startDate', dateOptions);
            
            // Initialize sign date picker
            flatpickrInstances.signDate = flatpickr('#signDate', dateOptions);
            
            // Force Arabic locale on both instances
            if (flatpickrInstances.startDate) {
                flatpickrInstances.startDate.set('locale', 'ar');
            }
            if (flatpickrInstances.signDate) {
                flatpickrInstances.signDate.set('locale', 'ar');
            }
        }
        
        // ================ DATE FORMATTING FUNCTIONS - SAME AS CALIBRATION SYSTEM ================
        function formatDateToDDMMYYYY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    if (day < 1 || day > 31) return null;
                    if (month < 0 || month > 11) return null;
                    if (year < 1900 || year > 2100) return null;
                    
                    return new Date(year, month, day);
                }
            }
            
            return null;
        }
        
        function formatDateForDisplay(dateString) {
            if (!dateString || dateString.trim() === '') return '';
            
            // If already in dd/mm/yyyy format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString.trim())) {
                return `<span class="english-date">${dateString}</span>`;
            }
            
            // Try to parse the date
            let dateObj = null;
            
            // Format YYYY/MM/DD (Google Sheets format)
            if (dateString.includes('/') && dateString.split('/')[0].length === 4) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    dateObj = new Date(year, month, day);
                }
            }
            // Format DD/MM/YYYY
            else if (dateString.includes('/') && dateString.split('/')[2].length === 4) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    dateObj = new Date(year, month, day);
                }
            }
            // Try other formats
            else {
                dateObj = new Date(dateString);
            }
            
            if (!dateObj || isNaN(dateObj.getTime())) {
                return `<span class="english-date">${dateString}</span>`;
            }
            
            const formattedDate = formatDateToDDMMYYYY(dateObj);
            return `<span class="english-date">${formattedDate}</span>`;
        }
        
        function formatDateForInput(dateString) {
            if (!dateString || dateString.trim() === '') return '';
            
            const cleanDateString = dateString.replace(/<[^>]*>/g, '');
            
            // If already in dd/mm/yyyy format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(cleanDateString.trim())) {
                return cleanDateString;
            }
            
            // Try to parse "30 September 2026" format
            const parts = cleanDateString.split(' ');
            if (parts.length === 3 && isNaN(parts[1])) {
                const day = parseInt(parts[0], 10);
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const monthIndex = monthNames.findIndex(name => 
                    name.toLowerCase() === parts[1].toLowerCase()
                );
                
                if (monthIndex !== -1) {
                    const month = (monthIndex + 1).toString().padStart(2, '0');
                    const year = parts[2];
                    return `${day.toString().padStart(2, '0')}/${month}/${year}`;
                }
            }
            
            // Try to parse as date
            try {
                const dateObj = new Date(cleanDateString);
                if (!isNaN(dateObj.getTime())) {
                    return formatDateToDDMMYYYY(dateObj);
                }
            } catch (e) {
                console.error('Error parsing date for input:', e);
            }
            
            return '';
        }
        
        function validateDate(dateString) {
            if (!dateString) return true;
            
            const ddMMyyyyRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const displayFormatRegex = /^(\d{1,2})\s+(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{4})$/i;
            
            if (ddMMyyyyRegex.test(dateString)) {
                const match = dateString.match(ddMMyyyyRegex);
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                const year = parseInt(match[3], 10);
                
                if (year < 1900 || year > 2100) return false;
                if (month < 1 || month > 12) return false;
                if (day < 1 || day > 31) return false;
                
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 
                                    31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            if (displayFormatRegex.test(dateString)) {
                const match = dateString.match(displayFormatRegex);
                const day = parseInt(match[1], 10);
                const monthName = match[2];
                const year = parseInt(match[3], 10);
                
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const month = monthNames.findIndex(name => 
                    name.toLowerCase() === monthName.toLowerCase()
                ) + 1;
                
                if (month === 0) return false;
                if (year < 1900 || year > 2100) return false;
                if (day < 1 || day > 31) return false;
                
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 
                                    31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            return false;
        }
        
        // ================ DATE VALIDATION - SAME AS CALIBRATION SYSTEM ================
        function validateSignDateNotOlder() {
            const startDateStr = document.getElementById('startDate').value;
            const signDateStr = document.getElementById('signDate').value;
            
            if (!startDateStr || !signDateStr) return;
            
            try {
                const startDate = parseDateDDMMYYYY(startDateStr);
                const signDate = parseDateDDMMYYYY(signDateStr);
                
                if (startDate && signDate && signDate < startDate) {
                    showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                    if (flatpickrInstances.signDate) {
                        flatpickrInstances.signDate.clear();
                    }
                    document.getElementById('signDate').value = '';
                }
            } catch (e) {
                console.error('Error validating dates:', e);
            }
        }
        
        function setCurrentDate() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('currentDate').textContent = `${day}/${month}/${year}`;
        }
        
        // ================ NOTIFICATION SYSTEM ================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getNotificationIcon(type)} me-3"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            return notification;
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        // ================ JSONP FUNCTION - SAME AS CALIBRATION SYSTEM ================
        function jsonp(url, callbackParam = 'callback') {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + callbackParam + '=' + callbackName;
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // ================ UTILITY FUNCTIONS ================
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // ================ STATUS MESSAGE FUNCTIONS ================
        function setStatus(msg, type = 'info') {
            const statusDiv = document.getElementById("status");
            statusDiv.innerHTML = msg;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                if (statusDiv.innerHTML === msg) {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }
        
        // ================ EMPLOYEE DATA FUNCTIONS - SAME AS CALIBRATION SYSTEM ================
        async function loadEmployeeData() {
            if (employeeDataLoaded) return;
            
            showNotification('📥 جاري تحميل بيانات الموظفين...', 'info', 3000);
            
            try {
                const res = await jsonp(`${EMPLOYEE_SCRIPT_URL}?action=getAll`);
                
                if (res && res.status === 'success') {
                    let records = [];
                    
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (Array.isArray(res)) {
                        records = res;
                    }
                    
                    employeeRecords = records;
                    employeeDataLoaded = true;
                    
                    populateEmployeeDatalists();
                    setupEmployeeAutocomplete();
                    showNotification('✅ تم تحميل بيانات الموظفين بنجاح (' + employeeRecords.length + ' موظف)', 'success', 3000);
                } else {
                    showNotification('❌ فشل في تحميل بيانات الموظفين. تأكد من صحة سكريبت الويب', 'error');
                    console.error('Employee data response:', res);
                }
            } catch (error) {
                showNotification('❌ خطأ في تحميل بيانات الموظفين', 'error');
            }
        }
        
        function populateEmployeeDatalists() {
            const nameList = document.getElementById('employeeNameList');
            const numberList = document.getElementById('employeeNumberList');
            const contractList = document.getElementById('contractTypeList');
            
            nameList.innerHTML = '';
            numberList.innerHTML = '';
            contractList.innerHTML = '';
            
            const names = new Set();
            const numbers = new Set();
            const contracts = new Set();
            
            contracts.add('دائم');
            contracts.add('مؤقت');
            contracts.add('تدريب');
            
            employeeRecords.forEach(record => {
                if (record && record.length > 1) {
                    if (record[1] && String(record[1]).trim() !== '') names.add(String(record[1]).trim());
                    if (record[2] && String(record[2]).trim() !== '') numbers.add(String(record[2]).trim());
                    if (record[5] && String(record[5]).trim() !== '') contracts.add(String(record[5]).trim());
                }
            });
            
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                nameList.appendChild(option);
            });
            
            numbers.forEach(number => {
                const option = document.createElement('option');
                option.value = number;
                numberList.appendChild(option);
            });
            
            contracts.forEach(contract => {
                const option = document.createElement('option');
                option.value = contract;
                contractList.appendChild(option);
            });
        }
        
        function setupEmployeeAutocomplete() {
            const employeeNameField = document.getElementById('employeeName');
            const employeeNumberField = document.getElementById('employeeNumber');
            
            employeeNameField.addEventListener('change', function() {
                autoFillFromEmployee('name', this.value);
            });
            
            employeeNumberField.addEventListener('change', function() {
                autoFillFromEmployee('number', this.value);
            });
            
            employeeNameField.addEventListener('input', function() {
                if (this.value.length > 2) {
                    autoFillFromEmployee('name', this.value);
                }
            });
            
            employeeNumberField.addEventListener('input', function() {
                if (this.value.length > 2) {
                    autoFillFromEmployee('number', this.value);
                }
            });
        }
        
        function autoFillFromEmployee(fieldType, value) {
            if (!value || !employeeDataLoaded || employeeRecords.length === 0) return;
            
            let record = null;
            
            if (fieldType === 'name') {
                record = employeeRecords.find(r => 
                    r && r[1] && String(r[1]).trim().toLowerCase() === String(value).trim().toLowerCase()
                );
                
                if (record && record[2]) {
                    document.getElementById('employeeNumber').value = record[2] || '';
                }
            } else if (fieldType === 'number') {
                record = employeeRecords.find(r => 
                    r && r[2] && String(r[2]).trim() === String(value).trim()
                );
                
                if (record && record[1]) {
                    document.getElementById('employeeName').value = record[1] || '';
                }
            }
            
            if (record) {
                document.getElementById('contractType').value = record[5] || '';
                
                if (record[6]) {
                    const startDateFormatted = formatDateForInput(record[6]);
                    if (startDateFormatted) {
                        document.getElementById('startDate').value = startDateFormatted;
                        
                        if (flatpickrInstances.startDate) {
                            try {
                                const parts = startDateFormatted.split('/');
                                if (parts.length === 3) {
                                    const day = parseInt(parts[0], 10);
                                    const month = parseInt(parts[1], 10) - 1;
                                    const year = parseInt(parts[2], 10);
                                    const dateObj = new Date(year, month, day);
                                    flatpickrInstances.startDate.setDate(dateObj, false);
                                }
                            } catch (e) {
                                console.error('Error setting start date:', e);
                            }
                        }
                    }
                }
                
                showNotification(`✅ تم تحميل بيانات الموظف: ${record[1] || ''}`, 'success', 2000);
            }
        }
        
        // ================ LOAD DATA - UPDATED WITH ASYNC/AWAIT ================
        async function loadData() {
            setStatus("جاري تحميل البيانات...", 'info');
            
            const spinner = document.getElementById('loadingSpinner');
            const tableContainer = document.getElementById('dataTableContainer');
            const noRecords = document.getElementById('noRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const res = await jsonp(`${IMPARTIALITY_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                
                spinner.style.display = 'none';
                
                let records = [];
                let responseStatus = 'error';
                let responseMessage = 'خطأ غير معروف';
                
                if (res && res.status) {
                    responseStatus = res.status;
                    responseMessage = res.message || 'بدون رسالة';
                    
                    if (responseStatus === 'success') {
                        if (Array.isArray(res.records)) {
                            records = res.records;
                        } else if (Array.isArray(res.data)) {
                            records = res.data;
                        } else if (res.records && typeof res.records === 'object') {
                            const keys = Object.keys(res.records);
                            if (keys.length > 0 && Array.isArray(res.records[keys[0]])) {
                                records = res.records[keys[0]];
                            }
                        }
                    }
                } else if (Array.isArray(res)) {
                    records = res;
                    responseStatus = 'success';
                    responseMessage = 'تم تحميل البيانات بنجاح';
                }
                
                if (responseStatus !== 'success') {
                    noRecords.style.display = 'block';
                    showNotification(`❌ ${responseMessage}`, 'error');
                    setStatus(responseMessage, 'error');
                    document.getElementById('totalRecords').textContent = '0';
                    return;
                }
                
                impartialityRecords = records;
                
                if (impartialityRecords.length > 0) {
                    displayRecords(impartialityRecords);
                    tableContainer.style.display = 'block';
                    document.getElementById('totalRecords').textContent = impartialityRecords.length.toLocaleString('ar-SA');
                } else {
                    noRecords.style.display = 'block';
                    document.getElementById('totalRecords').textContent = '0';
                }
                
                setStatus("تم تحميل البيانات بنجاح ✅", 'success');
                showNotification(`✅ تم تحميل ${impartialityRecords.length} سجل إفصاح`, 'success', 3000);
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification('❌ خطأ في تحميل البيانات', 'error');
                setStatus('خطأ في تحميل البيانات', 'error');
                document.getElementById('totalRecords').textContent = '0';
            }
        }
        
        function displayRecords(records) {
            const table = document.getElementById('dataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم السجل', 'اسم الموظف', 'الرقم الوظيفي', 'نوع العقد', 'تاريخ بدء العمل', 
                           'تاريخ التوقيع', 'المصادر المالية', 'رقم المخاطر', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record, index) => {
                html += '<tr>';
                
                const recordId = record[0] || record.id || record.recordId || '';
                const employeeName = record[1] || record.name || record.employeeName || '';
                const employeeNumber = record[2] || record.empNo || record.employeeNumber || '';
                const contractType = record[3] || record.contract || record.contractType || '';
                const startDate = record[4] || record.startDate || '';
                const signDate = record[5] || record.signDate || '';
                const financialSources = record[6] || record.financialSources || '';
                const riskNumber = record[15] || record.neutralityRiskNumber || '';
                
                html += `<td><strong>${escapeHtml(recordId)}</strong></td>`;
                html += `<td>${escapeHtml(employeeName)}</td>`;
                html += `<td>${escapeHtml(employeeNumber)}</td>`;
                html += `<td>${escapeHtml(contractType)}</td>`;
                html += `<td>${formatDateForDisplay(startDate)}</td>`;
                html += `<td>${formatDateForDisplay(signDate)}</td>`;
                html += `<td>${escapeHtml(financialSources)}</td>`;
                html += `<td>${escapeHtml(riskNumber)}</td>`;
                
                html += `<td class="action-buttons">
                    <button onclick="editRecord('${escapeHtml(recordId)}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(recordId)}', '${escapeHtml(employeeName)}')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(recordId)}')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        // ================ CRUD OPERATIONS - UPDATED WITH ASYNC/AWAIT ================
        async function addRecord() { 
            const requiredFields = ['recordId', 'employeeName', 'employeeNumber', 'signDate'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            // Check if record ID already exists
            const recordId = document.getElementById('recordId').value.trim();
            const existingRecord = impartialityRecords.find(r => {
                const id = r[0] || r.id || r.recordId || '';
                return String(id).trim() === recordId;
            });
            
            if (existingRecord) {
                showNotification('❌ رقم السجل موجود بالفعل. الرجاء استخدام رقم سجل مختلف', 'error');
                document.getElementById('recordId').classList.add('is-invalid');
                return;
            }
            
            // Validate dates - SAME AS CALIBRATION SYSTEM
            const startDate = document.getElementById('startDate').value;
            const signDate = document.getElementById('signDate').value;
            
            if (startDate && !validateDate(startDate)) {
                document.getElementById('startDate').classList.add('is-invalid');
                showNotification('❌ تاريخ بدء العمل غير صحيح', 'error');
                return;
            } else {
                document.getElementById('startDate').classList.remove('is-invalid');
            }
            
            if (signDate && !validateDate(signDate)) {
                document.getElementById('signDate').classList.add('is-invalid');
                showNotification('❌ تاريخ التوقيع غير صحيح', 'error');
                return;
            } else {
                document.getElementById('signDate').classList.remove('is-invalid');
            }
            
            // Validate sign date is not older than start date - SAME AS CALIBRATION SYSTEM
            if (startDate && signDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const signDateObj = parseDateDDMMYYYY(signDate);
                    
                    if (startDateObj && signDateObj && signDateObj < startDateObj) {
                        showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                        document.getElementById('signDate').classList.add('is-invalid');
                        return;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            setStatus("جاري الإرسال...", 'info');
            
            const button = document.getElementById('addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            const fields = [
                'recordId',
                'employeeName',
                'employeeNumber',
                'contractType',
                'financialSources',
                'financialDetails',
                'personalRelations',
                'personalRelationsDetails',
                'externalActivities',
                'externalActivitiesDetails',
                'giftsHospitality',
                'giftsDetails',
                'otherDisclosure',
                'neutralityRiskNumber',
                'reviewerName'
            ];
            
            let q = fields.map(f =>
                `${f}=${encodeURIComponent(document.getElementById(f).value || '')}`
            ).join('&');
            
            // Add dates - SAME AS CALIBRATION SYSTEM
            q += `&startDate=${encodeURIComponent(startDate)}`;
            q += `&signDate=${encodeURIComponent(signDate)}`;
            
            try {
                const res = await jsonp(`${IMPARTIALITY_SCRIPT_URL}?action=add&${q}`);
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    setStatus(res.message, 'success');
                    resetForm();
                    await loadData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                    setStatus(errorMsg, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في الإضافة', 'error');
                setStatus('خطأ في الإضافة', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function updateRecord() { 
            const requiredFields = ['recordId', 'employeeName', 'employeeNumber', 'signDate'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            // Validate dates - SAME AS CALIBRATION SYSTEM
            const startDate = document.getElementById('startDate').value;
            const signDate = document.getElementById('signDate').value;
            
            if (startDate && !validateDate(startDate)) {
                document.getElementById('startDate').classList.add('is-invalid');
                showNotification('❌ تاريخ بدء العمل غير صحيح', 'error');
                return;
            } else {
                document.getElementById('startDate').classList.remove('is-invalid');
            }
            
            if (signDate && !validateDate(signDate)) {
                document.getElementById('signDate').classList.add('is-invalid');
                showNotification('❌ تاريخ التوقيع غير صحيح', 'error');
                return;
            } else {
                document.getElementById('signDate').classList.remove('is-invalid');
            }
            
            // Validate sign date is not older than start date - SAME AS CALIBRATION SYSTEM
            if (startDate && signDate) {
                try {
                    const startDateObj = parseDateDDMMYYYY(startDate);
                    const signDateObj = parseDateDDMMYYYY(signDate);
                    
                    if (startDateObj && signDateObj && signDateObj < startDateObj) {
                        showNotification('❌ تاريخ التوقيع يجب أن يكون بعد تاريخ بدء العمل أو مساوياً له', 'error');
                        document.getElementById('signDate').classList.add('is-invalid');
                        return;
                    }
                } catch (e) {
                    console.error('Error comparing dates:', e);
                }
            }
            
            setStatus("جاري الإرسال...", 'info');
            
            const editingId = document.getElementById('editingId').value;
            if (!editingId) {
                showNotification('❌ خطأ: لا يوجد سجل للتحديث', 'error');
                return;
            }
            
            const button = document.getElementById('updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            const fields = [
                'recordId',
                'employeeName',
                'employeeNumber',
                'contractType',
                'financialSources',
                'financialDetails',
                'personalRelations',
                'personalRelationsDetails',
                'externalActivities',
                'externalActivitiesDetails',
                'giftsHospitality',
                'giftsDetails',
                'otherDisclosure',
                'neutralityRiskNumber',
                'reviewerName'
            ];
            
            let q = fields.map(f =>
                `${f}=${encodeURIComponent(document.getElementById(f).value || '')}`
            ).join('&');
            
            // Add dates - SAME AS CALIBRATION SYSTEM
            q += `&startDate=${encodeURIComponent(startDate)}`;
            q += `&signDate=${encodeURIComponent(signDate)}`;
            q += `&editingId=${encodeURIComponent(editingId)}`;
            
            try {
                const res = await jsonp(`${IMPARTIALITY_SCRIPT_URL}?action=update&${q}`);
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    setStatus(res.message, 'success');
                    resetForm();
                    await loadData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                    setStatus(errorMsg, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في التحديث', 'error');
                setStatus('خطأ في التحديث', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function editRecord(recordId) {
            setStatus('🔍 جاري تحميل بيانات الإفصاح...', 'info');
            
            const record = impartialityRecords.find(r => {
                const id = r[0] || r.id || r.recordId || '';
                return String(id).trim() === String(recordId).trim();
            });
            
            if (record) {
                fillForm(record);
                document.getElementById('updateBtn').style.display = 'inline-block';
                document.getElementById('addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات الإفصاح', 'success');
                setStatus('تم تحميل بيانات الإفصاح', 'success');
            } else {
                showNotification('❌ لم يتم العثور على الإفصاح', 'error');
                setStatus('لم يتم العثور على الإفصاح', 'error');
            }
        }
        
        function fillForm(record) {
            const recordId = record[0] || record.id || record.recordId || '';
            const employeeName = record[1] || record.name || record.employeeName || '';
            const employeeNumber = record[2] || record.empNo || record.employeeNumber || '';
            const contractType = record[3] || record.contract || record.contractType || '';
            const startDate = record[4] || record.startDate || '';
            const signDate = record[5] || record.signDate || '';
            const financialSources = record[6] || record.financialSources || '';
            const financialDetails = record[7] || record.financialDetails || '';
            const personalRelations = record[8] || record.personalRelations || '';
            const personalRelationsDetails = record[9] || record.personalRelationsDetails || '';
            const externalActivities = record[10] || record.externalActivities || '';
            const externalActivitiesDetails = record[11] || record.externalActivitiesDetails || '';
            const giftsHospitality = record[12] || record.giftsHospitality || '';
            const giftsDetails = record[13] || record.giftsDetails || '';
            const otherDisclosure = record[14] || record.otherDisclosure || '';
            const neutralityRiskNumber = record[15] || record.neutralityRiskNumber || '';
            const reviewerName = record[16] || record.reviewerName || '';
            
            document.getElementById('recordId').value = recordId;
            document.getElementById('employeeName').value = employeeName;
            document.getElementById('employeeNumber').value = employeeNumber;
            document.getElementById('contractType').value = contractType;
            
            document.getElementById('financialSources').value = financialSources || 'لا يوجد';
            document.getElementById('financialDetails').value = financialDetails || '';
            
            document.getElementById('personalRelations').value = personalRelations || 'لا يوجد';
            document.getElementById('personalRelationsDetails').value = personalRelationsDetails || '';
            
            document.getElementById('externalActivities').value = externalActivities || 'لا يوجد';
            document.getElementById('externalActivitiesDetails').value = externalActivitiesDetails || '';
            
            document.getElementById('giftsHospitality').value = giftsHospitality || 'لا يوجد';
            document.getElementById('giftsDetails').value = giftsDetails || '';
            
            document.getElementById('otherDisclosure').value = otherDisclosure || '';
            document.getElementById('neutralityRiskNumber').value = neutralityRiskNumber || '';
            document.getElementById('reviewerName').value = reviewerName || '';
            
            // Set date values - SAME AS CALIBRATION SYSTEM
            const startDateFormatted = formatDateForInput(startDate);
            const signDateFormatted = formatDateForInput(signDate);
            
            document.getElementById('startDate').value = startDateFormatted;
            document.getElementById('signDate').value = signDateFormatted;
            
            // Update Flatpickr instances - SAME AS CALIBRATION SYSTEM
            if (flatpickrInstances.startDate && startDateFormatted) {
                try {
                    const parts = startDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.startDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting start date:', e);
                }
            }
            
            if (flatpickrInstances.signDate && signDateFormatted) {
                try {
                    const parts = signDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.signDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting sign date:', e);
                }
            }
            
            document.getElementById('editingId').value = recordId;
        }
        
        function resetForm() {
            document.getElementById('impartialityForm').reset();
            document.getElementById('editingId').value = '';
            document.getElementById('addBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.querySelectorAll('#impartialityForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            // Reset dropdowns to default "لا يوجد"
            document.getElementById('financialSources').value = 'لا يوجد';
            document.getElementById('personalRelations').value = 'لا يوجد';
            document.getElementById('externalActivities').value = 'لا يوجد';
            document.getElementById('giftsHospitality').value = 'لا يوجد';
            
            // Clear Flatpickr instances
            if (flatpickrInstances.startDate) {
                flatpickrInstances.startDate.clear();
            }
            if (flatpickrInstances.signDate) {
                flatpickrInstances.signDate.clear();
            }
            
            setStatus('تم مسح النموذج', 'success');
        }
        
        function showDeleteModal(recordId, recordName) {
            deleteRecordId = recordId;
            deleteRecordName = recordName;
            
            document.getElementById('deleteRecordId').textContent = recordId || 'غير معروف';
            document.getElementById('deleteRecordName').textContent = recordName || 'غير معروف';
            
            if (deleteModalInstance) {
                deleteModalInstance.show();
            }
        }
        
        // ================ DELETE FUNCTION - UPDATED WITH ASYNC/AWAIT ================
        async function confirmDelete() {
            if (!deleteRecordId) {
                showNotification('❌ لا يوجد سجل محدد للحذف', 'error');
                return;
            }
            
            const button = document.getElementById('confirmDeleteBtn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحذف...';
            
            setStatus("جاري الحذف...", 'info');
            
            try {
                const res = await jsonp(`${IMPARTIALITY_SCRIPT_URL}?action=delete&recordId=${encodeURIComponent(deleteRecordId)}`);
                
                button.disabled = false;
                button.innerHTML = originalText;
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    setStatus(res.message, 'success');
                    
                    if (deleteModalInstance) {
                        deleteModalInstance.hide();
                    }
                    
                    deleteRecordId = '';
                    deleteRecordName = '';
                    
                    await loadData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ أثناء الحذف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                    setStatus(errorMsg, 'error');
                }
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalText;
                showNotification('❌ خطأ في الاتصال بالخادم', 'error');
                setStatus('خطأ في الاتصال بالخادم', 'error');
            }
        }
        
        // ================ DETAILS VIEW FUNCTION ================
        function viewDetails(recordId) {
            const record = impartialityRecords.find(r => {
                const id = r[0] || r.id || r.recordId || '';
                return String(id).trim() === String(recordId).trim();
            });
            
            if (!record) {
                showNotification('❌ لم يتم العثور على الإفصاح', 'error');
                return;
            }
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>رقم السجل:</strong> ${escapeHtml(record[0] || record.id || record.recordId || '')}</p>
                        <p><strong>اسم الموظف:</strong> ${escapeHtml(record[1] || record.name || record.employeeName || '')}</p>
                        <p><strong>الرقم الوظيفي:</strong> ${escapeHtml(record[2] || record.empNo || record.employeeNumber || '')}</p>
                        <p><strong>نوع العقد:</strong> ${escapeHtml(record[3] || record.contract || record.contractType || '')}</p>
                        <p><strong>تاريخ بدء العمل:</strong> <span class="english-date">${formatDateForDisplay(record[4] || record.startDate || '').replace(/<[^>]*>/g, '')}</span></p>
                        <p><strong>تاريخ التوقيع:</strong> <span class="english-date">${formatDateForDisplay(record[5] || record.signDate || '').replace(/<[^>]*>/g, '')}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>المصادر المالية:</strong> ${escapeHtml(record[6] || record.financialSources || '')}</p>
                        <p><strong>تفاصيل المصادر المالية:</strong> ${escapeHtml(record[7] || record.financialDetails || '')}</p>
                        <p><strong>العلاقات الشخصية:</strong> ${escapeHtml(record[8] || record.personalRelations || '')}</p>
                        <p><strong>تفاصيل العلاقات الشخصية:</strong> ${escapeHtml(record[9] || record.personalRelationsDetails || '')}</p>
                        <p><strong>رقم مخاطر الحيادية:</strong> ${escapeHtml(record[15] || record.neutralityRiskNumber || '')}</p>
                        <p><strong>اسم المراجع:</strong> ${escapeHtml(record[16] || record.reviewerName || '')}</p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>الأنشطة الخارجية:</strong> ${escapeHtml(record[10] || record.externalActivities || '')}</p>
                        <p><strong>تفاصيل الأنشطة الخارجية:</strong> ${escapeHtml(record[11] || record.externalActivitiesDetails || '')}</p>
                        <p><strong>الهدايا والضيافة:</strong> ${escapeHtml(record[12] || record.giftsHospitality || '')}</p>
                        <p><strong>تفاصيل الهدايا:</strong> ${escapeHtml(record[13] || record.giftsDetails || '')}</p>
                        <p><strong>أي إفصاح آخر:</strong> ${escapeHtml(record[14] || record.otherDisclosure || '')}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('detailsModalBody').innerHTML = detailsHTML;
            
            const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
            detailsModal.show();
        }
        
        // ================ EXPORT FUNCTION ================
        function exportCSV() {
            if (impartialityRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير إفصاحات الحيادية...', 'info');
            
            try {
                const headers = [
                    'رقم السجل', 'اسم الموظف', 'الرقم الوظيفي', 'نوع العقد', 'تاريخ بدء العمل',
                    'تاريخ التوقيع', 'المصادر المالية', 'تفاصيل المصادر المالية',
                    'العلاقات الشخصية', 'تفاصيل العلاقات الشخصية',
                    'الأنشطة الخارجية', 'تفاصيل الأنشطة الخارجية',
                    'الهدايا والضيافة', 'تفاصيل الهدايا',
                    'أي إفصاح آخر', 'رقم سجل مخاطر الحيادية', 'اسم المراجع'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                impartialityRecords.forEach(record => {
                    const startDateDisplay = formatDateForDisplay(record[4] || record.startDate || '').replace(/<[^>]*>/g, '');
                    const signDateDisplay = formatDateForDisplay(record[5] || record.signDate || '').replace(/<[^>]*>/g, '');
                    
                    const row = [
                        record[0] || record.id || record.recordId || '',
                        record[1] || record.name || record.employeeName || '',
                        record[2] || record.empNo || record.employeeNumber || '',
                        record[3] || record.contract || record.contractType || '',
                        startDateDisplay,
                        signDateDisplay,
                        record[6] || record.financialSources || '',
                        record[7] || record.financialDetails || '',
                        record[8] || record.personalRelations || '',
                        record[9] || record.personalRelationsDetails || '',
                        record[10] || record.externalActivities || '',
                        record[11] || record.externalActivitiesDetails || '',
                        record[12] || record.giftsHospitality || '',
                        record[13] || record.giftsDetails || '',
                        record[14] || record.otherDisclosure || '',
                        record[15] || record.neutralityRiskNumber || '',
                        record[16] || record.reviewerName || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `إفصاحات_الحيادية_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${impartialityRecords.length} إفصاح`, 'success');
            } catch (error) {
                showNotification(`❌ خطأ في التصدير`, 'error');
            }
        }
    </script>
</body>
</html>
