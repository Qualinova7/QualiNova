<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> نظام إدارة سجلات المعايرة - معمل كواليتك إنترناشيونال</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --calibration-mgmt-color: #1abc9c;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .main-header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .main-header .lead {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        /* Home Button */
        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
            white-space: nowrap;
        }
        
        .home-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .home-button i {
            margin-right: 5px;
        }
        
        /* Header adjustments for home button */
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        /* Ensure the date badge doesn't overlap with home button */
        @media (min-width: 769px) {
            .header-badge-container {
                position: relative;
                padding-left: 130px;
            }
        }
        
        /* Upload File Button Styles */
        .upload-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .upload-container:hover {
            background: #e9ecef;
            border-color: var(--calibration-mgmt-color);
        }
        
        .upload-container.dragover {
            background: #e3f2fd;
            border-color: var(--calibration-mgmt-color);
            border-style: solid;
        }
        
        .upload-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #5a6268;
        }
        
        .upload-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        
        .upload-status {
            margin-top: 10px;
            font-size: 0.85rem;
            min-height: 20px;
        }
        
        .upload-status.success {
            color: var(--success-color);
        }
        
        .upload-status.error {
            color: var(--danger-color);
        }
        
        .upload-status.loading {
            color: var(--calibration-mgmt-color);
        }
        
        .file-link-btn {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .file-link-btn:hover {
            background: #219653;
            color: white;
            text-decoration: none;
        }
        
        /* Card Styles */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-custom {
            padding: 15px 20px;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
        }
        
        .card-header-calibration-mgmt {
            background: linear-gradient(135deg, var(--calibration-mgmt-color), #16a085);
        }
        
        /* Form Styles */
        .form-control-custom, .form-select-custom, .form-textarea-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-control-custom:focus, .form-select-custom:focus, .form-textarea-custom:focus {
            border-color: var(--calibration-mgmt-color);
            box-shadow: 0 0 0 0.25rem rgba(26, 188, 156, 0.25);
            background: white;
        }
        
        .form-textarea-custom {
            min-height: 70px;
            resize: vertical;
        }
        
        .form-label-custom {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Date Input Styling */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .date-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--calibration-mgmt-color);
            pointer-events: none;
        }
        
        .date-input-wrapper .form-control-custom {
            padding-right: 40px;
            direction: ltr;
            text-align: right;
        }
        
        /* Flatpickr Customization */
        .flatpickr-calendar {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }
        
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--calibration-mgmt-color);
            border-color: var(--calibration-mgmt-color);
        }
        
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-family: 'Cairo', sans-serif;
        }
        
        .flatpickr-weekdays {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 0;
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0;
            min-width: 1300px;
            width: 100%;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, var(--calibration-mgmt-color), #16a085);
            color: white;
            border: none;
            padding: 15px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .table-custom tbody tr {
            transition: all 0.2s;
        }
        
        .table-custom tbody tr:hover {
            background-color: rgba(26, 188, 156, 0.08);
        }
        
        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 2px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 70px;
        }
        
        /* Status Details Input */
        .status-details {
            margin-top: 8px;
            display: none;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--calibration-mgmt-color), #16a085);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: #212529;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        
        .spinner-border-custom {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.2rem;
        }
        
        /* Form Sections */
        .form-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section-title {
            color: var(--calibration-mgmt-color);
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* FIX FOR ENGLISH DATE DISPLAY IN RTL CONTEXT */
        .english-date {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed !important;
            display: inline-block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 1px;
                min-width: 60px;
            }
            
            .home-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
            
            .main-header {
                padding-top: 60px;
            }
            
            .header-badge-container {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
            }
            
            .table-custom {
                min-width: 1100px;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--calibration-mgmt-color);
            border-radius: 10px;
        }
        
        /* Modal Custom */
        .modal-header-custom {
            background: linear-gradient(135deg, var(--calibration-mgmt-color), #16a085);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Modal Fix - Prevent background scroll */
        body.modal-open {
            overflow: hidden;
            padding-right: 0 !important;
        }
        
        /* Frequency Input Group */
        .frequency-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .frequency-input {
            flex: 1;
        }
        
        .frequency-options {
            display: flex;
            gap: 5px;
        }
        
        .frequency-btn {
            padding: 5px 10px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .frequency-btn:hover {
            background: #dee2e6;
        }
        
        .frequency-btn.active {
            background: var(--calibration-mgmt-color);
            color: white;
            border-color: var(--calibration-mgmt-color);
        }
        
        /* Status Dropdown Styling */
        .status-select {
            position: relative;
        }
        
        .status-select select {
            appearance: none;
            padding-right: 40px;
        }
        
        .status-select:after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }
        
        /* Autofill dropdown styles */
        .autofill-options {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 5px;
            display: none;
        }
        
        .autofill-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autofill-option:hover {
            background-color: #f0f0f0;
        }
        
        .autofill-container {
            position: relative;
        }
        
        /* Autofill indicator */
        .autofill-indicator {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            color: var(--calibration-mgmt-color);
            font-size: 0.9rem;
            display: none;
        }
        
        .autofill-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Main Container -->
    <div class="container-fluid main-container">
        <!-- Main Header -->
        <div class="main-header fade-in">
            <!-- Return to Home Button -->
            <a href="https://qualinova7.github.io/QualiNova/" class="home-button">
                <i class="fas fa-home"></i> العودة للرئيسية
            </a>
            
            <div class="header-content">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="fas fa-tools me-2"></i> نظام إدارة سجلات المعايرة - معمل كواليتك إنترناشيونال</h1>
                        <p class="lead mb-0">نظام متكامل لإدارة سجلات المعايرة والأجهزة والمواعيد والشهادات والاعتمادات</p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0 header-badge-container">
                        <div class="header-badge d-inline-block me-3">
                            <i class="fas fa-database me-2"></i>
                            <span id="totalRecords">0</span> سجلات
                        </div>
                        <div class="header-badge d-inline-block">
                            <i class="fas fa-calendar me-2"></i>
                            <span id="currentDate">--/--/----</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calibration Management Section -->
        <div class="row fade-in">
            <!-- Form Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="custom-card">
                        <div class="card-header-custom card-header-calibration-mgmt">
                            <i class="fas fa-tools me-2"></i> نظام إدارة سجلات المعايرة
                        </div>
                        <div class="card-body">
                            <form id="calibrationMgmtForm">
                                <!-- File Upload Section -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="upload-container" id="uploadContainer">
                                            <h6><i class="fas fa-cloud-upload-alt me-2"></i>رفع شهادة المعايرة (PDF أو صورة)</h6>
                                            <p class="text-muted mb-2" style="font-size: 0.85rem;">الحد الأقصى لحجم الملف: 10 ميجابايت. الأنواع المسموحة: PNG, JPG, JPEG, PDF</p>
                                            
                                            <input type="file" id="fileInput" 
                                                   accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf"
                                                   style="display: none">
                                            <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                                <i class="fas fa-folder-open me-1"></i> اختر ملف للرفع
                                            </button>
                                            <button type="button" class="upload-btn" onclick="uploadFile()" id="uploadBtn">
                                                <i class="fas fa-upload me-1"></i> رفع الملف
                                            </button>
                                            
                                            <div class="upload-status" id="uploadStatus"></div>
                                            
                                            <div id="uploadedFileInfo" style="display: none; margin-top: 10px;">
                                                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                                                    <div>
                                                        <i class="fas fa-file me-2"></i>
                                                        <span id="uploadedFileName"></span>
                                                        <span class="badge bg-success ms-2" id="uploadedFileSize"></span>
                                                    </div>
                                                    <a href="#" target="_blank" class="file-link-btn" id="uploadedFileLink" style="display: none;">
                                                        <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-info-circle"></i> المعلومات الأساسية
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم الشهادة *</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_certificateNumber" placeholder="رقم الشهادة" required>
                                        </div>
                                        <div class="col-md-3 mb-2 autofill-container">
                                            <label class="form-label-custom">العميل</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_client" placeholder="اسم العميل" list="clientList" oninput="filterClients()" onfocus="showClientDropdown()" onblur="hideClientDropdown()" onchange="checkAutoFill()">
                                            <datalist id="clientList"></datalist>
                                            <div class="autofill-options" id="clientOptions"></div>
                                            <span class="autofill-indicator" id="clientAutofillIndicator"><i class="fas fa-magic"></i></span>
                                        </div>
                                        <div class="col-md-3 mb-2 autofill-container">
                                            <label class="form-label-custom">رقم الجهاز *</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_deviceNumber" placeholder="رقم الجهاز" required list="deviceNumberList" oninput="filterDeviceNumbers()" onfocus="showDeviceNumberDropdown()" onblur="hideDeviceNumberDropdown()" onchange="checkAutoFill()">
                                            <datalist id="deviceNumberList"></datalist>
                                            <div class="autofill-options" id="deviceNumberOptions"></div>
                                            <span class="autofill-indicator" id="deviceNumberAutofillIndicator"><i class="fas fa-magic"></i></span>
                                        </div>
                                        <div class="col-md-3 mb-2 autofill-container">
                                            <label class="form-label-custom">اسم الجهاز *</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_deviceName" placeholder="اسم الجهاز" required list="deviceNameList" oninput="filterDeviceNames()" onfocus="showDeviceNameDropdown()" onblur="hideDeviceNameDropdown()" onchange="checkAutoFill()">
                                            <datalist id="deviceNameList"></datalist>
                                            <div class="autofill-options" id="deviceNameOptions"></div>
                                            <span class="autofill-indicator" id="deviceNameAutofillIndicator"><i class="fas fa-magic"></i></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-calendar-alt"></i> مواعيد المعايرة
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">تاريخ المعايرة</label>
                                            <div class="date-input-wrapper">
                                                <input type="text" class="form-control form-control-custom date-picker" id="calMgmt_calibrationDate" placeholder="يوم/شهر/سنة" readonly>
                                                <i class="fas fa-calendar-alt date-icon"></i>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">التكرار (بالأيام)</label>
                                            <div class="frequency-group">
                                                <div class="frequency-input">
                                                    <input type="number" class="form-control form-control-custom" id="calMgmt_frequency" placeholder="عدد الأيام" min="1" value="365" onchange="calculateDueDate()">
                                                </div>
                                                <div class="frequency-options">
                                                    <button type="button" class="frequency-btn active" onclick="setFrequency(365)">365</button>
                                                    <button type="button" class="frequency-btn" onclick="setFrequency(180)">180</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label-custom">تاريخ الاستحقاق</label>
                                            <div class="date-input-wrapper">
                                                <input type="text" class="form-control form-control-custom date-picker" id="calMgmt_dueDate" placeholder="يوم/شهر/سنة" readonly>
                                                <i class="fas fa-calendar-alt date-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-flask"></i> تفاصيل المعايرة
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مختبر المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_calibrationLab" placeholder="مختبر المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">رقم الاعتماد (ISO 17025)</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_accreditationNumber" placeholder="رقم الاعتماد">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">قابلية التتبع إلى</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_traceability" placeholder="قابلية التتبع إلى">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">عدم اليقين</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_uncertainty" placeholder="عدم اليقين">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-clipboard-check"></i> حالة الجهاز
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة عند الاستلام</label>
                                            <div class="status-select">
                                                <select class="form-select form-select-custom" id="calMgmt_statusBefore" onchange="toggleStatusDetails('before')">
                                                    <option value="سليم">سليم</option>
                                                    <option value="معيب">معيب</option>
                                                </select>
                                            </div>
                                            <div class="status-details" id="statusBeforeDetails">
                                                <input type="text" class="form-control form-control-custom mt-2" id="calMgmt_statusBeforeDetails" placeholder="تفاصيل الحالة عند الاستلام">
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الحالة بعد المعايرة</label>
                                            <div class="status-select">
                                                <select class="form-select form-select-custom" id="calMgmt_statusAfter" onchange="toggleStatusDetails('after')">
                                                    <option value="سليم">سليم</option>
                                                    <option value="معيب">معيب</option>
                                                </select>
                                            </div>
                                            <div class="status-details" id="statusAfterDetails">
                                                <input type="text" class="form-control form-control-custom mt-2" id="calMgmt_statusAfterDetails" placeholder="تفاصيل الحالة بعد المعايرة">
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">الفني المسؤول</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_technician" placeholder="الفني المسؤول" list="technicianList">
                                            <datalist id="technicianList"></datalist>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مراجعة الجودة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_qualityReview" placeholder="مراجعة الجودة" list="qualityReviewerList">
                                            <datalist id="qualityReviewerList"></datalist>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-money-bill-wave"></i> معلومات إضافية
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">تكلفة المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_calibrationCost" placeholder="تكلفة المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">مدة التوقف</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_downtime" placeholder="مدة التوقف">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">طريقة المعايرة</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_calibrationMethod" placeholder="طريقة المعايرة">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label-custom">المراجع</label>
                                            <input type="text" class="form-control form-control-custom" id="calMgmt_reviewer" placeholder="المراجع" list="reviewerList">
                                            <datalist id="reviewerList"></datalist>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-section-title">
                                        <i class="fas fa-sticky-note"></i> ملاحظات
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <textarea class="form-control form-textarea-custom" id="calMgmt_notes" placeholder="الملاحظات الإضافية" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12 d-flex justify-content-between">
                                        <button type="button" onclick="resetCalibrationMgmtForm()" class="btn btn-outline-secondary">
                                            <i class="fas fa-redo me-1"></i> مسح النموذج
                                        </button>
                                        <div>
                                            <button type="button" onclick="addCalibrationMgmtRecord()" class="btn btn-success me-2" id="calibrationMgmt_addBtn">
                                                <i class="fas fa-plus me-1"></i> إضافة جديد
                                            </button>
                                            <button type="button" onclick="updateCalibrationMgmtRecord()" class="btn btn-primary" id="calibrationMgmt_updateBtn" style="display: none;">
                                                <i class="fas fa-save me-1"></i> تحديث السجل
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="calibrationMgmt_editingId">
                                <input type="hidden" id="calibrationMgmt_internalRecordId">
                                <input type="hidden" id="calibrationMgmt_fileLink">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Records Table Section -->
            <div class="row">
                <div class="col-12">
                    <div class="custom-card">
                        <div class="card-header-custom card-header-calibration-mgmt d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list me-2"></i> قائمة سجلات المعايرة</span>
                            <div>
                                <button onclick="loadCalibrationMgmtData()" class="btn btn-light btn-sm me-2">
                                    <i class="fas fa-sync-alt"></i> تحديث
                                </button>
                                <button onclick="exportCalibrationMgmtCSV()" class="btn btn-light btn-sm">
                                    <i class="fas fa-download"></i> تصدير
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="loading-spinner" id="calibrationMgmtLoadingSpinner">
                                <div class="spinner-border text-primary spinner-border-custom" role="status">
                                    <span class="visually-hidden">جاري التحميل...</span>
                                </div>
                            </div>
                            
                            <div class="table-responsive" id="calibrationMgmtTableContainer" style="display: none;">
                                <table class="table table-custom table-hover" id="calibrationMgmtDataTable">
                                </table>
                            </div>
                            
                            <div id="calibrationMgmtNoRecords" class="text-center py-5" style="display: none;">
                                <i class="fas fa-tools fa-4x text-muted mb-4"></i>
                                <h4 class="text-muted">لا توجد سجلات معايرة لعرضها</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 fade-in">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-copyright me-1"></i> نظام إدارة سجلات المعايرة 
                    <span id="currentYear"></span> | 
                    <span id="appVersion" class="text-info">الإصدار 2.0 (مع رفع الملفات)</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تأكيد الحذف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-2x float-start me-3"></i>
                        <h5 class="alert-heading">تحذير!</h5>
                        <p>هل أنت متأكد من حذف هذا السجل؟ هذا الإجراء لا يمكن التراجع عنه.</p>
                        <hr>
                        <p class="mb-0"><strong>النظام:</strong> <span id="deleteSystemType">إدارة المعايرة</span></p>
                        <p class="mb-0"><strong>رقم الشهادة:</strong> <span id="deleteRecordId">غير معروف</span></p>
                        <p class="mb-0"><strong>اسم الجهاز:</strong> <span id="deleteRecordName">غير معروف</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> نعم، احذف السجل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">تفاصيل سجل المعايرة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr Calendar -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ================ CONFIGURATION ================
        const CALIBRATION_MGMT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi3VyWxkd0HCGXDyt21grQ9IjSxLz4ooCSvvhZRbCcuynggxZOaKrq3J5RRG9VzkaH2w/exec";
        const EMPLOYEE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiKkgfhdI3xaW6biMBZCCkuIN9P_6mvUQVHJWgj35kHOUvuQjduHzYfAnOCG0aHWlcpA/exec";
        const UPLOAD_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxHkCAAlvV2mSDofBL0TfZaSWQNWlsgpBdrue0Djny-mdZEqxpSzFsNP9NKYO6YdxUm/exec";
        
        // ================ GLOBAL VARIABLES ================
        let calibrationMgmtRecords = [];
        let employeeRecords = [];
        let deleteRecordId = '';
        let deleteRecordName = '';
        let flatpickrInstances = {};
        let deleteModalInstance = null;
        let detailsModalInstance = null;
        let selectedFile = null;
        let uploadedFileUrl = '';
        let uniqueClients = new Set();
        let uniqueDeviceNumbers = new Set();
        let uniqueDeviceNames = new Set();
        let filteredRecords = [];
        let autoFillTimeout = null;
        let isAutoFilling = false;
        
        // ================ NEW DATE SYSTEM WITH D, M, Y SIGNS ================
        function formatDateToDMY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `D${day} M${month} Y${year}`;
        }
        
        function parseDateFromDMY(dmyString) {
            if (!dmyString) return null;
            
            dmyString = dmyString.toString().trim();
            
            const match = dmyString.match(/^D(\d+)\s+M(\d+)\s+Y(\d+)$/);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10) - 1;
                const year = parseInt(match[3], 10);
                
                if (day < 1 || day > 31) return null;
                if (month < 0 || month > 11) return null;
                if (year < 1900 || year > 2100) return null;
                
                const dateObj = new Date(year, month, day);
                if (dateObj.getDate() !== day || dateObj.getMonth() !== month || dateObj.getFullYear() !== year) {
                    return null;
                }
                
                return dateObj;
            }
            
            return null;
        }
        
        function formatDMYForDisplay(dmyString) {
            if (!dmyString) return '';
            
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    if (!isNaN(regularDate.getTime())) {
                        return `<span class="english-date">${formatDateToDayMonthYear(regularDate)}</span>`;
                    }
                } catch (e) {
                    // Ignore error
                }
                return `<span class="english-date">${dmyString}</span>`;
            }
            
            const formattedDate = formatDateToDayMonthYear(dateObj);
            return `<span class="english-date">${formattedDate}</span>`;
        }
        
        function formatDateToDayMonthYear(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            
            const day = date.getDate();
            const monthIndex = date.getMonth();
            const year = date.getFullYear();
            
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            
            return `${day} ${monthNames[monthIndex]} ${year}`;
        }
        
        function formatDMYForInput(dmyString) {
            if (!dmyString) return '';
            
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    if (!isNaN(regularDate.getTime())) {
                        return formatDateToDDMMYYYY(regularDate);
                    }
                } catch (e) {
                    // Ignore error
                }
                return '';
            }
            
            return formatDateToDDMMYYYY(dateObj);
        }
        
        function validateDMYDate(dmyString) {
            if (!dmyString) return true;
            
            const dateObj = parseDateFromDMY(dmyString);
            if (!dateObj) {
                try {
                    const regularDate = new Date(dmyString);
                    return !isNaN(regularDate.getTime());
                } catch (e) {
                    return false;
                }
            }
            
            return true;
        }
        
        // ================ FILE UPLOAD FUNCTIONS ================
        function initializeFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadContainer = document.getElementById('uploadContainer');
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            uploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadContainer.classList.add('dragover');
            });
            
            uploadContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');
            });
            
            uploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
        }
        
        function handleFileSelect(file) {
            const allowedTypes = [
                "image/png",
                "image/jpeg",
                "application/pdf"
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showNotification("❌ فقط ملفات PNG, JPG, JPEG أو PDF مسموحة", "error");
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification("❌ حجم الملف كبير جداً (الحد الأقصى 10MB)", "error");
                return;
            }
            
            selectedFile = file;
            
            document.getElementById('uploadedFileName').textContent = file.name;
            document.getElementById('uploadedFileSize').textContent = formatFileSize(file.size);
            document.getElementById('uploadedFileInfo').style.display = 'block';
            document.getElementById('uploadedFileLink').style.display = 'none';
            
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = '';
            uploadStatus.className = 'upload-status';
            
            showNotification(`✅ تم اختيار الملف: ${file.name}`, 'success', 3000);
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' بايت';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' كيلوبايت';
            else return (bytes / 1048576).toFixed(1) + ' ميجابايت';
        }
        
        async function uploadFile() {
            if (!selectedFile) {
                showNotification("⚠️ يرجى اختيار ملف أولاً", "warning");
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الرفع...';
            uploadStatus.textContent = 'جاري رفع الملف... ⏳';
            uploadStatus.className = 'upload-status loading';
            
            try {
                const reader = new FileReader();
                
                reader.onload = async function() {
                    const base64 = reader.result.split(",")[1];
                    
                    const response = await fetch(UPLOAD_WEB_APP_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            fileName: selectedFile.name,
                            mimeType: selectedFile.type,
                            fileData: base64
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === "success") {
                        uploadedFileUrl = data.url;
                        
                        document.getElementById('calibrationMgmt_fileLink').value = uploadedFileUrl;
                        
                        uploadStatus.textContent = '✅ تم رفع الملف بنجاح';
                        uploadStatus.className = 'upload-status success';
                        
                        const fileLinkBtn = document.getElementById('uploadedFileLink');
                        fileLinkBtn.href = uploadedFileUrl;
                        fileLinkBtn.style.display = 'inline-block';
                        
                        showNotification(`✅ تم رفع الملف بنجاح: ${selectedFile.name}`, 'success');
                    } else {
                        uploadStatus.textContent = '❌ فشل في رفع الملف: ' + (data.message || 'خطأ غير معروف');
                        uploadStatus.className = 'upload-status error';
                        showNotification(`❌ فشل في رفع الملف: ${data.message || 'خطأ غير معروف'}`, 'error');
                    }
                    
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                };
                
                reader.onerror = function() {
                    uploadStatus.textContent = '❌ خطأ في قراءة الملف';
                    uploadStatus.className = 'upload-status error';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                    showNotification('❌ خطأ في قراءة الملف', 'error');
                };
                
                reader.readAsDataURL(selectedFile);
                
            } catch (error) {
                uploadStatus.textContent = '❌ فشل في رفع الملف: ' + error;
                uploadStatus.className = 'upload-status error';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i> رفع الملف';
                showNotification('❌ فشل في رفع الملف: ' + error, 'error');
            }
        }
        
        // ================ FREQUENCY AND DATE FUNCTIONS ================
        function setFrequency(days) {
            const frequencyInput = document.getElementById('calMgmt_frequency');
            frequencyInput.value = days;
            
            // Update active button
            document.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === days) {
                    btn.classList.add('active');
                }
            });
            
            calculateDueDate();
        }
        
        function calculateDueDate() {
            const calibrationDateInput = document.getElementById('calMgmt_calibrationDate');
            const frequencyInput = document.getElementById('calMgmt_frequency');
            const dueDateInput = document.getElementById('calMgmt_dueDate');
            
            if (!calibrationDateInput.value || !frequencyInput.value) return;
            
            try {
                const calibrationDate = parseDateDDMMYYYY(calibrationDateInput.value);
                if (!calibrationDate) return;
                
                const frequency = parseInt(frequencyInput.value) || 365;
                const dueDate = new Date(calibrationDate);
                dueDate.setDate(dueDate.getDate() + frequency);
                
                const formattedDueDate = formatDateToDDMMYYYY(dueDate);
                dueDateInput.value = formattedDueDate;
                
                if (flatpickrInstances.dueDate) {
                    flatpickrInstances.dueDate.setDate(dueDate, false);
                }
            } catch (e) {
                console.error('Error calculating due date:', e);
            }
        }
        
        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteModal'));
            detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal'));
            
            initializeDatePickers();
            initializeFileUpload();
            
            setTimeout(() => {
                loadCalibrationMgmtData();
                loadEmployeeData();
            }, 500);
            
            document.getElementById('deleteModal').addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            });
            
            document.getElementById('detailsModal').addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            });
            
            // Initialize autofill indicators
            initializeAutofillIndicators();
        });
        
        function initializeAutofillIndicators() {
            // Show indicators when fields have data that could trigger autofill
            const fields = ['calMgmt_client', 'calMgmt_deviceNumber', 'calMgmt_deviceName'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function() {
                    const indicator = document.getElementById(fieldId + 'AutofillIndicator');
                    if (this.value.trim() !== '') {
                        indicator.classList.add('show');
                    } else {
                        indicator.classList.remove('show');
                    }
                });
            });
        }
        
        // ================ DATE PICKER INITIALIZATION ================
        function initializeDatePickers() {
            if (flatpickrInstances.calibrationDate) flatpickrInstances.calibrationDate.destroy();
            if (flatpickrInstances.dueDate) flatpickrInstances.dueDate.destroy();
            
            const dateOptions = {
                locale: 'ar',
                dateFormat: "d/m/Y",
                altFormat: "d/m/Y",
                altInput: false,
                allowInput: true,
                clickOpens: true,
                position: 'auto',
                monthSelectorType: 'static',
                yearSelectorType: 'scrolling',
                prevArrow: '<i class="fas fa-chevron-right"></i>',
                nextArrow: '<i class="fas fa-chevron-left"></i>',
                weekNumbers: false,
                disableMobile: true,
                onChange: function(selectedDates, dateStr, instance) {
                    if (instance.input.id === 'calMgmt_calibrationDate') {
                        calculateDueDate();
                    }
                    
                    if (selectedDates.length > 0) {
                        const date = selectedDates[0];
                        const formattedDate = formatDateToDDMMYYYY(date);
                        instance.input.value = formattedDate;
                    }
                }
            };
            
            flatpickrInstances.calibrationDate = flatpickr('#calMgmt_calibrationDate', dateOptions);
            flatpickrInstances.dueDate = flatpickr('#calMgmt_dueDate', dateOptions);
            
            if (flatpickrInstances.calibrationDate) flatpickrInstances.calibrationDate.set('locale', 'ar');
            if (flatpickrInstances.dueDate) flatpickrInstances.dueDate.set('locale', 'ar');
            
            // Set calibration date to current date by default
            const today = new Date();
            const todayFormatted = formatDateToDDMMYYYY(today);
            document.getElementById('calMgmt_calibrationDate').value = todayFormatted;
            if (flatpickrInstances.calibrationDate) {
                flatpickrInstances.calibrationDate.setDate(today, false);
            }
            
            // Calculate initial due date
            calculateDueDate();
        }
        
        // ================ DATE FORMATTING FUNCTIONS ================
        function formatDateToDDMMYYYY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    if (day < 1 || day > 31) return null;
                    if (month < 0 || month > 11) return null;
                    if (year < 1900 || year > 2100) return null;
                    
                    return new Date(year, month, day);
                }
            }
            
            return null;
        }
        
        function setCurrentDate() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('currentDate').textContent = `${day}/${month}/${year}`;
        }
        
        // ================ NOTIFICATION SYSTEM ================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getNotificationIcon(type)} me-3"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            return notification;
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // ================ JSONP FUNCTION ================
        function jsonp(url, callbackParam = 'callback') {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + callbackParam + '=' + callbackName;
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // ================ VALIDATION HELPER ================
        function validateForm(requiredFields) {
            let isValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            const calibrationDate = document.getElementById('calMgmt_calibrationDate').value;
            const dueDate = document.getElementById('calMgmt_dueDate').value;
            
            if (calibrationDate && !validateDate(calibrationDate)) {
                document.getElementById('calMgmt_calibrationDate').classList.add('is-invalid');
                showNotification('❌ تاريخ المعايرة غير صحيح', 'error');
                isValid = false;
            } else {
                document.getElementById('calMgmt_calibrationDate').classList.remove('is-invalid');
            }
            
            if (dueDate && !validateDate(dueDate)) {
                document.getElementById('calMgmt_dueDate').classList.add('is-invalid');
                showNotification('❌ تاريخ الاستحقاق غير صحيح', 'error');
                isValid = false;
            } else {
                document.getElementById('calMgmt_dueDate').classList.remove('is-invalid');
            }
            
            return isValid;
        }
        
        function validateDate(dateString) {
            if (!dateString) return true;
            
            if (validateDMYDate(dateString)) {
                return true;
            }
            
            const ddMMyyyyRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            if (ddMMyyyyRegex.test(dateString)) {
                const match = dateString.match(ddMMyyyyRegex);
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                const year = parseInt(match[3], 10);
                
                if (year < 1900 || year > 2100) return false;
                if (month < 1 || month > 12) return false;
                if (day < 1 || day > 31) return false;
                
                const daysInMonth = [31, (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 29 : 28, 
                                    31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                return day <= daysInMonth[month - 1];
            }
            
            return false;
        }
        
        // ================ EMPLOYEE DATA FUNCTIONS ================
        async function loadEmployeeData() {
            try {
                const res = await jsonp(`${EMPLOYEE_SCRIPT_URL}?action=getAll`);
                
                if (res && res.status === 'success') {
                    let records = [];
                    
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (Array.isArray(res)) {
                        records = res;
                    }
                    
                    employeeRecords = records;
                    populateEmployeeDatalists();
                } else {
                    console.log('Failed to load employee data');
                }
            } catch (error) {
                console.error('Error loading employee data:', error);
            }
        }
        
        function populateEmployeeDatalists() {
            const technicianList = document.getElementById('technicianList');
            const qualityReviewerList = document.getElementById('qualityReviewerList');
            const reviewerList = document.getElementById('reviewerList');
            
            technicianList.innerHTML = '';
            qualityReviewerList.innerHTML = '';
            reviewerList.innerHTML = '';
            
            const names = new Set();
            
            employeeRecords.forEach(record => {
                if (record && record.length > 1 && record[1]) {
                    names.add(String(record[1]).trim());
                }
            });
            
            names.forEach(name => {
                const option1 = document.createElement('option');
                option1.value = name;
                technicianList.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = name;
                qualityReviewerList.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = name;
                reviewerList.appendChild(option3);
            });
        }
        
        // ================ STATUS DETAILS FUNCTIONS ================
        function toggleStatusDetails(type) {
            const statusSelect = document.getElementById(`calMgmt_status${type === 'before' ? 'Before' : 'After'}`);
            const detailsDiv = document.getElementById(`status${type === 'before' ? 'Before' : 'After'}Details`);
            
            if (statusSelect.value === 'معيب') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }
        
        // ================ AUTOFILL AND FILTER FUNCTIONS ================
        function updateUniqueValues() {
            uniqueClients.clear();
            uniqueDeviceNumbers.clear();
            uniqueDeviceNames.clear();
            
            calibrationMgmtRecords.forEach(record => {
                // Column mapping correction based on Google Apps Script:
                // 0: ID, 1: certificateNumber, 2: client, 3: deviceNumber, 4: deviceName,
                // 5: calibrationDate, 6: frequency, 7: dueDate, 8: calibrationLab,
                // 9: accreditationNumber, 10: traceability, 11: uncertainty,
                // 12: statusBefore, 13: statusAfter, 14: fileLocation,
                // 15: notes, 16: technician, 17: calibrationCost,
                // 18: downtime, 19: calibrationMethod, 20: qualityReview, 21: reviewer
                
                if (record[2] && record[2].toString().trim() !== '') {
                    uniqueClients.add(record[2].toString().trim());
                }
                
                if (record[3] && record[3].toString().trim() !== '') {
                    uniqueDeviceNumbers.add(record[3].toString().trim());
                }
                
                if (record[4] && record[4].toString().trim() !== '') {
                    uniqueDeviceNames.add(record[4].toString().trim());
                }
            });
            
            // Populate client datalist
            const clientList = document.getElementById('clientList');
            clientList.innerHTML = '';
            uniqueClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                clientList.appendChild(option);
            });
            
            // Populate device number datalist
            const deviceNumberList = document.getElementById('deviceNumberList');
            deviceNumberList.innerHTML = '';
            uniqueDeviceNumbers.forEach(deviceNumber => {
                const option = document.createElement('option');
                option.value = deviceNumber;
                deviceNumberList.appendChild(option);
            });
            
            // Populate device name datalist
            const deviceNameList = document.getElementById('deviceNameList');
            deviceNameList.innerHTML = '';
            uniqueDeviceNames.forEach(deviceName => {
                const option = document.createElement('option');
                option.value = deviceName;
                deviceNameList.appendChild(option);
            });
        }
        
        function showClientDropdown() {
            const input = document.getElementById('calMgmt_client');
            const optionsDiv = document.getElementById('clientOptions');
            
            if (uniqueClients.size === 0) return;
            
            optionsDiv.innerHTML = '';
            uniqueClients.forEach(client => {
                const div = document.createElement('div');
                div.className = 'autofill-option';
                div.textContent = client;
                div.onclick = function() {
                    input.value = client;
                    optionsDiv.style.display = 'none';
                    filterDevicesByClient();
                    checkAutoFill();
                };
                optionsDiv.appendChild(div);
            });
            
            optionsDiv.style.display = 'block';
        }
        
        function hideClientDropdown() {
            setTimeout(() => {
                document.getElementById('clientOptions').style.display = 'none';
            }, 200);
        }
        
        function filterClients() {
            const input = document.getElementById('calMgmt_client');
            const filter = input.value.toLowerCase();
            const optionsDiv = document.getElementById('clientOptions');
            
            optionsDiv.innerHTML = '';
            
            Array.from(uniqueClients)
                .filter(client => client.toLowerCase().includes(filter))
                .forEach(client => {
                    const div = document.createElement('div');
                    div.className = 'autofill-option';
                    div.textContent = client;
                    div.onclick = function() {
                        input.value = client;
                        optionsDiv.style.display = 'none';
                        filterDevicesByClient();
                        checkAutoFill();
                    };
                    optionsDiv.appendChild(div);
                });
            
            if (optionsDiv.children.length > 0) {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
            
            checkAutoFill();
        }
        
        function filterDevicesByClient() {
            const client = document.getElementById('calMgmt_client').value.trim();
            if (!client) return;
            
            // Filter records by client
            filteredRecords = calibrationMgmtRecords.filter(record => 
                record[2] && record[2].toString().trim() === client
            );
            
            // Update device number and name datalists
            const deviceNumberList = document.getElementById('deviceNumberList');
            const deviceNameList = document.getElementById('deviceNameList');
            
            deviceNumberList.innerHTML = '';
            deviceNameList.innerHTML = '';
            
            const filteredDeviceNumbers = new Set();
            const filteredDeviceNames = new Set();
            
            filteredRecords.forEach(record => {
                if (record[3] && record[3].toString().trim() !== '') {
                    filteredDeviceNumbers.add(record[3].toString().trim());
                }
                if (record[4] && record[4].toString().trim() !== '') {
                    filteredDeviceNames.add(record[4].toString().trim());
                }
            });
            
            filteredDeviceNumbers.forEach(deviceNumber => {
                const option = document.createElement('option');
                option.value = deviceNumber;
                deviceNumberList.appendChild(option);
            });
            
            filteredDeviceNames.forEach(deviceName => {
                const option = document.createElement('option');
                option.value = deviceName;
                deviceNameList.appendChild(option);
            });
        }
        
        function showDeviceNumberDropdown() {
            const input = document.getElementById('calMgmt_deviceNumber');
            const optionsDiv = document.getElementById('deviceNumberOptions');
            const client = document.getElementById('calMgmt_client').value.trim();
            
            let devicesToShow = uniqueDeviceNumbers;
            if (client) {
                // Filter by client if client is selected
                devicesToShow = new Set();
                filteredRecords.forEach(record => {
                    if (record[3] && record[3].toString().trim() !== '') {
                        devicesToShow.add(record[3].toString().trim());
                    }
                });
            }
            
            if (devicesToShow.size === 0) return;
            
            optionsDiv.innerHTML = '';
            devicesToShow.forEach(deviceNumber => {
                const div = document.createElement('div');
                div.className = 'autofill-option';
                div.textContent = deviceNumber;
                div.onclick = function() {
                    input.value = deviceNumber;
                    optionsDiv.style.display = 'none';
                    checkAutoFill();
                };
                optionsDiv.appendChild(div);
            });
            
            optionsDiv.style.display = 'block';
        }
        
        function hideDeviceNumberDropdown() {
            setTimeout(() => {
                document.getElementById('deviceNumberOptions').style.display = 'none';
            }, 200);
        }
        
        function filterDeviceNumbers() {
            const input = document.getElementById('calMgmt_deviceNumber');
            const filter = input.value.toLowerCase();
            const optionsDiv = document.getElementById('deviceNumberOptions');
            const client = document.getElementById('calMgmt_client').value.trim();
            
            let devicesToShow = uniqueDeviceNumbers;
            if (client) {
                devicesToShow = new Set();
                filteredRecords.forEach(record => {
                    if (record[3] && record[3].toString().trim() !== '') {
                        devicesToShow.add(record[3].toString().trim());
                    }
                });
            }
            
            optionsDiv.innerHTML = '';
            
            Array.from(devicesToShow)
                .filter(deviceNumber => deviceNumber.toLowerCase().includes(filter))
                .forEach(deviceNumber => {
                    const div = document.createElement('div');
                    div.className = 'autofill-option';
                    div.textContent = deviceNumber;
                    div.onclick = function() {
                        input.value = deviceNumber;
                        optionsDiv.style.display = 'none';
                        checkAutoFill();
                    };
                    optionsDiv.appendChild(div);
                });
            
            if (optionsDiv.children.length > 0) {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
            
            checkAutoFill();
        }
        
        function showDeviceNameDropdown() {
            const input = document.getElementById('calMgmt_deviceName');
            const optionsDiv = document.getElementById('deviceNameOptions');
            const client = document.getElementById('calMgmt_client').value.trim();
            
            let devicesToShow = uniqueDeviceNames;
            if (client) {
                devicesToShow = new Set();
                filteredRecords.forEach(record => {
                    if (record[4] && record[4].toString().trim() !== '') {
                        devicesToShow.add(record[4].toString().trim());
                    }
                });
            }
            
            if (devicesToShow.size === 0) return;
            
            optionsDiv.innerHTML = '';
            devicesToShow.forEach(deviceName => {
                const div = document.createElement('div');
                div.className = 'autofill-option';
                div.textContent = deviceName;
                div.onclick = function() {
                    input.value = deviceName;
                    optionsDiv.style.display = 'none';
                    checkAutoFill();
                };
                optionsDiv.appendChild(div);
            });
            
            optionsDiv.style.display = 'block';
        }
        
        function hideDeviceNameDropdown() {
            setTimeout(() => {
                document.getElementById('deviceNameOptions').style.display = 'none';
            }, 200);
        }
        
        function filterDeviceNames() {
            const input = document.getElementById('calMgmt_deviceName');
            const filter = input.value.toLowerCase();
            const optionsDiv = document.getElementById('deviceNameOptions');
            const client = document.getElementById('calMgmt_client').value.trim();
            
            let devicesToShow = uniqueDeviceNames;
            if (client) {
                devicesToShow = new Set();
                filteredRecords.forEach(record => {
                    if (record[4] && record[4].toString().trim() !== '') {
                        devicesToShow.add(record[4].toString().trim());
                    }
                });
            }
            
            optionsDiv.innerHTML = '';
            
            Array.from(devicesToShow)
                .filter(deviceName => deviceName.toLowerCase().includes(filter))
                .forEach(deviceName => {
                    const div = document.createElement('div');
                    div.className = 'autofill-option';
                    div.textContent = deviceName;
                    div.onclick = function() {
                        input.value = deviceName;
                        optionsDiv.style.display = 'none';
                        checkAutoFill();
                    };
                    optionsDiv.appendChild(div);
                });
            
            if (optionsDiv.children.length > 0) {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
            
            checkAutoFill();
        }
        
        // ================ NEW AUTOFILL FUNCTION ================
        function checkAutoFill() {
            // Clear previous timeout
            if (autoFillTimeout) {
                clearTimeout(autoFillTimeout);
            }
            
            // Set a timeout to check after user stops typing
            autoFillTimeout = setTimeout(() => {
                performAutoFill();
            }, 500);
        }
        
        function performAutoFill() {
            // Don't autofill if we're in edit mode
            if (document.getElementById('calibrationMgmt_editingId').value) {
                return;
            }
            
            const client = document.getElementById('calMgmt_client').value.trim();
            const deviceNumber = document.getElementById('calMgmt_deviceNumber').value.trim();
            const deviceName = document.getElementById('calMgmt_deviceName').value.trim();
            
            // Check if all three fields are filled
            if (!client || !deviceNumber || !deviceName) {
                return;
            }
            
            // Don't autofill if we're already in the process of autofilling
            if (isAutoFilling) {
                return;
            }
            
            isAutoFilling = true;
            
            // Find records that match all three criteria
            let matchingRecords = calibrationMgmtRecords.filter(record => {
                const recordClient = record[2] ? record[2].toString().trim() : '';
                const recordDeviceNumber = record[3] ? record[3].toString().trim() : '';
                const recordDeviceName = record[4] ? record[4].toString().trim() : '';
                
                return recordClient === client && 
                       recordDeviceNumber === deviceNumber && 
                       recordDeviceName === deviceName;
            });
            
            if (matchingRecords.length === 0) {
                isAutoFilling = false;
                return;
            }
            
            // Find the most recent record by calibration date
            let mostRecentRecord = matchingRecords[0];
            let mostRecentDate = parseDateFromDMY(matchingRecords[0][5] || '');
            
            for (let i = 1; i < matchingRecords.length; i++) {
                const currentDate = parseDateFromDMY(matchingRecords[i][5] || '');
                if (currentDate && mostRecentDate) {
                    if (currentDate > mostRecentDate) {
                        mostRecentRecord = matchingRecords[i];
                        mostRecentDate = currentDate;
                    }
                }
            }
            
            // Check if this is the same data already in the form
            if (!isFormDataDifferent(mostRecentRecord)) {
                isAutoFilling = false;
                return;
            }
            
            // Show confirmation dialog
            const confirmFill = confirm('تم العثور على سجل مطابق. هل تريد تعبئة البيانات تلقائياً؟');
            
            if (confirmFill) {
                // Fill other fields (excluding certificate number and the three identifying fields)
                document.getElementById('calMgmt_calibrationLab').value = mostRecentRecord[8] || '';
                document.getElementById('calMgmt_accreditationNumber').value = mostRecentRecord[9] || '';
                document.getElementById('calMgmt_traceability').value = mostRecentRecord[10] || '';
                document.getElementById('calMgmt_uncertainty').value = mostRecentRecord[11] || '';
                
                // Handle status fields with details
                const statusBefore = mostRecentRecord[12] || 'سليم';
                if (statusBefore.includes(' - ')) {
                    const parts = statusBefore.split(' - ');
                    document.getElementById('calMgmt_statusBefore').value = parts[0];
                    document.getElementById('calMgmt_statusBeforeDetails').value = parts.slice(1).join(' - ');
                    document.getElementById('statusBeforeDetails').style.display = parts[0] === 'معيب' ? 'block' : 'none';
                } else {
                    document.getElementById('calMgmt_statusBefore').value = statusBefore;
                    document.getElementById('statusBeforeDetails').style.display = 'none';
                }
                
                const statusAfter = mostRecentRecord[13] || 'سليم';
                if (statusAfter.includes(' - ')) {
                    const parts = statusAfter.split(' - ');
                    document.getElementById('calMgmt_statusAfter').value = parts[0];
                    document.getElementById('calMgmt_statusAfterDetails').value = parts.slice(1).join(' - ');
                    document.getElementById('statusAfterDetails').style.display = parts[0] === 'معيب' ? 'block' : 'none';
                } else {
                    document.getElementById('calMgmt_statusAfter').value = statusAfter;
                    document.getElementById('statusAfterDetails').style.display = 'none';
                }
                
                document.getElementById('calMgmt_notes').value = mostRecentRecord[15] || '';
                document.getElementById('calMgmt_technician').value = mostRecentRecord[16] || '';
                document.getElementById('calMgmt_calibrationCost').value = mostRecentRecord[17] || '';
                document.getElementById('calMgmt_downtime').value = mostRecentRecord[18] || '';
                document.getElementById('calMgmt_calibrationMethod').value = mostRecentRecord[19] || '';
                document.getElementById('calMgmt_qualityReview').value = mostRecentRecord[20] || '';
                document.getElementById('calMgmt_reviewer').value = mostRecentRecord[21] || '';
                
                // Set frequency
                document.getElementById('calMgmt_frequency').value = mostRecentRecord[6] || '365';
                document.querySelectorAll('.frequency-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.textContent) === parseInt(mostRecentRecord[6] || '365')) {
                        btn.classList.add('active');
                    }
                });
                
                // Set the file link
                const fileLink = mostRecentRecord[14] || '';
                document.getElementById('calibrationMgmt_fileLink').value = fileLink;
                
                // Display file info if there's a file link
                if (fileLink && fileLink.trim() !== '') {
                    const fileName = 'ملف المعايرة';
                    document.getElementById('uploadedFileName').textContent = fileName;
                    document.getElementById('uploadedFileSize').textContent = '';
                    document.getElementById('uploadedFileInfo').style.display = 'block';
                    
                    const fileLinkBtn = document.getElementById('uploadedFileLink');
                    fileLinkBtn.href = fileLink;
                    fileLinkBtn.style.display = 'inline-block';
                    
                    const uploadStatus = document.getElementById('uploadStatus');
                    uploadStatus.textContent = '✅ ملف مرفق مسبقاً';
                    uploadStatus.className = 'upload-status success';
                }
                
                // Set date values using D M Y format
                const calibrationDateFormatted = formatDMYForInput(mostRecentRecord[5] || '');
                const dueDateFormatted = formatDMYForInput(mostRecentRecord[7] || '');
                
                document.getElementById('calMgmt_calibrationDate').value = calibrationDateFormatted;
                document.getElementById('calMgmt_dueDate').value = dueDateFormatted;
                
                // Update Flatpickr instances
                if (flatpickrInstances.calibrationDate && calibrationDateFormatted) {
                    try {
                        const parts = calibrationDateFormatted.split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1;
                            const year = parseInt(parts[2], 10);
                            const dateObj = new Date(year, month, day);
                            flatpickrInstances.calibrationDate.setDate(dateObj, false);
                        }
                    } catch (e) {
                        console.error('Error setting calibration date:', e);
                    }
                }
                
                if (flatpickrInstances.dueDate && dueDateFormatted) {
                    try {
                        const parts = dueDateFormatted.split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1;
                            const year = parseInt(parts[2], 10);
                            const dateObj = new Date(year, month, day);
                            flatpickrInstances.dueDate.setDate(dateObj, false);
                        }
                    } catch (e) {
                        console.error('Error setting due date:', e);
                    }
                }
                
                // Calculate due date
                calculateDueDate();
                
                showNotification('✅ تم تعبئة البيانات تلقائياً من آخر سجل', 'success', 3000);
            }
            
            isAutoFilling = false;
        }
        
        function isFormDataDifferent(record) {
            // Check if the form data is different from the record
            // We'll check a few key fields to avoid unnecessary prompts
            
            const currentCalibrationLab = document.getElementById('calMgmt_calibrationLab').value.trim();
            const recordCalibrationLab = record[8] || '';
            
            const currentTechnician = document.getElementById('calMgmt_technician').value.trim();
            const recordTechnician = record[16] || '';
            
            const currentNotes = document.getElementById('calMgmt_notes').value.trim();
            const recordNotes = record[15] || '';
            
            return currentCalibrationLab !== recordCalibrationLab ||
                   currentTechnician !== recordTechnician ||
                   currentNotes !== recordNotes;
        }
        
        // ================ CALIBRATION MANAGEMENT SYSTEM FUNCTIONS ================
        async function loadCalibrationMgmtData() {
            const spinner = document.getElementById('calibrationMgmtLoadingSpinner');
            const tableContainer = document.getElementById('calibrationMgmtTableContainer');
            const noRecords = document.getElementById('calibrationMgmtNoRecords');
            
            spinner.style.display = 'flex';
            tableContainer.style.display = 'none';
            noRecords.style.display = 'none';
            
            try {
                const res = await jsonp(`${CALIBRATION_MGMT_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                
                spinner.style.display = 'none';
                
                let records = [];
                let responseStatus = 'error';
                
                if (res && res.status === 'success') {
                    responseStatus = 'success';
                    if (Array.isArray(res.records)) {
                        records = res.records;
                    } else if (Array.isArray(res.data)) {
                        records = res.data;
                    } else if (res.records && typeof res.records === 'object') {
                        const keys = Object.keys(res.records);
                        if (keys.length > 0 && Array.isArray(res.records[keys[0]])) {
                            records = res.records[keys[0]];
                        }
                    }
                } else if (Array.isArray(res)) {
                    records = res;
                    responseStatus = 'success';
                }
                
                if (responseStatus !== 'success') {
                    noRecords.style.display = 'block';
                    showNotification('❌ فشل في تحميل سجلات المعايرة', 'error');
                    document.getElementById('totalRecords').textContent = '0';
                    return;
                }
                
                calibrationMgmtRecords = records;
                
                if (calibrationMgmtRecords.length > 0) {
                    displayCalibrationMgmtRecords(calibrationMgmtRecords);
                    tableContainer.style.display = 'block';
                    document.getElementById('totalRecords').textContent = calibrationMgmtRecords.length.toLocaleString('ar-SA');
                    
                    // Update unique values for autofill
                    updateUniqueValues();
                } else {
                    noRecords.style.display = 'block';
                    document.getElementById('totalRecords').textContent = '0';
                }
            } catch (error) {
                spinner.style.display = 'none';
                noRecords.style.display = 'block';
                showNotification('❌ خطأ في تحميل سجلات المعايرة', 'error');
                document.getElementById('totalRecords').textContent = '0';
            }
        }
        
        function displayCalibrationMgmtRecords(records) {
            const table = document.getElementById('calibrationMgmtDataTable');
            
            let html = '<thead><tr>';
            const headers = ['رقم الشهادة', 'العميل', 'رقم الجهاز', 'اسم الجهاز', 'تاريخ المعايرة', 'تاريخ الاستحقاق', 'مختبر المعايرة', 'الحالة بعد المعايرة', 'الملف المرفوع', 'الإجراءات'];
            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            records.forEach((record) => {
                // Column mapping correction based on Google Apps Script:
                // 0: ID, 1: certificateNumber, 2: client, 3: deviceNumber, 4: deviceName,
                // 5: calibrationDate, 6: frequency, 7: dueDate, 8: calibrationLab,
                // 9: accreditationNumber, 10: traceability, 11: uncertainty,
                // 12: statusBefore, 13: statusAfter, 14: fileLocation,
                // 15: notes, 16: technician, 17: calibrationCost,
                // 18: downtime, 19: calibrationMethod, 20: qualityReview, 21: reviewer
                
                const fileLink = record[14] || '';
                
                html += '<tr>';
                
                html += `<td><strong>${escapeHtml(record[1] || '')}</strong></td>`;
                html += `<td>${escapeHtml(record[2] || '')}</td>`;
                html += `<td>${escapeHtml(record[3] || '')}</td>`;
                html += `<td>${escapeHtml(record[4] || '')}</td>`;
                html += `<td>${formatDMYForDisplay(record[5] || '')}</td>`;
                html += `<td>${formatDMYForDisplay(record[7] || '')}</td>`;
                html += `<td>${escapeHtml(record[8] || '')}</td>`;
                html += `<td>${escapeHtml(record[13] || '')}</td>`;
                
                // File link column
                if (fileLink && fileLink.trim() !== '') {
                    html += `<td>
                        <a href="${escapeHtml(fileLink)}" target="_blank" class="file-link-btn">
                            <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                        </a>
                    </td>`;
                } else {
                    html += `<td><span class="text-muted">لا يوجد ملف</span></td>`;
                }
                
                html += `<td class="action-buttons">
                    <button onclick="editCalibrationMgmtRecord('${escapeHtml(record[0])}')" class="btn btn-sm btn-primary" title="تعديل">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button onclick="showDeleteModal('${escapeHtml(record[0])}', '${escapeHtml(record[4])}', '${escapeHtml(record[1] || '')}')" class="btn btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button onclick="viewDetails('${escapeHtml(record[0])}')" class="btn btn-sm btn-info" title="عرض">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function addCalibrationMgmtRecord() {
            const requiredFields = ['calMgmt_certificateNumber', 'calMgmt_deviceNumber', 'calMgmt_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const calibrationDate = document.getElementById('calMgmt_calibrationDate').value;
            const dueDate = document.getElementById('calMgmt_dueDate').value;
            
            const button = document.getElementById('calibrationMgmt_addBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإضافة...';
            
            if (calibrationDate && !validateDate(calibrationDate)) {
                showNotification('❌ تاريخ المعايرة غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            if (dueDate && !validateDate(dueDate)) {
                showNotification('❌ تاريخ الاستحقاق غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            // Generate internal recordId
            const internalRecordId = 'CAL-' + Date.now();
            document.getElementById('calibrationMgmt_internalRecordId').value = internalRecordId;
            
            // Get file link from hidden field
            const fileLink = document.getElementById('calibrationMgmt_fileLink').value;
            
            // Convert dates to D M Y format
            const calibrationDateDMY = calibrationDate ? formatDateToDMY(parseDateDDMMYYYY(calibrationDate)) : '';
            const dueDateDMY = dueDate ? formatDateToDMY(parseDateDDMMYYYY(dueDate)) : '';
            
            // Prepare status with details
            const statusBeforeValue = document.getElementById('calMgmt_statusBefore').value;
            const statusBeforeDetails = document.getElementById('calMgmt_statusBeforeDetails').value;
            const statusBeforeToSave = statusBeforeDetails && statusBeforeValue === 'معيب' 
                ? `${statusBeforeValue} - ${statusBeforeDetails}`
                : statusBeforeValue;
            
            const statusAfterValue = document.getElementById('calMgmt_statusAfter').value;
            const statusAfterDetails = document.getElementById('calMgmt_statusAfterDetails').value;
            const statusAfterToSave = statusAfterDetails && statusAfterValue === 'معيب'
                ? `${statusAfterValue} - ${statusAfterDetails}`
                : statusAfterValue;
            
            // Build query string with correct parameter names
            let q = `certificateNumber=${encodeURIComponent(document.getElementById('calMgmt_certificateNumber').value || '')}&`;
            q += `client=${encodeURIComponent(document.getElementById('calMgmt_client').value || '')}&`;
            q += `deviceNumber=${encodeURIComponent(document.getElementById('calMgmt_deviceNumber').value || '')}&`;
            q += `deviceName=${encodeURIComponent(document.getElementById('calMgmt_deviceName').value || '')}&`;
            q += `frequency=${encodeURIComponent(document.getElementById('calMgmt_frequency').value || '365')}&`;
            q += `calibrationLab=${encodeURIComponent(document.getElementById('calMgmt_calibrationLab').value || '')}&`;
            q += `accreditationNumber=${encodeURIComponent(document.getElementById('calMgmt_accreditationNumber').value || '')}&`;
            q += `traceability=${encodeURIComponent(document.getElementById('calMgmt_traceability').value || '')}&`;
            q += `uncertainty=${encodeURIComponent(document.getElementById('calMgmt_uncertainty').value || '')}&`;
            q += `statusBefore=${encodeURIComponent(statusBeforeToSave)}&`;
            q += `statusAfter=${encodeURIComponent(statusAfterToSave)}&`;
            q += `notes=${encodeURIComponent(document.getElementById('calMgmt_notes').value || '')}&`;
            q += `technician=${encodeURIComponent(document.getElementById('calMgmt_technician').value || '')}&`;
            q += `calibrationCost=${encodeURIComponent(document.getElementById('calMgmt_calibrationCost').value || '')}&`;
            q += `downtime=${encodeURIComponent(document.getElementById('calMgmt_downtime').value || '')}&`;
            q += `calibrationMethod=${encodeURIComponent(document.getElementById('calMgmt_calibrationMethod').value || '')}&`;
            q += `qualityReview=${encodeURIComponent(document.getElementById('calMgmt_qualityReview').value || '')}&`;
            q += `reviewer=${encodeURIComponent(document.getElementById('calMgmt_reviewer').value || '')}&`;
            q += `calibrationDate=${encodeURIComponent(calibrationDateDMY)}&`;
            q += `dueDate=${encodeURIComponent(dueDateDMY)}&`;
            q += `fileLink=${encodeURIComponent(fileLink || '')}`;
            
            try {
                const res = await jsonp(`${CALIBRATION_MGMT_SCRIPT_URL}?action=add&${q}`);
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    resetCalibrationMgmtForm();
                    await loadCalibrationMgmtData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في الإضافة', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        async function editCalibrationMgmtRecord(recordId) {
            showNotification('🔍 جاري تحميل بيانات سجل المعايرة...', 'info');
            
            const record = calibrationMgmtRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (record) {
                fillCalibrationMgmtForm(record);
                document.getElementById('calibrationMgmt_updateBtn').style.display = 'inline-block';
                document.getElementById('calibrationMgmt_addBtn').style.display = 'none';
                showNotification('✅ تم تحميل بيانات سجل المعايرة', 'success');
            } else {
                showNotification('❌ لم يتم العثور على سجل المعايرة', 'error');
            }
        }
        
        function fillCalibrationMgmtForm(record) {
            // Clear any previous autofill data
            filteredRecords = [];
            
            document.getElementById('calMgmt_certificateNumber').value = record[1] || '';
            document.getElementById('calMgmt_client').value = record[2] || '';
            document.getElementById('calMgmt_deviceNumber').value = record[3] || '';
            document.getElementById('calMgmt_deviceName').value = record[4] || '';
            document.getElementById('calMgmt_frequency').value = record[6] || '365';
            document.getElementById('calMgmt_calibrationLab').value = record[8] || '';
            document.getElementById('calMgmt_accreditationNumber').value = record[9] || '';
            document.getElementById('calMgmt_traceability').value = record[10] || '';
            document.getElementById('calMgmt_uncertainty').value = record[11] || '';
            
            // Handle status with details
            const statusBefore = record[12] || 'سليم';
            if (statusBefore.includes(' - ')) {
                const parts = statusBefore.split(' - ');
                document.getElementById('calMgmt_statusBefore').value = parts[0];
                document.getElementById('calMgmt_statusBeforeDetails').value = parts.slice(1).join(' - ');
                document.getElementById('statusBeforeDetails').style.display = parts[0] === 'معيب' ? 'block' : 'none';
            } else {
                document.getElementById('calMgmt_statusBefore').value = statusBefore;
                document.getElementById('calMgmt_statusBeforeDetails').value = '';
                document.getElementById('statusBeforeDetails').style.display = 'none';
            }
            
            const statusAfter = record[13] || 'سليم';
            if (statusAfter.includes(' - ')) {
                const parts = statusAfter.split(' - ');
                document.getElementById('calMgmt_statusAfter').value = parts[0];
                document.getElementById('calMgmt_statusAfterDetails').value = parts.slice(1).join(' - ');
                document.getElementById('statusAfterDetails').style.display = parts[0] === 'معيب' ? 'block' : 'none';
            } else {
                document.getElementById('calMgmt_statusAfter').value = statusAfter;
                document.getElementById('calMgmt_statusAfterDetails').value = '';
                document.getElementById('statusAfterDetails').style.display = 'none';
            }
            
            document.getElementById('calMgmt_notes').value = record[15] || '';
            document.getElementById('calMgmt_technician').value = record[16] || '';
            document.getElementById('calMgmt_calibrationCost').value = record[17] || '';
            document.getElementById('calMgmt_downtime').value = record[18] || '';
            document.getElementById('calMgmt_calibrationMethod').value = record[19] || '';
            document.getElementById('calMgmt_qualityReview').value = record[20] || '';
            document.getElementById('calMgmt_reviewer').value = record[21] || '';
            
            // Set the file link
            const fileLink = record[14] || '';
            document.getElementById('calibrationMgmt_fileLink').value = fileLink;
            
            // Display file info if there's a file link
            if (fileLink && fileLink.trim() !== '') {
                const fileName = 'ملف المعايرة';
                document.getElementById('uploadedFileName').textContent = fileName;
                document.getElementById('uploadedFileSize').textContent = '';
                document.getElementById('uploadedFileInfo').style.display = 'block';
                
                const fileLinkBtn = document.getElementById('uploadedFileLink');
                fileLinkBtn.href = fileLink;
                fileLinkBtn.style.display = 'inline-block';
                
                const uploadStatus = document.getElementById('uploadStatus');
                uploadStatus.textContent = '✅ ملف مرفق مسبقاً';
                uploadStatus.className = 'upload-status success';
            }
            
            // Set date values using D M Y format
            const calibrationDateFormatted = formatDMYForInput(record[5] || '');
            const dueDateFormatted = formatDMYForInput(record[7] || '');
            
            document.getElementById('calMgmt_calibrationDate').value = calibrationDateFormatted;
            document.getElementById('calMgmt_dueDate').value = dueDateFormatted;
            
            // Update Flatpickr instances
            if (flatpickrInstances.calibrationDate && calibrationDateFormatted) {
                try {
                    const parts = calibrationDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.calibrationDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting calibration date:', e);
                }
            }
            
            if (flatpickrInstances.dueDate && dueDateFormatted) {
                try {
                    const parts = dueDateFormatted.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        const dateObj = new Date(year, month, day);
                        flatpickrInstances.dueDate.setDate(dateObj, false);
                    }
                } catch (e) {
                    console.error('Error setting due date:', e);
                }
            }
            
            document.getElementById('calibrationMgmt_editingId').value = record[0];
            document.getElementById('calibrationMgmt_internalRecordId').value = record[0];
            
            // Update frequency buttons active state
            const frequency = record[6] || '365';
            document.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === parseInt(frequency)) {
                    btn.classList.add('active');
                }
            });
        }
        
        async function updateCalibrationMgmtRecord() {
            const recordId = document.getElementById('calibrationMgmt_editingId').value;
            if (!recordId) {
                showNotification('❌ لم يتم تحديد سجل معايرة للتحديث', 'error');
                return;
            }
            
            const requiredFields = ['calMgmt_certificateNumber', 'calMgmt_deviceNumber', 'calMgmt_deviceName'];
            if (!validateForm(requiredFields)) {
                showNotification('⚠️ يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }
            
            const calibrationDate = document.getElementById('calMgmt_calibrationDate').value;
            const dueDate = document.getElementById('calMgmt_dueDate').value;
            
            const button = document.getElementById('calibrationMgmt_updateBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث...';
            
            if (calibrationDate && !validateDate(calibrationDate)) {
                showNotification('❌ تاريخ المعايرة غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            if (dueDate && !validateDate(dueDate)) {
                showNotification('❌ تاريخ الاستحقاق غير صحيح', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                return;
            }
            
            // Get file link from hidden field
            const fileLink = document.getElementById('calibrationMgmt_fileLink').value;
            
            // Convert dates to D M Y format
            const calibrationDateDMY = calibrationDate ? formatDateToDMY(parseDateDDMMYYYY(calibrationDate)) : '';
            const dueDateDMY = dueDate ? formatDateToDMY(parseDateDDMMYYYY(dueDate)) : '';
            
            // Prepare status with details
            const statusBeforeValue = document.getElementById('calMgmt_statusBefore').value;
            const statusBeforeDetails = document.getElementById('calMgmt_statusBeforeDetails').value;
            const statusBeforeToSave = statusBeforeDetails && statusBeforeValue === 'معيب' 
                ? `${statusBeforeValue} - ${statusBeforeDetails}`
                : statusBeforeValue;
            
            const statusAfterValue = document.getElementById('calMgmt_statusAfter').value;
            const statusAfterDetails = document.getElementById('calMgmt_statusAfterDetails').value;
            const statusAfterToSave = statusAfterDetails && statusAfterValue === 'معيب'
                ? `${statusAfterValue} - ${statusAfterDetails}`
                : statusAfterValue;
            
            // Build query string for update
            let q = `internalRecordId=${encodeURIComponent(recordId)}&`;
            q += `certificateNumber=${encodeURIComponent(document.getElementById('calMgmt_certificateNumber').value || '')}&`;
            q += `client=${encodeURIComponent(document.getElementById('calMgmt_client').value || '')}&`;
            q += `deviceNumber=${encodeURIComponent(document.getElementById('calMgmt_deviceNumber').value || '')}&`;
            q += `deviceName=${encodeURIComponent(document.getElementById('calMgmt_deviceName').value || '')}&`;
            q += `frequency=${encodeURIComponent(document.getElementById('calMgmt_frequency').value || '365')}&`;
            q += `calibrationLab=${encodeURIComponent(document.getElementById('calMgmt_calibrationLab').value || '')}&`;
            q += `accreditationNumber=${encodeURIComponent(document.getElementById('calMgmt_accreditationNumber').value || '')}&`;
            q += `traceability=${encodeURIComponent(document.getElementById('calMgmt_traceability').value || '')}&`;
            q += `uncertainty=${encodeURIComponent(document.getElementById('calMgmt_uncertainty').value || '')}&`;
            q += `statusBefore=${encodeURIComponent(statusBeforeToSave)}&`;
            q += `statusAfter=${encodeURIComponent(statusAfterToSave)}&`;
            q += `notes=${encodeURIComponent(document.getElementById('calMgmt_notes').value || '')}&`;
            q += `technician=${encodeURIComponent(document.getElementById('calMgmt_technician').value || '')}&`;
            q += `calibrationCost=${encodeURIComponent(document.getElementById('calMgmt_calibrationCost').value || '')}&`;
            q += `downtime=${encodeURIComponent(document.getElementById('calMgmt_downtime').value || '')}&`;
            q += `calibrationMethod=${encodeURIComponent(document.getElementById('calMgmt_calibrationMethod').value || '')}&`;
            q += `qualityReview=${encodeURIComponent(document.getElementById('calMgmt_qualityReview').value || '')}&`;
            q += `reviewer=${encodeURIComponent(document.getElementById('calMgmt_reviewer').value || '')}&`;
            q += `calibrationDate=${encodeURIComponent(calibrationDateDMY)}&`;
            q += `dueDate=${encodeURIComponent(dueDateDMY)}&`;
            q += `fileLink=${encodeURIComponent(fileLink || '')}`;
            
            try {
                const res = await jsonp(`${CALIBRATION_MGMT_SCRIPT_URL}?action=update&${q}`);
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    resetCalibrationMgmtForm();
                    await loadCalibrationMgmtData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ غير معروف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                showNotification('❌ خطأ في التحديث', 'error');
                console.error('Update error:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        function resetCalibrationMgmtForm() {
            document.getElementById('calibrationMgmtForm').reset();
            document.getElementById('calibrationMgmt_editingId').value = '';
            document.getElementById('calibrationMgmt_internalRecordId').value = '';
            document.getElementById('calibrationMgmt_fileLink').value = '';
            document.getElementById('calibrationMgmt_addBtn').style.display = 'inline-block';
            document.getElementById('calibrationMgmt_updateBtn').style.display = 'none';
            document.querySelectorAll('#calibrationMgmtForm .is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            // Reset status dropdowns and details
            document.getElementById('calMgmt_statusBefore').value = 'سليم';
            document.getElementById('calMgmt_statusBeforeDetails').value = '';
            document.getElementById('statusBeforeDetails').style.display = 'none';
            
            document.getElementById('calMgmt_statusAfter').value = 'سليم';
            document.getElementById('calMgmt_statusAfterDetails').value = '';
            document.getElementById('statusAfterDetails').style.display = 'none';
            
            // Reset file upload section
            selectedFile = null;
            uploadedFileUrl = '';
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('uploadedFileLink').style.display = 'none';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('uploadStatus').className = 'upload-status';
            document.getElementById('fileInput').value = '';
            
            // Reset dates and frequency
            if (flatpickrInstances.calibrationDate) {
                const today = new Date();
                const todayFormatted = formatDateToDDMMYYYY(today);
                document.getElementById('calMgmt_calibrationDate').value = todayFormatted;
                flatpickrInstances.calibrationDate.setDate(today, false);
            }
            
            if (flatpickrInstances.dueDate) flatpickrInstances.dueDate.clear();
            
            document.getElementById('calMgmt_frequency').value = '365';
            document.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === 365) {
                    btn.classList.add('active');
                }
            });
            
            // Clear filtered records
            filteredRecords = [];
            
            // Reset autofill indicators
            document.querySelectorAll('.autofill-indicator').forEach(indicator => {
                indicator.classList.remove('show');
            });
            
            // Calculate due date
            calculateDueDate();
        }
        
        function exportCalibrationMgmtCSV() {
            if (calibrationMgmtRecords.length === 0) {
                showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            showNotification('📥 جاري تصدير سجلات المعايرة...', 'info');
            
            try {
                const headers = [
                    'رقم الشهادة', 'العميل', 'رقم الجهاز', 'اسم الجهاز',
                    'تاريخ المعايرة', 'التكرار (أيام)', 'تاريخ الاستحقاق',
                    'مختبر المعايرة', 'رقم الاعتماد', 'قابلية التتبع',
                    'عدم اليقين', 'الحالة عند الاستلام', 'الحالة بعد المعايرة',
                    'لينك الملف', 'ملاحظات', 'الفني المسؤول', 'تكلفة المعايرة',
                    'مدة التوقف', 'طريقة المعايرة', 'مراجعة الجودة', 'المراجع'
                ];
                
                let csvContent = '\uFEFF';
                csvContent += headers.join(",") + "\r\n";
                
                calibrationMgmtRecords.forEach(record => {
                    const calibrationDateObj = parseDateFromDMY(record[5] || '');
                    const dueDateObj = parseDateFromDMY(record[7] || '');
                    
                    const calibrationDateDisplay = calibrationDateObj ? formatDateToDayMonthYear(calibrationDateObj) : '';
                    const dueDateDisplay = dueDateObj ? formatDateToDayMonthYear(dueDateObj) : '';
                    
                    const row = [
                        record[1] || '',
                        record[2] || '',
                        record[3] || '',
                        record[4] || '',
                        calibrationDateDisplay,
                        record[6] || '',
                        dueDateDisplay,
                        record[8] || '',
                        record[9] || '',
                        record[10] || '',
                        record[11] || '',
                        record[12] || '',
                        record[13] || '',
                        record[14] || '',
                        record[15] || '',
                        record[16] || '',
                        record[17] || '',
                        record[18] || '',
                        record[19] || '',
                        record[20] || '',
                        record[21] || ''
                    ];
                    
                    const escapedRow = row.map(cell => {
                        return `"${cell.toString().replace(/"/g, '""')}"`;
                    });
                    csvContent += escapedRow.join(",") + "\r\n";
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `سجلات_المعايرة_${new Date().toISOString().slice(0,10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`✅ تم تصدير ${calibrationMgmtRecords.length} سجل`, 'success');
            } catch (error) {
                showNotification('❌ خطأ في التصدير', 'error');
            }
        }
        
        // ================ DETAILS VIEW FUNCTION ================
        function viewDetails(recordId) {
            const record = calibrationMgmtRecords.find(r => 
                String(r[0] || '').trim() === String(recordId).trim()
            );
            
            if (!record) {
                showNotification('❌ لم يتم العثور على السجل', 'error');
                return;
            }
            
            const fileLink = record[14] || '';
            
            const calibrationDateObj = parseDateFromDMY(record[5] || '');
            const dueDateObj = parseDateFromDMY(record[7] || '');
            
            const calibrationDateDisplay = calibrationDateObj ? formatDateToDayMonthYear(calibrationDateObj) : '';
            const dueDateDisplay = dueDateObj ? formatDateToDayMonthYear(dueDateObj) : '';
            
            // Parse status with details
            const statusBefore = record[12] || 'سليم';
            const statusAfter = record[13] || 'سليم';
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>رقم الشهادة:</strong> ${escapeHtml(record[1] || '')}</p>
                        <p><strong>العميل:</strong> ${escapeHtml(record[2] || '')}</p>
                        <p><strong>رقم الجهاز:</strong> ${escapeHtml(record[3])}</p>
                        <p><strong>اسم الجهاز:</strong> ${escapeHtml(record[4])}</p>
                        <p><strong>تاريخ المعايرة:</strong> <span class="english-date">${calibrationDateDisplay}</span></p>
                        <p><strong>التكرار:</strong> ${escapeHtml(record[6])} يوم</p>
                        <p><strong>تاريخ الاستحقاق:</strong> <span class="english-date">${dueDateDisplay}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>مختبر المعايرة:</strong> ${escapeHtml(record[8] || '')}</p>
                        <p><strong>رقم الاعتماد:</strong> ${escapeHtml(record[9] || '')}</p>
                        <p><strong>قابلية التتبع:</strong> ${escapeHtml(record[10] || '')}</p>
                        <p><strong>عدم اليقين:</strong> ${escapeHtml(record[11] || '')}</p>
                        <p><strong>الحالة عند الاستلام:</strong> ${escapeHtml(statusBefore)}</p>
                        <p><strong>الحالة بعد المعايرة:</strong> ${escapeHtml(statusAfter)}</p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p><strong>الفني المسؤول:</strong> ${escapeHtml(record[16] || '')}</p>
                        <p><strong>تكلفة المعايرة:</strong> ${escapeHtml(record[17] || '')}</p>
                        <p><strong>مدة التوقف:</strong> ${escapeHtml(record[18] || '')}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>طريقة المعايرة:</strong> ${escapeHtml(record[19] || '')}</p>
                        <p><strong>مراجعة الجودة:</strong> ${escapeHtml(record[20] || '')}</p>
                        <p><strong>المراجع:</strong> ${escapeHtml(record[21] || '')}</p>
                    </div>
                </div>
                
                ${record[15] ? `<div class="row mt-3">
                    <div class="col-12">
                        <p><strong>ملاحظات:</strong> ${escapeHtml(record[15])}</p>
                    </div>
                </div>` : ''}
                
                ${fileLink ? `<div class="row mt-3">
                    <div class="col-md-12">
                        <p><strong>الملف المرفوع:</strong> 
                            <a href="${escapeHtml(fileLink)}" target="_blank" class="file-link-btn ms-2">
                                <i class="fas fa-external-link-alt me-1"></i> فتح الملف
                            </a>
                        </p>
                    </div>
                </div>` : ''}
            `;
            
            document.getElementById('detailsModalBody').innerHTML = detailsHTML;
            detailsModalInstance.show();
        }
        
        // ================ DELETE FUNCTIONALITY ================
        function showDeleteModal(recordId, recordName, recordNumber = '') {
            deleteRecordId = recordId;
            deleteRecordName = recordName;
            
            document.getElementById('deleteRecordId').textContent = recordNumber || 'غير معروف';
            document.getElementById('deleteRecordName').textContent = recordName || 'غير معروف';
            
            deleteModalInstance.show();
        }
        
        async function confirmDelete() {
            if (!deleteRecordId) return;
            
            const button = document.getElementById('confirmDeleteBtn');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحذف...';
            
            try {
                const res = await jsonp(`${CALIBRATION_MGMT_SCRIPT_URL}?action=delete&recordId=${encodeURIComponent(deleteRecordId)}`);
                
                button.disabled = false;
                button.innerHTML = originalHtml;
                
                if (res && res.status === 'success') {
                    showNotification(`✅ ${res.message}`, 'success');
                    
                    deleteModalInstance.hide();
                    
                    deleteRecordId = '';
                    deleteRecordName = '';
                    
                    loadCalibrationMgmtData();
                } else {
                    const errorMsg = res && res.message ? res.message : 'حدث خطأ أثناء الحذف';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting record:', error);
                button.disabled = false;
                button.innerHTML = originalHtml;
                showNotification('❌ خطأ في الاتصال بالخادم', 'error');
            }
        }
    </script>
</body>
</html>
